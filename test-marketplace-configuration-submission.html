<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin Marketplace Configuration & Submission Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .test-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .test-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .test-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .test-btn.success { background: linear-gradient(135deg, #4CAF50, #45a049); }
        .test-btn.warning { background: linear-gradient(135deg, #ff9800, #f57c00); }
        .test-btn.danger { background: linear-gradient(135deg, #f44336, #d32f2f); }
        .test-btn.info { background: linear-gradient(135deg, #2196F3, #1976D2); }

        .status-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .status-success { border-left-color: #28a745; background: #d4edda; }
        .status-warning { border-left-color: #ffc107; background: #fff3cd; }
        .status-error { border-left-color: #dc3545; background: #f8d7da; }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-list li:last-child {
            border-bottom: none;
        }

        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending { background: #ffc107; color: white; }
        .status-success-icon { background: #28a745; color: white; }
        .status-error-icon { background: #dc3545; color: white; }

        .config-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .port-display {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            color: #1565c0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🛒 Plugin Marketplace Configuration & Submission Test</h1>
        <p>Comprehensive testing suite for enhanced marketplace features</p>
    </div>

    <div class="test-container">
        <!-- Marketplace Access Test -->
        <div class="test-section">
            <h3>🛒 Marketplace Access</h3>
            <div class="test-grid">
                <button class="test-btn" onclick="testMarketplaceAccess()">
                    <span>🚀</span> Open Marketplace
                </button>
                <button class="test-btn info" onclick="testMarketplaceUI()">
                    <span>🎨</span> Test UI
                </button>
            </div>
            <div id="marketplace-status" class="status-display">Ready to test marketplace access...</div>
        </div>

        <!-- Configuration Test -->
        <div class="test-section">
            <h3>⚙️ Configuration Management</h3>
            <div class="test-grid">
                <button class="test-btn warning" onclick="openConfiguration()">
                    <span>⚙️</span> Open Config
                </button>
                <button class="test-btn info" onclick="testConnectionStatus()">
                    <span>🔗</span> Test Connections
                </button>
            </div>
            
            <div class="config-form">
                <div class="form-group">
                    <label>MCP Server Port:</label>
                    <input type="number" id="mcpPort" value="3000" min="1024" max="65535">
                </div>
                <div class="form-group">
                    <label>Marketplace Port (Auto: MCP + 1):</label>
                    <div class="port-display" id="marketplacePortDisplay">3001</div>
                </div>
            </div>
            <div id="config-status" class="status-display">Configuration system ready...</div>
        </div>

        <!-- Submission Test -->
        <div class="test-section">
            <h3>📤 Plugin Submission</h3>
            <div class="test-grid">
                <button class="test-btn success" onclick="openSubmissionDialog()">
                    <span>📤</span> Submit Plugin
                </button>
                <button class="test-btn info" onclick="testFileUpload()">
                    <span>📁</span> Test Upload
                </button>
            </div>
            <div id="submission-status" class="status-display">Submission system ready...</div>
        </div>

        <!-- Server Status -->
        <div class="test-section">
            <h3>🌐 Server Status</h3>
            <div class="test-grid">
                <button class="test-btn" onclick="checkMarketplaceServer()">
                    <span>🔍</span> Check Server
                </button>
                <button class="test-btn warning" onclick="startMarketplaceServer()">
                    <span>🚀</span> Start Server
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="server-status">🔴</div>
                    <div class="stat-label">Server Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="connection-count">0</div>
                    <div class="stat-label">Connections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="plugins-count">0</div>
                    <div class="stat-label">Plugins</div>
                </div>
            </div>
            <div id="server-status-log" class="status-display">Server status unknown...</div>
        </div>
    </div>

    <!-- System Status -->
    <div class="test-section">
        <h3>📊 System Status</h3>
        <ul class="feature-list">
            <li>
                <div class="status-icon status-pending" id="modules-status">?</div>
                Module Loading Status
            </li>
            <li>
                <div class="status-icon status-pending" id="config-system-status">?</div>
                Configuration System
            </li>
            <li>
                <div class="status-icon status-pending" id="submission-system-status">?</div>
                Submission System
            </li>
            <li>
                <div class="status-icon status-pending" id="marketplace-system-status">?</div>
                Marketplace System
            </li>
            <li>
                <div class="status-icon status-pending" id="server-connection-status">?</div>
                Server Connection
            </li>
        </ul>
        <div id="system-status" class="status-display">Checking system status...</div>
    </div>

    <!-- Load Required Modules -->
    <script src="src/renderer/modules/ConfigManager.js"></script>
    <script src="src/renderer/modules/PluginAPI.js"></script>
    <script src="src/renderer/modules/PluginResourceManager.js"></script>
    <script src="src/renderer/modules/PluginMarketplace.js"></script>
    <script src="src/renderer/modules/PluginDependencyResolver.js"></script>
    <script src="src/renderer/modules/PluginSecurityValidator.js"></script>
    <script src="src/renderer/modules/PluginUpdateManager.js"></script>
    <script src="src/renderer/modules/PluginManagerV2.js"></script>
    <script src="src/renderer/modules/PluginMarketplaceConfig.js"></script>
    <script src="src/renderer/modules/PluginSubmissionUI.js"></script>
    <script src="src/renderer/modules/PluginMarketplaceUI.js"></script>
    <script src="src/renderer/modules/PluginManagementUI.js"></script>
    <script src="src/renderer/modules/PluginSystemBootstrap.js"></script>

    <script>
        // Global variables for testing
        let pluginManager = null;
        let marketplace = null;
        let marketplaceUI = null;
        let config = null;
        let submissionUI = null;

        // Initialize system
        async function initializeSystem() {
            updateStatus('system-status', 'Initializing system...', 'info');
            
            try {
                // Initialize ConfigManager
                const configManager = new ConfigManager();
                updateSystemStatus('config-system-status', true);
                
                // Initialize PluginManagerV2
                pluginManager = new PluginManagerV2(configManager);
                await pluginManager.initialize();
                updateSystemStatus('modules-status', true);
                
                // Initialize Marketplace
                marketplace = new PluginMarketplace(pluginManager);
                await marketplace.initialize();
                updateSystemStatus('marketplace-system-status', true);
                
                // Initialize MarketplaceUI
                marketplaceUI = new PluginMarketplaceUI(marketplace);
                
                // Initialize Configuration
                config = new PluginMarketplaceConfig(configManager);
                updateSystemStatus('config-system-status', true);
                
                // Initialize Submission UI
                submissionUI = new PluginSubmissionUI(config, pluginManager);
                updateSystemStatus('submission-system-status', true);
                
                updateStatus('system-status', 'System initialized successfully!', 'success');
                
                // Test server connection
                await testServerConnection();
                
            } catch (error) {
                updateStatus('system-status', `Initialization error: ${error.message}`, 'error');
                console.error('System initialization failed:', error);
            }
        }

        // Test marketplace access
        async function testMarketplaceAccess() {
            updateStatus('marketplace-status', 'Testing marketplace access...', 'info');
            
            try {
                if (!marketplaceUI) {
                    throw new Error('MarketplaceUI not initialized');
                }
                
                await marketplaceUI.openMarketplace();
                updateStatus('marketplace-status', 'Marketplace opened successfully!', 'success');
                
            } catch (error) {
                updateStatus('marketplace-status', `Marketplace access error: ${error.message}`, 'error');
            }
        }

        // Test marketplace UI features
        function testMarketplaceUI() {
            updateStatus('marketplace-status', 'Testing UI features...', 'info');
            
            try {
                if (!marketplaceUI || !marketplaceUI.isOpen) {
                    throw new Error('Marketplace not open');
                }
                
                // Test search functionality
                const searchInput = document.getElementById('plugin-search');
                if (searchInput) {
                    searchInput.value = 'test';
                    marketplaceUI.searchPlugins();
                }
                
                updateStatus('marketplace-status', 'UI features tested successfully!', 'success');
                
            } catch (error) {
                updateStatus('marketplace-status', `UI test error: ${error.message}`, 'error');
            }
        }

        // Open configuration dialog
        function openConfiguration() {
            updateStatus('config-status', 'Opening configuration...', 'info');
            
            try {
                if (!config) {
                    throw new Error('Configuration system not initialized');
                }
                
                config.showConfiguration();
                updateStatus('config-status', 'Configuration opened successfully!', 'success');
                
            } catch (error) {
                updateStatus('config-status', `Configuration error: ${error.message}`, 'error');
            }
        }

        // Test connection status
        async function testConnectionStatus() {
            updateStatus('config-status', 'Testing connections...', 'info');
            
            try {
                if (!config) {
                    throw new Error('Configuration system not initialized');
                }
                
                const sources = config.getEnabledSources();
                let results = [];
                
                for (const source of sources) {
                    const result = await config.testSource(source);
                    results.push(`${source.id}: ${result.success ? '✅' : '❌'} ${result.message || ''}`);
                }
                
                updateStatus('config-status', `Connection test results:\n${results.join('\n')}`, 
                           results.some(r => r.includes('✅')) ? 'success' : 'warning');
                
            } catch (error) {
                updateStatus('config-status', `Connection test error: ${error.message}`, 'error');
            }
        }

        // Open submission dialog
        function openSubmissionDialog() {
            updateStatus('submission-status', 'Opening submission dialog...', 'info');
            
            try {
                if (!submissionUI) {
                    throw new Error('Submission system not initialized');
                }
                
                submissionUI.showSubmissionDialog();
                updateStatus('submission-status', 'Submission dialog opened successfully!', 'success');
                
            } catch (error) {
                updateStatus('submission-status', `Submission error: ${error.message}`, 'error');
            }
        }

        // Test file upload
        function testFileUpload() {
            updateStatus('submission-status', 'Testing file upload...', 'info');
            
            try {
                // Create a test file
                const testContent = JSON.stringify({
                    name: 'Test Plugin',
                    version: '1.0.0',
                    description: 'A test plugin for validation',
                    author: 'Test User'
                }, null, 2);
                
                const blob = new Blob([testContent], { type: 'application/json' });
                const file = new File([blob], 'test-plugin.json', { type: 'application/json' });
                
                updateStatus('submission-status', `Test file created: ${file.name} (${file.size} bytes)`, 'success');
                
            } catch (error) {
                updateStatus('submission-status', `File upload test error: ${error.message}`, 'error');
            }
        }

        // Check marketplace server
        async function checkMarketplaceServer() {
            updateStatus('server-status-log', 'Checking marketplace server...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/v1/health');
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('server-status-log', `Server healthy: ${JSON.stringify(data, null, 2)}`, 'success');
                    updateServerStats(true, data);
                } else {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
            } catch (error) {
                updateStatus('server-status-log', `Server check failed: ${error.message}`, 'error');
                updateServerStats(false);
            }
        }

        // Start marketplace server
        function startMarketplaceServer() {
            updateStatus('server-status-log', 'Starting marketplace server...', 'info');
            updateStatus('server-status-log', 
                'Please run: ./start-marketplace-server.sh\nOr manually: node plugin-marketplace-server.js', 
                'warning');
        }

        // Test server connection
        async function testServerConnection() {
            try {
                await checkMarketplaceServer();
                updateSystemStatus('server-connection-status', true);
            } catch (error) {
                updateSystemStatus('server-connection-status', false);
            }
        }

        // Update port display when MCP port changes
        document.getElementById('mcpPort').addEventListener('input', function() {
            const mcpPort = parseInt(this.value) || 3000;
            const marketplacePort = mcpPort + 1;
            document.getElementById('marketplacePortDisplay').textContent = marketplacePort;
        });

        // Utility functions
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status-display status-${type}`;
            }
        }

        function updateSystemStatus(elementId, success) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = success ? '✓' : '✗';
                element.className = `status-icon ${success ? 'status-success-icon' : 'status-error-icon'}`;
            }
        }

        function updateServerStats(isOnline, data = {}) {
            document.getElementById('server-status').textContent = isOnline ? '🟢' : '🔴';
            document.getElementById('connection-count').textContent = data.connections || 0;
            document.getElementById('plugins-count').textContent = data.plugins || 0;
        }

        // Initialize on page load
        window.addEventListener('load', initializeSystem);
    </script>
</body>
</html> 