<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Refresh & Save Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef; }
        .header h1 { color: #2c3e50; font-size: 2.2em; margin-bottom: 10px; }
        .test-section { margin-bottom: 25px; padding: 20px; border-radius: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .issue-section { background: #fff3cd; border-left: 4px solid #ffc107; }
        .fix-section { background: #d4edda; border-left: 4px solid #28a745; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .code-block { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 0.9em; margin: 10px 0; }
        .highlight { background: rgba(0,123,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin: 15px 0; }
        .data-flow { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .flow-step { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; border: 2px solid #e9ecef; }
        .flow-step.active { border-color: #28a745; background: #d4edda; }
        .flow-step.error { border-color: #dc3545; background: #f8d7da; }
        .flow-icon { font-size: 1.5em; margin-bottom: 8px; }
        .flow-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 0.9em; }
        .flow-desc { font-size: 0.8em; color: #6c757d; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”„ Project Refresh & Save Test</h1>
            <p>éªŒè¯RefreshåŠŸèƒ½æ£€æµ‹åˆ°çš„æ–°æ–‡ä»¶èƒ½å¤Ÿæ­£ç¡®ä¿å­˜åˆ°.prj.GAIæ–‡ä»¶ä¸­</p>
        </div>

        <div class="issue-section test-section">
            <h3>âŒ æŠ¥å‘Šçš„é—®é¢˜</h3>
            <ul>
                <li>Refreshåèƒ½çœ‹åˆ°æ–°çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li>
                <li>ä½†ç‚¹å‡»ä¿å­˜æŒ‰é’®åï¼Œè¿™äº›æ–°å¢å†…å®¹æ²¡æœ‰ä¿å­˜åˆ°.prj.GAIæ–‡ä»¶ä¸­</li>
                <li>é‡æ–°æ‰“å¼€é¡¹ç›®æ–‡ä»¶åéœ€è¦é‡æ–°Refreshæ‰èƒ½çœ‹åˆ°è¿™äº›æ–‡ä»¶</li>
            </ul>
        </div>

        <div class="fix-section test-section">
            <h3>âœ… ä¿®å¤æ–¹æ¡ˆ</h3>
            <div class="highlight">
                <strong>é—®é¢˜åˆ†æï¼š</strong>åœ¨scanAndAddNewFiles()æ–¹æ³•ä¸­ï¼Œæ–°æ–‡ä»¶è¢«æ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œä½†ç¼ºå°‘äº†markProjectAsModified()è°ƒç”¨ã€‚
                <br><br>
                <strong>ä¿®å¤ï¼š</strong>åœ¨æ£€æµ‹åˆ°æ–°æ–‡ä»¶åè°ƒç”¨markProjectAsModified()ï¼Œç¡®ä¿é¡¹ç›®è¢«æ ‡è®°ä¸ºéœ€è¦ä¿å­˜ã€‚
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ”„ æ•°æ®æµç¨‹</h3>
            <div class="data-flow">
                <div class="flow-step" id="step1">
                    <div class="flow-icon">ğŸ“</div>
                    <div class="flow-title">RefreshæŒ‰é’®</div>
                    <div class="flow-desc">refreshProjects()</div>
                </div>
                <div class="flow-step" id="step2">
                    <div class="flow-icon">ğŸ”</div>
                    <div class="flow-title">æ‰«æç›®å½•</div>
                    <div class="flow-desc">scanAndAddNewFiles()</div>
                </div>
                <div class="flow-step" id="step3">
                    <div class="flow-icon">ğŸ†•</div>
                    <div class="flow-title">æ£€æµ‹æ–°æ–‡ä»¶</div>
                    <div class="flow-desc">æ¯”è¾ƒç°æœ‰æ–‡ä»¶</div>
                </div>
                <div class="flow-step" id="step4">
                    <div class="flow-icon">ğŸ’¾</div>
                    <div class="flow-title">æ›´æ–°å†…å­˜</div>
                    <div class="flow-desc">æ·»åŠ åˆ°filesæ•°ç»„</div>
                </div>
                <div class="flow-step" id="step5">
                    <div class="flow-icon">ğŸ””</div>
                    <div class="flow-title">æ ‡è®°ä¿®æ”¹</div>
                    <div class="flow-desc">markProjectAsModified()</div>
                </div>
                <div class="flow-step" id="step6">
                    <div class="flow-icon">ğŸ’¾</div>
                    <div class="flow-title">ä¿å­˜æŒ‰é’®</div>
                    <div class="flow-desc">saveCurrentProject()</div>
                </div>
                <div class="flow-step" id="step7">
                    <div class="flow-icon">ğŸ“„</div>
                    <div class="flow-title">å†™å…¥æ–‡ä»¶</div>
                    <div class="flow-desc">ä¿å­˜åˆ°.prj.GAI</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>æ‰“å¼€Project Manager</li>
                <li>åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ªé¡¹ç›®</li>
                <li>åœ¨é¡¹ç›®ç›®å½•ä¸­æ‰‹åŠ¨æ·»åŠ æ–°æ–‡ä»¶</li>
                <li>ç‚¹å‡»RefreshæŒ‰é’®</li>
                <li>éªŒè¯æ–°æ–‡ä»¶åœ¨UIä¸­æ˜¾ç¤º</li>
                <li>æ£€æŸ¥ä¿å­˜æŒ‰é’®æ˜¯å¦å˜çº¢å¹¶æ˜¾ç¤ºæ˜Ÿå·</li>
                <li>ç‚¹å‡»ä¿å­˜æŒ‰é’®</li>
                <li>é‡æ–°æ‰“å¼€é¡¹ç›®éªŒè¯æ–°æ–‡ä»¶è‡ªåŠ¨æ˜¾ç¤º</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ”§ è°ƒè¯•å·¥å…·</h3>
            <div style="text-align: center;">
                <button class="btn btn-success" onclick="runTest()">ğŸ§ª è¿è¡Œæµ‹è¯•</button>
                <button class="btn btn-warning" onclick="checkState()">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                <button class="btn" onclick="simulateRefresh()">ğŸ”„ æ¨¡æ‹ŸRefresh</button>
                <button class="btn btn-danger" onclick="clearTest()">ğŸ—‘ï¸ æ¸…é™¤æµ‹è¯•</button>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ å…³é”®ä»£ç </h3>
            <h4>ä¿®å¤å‰ï¼š</h4>
            <div class="code-block">
// scanAndAddNewFiles() ä¸­ç¼ºå°‘ï¼š
this.currentProject.modified = new Date().toISOString();
this.projects.set(this.currentProject.id, this.currentProject);
await this.saveProjects(); // åªä¿å­˜åˆ°localStorage
// âŒ ç¼ºå°‘ï¼šthis.markProjectAsModified();
            </div>
            
            <h4>ä¿®å¤åï¼š</h4>
            <div class="code-block">
// scanAndAddNewFiles() ä¸­æ–°å¢ï¼š
this.currentProject.modified = new Date().toISOString();
this.projects.set(this.currentProject.id, this.currentProject);
// âœ… æ–°å¢ï¼šæ ‡è®°é¡¹ç›®ä¸ºå·²ä¿®æ”¹
this.markProjectAsModified();
await this.saveProjects();
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults">
                <div style="text-align: center; color: #6c757d; padding: 20px;">
                    ç‚¹å‡»"è¿è¡Œæµ‹è¯•"å¼€å§‹éªŒè¯
                </div>
            </div>
        </div>
    </div>

    <script>
        function runTest() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<h4>ğŸ§ª æµ‹è¯•ç»“æœï¼š</h4>';
            
            const tests = [
                { name: 'ProjectManagerWindowå®ä¾‹', test: () => typeof window.projectManagerWindow !== 'undefined' },
                { name: 'markProjectAsModifiedæ–¹æ³•', test: () => typeof window.projectManagerWindow?.markProjectAsModified === 'function' },
                { name: 'scanAndAddNewFilesæ–¹æ³•', test: () => typeof window.projectManagerWindow?.scanAndAddNewFiles === 'function' },
                { name: 'saveCurrentProjectæ–¹æ³•', test: () => typeof window.projectManagerWindow?.saveCurrentProject === 'function' }
            ];
            
            tests.forEach(test => {
                const passed = test.test();
                const icon = passed ? 'âœ…' : 'âŒ';
                results.innerHTML += '<div><span class="status-indicator status-' + (passed ? 'success' : 'error') + '"></span>' + icon + ' ' + test.name + '</div>';
            });
            
            if (window.projectManagerWindow?.currentProject) {
                const project = window.projectManagerWindow.currentProject;
                results.innerHTML += '<h4>ğŸ“Š å½“å‰é¡¹ç›®ï¼š</h4>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>é¡¹ç›®: ' + project.name + '</div>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>æ–‡ä»¶æ•°: ' + (project.files?.length || 0) + '</div>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>æœªä¿å­˜æ›´æ”¹: ' + (project.hasUnsavedChanges ? 'æ˜¯' : 'å¦') + '</div>';
            }
        }
        
        function checkState() {
            if (!window.projectManagerWindow) {
                alert('Project Manageræœªåˆå§‹åŒ–');
                return;
            }
            
            const project = window.projectManagerWindow.currentProject;
            if (!project) {
                alert('å½“å‰æ²¡æœ‰æ‰“å¼€çš„é¡¹ç›®');
                return;
            }
            
            alert('é¡¹ç›®çŠ¶æ€ï¼š\n\n' +
                  'åç§°: ' + project.name + '\n' +
                  'æ–‡ä»¶æ•°: ' + (project.files?.length || 0) + '\n' +
                  'æœªä¿å­˜æ›´æ”¹: ' + (project.hasUnsavedChanges ? 'æ˜¯' : 'å¦') + '\n' +
                  'é¡¹ç›®æ–‡ä»¶è·¯å¾„: ' + (project.projectFilePath || 'æœªè®¾ç½®'));
        }
        
        function simulateRefresh() {
            if (!window.projectManagerWindow?.currentProject) {
                alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªé¡¹ç›®');
                return;
            }
            
            const newFile = {
                id: 'sim_' + Date.now(),
                name: 'simulated_file.txt',
                path: '/sim/simulated_file.txt',
                size: 1024,
                type: 'text',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                metadata: { autoDiscovered: true, simulated: true }
            };
            
            if (!window.projectManagerWindow.currentProject.files) {
                window.projectManagerWindow.currentProject.files = [];
            }
            window.projectManagerWindow.currentProject.files.push(newFile);
            window.projectManagerWindow.markProjectAsModified();
            
            if (window.projectManagerWindow.refreshCurrentView) {
                window.projectManagerWindow.refreshCurrentView();
            }
            
            alert('âœ… æ¨¡æ‹ŸRefreshå®Œæˆï¼\næ–°å¢æ¨¡æ‹Ÿæ–‡ä»¶ï¼Œé¡¹ç›®å·²æ ‡è®°ä¸ºå·²ä¿®æ”¹ã€‚');
        }
        
        function clearTest() {
            if (!window.projectManagerWindow?.currentProject?.files) {
                alert('æ²¡æœ‰å¯æ¸…é™¤çš„æ•°æ®');
                return;
            }
            
            const before = window.projectManagerWindow.currentProject.files.length;
            window.projectManagerWindow.currentProject.files = window.projectManagerWindow.currentProject.files.filter(f => !f.metadata?.simulated);
            const after = window.projectManagerWindow.currentProject.files.length;
            
            if (before !== after) {
                window.projectManagerWindow.markProjectAsModified();
                if (window.projectManagerWindow.refreshCurrentView) {
                    window.projectManagerWindow.refreshCurrentView();
                }
                alert('âœ… æ¸…é™¤äº† ' + (before - after) + ' ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶');
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°æ¨¡æ‹Ÿæ–‡ä»¶');
            }
        }
    </script>
</body>
</html>
