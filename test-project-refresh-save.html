<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Refresh & Save Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e9ecef; }
        .header h1 { color: #2c3e50; font-size: 2.2em; margin-bottom: 10px; }
        .test-section { margin-bottom: 25px; padding: 20px; border-radius: 10px; background: #f8f9fa; border-left: 4px solid #007bff; }
        .issue-section { background: #fff3cd; border-left: 4px solid #ffc107; }
        .fix-section { background: #d4edda; border-left: 4px solid #28a745; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; }
        .code-block { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px; font-family: monospace; font-size: 0.9em; margin: 10px 0; }
        .highlight { background: rgba(0,123,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin: 15px 0; }
        .data-flow { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
        .flow-step { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; border: 2px solid #e9ecef; }
        .flow-step.active { border-color: #28a745; background: #d4edda; }
        .flow-step.error { border-color: #dc3545; background: #f8d7da; }
        .flow-icon { font-size: 1.5em; margin-bottom: 8px; }
        .flow-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; font-size: 0.9em; }
        .flow-desc { font-size: 0.8em; color: #6c757d; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
        .status-success { background: #28a745; }
        .status-warning { background: #ffc107; }
        .status-error { background: #dc3545; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 Project Refresh & Save Test</h1>
            <p>验证Refresh功能检测到的新文件能够正确保存到.prj.GAI文件中</p>
        </div>

        <div class="issue-section test-section">
            <h3>❌ 报告的问题</h3>
            <ul>
                <li>Refresh后能看到新的文件和文件夹</li>
                <li>但点击保存按钮后，这些新增内容没有保存到.prj.GAI文件中</li>
                <li>重新打开项目文件后需要重新Refresh才能看到这些文件</li>
            </ul>
        </div>

        <div class="fix-section test-section">
            <h3>✅ 修复方案</h3>
            <div class="highlight">
                <strong>问题分析：</strong>在scanAndAddNewFiles()方法中，新文件被添加到内存中，但缺少了markProjectAsModified()调用。
                <br><br>
                <strong>修复：</strong>在检测到新文件后调用markProjectAsModified()，确保项目被标记为需要保存。
            </div>
        </div>

        <div class="test-section">
            <h3>🔄 数据流程</h3>
            <div class="data-flow">
                <div class="flow-step" id="step1">
                    <div class="flow-icon">📁</div>
                    <div class="flow-title">Refresh按钮</div>
                    <div class="flow-desc">refreshProjects()</div>
                </div>
                <div class="flow-step" id="step2">
                    <div class="flow-icon">🔍</div>
                    <div class="flow-title">扫描目录</div>
                    <div class="flow-desc">scanAndAddNewFiles()</div>
                </div>
                <div class="flow-step" id="step3">
                    <div class="flow-icon">🆕</div>
                    <div class="flow-title">检测新文件</div>
                    <div class="flow-desc">比较现有文件</div>
                </div>
                <div class="flow-step" id="step4">
                    <div class="flow-icon">💾</div>
                    <div class="flow-title">更新内存</div>
                    <div class="flow-desc">添加到files数组</div>
                </div>
                <div class="flow-step" id="step5">
                    <div class="flow-icon">🔔</div>
                    <div class="flow-title">标记修改</div>
                    <div class="flow-desc">markProjectAsModified()</div>
                </div>
                <div class="flow-step" id="step6">
                    <div class="flow-icon">💾</div>
                    <div class="flow-title">保存按钮</div>
                    <div class="flow-desc">saveCurrentProject()</div>
                </div>
                <div class="flow-step" id="step7">
                    <div class="flow-icon">📄</div>
                    <div class="flow-title">写入文件</div>
                    <div class="flow-desc">保存到.prj.GAI</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🧪 测试步骤</h3>
            <ol>
                <li>打开Project Manager</li>
                <li>创建或打开一个项目</li>
                <li>在项目目录中手动添加新文件</li>
                <li>点击Refresh按钮</li>
                <li>验证新文件在UI中显示</li>
                <li>检查保存按钮是否变红并显示星号</li>
                <li>点击保存按钮</li>
                <li>重新打开项目验证新文件自动显示</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>🔧 调试工具</h3>
            <div style="text-align: center;">
                <button class="btn btn-success" onclick="runTest()">🧪 运行测试</button>
                <button class="btn btn-warning" onclick="checkState()">📊 检查状态</button>
                <button class="btn" onclick="simulateRefresh()">🔄 模拟Refresh</button>
                <button class="btn btn-danger" onclick="clearTest()">🗑️ 清除测试</button>
            </div>
        </div>

        <div class="test-section">
            <h3>📋 关键代码</h3>
            <h4>修复前：</h4>
            <div class="code-block">
// scanAndAddNewFiles() 中缺少：
this.currentProject.modified = new Date().toISOString();
this.projects.set(this.currentProject.id, this.currentProject);
await this.saveProjects(); // 只保存到localStorage
// ❌ 缺少：this.markProjectAsModified();
            </div>
            
            <h4>修复后：</h4>
            <div class="code-block">
// scanAndAddNewFiles() 中新增：
this.currentProject.modified = new Date().toISOString();
this.projects.set(this.currentProject.id, this.currentProject);
// ✅ 新增：标记项目为已修改
this.markProjectAsModified();
await this.saveProjects();
            </div>
        </div>

        <div class="test-section">
            <h3>📊 测试结果</h3>
            <div id="testResults">
                <div style="text-align: center; color: #6c757d; padding: 20px;">
                    点击"运行测试"开始验证
                </div>
            </div>
        </div>
    </div>

    <script>
        function runTest() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<h4>🧪 测试结果：</h4>';
            
            const tests = [
                { name: 'ProjectManagerWindow实例', test: () => typeof window.projectManagerWindow !== 'undefined' },
                { name: 'markProjectAsModified方法', test: () => typeof window.projectManagerWindow?.markProjectAsModified === 'function' },
                { name: 'scanAndAddNewFiles方法', test: () => typeof window.projectManagerWindow?.scanAndAddNewFiles === 'function' },
                { name: 'saveCurrentProject方法', test: () => typeof window.projectManagerWindow?.saveCurrentProject === 'function' }
            ];
            
            tests.forEach(test => {
                const passed = test.test();
                const icon = passed ? '✅' : '❌';
                results.innerHTML += '<div><span class="status-indicator status-' + (passed ? 'success' : 'error') + '"></span>' + icon + ' ' + test.name + '</div>';
            });
            
            if (window.projectManagerWindow?.currentProject) {
                const project = window.projectManagerWindow.currentProject;
                results.innerHTML += '<h4>📊 当前项目：</h4>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>项目: ' + project.name + '</div>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>文件数: ' + (project.files?.length || 0) + '</div>';
                results.innerHTML += '<div><span class="status-indicator status-info"></span>未保存更改: ' + (project.hasUnsavedChanges ? '是' : '否') + '</div>';
            }
        }
        
        function checkState() {
            if (!window.projectManagerWindow) {
                alert('Project Manager未初始化');
                return;
            }
            
            const project = window.projectManagerWindow.currentProject;
            if (!project) {
                alert('当前没有打开的项目');
                return;
            }
            
            alert('项目状态：\n\n' +
                  '名称: ' + project.name + '\n' +
                  '文件数: ' + (project.files?.length || 0) + '\n' +
                  '未保存更改: ' + (project.hasUnsavedChanges ? '是' : '否') + '\n' +
                  '项目文件路径: ' + (project.projectFilePath || '未设置'));
        }
        
        function simulateRefresh() {
            if (!window.projectManagerWindow?.currentProject) {
                alert('请先打开一个项目');
                return;
            }
            
            const newFile = {
                id: 'sim_' + Date.now(),
                name: 'simulated_file.txt',
                path: '/sim/simulated_file.txt',
                size: 1024,
                type: 'text',
                created: new Date().toISOString(),
                modified: new Date().toISOString(),
                metadata: { autoDiscovered: true, simulated: true }
            };
            
            if (!window.projectManagerWindow.currentProject.files) {
                window.projectManagerWindow.currentProject.files = [];
            }
            window.projectManagerWindow.currentProject.files.push(newFile);
            window.projectManagerWindow.markProjectAsModified();
            
            if (window.projectManagerWindow.refreshCurrentView) {
                window.projectManagerWindow.refreshCurrentView();
            }
            
            alert('✅ 模拟Refresh完成！\n新增模拟文件，项目已标记为已修改。');
        }
        
        function clearTest() {
            if (!window.projectManagerWindow?.currentProject?.files) {
                alert('没有可清除的数据');
                return;
            }
            
            const before = window.projectManagerWindow.currentProject.files.length;
            window.projectManagerWindow.currentProject.files = window.projectManagerWindow.currentProject.files.filter(f => !f.metadata?.simulated);
            const after = window.projectManagerWindow.currentProject.files.length;
            
            if (before !== after) {
                window.projectManagerWindow.markProjectAsModified();
                if (window.projectManagerWindow.refreshCurrentView) {
                    window.projectManagerWindow.refreshCurrentView();
                }
                alert('✅ 清除了 ' + (before - after) + ' 个模拟文件');
            } else {
                alert('没有找到模拟文件');
            }
        }
    </script>
</body>
</html>
