<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Path Consistency Fix - Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .test-description {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        
        .path-display {
            font-family: 'Courier New', monospace;
            background: #2d3748;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .issue-found {
            background: #fed7d7;
            border-left-color: #e53e3e;
        }
        
        .issue-fixed {
            background: #c6f6d5;
            border-left-color: #38a169;
        }
        
        .validation-steps {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
        }
        
        .step-number {
            background: #4299e1;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-fixed { background: #38a169; }
        .status-error { background: #e53e3e; }
        .status-warning { background: #d69e2e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Project Path Consistency Fix Validation</h1>
            <p>Testing the resolution of path mismatch between project data scanning and .prj.GAI file saving</p>
        </div>
        
        <div class="content">
            <!-- Problem Description -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-error"></span>
                    Problem Identified
                </div>
                <div class="test-description issue-found">
                    <strong>路径不匹配问题：</strong><br>
                    • 项目数据文件夹：<code>/Users/song/Documents/GenomeExplorer Projects/5555</code><br>
                    • 保存的.prj.GAI文件：<code>/Users/song/Documents/Genome AI Studio Projects/5555.prj.GAI</code><br>
                    <br>
                    这导致新文件从一个目录扫描，但.prj.GAI文件却保存到了另一个目录！
                </div>
            </div>

            <!-- Root Cause Analysis -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-warning"></span>
                    Root Cause Analysis
                </div>
                <div class="test-description">
                    <strong>发现的问题源头：</strong>
                    <ul>
                        <li><strong>混用目录名</strong>：代码中同时使用了 "GenomeExplorer Projects" 和 "Genome AI Studio Projects"</li>
                        <li><strong>硬编码路径</strong>：保存逻辑中使用了错误的硬编码目录名</li>
                        <li><strong>不一致的路径推算</strong>：项目加载和保存使用了不同的目录结构</li>
                    </ul>
                </div>
            </div>

            <!-- Fixes Applied -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-fixed"></span>
                    Applied Fixes
                </div>
                
                <div class="test-description issue-fixed">
                    <strong>1. src/project-manager.html - saveCurrentProject() 智能路径推算</strong>
                    <div class="path-display">
// 修复前：硬编码 "Genome AI Studio Projects"
projectsDir = `${documentsPath}/Genome AI Studio Projects`;

// 修复后：优先使用项目实际路径
if (this.currentProject.dataFolderPath) {
    const parentDir = this.currentProject.dataFolderPath.substring(0, 
        this.currentProject.dataFolderPath.lastIndexOf('/'));
    this.currentProject.projectFilePath = `${parentDir}/${this.currentProject.name}.prj.GAI`;
}</div>
                </div>

                <div class="test-description issue-fixed">
                    <strong>2. src/main.js - copyFileToProject() 路径统一</strong>
                    <div class="path-display">
// 修复：统一使用 "GenomeExplorer Projects"
const projectsDir = path.join(documentsPath, 'GenomeExplorer Projects');</div>
                </div>

                <div class="test-description issue-fixed">
                    <strong>3. src/project-manager.html - 拖拽移动逻辑修复</strong>
                    <div class="path-display">
// 修复：拖拽移动也使用正确的目录名
projectBasePath = `${documentsPath}/GenomeExplorer Projects/${this.currentProject.name}`;</div>
                </div>
            </div>

            <!-- Expected Behavior -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-fixed"></span>
                    Expected Behavior After Fix
                </div>
                <div class="validation-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div>
                            <strong>项目加载：</strong> 从 <code>/Users/song/Documents/GenomeExplorer Projects/5555.prj.GAI</code> 加载
                            <div class="path-display">dataFolderPath = /Users/song/Documents/GenomeExplorer Projects/5555</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>
                            <strong>文件扫描：</strong> 从 <code>dataFolderPath</code> 扫描新文件
                            <div class="path-display">🔍 Scanning: /Users/song/Documents/GenomeExplorer Projects/5555</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>
                            <strong>智能路径推算：</strong> 基于 <code>dataFolderPath</code> 计算保存路径
                            <div class="path-display">parentDir = /Users/song/Documents/GenomeExplorer Projects
projectFilePath = /Users/song/Documents/GenomeExplorer Projects/5555.prj.GAI</div>
                        </div>
                    </div>
                    
                    <div class="step">
                        <div class="step-number">4</div>
                        <div>
                            <strong>一致性保存：</strong> XML文件保存到与数据相同的目录
                            <div class="path-display">✅ 保存位置与扫描位置完全一致！</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Testing Instructions -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-fixed"></span>
                    Testing Instructions
                </div>
                <div class="test-description">
                    <strong>按以下步骤验证修复：</strong>
                    <ol>
                        <li>打开Project Manager并加载现有项目（如"5555"）</li>
                        <li>点击 🔄 刷新按钮，观察控制台输出</li>
                        <li>检查扫描路径和保存路径是否一致</li>
                        <li>验证新文件能正确保存到.prj.GAI文件</li>
                        <li>确认保存按钮从红色恢复正常状态</li>
                    </ol>
                </div>
            </div>

            <!-- Console Messages to Look For -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-fixed"></span>
                    Expected Console Messages
                </div>
                <div class="test-description">
                    <strong>成功修复后应看到：</strong>
                    <div class="path-display">
🔍 Scanning project folder: /Users/song/Documents/GenomeExplorer Projects/5555
📁 Generated project file path from dataFolderPath: /Users/song/Documents/GenomeExplorer Projects/5555.prj.GAI
✅ Project saved to: /Users/song/Documents/GenomeExplorer Projects/5555.prj.GAI
💾 Project marked as saved</div>
                    
                    <strong>不应再看到：</strong>
                    <div class="path-display" style="color: #e53e3e;">
❌ 扫描路径：/Users/song/Documents/GenomeExplorer Projects/5555
❌ 保存路径：/Users/song/Documents/Genome AI Studio Projects/5555.prj.GAI</div>
                </div>
            </div>

            <!-- Summary -->
            <div class="test-section">
                <div class="test-title">
                    <span class="status-indicator status-fixed"></span>
                    Fix Summary
                </div>
                <div class="test-description issue-fixed">
                    <strong>✅ 已解决的问题：</strong>
                    <ul>
                        <li>统一了项目目录命名：全部使用 "GenomeExplorer Projects"</li>
                        <li>智能路径推算：优先使用项目实际位置而非硬编码路径</li>
                        <li>保存逻辑修复：确保XML文件保存到正确的项目目录</li>
                        <li>路径一致性：扫描路径与保存路径完全匹配</li>
                        <li>向后兼容：仍支持已有的项目结构</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🧪 Project Path Consistency Fix Test Page Loaded');
        console.log('📋 请在Project Manager中测试refresh/save功能');
        console.log('🔍 观察控制台输出中的路径是否一致');
        
        // 显示当前预期的修复状态
        const fixes = [
            'src/project-manager.html: saveCurrentProject() 智能路径推算',
            'src/main.js: copyFileToProject() 路径统一',
            'src/project-manager.html: 拖拽移动逻辑修复',
            'src/project-manager.html: getProjectRelativePath() 兼容性修复'
        ];
        
        console.log('✅ Applied Fixes:');
        fixes.forEach((fix, index) => {
            console.log(`   ${index + 1}. ${fix}`);
        });
        
        console.log('\n🎯 Expected Result: 项目扫描路径与保存路径完全一致！');
    </script>
</body>
</html> 