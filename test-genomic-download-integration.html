<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基因组下载与项目集成测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .test-section h2 {
            color: #34495e;
            margin-top: 0;
        }
        
        .button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }
        
        .button.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.info {
            background: #cce7ff;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 15px;
        }
        
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .workflow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .workflow-step {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .workflow-step h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .workflow-step .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬📁 基因组下载与项目集成测试</h1>
        
        <div class="info-box">
            <h3>🔍 测试目标</h3>
            <p>验证基因组数据下载功能与项目管理系统的完整集成，确保下载的文件正确保存到项目文件夹中。</p>
        </div>
        
        <div class="workflow">
            <div class="workflow-step">
                <div class="step-number">1</div>
                <h4>项目检查</h4>
                <p>验证是否需要先创建或打开项目</p>
            </div>
            <div class="workflow-step">
                <div class="step-number">2</div>
                <h4>菜单访问</h4>
                <p>通过File菜单访问下载功能</p>
            </div>
            <div class="workflow-step">
                <div class="step-number">3</div>
                <h4>项目集成</h4>
                <p>验证项目信息显示和路径设置</p>
            </div>
            <div class="workflow-step">
                <div class="step-number">4</div>
                <h4>数据下载</h4>
                <p>执行实际的数据下载测试</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>🗂️ 项目状态检查</h2>
            <p>首先检查当前是否有活动项目，以及项目集成功能是否正常工作。</p>
            <button class="button" onclick="checkProjectStatus()">检查项目状态</button>
            <button class="button warning" onclick="testWithoutProject()">测试无项目状态</button>
            <div id="projectStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>📋 菜单功能测试</h2>
            <p>测试从File菜单访问各种基因组数据库的功能。</p>
            <div class="status info">
                <strong>测试步骤：</strong><br>
                1. 打开 File → Download Genomic Data<br>
                2. 选择任意数据库类型<br>
                3. 验证是否正确显示项目要求对话框<br>
                4. 验证项目选择后是否正确打开下载界面
            </div>
            <button class="button success" onclick="testMenuAccess('ncbi-genbank')">测试 NCBI GenBank</button>
            <button class="button success" onclick="testMenuAccess('embl-sequences')">测试 EMBL Sequences</button>
            <button class="button success" onclick="testMenuAccess('uniprot-proteins')">测试 UniProt</button>
        </div>
        
        <div class="test-section">
            <h2>🔗 项目集成功能</h2>
            <p>测试下载功能与项目系统的集成，包括路径设置和文件组织。</p>
            <button class="button" onclick="testProjectIntegration()">测试项目信息集成</button>
            <button class="button" onclick="testDownloadPath()">测试下载路径设置</button>
            <div id="integrationStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>📥 下载功能测试</h2>
            <p>测试实际的文件下载功能，验证文件是否正确保存到项目目录中。</p>
            <button class="button success" onclick="testDownloadToProject()">测试下载到项目</button>
            <button class="button" onclick="checkDownloadedFiles()">检查已下载文件</button>
            <div id="downloadStatus"></div>
        </div>
        
        <div class="test-section">
            <h2>🔧 API连接测试</h2>
            <p>验证与各个公共数据库的API连接状态。</p>
            <button class="button" onclick="testAllAPIs()">测试所有API连接</button>
            <div id="apiStatus"></div>
        </div>
        
        <div class="log" id="testLog">测试日志将在这里显示...</div>
    </div>

    <script>
        let logElement = document.getElementById('testLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }
        
        async function checkProjectStatus() {
            log('🔍 检查当前项目状态...');
            
            if (window.electronAPI && window.electronAPI.getCurrentProject) {
                try {
                    const project = await window.electronAPI.getCurrentProject();
                    if (project) {
                        log(`✅ 找到活动项目: ${project.name}`);
                        log(`📁 项目位置: ${project.location || 'Not set'}`);
                        log(`💾 数据文件夹: ${project.dataFolderPath || 'Not set'}`);
                        showStatus('projectStatus', 
                            `活动项目：${project.name}<br>数据文件夹：${project.dataFolderPath}`, 
                            'success');
                    } else {
                        log('⚠️ 未找到活动项目');
                        showStatus('projectStatus', '未找到活动项目。请先创建或打开一个项目。', 'warning');
                    }
                } catch (error) {
                    log(`❌ 检查项目状态时出错: ${error.message}`);
                    showStatus('projectStatus', `错误：${error.message}`, 'error');
                }
            } else {
                log('❌ electronAPI不可用');
                showStatus('projectStatus', 'electronAPI不可用，需要在Electron环境中运行', 'error');
            }
        }
        
        function testWithoutProject() {
            log('🧪 测试无项目状态下的行为...');
            log('📝 预期行为：');
            log('   1. 点击File → Download Genomic Data → 任意数据库');
            log('   2. 应该显示"Project Required"对话框');
            log('   3. 提供创建新项目或打开现有项目的选项');
            log('   4. 取消操作应该不打开下载窗口');
            showStatus('projectStatus', '请手动测试：尝试在没有项目时访问下载功能', 'info');
        }
        
        function testMenuAccess(downloadType) {
            log(`🔍 测试菜单访问: ${downloadType}`);
            log(`📝 操作步骤：`);
            log(`   1. 打开 File → Download Genomic Data`);
            log(`   2. 选择 ${downloadType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}`);
            log(`   3. 验证项目检查和窗口打开`);
            log(`🎯 预期结果：`);
            log(`   - 如果有项目：直接打开下载窗口`);
            log(`   - 如果无项目：显示项目要求对话框`);
        }
        
        async function testProjectIntegration() {
            log('🔗 测试项目集成功能...');
            
            try {
                const project = await window.electronAPI.getCurrentProject();
                if (project) {
                    log(`✅ 项目集成测试:`);
                    log(`   - 项目名称: ${project.name}`);
                    log(`   - 数据路径: ${project.dataFolderPath}`);
                    log(`   - 预期基因组目录: ${project.dataFolderPath}/genomes`);
                    
                    showStatus('integrationStatus', 
                        `项目集成正常<br>基因组文件将保存到：${project.dataFolderPath}/genomes`, 
                        'success');
                } else {
                    log('⚠️ 无活动项目，无法测试集成功能');
                    showStatus('integrationStatus', '需要先打开一个项目才能测试集成功能', 'warning');
                }
            } catch (error) {
                log(`❌ 项目集成测试失败: ${error.message}`);
                showStatus('integrationStatus', `集成测试失败：${error.message}`, 'error');
            }
        }
        
        function testDownloadPath() {
            log('📁 测试下载路径设置...');
            log('📝 测试步骤：');
            log('   1. 打开基因组下载窗口');
            log('   2. 检查输出目录是否自动设置为项目的genomes文件夹');
            log('   3. 验证项目信息是否在界面中正确显示');
            log('🎯 预期：输出目录 = [ProjectPath]/genomes');
        }
        
        async function testDownloadToProject() {
            log('📥 测试下载到项目功能...');
            
            try {
                const project = await window.electronAPI.getCurrentProject();
                if (!project) {
                    log('❌ 需要先打开一个项目');
                    showStatus('downloadStatus', '请先创建或打开一个项目', 'warning');
                    return;
                }
                
                // 测试下载一个小文件
                const testUrl = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=nucleotide&id=NC_000913&rettype=fasta&retmode=text&retstart=1&retend=100';
                const filename = 'test_download.fasta';
                
                log(`🔗 测试下载URL: ${testUrl}`);
                log(`📁 目标项目: ${project.name}`);
                log(`💾 预期保存路径: ${project.dataFolderPath}/genomes/${filename}`);
                
                const result = await window.electronAPI.downloadFile(testUrl, filename, project);
                
                if (result.success) {
                    log(`✅ 下载成功: ${result.filePath}`);
                    showStatus('downloadStatus', 
                        `下载成功！<br>文件保存到：${result.filePath}`, 
                        'success');
                } else {
                    log(`❌ 下载失败: ${result.error}`);
                    showStatus('downloadStatus', `下载失败：${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`❌ 下载测试出错: ${error.message}`);
                showStatus('downloadStatus', `下载测试失败：${error.message}`, 'error');
            }
        }
        
        function checkDownloadedFiles() {
            log('📋 检查已下载文件...');
            log('📝 手动检查步骤：');
            log('   1. 打开项目文件夹');
            log('   2. 导航到 genomes 子文件夹');
            log('   3. 验证下载的文件是否存在');
            log('   4. 检查文件内容是否正确');
            showStatus('downloadStatus', '请手动检查项目的genomes文件夹中的下载文件', 'info');
        }
        
        async function testAllAPIs() {
            log('📡 测试所有API连接...');
            
            const apis = [
                { name: 'NCBI', url: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=nucleotide&term=test&retmax=1&retmode=json' },
                { name: 'EMBL-EBI', url: 'https://www.ebi.ac.uk/ena/portal/api/search?result=sequence&query=test&format=json&limit=1' },
                { name: 'Ensembl', url: 'https://rest.ensembl.org/info/ping?content-type=application/json' },
                { name: 'UniProt', url: 'https://rest.uniprot.org/uniprotkb/search?query=test&format=json&size=1' }
            ];
            
            let results = [];
            
            for (const api of apis) {
                try {
                    log(`🔗 测试 ${api.name} API...`);
                    const response = await fetch(api.url);
                    if (response.ok) {
                        log(`✅ ${api.name} API 连接成功 (${response.status})`);
                        results.push(`${api.name}: ✅ 连接成功`);
                    } else {
                        log(`❌ ${api.name} API 连接失败 (${response.status})`);
                        results.push(`${api.name}: ❌ 连接失败 (${response.status})`);
                    }
                } catch (error) {
                    log(`❌ ${api.name} API 连接错误: ${error.message}`);
                    results.push(`${api.name}: ❌ 连接错误`);
                }
            }
            
            showStatus('apiStatus', results.join('<br>'), 
                results.every(r => r.includes('✅')) ? 'success' : 'warning');
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            log('🧬 基因组下载与项目集成测试页面已加载');
            log('');
            log('📋 测试清单：');
            log('   ✓ 项目状态检查');
            log('   ✓ 菜单访问测试');
            log('   ✓ 项目集成验证');
            log('   ✓ 下载功能测试');
            log('   ✓ API连接测试');
            log('');
            log('🎯 开始测试：点击上方按钮执行各项测试');
            log('');
            
            // 自动检查项目状态
            setTimeout(checkProjectStatus, 1000);
        });
    </script>
</body>
</html> 