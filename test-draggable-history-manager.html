<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Draggable History Manager - GenomeExplorer</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 8px;
        }
        
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .test-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #4a9eff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #357abd;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .test-log {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 16px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: #ccc;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #27ae60; }
        .status-error { background: #e74c3c; }
        .status-warning { background: #f39c12; }
        .status-info { background: #3498db; }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .mock-data-info {
            background: #333;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1><i class="fas fa-history"></i> Draggable History Manager Test</h1>
            <p>Testing the new draggable History Manager with conversation management features</p>
        </div>
        
        <div class="test-section">
            <h2>üéØ Test Features</h2>
            <ul class="feature-list">
                <li><span class="status-indicator status-info"></span> Draggable window interface</li>
                <li><span class="status-indicator status-info"></span> Conversation list with selection</li>
                <li><span class="status-indicator status-info"></span> Batch operations (delete, mark as success)</li>
                <li><span class="status-indicator status-info"></span> Individual conversation actions</li>
                <li><span class="status-indicator status-info"></span> Success example management</li>
                <li><span class="status-indicator status-info"></span> Search functionality</li>
                <li><span class="status-indicator status-info"></span> Detailed conversation view</li>
                <li><span class="status-indicator status-info"></span> ChatBox integration</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>üß™ Test Controls</h2>
            <div class="test-buttons">
                <button class="btn btn-primary" onclick="initializeMockData()">
                    <i class="fas fa-database"></i> Initialize Mock Data
                </button>
                <button class="btn btn-success" onclick="openHistoryManager()">
                    <i class="fas fa-history"></i> Open History Manager
                </button>
                <button class="btn btn-warning" onclick="testSuccessExamples()">
                    <i class="fas fa-star"></i> Test Success Examples
                </button>
                <button class="btn btn-danger" onclick="clearTestData()">
                    <i class="fas fa-trash"></i> Clear Test Data
                </button>
            </div>
            
            <div class="mock-data-info" id="mockDataInfo">
                <h4>Mock Data Status</h4>
                <p>No mock data loaded. Click "Initialize Mock Data" to create test conversations.</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìù Test Log</h2>
            <div class="test-log" id="testLog">
Draggable History Manager Test initialized.
Ready to test features...

</div>
        </div>
    </div>

    <!-- Load required modules -->
    <script src="src/renderer/modules/ConfigManager.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionStorageManager.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionManager.js"></script>
    
    <script>
        // Global variables for testing
        let mockEvolutionManager = null;
        let mockConfigManager = null;
        let testLog = document.getElementById('testLog');
        
        // Initialize test environment
        async function initializeTestEnvironment() {
            log('üöÄ Initializing test environment...');
            
            try {
                // Create mock config manager
                mockConfigManager = new ConfigManager();
                await mockConfigManager.waitForInitialization();
                
                // Create mock evolution manager
                mockEvolutionManager = new ConversationEvolutionManager(null, mockConfigManager, null);
                
                // Make globally available for History Manager
                window.evolutionManager = mockEvolutionManager;
                window.configManager = mockConfigManager;
                
                log('‚úÖ Test environment initialized successfully');
                return true;
            } catch (error) {
                log('‚ùå Failed to initialize test environment: ' + error.message);
                return false;
            }
        }
        
        // Initialize mock conversation data
        async function initializeMockData() {
            log('üìä Creating mock conversation data...');
            
            if (!mockEvolutionManager) {
                const success = await initializeTestEnvironment();
                if (!success) return;
            }
            
            // Create sample conversations
            const mockConversations = [
                {
                    id: 'conv_001_' + Date.now(),
                    startTime: new Date(Date.now() - 86400000).toISOString(),
                    endTime: new Date(Date.now() - 86300000).toISOString(),
                    duration: '1m 40s',
                    source: 'test_chatbox',
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 86400000).toISOString(),
                            sender: 'user',
                            content: 'How do I analyze genomic data with GenomeExplorer?'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 86390000).toISOString(),
                            sender: 'assistant',
                            content: 'GenomeExplorer provides several tools for genomic analysis. You can start by loading your data files through the File menu, then use the visualization tools to explore your genome sequences.'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 86380000).toISOString(),
                            sender: 'user',
                            content: 'Can you show me how to use the BLAST tool?'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 86370000).toISOString(),
                            sender: 'assistant',
                            content: 'Certainly! You can access BLAST through Tools ‚Üí BLAST Search. Upload your query sequence, select the appropriate database, and configure the search parameters for optimal results.'
                        }
                    ],
                    stats: {
                        messageCount: 4,
                        successCount: 2,
                        errorCount: 0,
                        toolCallCount: 1
                    },
                    metadata: {
                        category: 'tool-intensive',
                        isSuccessExample: true,
                        markedAsExampleAt: new Date().toISOString()
                    }
                },
                {
                    id: 'conv_002_' + Date.now(),
                    startTime: new Date(Date.now() - 43200000).toISOString(),
                    endTime: new Date(Date.now() - 43100000).toISOString(),
                    duration: '2m 15s',
                    source: 'test_chatbox',
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 43200000).toISOString(),
                            sender: 'user',
                            content: 'I need help with protein structure analysis'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 43190000).toISOString(),
                            sender: 'assistant',
                            content: 'For protein structure analysis, you can use the Protein Structure Viewer in GenomeExplorer. It supports PDB files and provides 3D visualization capabilities.'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 43180000).toISOString(),
                            sender: 'user',
                            content: 'The viewer is not loading my PDB file correctly'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 43170000).toISOString(),
                            sender: 'assistant',
                            content: 'This seems to be a known issue. Let me help you troubleshoot the PDB file loading problem.'
                        }
                    ],
                    stats: {
                        messageCount: 4,
                        successCount: 1,
                        errorCount: 1,
                        toolCallCount: 0
                    },
                    metadata: {
                        category: 'problematic',
                        isSuccessExample: false
                    }
                },
                {
                    id: 'conv_003_' + Date.now(),
                    startTime: new Date(Date.now() - 7200000).toISOString(),
                    endTime: new Date(Date.now() - 7100000).toISOString(),
                    duration: '3m 30s',
                    source: 'test_chatbox',
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 7200000).toISOString(),
                            sender: 'user',
                            content: 'Can you explain how to use the phylogenetic tree builder?'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 7190000).toISOString(),
                            sender: 'assistant',
                            content: 'The phylogenetic tree builder is available under Tools ‚Üí Phylogenetic Analysis. You can input multiple sequences in FASTA format and choose from various tree construction methods like neighbor-joining or maximum likelihood.'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 7180000).toISOString(),
                            sender: 'user',
                            content: 'Perfect! That worked exactly as expected. Thank you!'
                        }
                    ],
                    stats: {
                        messageCount: 3,
                        successCount: 3,
                        errorCount: 0,
                        toolCallCount: 1
                    },
                    metadata: {
                        category: 'standard',
                        isSuccessExample: true,
                        markedAsExampleAt: new Date().toISOString()
                    }
                },
                {
                    id: 'conv_004_' + Date.now(),
                    startTime: new Date(Date.now() - 1800000).toISOString(),
                    endTime: new Date(Date.now() - 1700000).toISOString(),
                    duration: '5m 45s',
                    source: 'test_chatbox',
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 1800000).toISOString(),
                            sender: 'user',
                            content: 'I want to create a custom plugin for sequence analysis'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 1790000).toISOString(),
                            sender: 'assistant',
                            content: 'Great! GenomeExplorer has a plugin system. You can create custom plugins by following the plugin development guide in the documentation.'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 1780000).toISOString(),
                            sender: 'user',
                            content: 'Where can I find the plugin templates and examples?'
                        },
                        {
                            type: 'message',
                            timestamp: new Date(Date.now() - 1770000).toISOString(),
                            sender: 'assistant',
                            content: 'Plugin templates are available in the src/renderer/modules/Plugins/ directory. You can also use the Plugin Generator tool to create a basic plugin structure automatically.'
                        }
                    ],
                    stats: {
                        messageCount: 4,
                        successCount: 4,
                        errorCount: 0,
                        toolCallCount: 2
                    },
                    metadata: {
                        category: 'plugin-generation',
                        isSuccessExample: false
                    }
                }
            ];
            
            // Add conversations to storage
            if (mockEvolutionManager.storageManager) {
                mockEvolutionManager.storageManager.historyData.conversations = mockConversations;
                mockEvolutionManager.storageManager.updateStorageStats();
                await mockEvolutionManager.storageManager.saveHistoryData();
                
                log(`‚úÖ Created ${mockConversations.length} mock conversations`);
                log(`üìä ${mockConversations.filter(c => c.metadata.isSuccessExample).length} marked as success examples`);
                
                // Update mock data info
                updateMockDataInfo(mockConversations);
            } else {
                log('‚ùå Storage manager not available');
            }
        }
        
        // Update mock data information display
        function updateMockDataInfo(conversations) {
            const info = document.getElementById('mockDataInfo');
            const successExamples = conversations.filter(c => c.metadata.isSuccessExample).length;
            const categories = [...new Set(conversations.map(c => c.metadata.category))];
            
            info.innerHTML = `
                <h4>Mock Data Status</h4>
                <p><strong>Total Conversations:</strong> ${conversations.length}</p>
                <p><strong>Success Examples:</strong> ${successExamples}</p>
                <p><strong>Categories:</strong> ${categories.join(', ')}</p>
                <p><strong>Last Updated:</strong> ${new Date().toLocaleString()}</p>
            `;
        }
        
        // Open History Manager (load from conversation-evolution.html)
        async function openHistoryManager() {
            log('ü™ü Opening History Manager window...');
            
            if (!mockEvolutionManager) {
                log('‚ö†Ô∏è Mock data not initialized. Initializing now...');
                await initializeMockData();
            }
            
            try {
                // Load the History Manager functions from the main file
                const response = await fetch('src/conversation-evolution.html');
                const htmlContent = await response.text();
                
                // Extract the JavaScript functions we need
                const scriptMatch = htmlContent.match(/<script>([\s\S]*)<\/script>/);
                if (scriptMatch) {
                    const scriptContent = scriptMatch[1];
                    
                    // Extract specific functions we need
                    const functionsToExtract = [
                        'createDraggableHistoryManager',
                        'renderConversationList',
                        'makeDraggable',
                        'closeHistoryWindow',
                        'minimizeHistoryWindow',
                        'selectAllConversations',
                        'deselectAllConversations',
                        'updateSelectionCount',
                        'deleteSelectedConversations',
                        'markAsSuccessExample',
                        'toggleSuccessExample',
                        'deleteConversation',
                        'editConversation',
                        'duplicateConversation',
                        'expandConversation',
                        'searchHistoryConversations',
                        'refreshHistoryManager',
                        'updateSuccessExamplesCount',
                        'viewSuccessExamples',
                        'updateChatBoxWithSuccessExamples',
                        'addHistoryManagerStyles',
                        'viewConversationDetails'
                    ];
                    
                    // Execute the functions in our context
                    eval(scriptContent);
                    
                    // Now call the History Manager
                    createDraggableHistoryManager();
                    
                    log('‚úÖ History Manager window opened successfully');
                } else {
                    throw new Error('Could not extract JavaScript from conversation-evolution.html');
                }
            } catch (error) {
                log('‚ùå Failed to open History Manager: ' + error.message);
                console.error(error);
            }
        }
        
        // Test success examples functionality
        function testSuccessExamples() {
            log('‚≠ê Testing success examples functionality...');
            
            if (!mockEvolutionManager || !mockEvolutionManager.storageManager) {
                log('‚ùå Evolution manager not available');
                return;
            }
            
            const conversations = mockEvolutionManager.storageManager.historyData.conversations;
            const successExamples = conversations.filter(c => c.metadata.isSuccessExample);
            
            log(`üìä Found ${successExamples.length} success examples:`);
            successExamples.forEach((conv, index) => {
                log(`  ${index + 1}. ${conv.id} (${conv.metadata.category})`);
            });
            
            // Test ChatBox integration
            if (mockConfigManager) {
                const currentPrompt = mockConfigManager.get('chatbox.systemPrompt', '');
                log(`üí¨ Current ChatBox prompt length: ${currentPrompt.length} characters`);
                
                // Simulate updating ChatBox with examples
                const examplePrompts = successExamples.map((conv, index) => {
                    const messages = conv.events.filter(event => 
                        event.type === 'message' && event.content
                    );
                    
                    const formattedMessages = messages.slice(0, 2).map(msg => 
                        `${msg.sender}: ${msg.content.substring(0, 100)}...`
                    ).join('\n');
                    
                    return `Example ${index + 1}:\n${formattedMessages}`;
                }).join('\n---\n');
                
                const newPrompt = currentPrompt + `\n\n## Success Examples:\n${examplePrompts}`;
                mockConfigManager.set('chatbox.systemPrompt', newPrompt);
                
                log(`‚úÖ Updated ChatBox prompt with ${successExamples.length} examples`);
                log(`üìù New prompt length: ${newPrompt.length} characters`);
            }
        }
        
        // Clear test data
        async function clearTestData() {
            log('üóëÔ∏è Clearing test data...');
            
            if (mockEvolutionManager && mockEvolutionManager.storageManager) {
                mockEvolutionManager.storageManager.historyData.conversations = [];
                mockEvolutionManager.storageManager.historyData.analysisRecords = [];
                mockEvolutionManager.storageManager.historyData.pluginGenerationHistory = [];
                mockEvolutionManager.storageManager.updateStorageStats();
                await mockEvolutionManager.storageManager.saveHistoryData();
                
                log('‚úÖ Test data cleared');
                
                // Update mock data info
                document.getElementById('mockDataInfo').innerHTML = `
                    <h4>Mock Data Status</h4>
                    <p>No mock data loaded. Click "Initialize Mock Data" to create test conversations.</p>
                `;
                
                // Close any open History Manager windows
                const existingWindow = document.getElementById('historyManagerWindow');
                if (existingWindow) {
                    existingWindow.remove();
                    log('ü™ü Closed History Manager window');
                }
            }
            
            // Clear ChatBox prompt
            if (mockConfigManager) {
                mockConfigManager.set('chatbox.systemPrompt', '');
                log('üí¨ Cleared ChatBox prompt');
            }
        }
        
        // Logging function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.textContent += `[${timestamp}] ${message}\n`;
            testLog.scrollTop = testLog.scrollHeight;
            console.log(message);
        }
        
        // Initialize test environment on load
        document.addEventListener('DOMContentLoaded', async () => {
            log('üß™ Draggable History Manager Test Page Loaded');
            log('üìã Ready to test features. Start by clicking "Initialize Mock Data"');
        });
    </script>
</body>
</html> 