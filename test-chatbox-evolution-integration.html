<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox Evolution Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .data-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧬 ChatBox Evolution Integration Test</h1>
        <p>这个测试页面验证ChatBox与Conversation Evolution System的数据集成功能</p>

        <!-- 系统状态检查 -->
        <div class="test-section">
            <h3>1. 系统组件状态检查</h3>
            <button onclick="checkSystemComponents()">检查系统组件</button>
            <div id="systemStatus"></div>
        </div>

        <!-- ChatBox集成测试 -->
        <div class="test-section">
            <h3>2. ChatBox集成测试</h3>
            <button onclick="testChatBoxIntegration()">测试ChatBox集成</button>
            <div id="chatboxStatus"></div>
        </div>

        <!-- Evolution数据流测试 -->
        <div class="test-section">
            <h3>3. Evolution数据流测试</h3>
            <button onclick="testEvolutionDataFlow()">测试数据流</button>
            <div id="dataFlowStatus"></div>
        </div>

        <!-- 对话模拟测试 -->
        <div class="test-section">
            <h3>4. 对话模拟测试</h3>
            <button onclick="simulateConversation()">模拟对话</button>
            <div id="conversationStatus"></div>
        </div>

        <!-- 实时统计 -->
        <div class="test-section">
            <h3>5. 实时统计</h3>
            <div class="metrics" id="metricsDisplay"></div>
            <button onclick="updateMetrics()">更新统计</button>
        </div>

        <!-- 数据查看 -->
        <div class="test-section">
            <h3>6. 数据查看</h3>
            <button onclick="viewEvolutionData()">查看Evolution数据</button>
            <button onclick="viewChatBoxData()">查看ChatBox数据</button>
            <div class="data-display" id="dataDisplay"></div>
        </div>
    </div>

    <!-- Load required modules -->
    <script src="src/renderer/modules/ConfigManager.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionStorageManager.js"></script>
    <script src="src/renderer/modules/ConversationAnalysisEngine.js"></script>
    <script src="src/renderer/modules/AutoPluginGenerator.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionManager.js"></script>
    <script src="src/renderer/modules/LLMConfigManager.js"></script>
    <script src="src/renderer/modules/ChatManager.js"></script>

    <script>
        let configManager;
        let evolutionManager;
        let chatManager;
        let testResults = {};

        // 初始化系统
        async function initializeSystem() {
            try {
                console.log('Initializing test system...');
                
                // 初始化ConfigManager
                configManager = new ConfigManager();
                await configManager.waitForInitialization();

                // 创建模拟app对象
                const mockApp = {
                    currentChromosome: 'test_chr',
                    currentPosition: { start: 1000, end: 2000 },
                    getCurrentState: () => ({
                        chromosome: 'test_chr',
                        position: { start: 1000, end: 2000 },
                        loadedFiles: ['test.gb'],
                        tracks: ['genes', 'cds']
                    })
                };

                // 初始化ChatManager (模拟模式)
                chatManager = new ChatManager(mockApp, configManager);
                window.chatManager = chatManager;

                // 初始化EvolutionManager
                evolutionManager = new ConversationEvolutionManager(mockApp, configManager, chatManager);
                window.evolutionManager = evolutionManager;

                // 等待系统初始化完成
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Test system initialized successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize test system:', error);
                return false;
            }
        }

        // 检查系统组件
        async function checkSystemComponents() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">正在检查系统组件...</div>';

            const components = {
                'ConfigManager': !!configManager,
                'ChatManager': !!chatManager,
                'EvolutionManager': !!evolutionManager,
                'Evolution Storage': !!(evolutionManager?.storageManager),
                'ChatBox Integration': !!(chatManager?.evolutionManager)
            };

            let html = '';
            let allPassed = true;

            for (const [name, status] of Object.entries(components)) {
                const statusClass = status ? 'success' : 'error';
                const statusText = status ? '✅ 正常' : '❌ 未找到';
                html += `<div class="status ${statusClass}">${name}: ${statusText}</div>`;
                if (!status) allPassed = false;
            }

            testResults.systemComponents = allPassed;
            statusDiv.innerHTML = html;
        }

        // 测试ChatBox集成
        async function testChatBoxIntegration() {
            const statusDiv = document.getElementById('chatboxStatus');
            statusDiv.innerHTML = '<div class="status info">正在测试ChatBox集成...</div>';

            let html = '';
            let allPassed = true;

            try {
                // 测试1: 检查Evolution集成方法是否存在
                const hasEvolutionMethods = !!(
                    chatManager.addToEvolutionData &&
                    chatManager.resetCurrentConversationData &&
                    chatManager.syncCurrentConversationToEvolution
                );
                
                html += `<div class="status ${hasEvolutionMethods ? 'success' : 'error'}">
                    Evolution集成方法: ${hasEvolutionMethods ? '✅ 存在' : '❌ 缺失'}
                </div>`;

                // 测试2: 检查当前对话数据结构
                const hasConversationData = !!(chatManager.currentConversationData);
                html += `<div class="status ${hasConversationData ? 'success' : 'error'}">
                    对话数据结构: ${hasConversationData ? '✅ 已初始化' : '❌ 未初始化'}
                </div>`;

                // 测试3: 检查Evolution Manager连接
                const isConnected = !!(chatManager.evolutionManager);
                html += `<div class="status ${isConnected ? 'success' : 'error'}">
                    Evolution Manager连接: ${isConnected ? '✅ 已连接' : '❌ 未连接'}
                </div>`;

                // 测试4: 测试Evolution数据测试
                const testResult = chatManager.testEvolutionIntegration();
                html += `<div class="status success">Evolution集成测试: ✅ 完成</div>`;
                html += `<div class="data-display">${JSON.stringify(testResult, null, 2)}</div>`;

                allPassed = hasEvolutionMethods && hasConversationData && isConnected;

            } catch (error) {
                html += `<div class="status error">测试失败: ${error.message}</div>`;
                allPassed = false;
            }

            testResults.chatboxIntegration = allPassed;
            statusDiv.innerHTML = html;
        }

        // 测试Evolution数据流
        async function testEvolutionDataFlow() {
            const statusDiv = document.getElementById('dataFlowStatus');
            statusDiv.innerHTML = '<div class="status info">正在测试数据流...</div>';

            let html = '';
            let allPassed = true;

            try {
                // 测试1: 检查Evolution Manager的数据接收方法
                const hasDataMethods = !!(
                    evolutionManager.addConversationData &&
                    evolutionManager.processConversationForAnalysis &&
                    evolutionManager.extractAnalysisPatterns
                );
                
                html += `<div class="status ${hasDataMethods ? 'success' : 'error'}">
                    数据接收方法: ${hasDataMethods ? '✅ 存在' : '❌ 缺失'}
                </div>`;

                // 测试2: 检查存储管理器的方法
                const hasStorageMethods = !!(
                    evolutionManager.storageManager?.addConversationRecord &&
                    evolutionManager.storageManager?.addAnalysisRecord
                );
                
                html += `<div class="status ${hasStorageMethods ? 'success' : 'error'}">
                    存储方法: ${hasStorageMethods ? '✅ 存在' : '❌ 缺失'}
                </div>`;

                // 测试3: 测试实际数据流
                const testData = {
                    id: 'test_conversation_' + Date.now(),
                    startTime: new Date().toISOString(),
                    endTime: null,
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date().toISOString(),
                            sender: 'user',
                            content: 'Test message for data flow',
                            isError: false
                        }
                    ],
                    stats: { messageCount: 1, userMessageCount: 1 },
                    metadata: { source: 'test' }
                };

                evolutionManager.addConversationData(testData);
                html += `<div class="status success">数据流测试: ✅ 完成</div>`;

                allPassed = hasDataMethods && hasStorageMethods;

            } catch (error) {
                html += `<div class="status error">数据流测试失败: ${error.message}</div>`;
                allPassed = false;
            }

            testResults.dataFlow = allPassed;
            statusDiv.innerHTML = html;
        }

        // 模拟对话
        async function simulateConversation() {
            const statusDiv = document.getElementById('conversationStatus');
            statusDiv.innerHTML = '<div class="status info">正在模拟对话...</div>';

            let html = '';

            try {
                // 开始新对话
                chatManager.startNewConversationForEvolution();
                html += `<div class="status success">✅ 开始新对话</div>`;

                // 模拟用户消息
                chatManager.addMessageToChat('Hello, can you help me analyze a gene?', 'user');
                html += `<div class="status success">✅ 添加用户消息</div>`;

                // 模拟AI思考过程
                chatManager.addThinkingMessage('Analyzing user request for gene analysis...');
                html += `<div class="status success">✅ 添加思考过程</div>`;

                // 模拟工具调用
                const mockTools = [
                    { tool_name: 'search_gene', parameters: { query: 'test_gene' } }
                ];
                chatManager.addToolCallMessage(mockTools);
                html += `<div class="status success">✅ 添加工具调用</div>`;

                // 模拟工具结果
                const mockResults = [
                    { tool: 'search_gene', success: true, result: 'Gene found' }
                ];
                chatManager.addToolResultMessage(mockResults);
                html += `<div class="status success">✅ 添加工具结果</div>`;

                // 模拟AI回复
                chatManager.addMessageToChat('I found the gene you requested. Here are the details...', 'assistant');
                html += `<div class="status success">✅ 添加AI回复</div>`;

                // 获取对话总结
                const summary = chatManager.getEvolutionDataSummary();
                html += `<div class="data-display">${JSON.stringify(summary, null, 2)}</div>`;

            } catch (error) {
                html += `<div class="status error">对话模拟失败: ${error.message}</div>`;
            }

            statusDiv.innerHTML = html;
        }

        // 更新统计
        function updateMetrics() {
            const metricsDiv = document.getElementById('metricsDisplay');

            try {
                const chatBoxSummary = chatManager.getEvolutionDataSummary();
                const storageStats = evolutionManager.storageManager?.getStorageInfo();

                const metrics = [
                    {
                        label: '当前对话事件',
                        value: chatBoxSummary.eventCount || 0
                    },
                    {
                        label: '消息数量',
                        value: chatBoxSummary.statistics?.messageCount || 0
                    },
                    {
                        label: '思考过程',
                        value: chatBoxSummary.statistics?.thinkingProcessCount || 0
                    },
                    {
                        label: '工具调用',
                        value: chatBoxSummary.statistics?.toolCallCount || 0
                    },
                    {
                        label: '存储的对话',
                        value: storageStats?.totalConversations || 0
                    },
                    {
                        label: 'Evolution连接',
                        value: chatBoxSummary.evolutionManagerConnected ? 1 : 0
                    }
                ];

                let html = '';
                metrics.forEach(metric => {
                    html += `
                        <div class="metric-card">
                            <div class="metric-value">${metric.value}</div>
                            <div class="metric-label">${metric.label}</div>
                        </div>
                    `;
                });

                metricsDiv.innerHTML = html;

            } catch (error) {
                metricsDiv.innerHTML = `<div class="status error">统计更新失败: ${error.message}</div>`;
            }
        }

        // 查看Evolution数据
        function viewEvolutionData() {
            const dataDiv = document.getElementById('dataDisplay');
            
            try {
                const storageData = evolutionManager.storageManager?.historyData;
                dataDiv.textContent = JSON.stringify(storageData, null, 2);
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
            }
        }

        // 查看ChatBox数据
        function viewChatBoxData() {
            const dataDiv = document.getElementById('dataDisplay');
            
            try {
                const chatBoxData = chatManager.currentConversationData;
                dataDiv.textContent = JSON.stringify(chatBoxData, null, 2);
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
            }
        }

        // 页面加载时初始化
        window.addEventListener('load', async () => {
            const success = await initializeSystem();
            if (success) {
                setTimeout(() => {
                    checkSystemComponents();
                    updateMetrics();
                }, 1000);
            } else {
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="status error">❌ 系统初始化失败</div>';
            }
        });

        // 定期更新统计
        setInterval(updateMetrics, 5000);
    </script>
</body>
</html> 