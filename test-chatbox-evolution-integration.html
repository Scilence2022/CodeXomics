<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox Evolution Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .data-display {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #4CAF50;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¬ ChatBox Evolution Integration Test</h1>
        <p>è¿™ä¸ªæµ‹è¯•é¡µé¢éªŒè¯ChatBoxä¸Conversation Evolution Systemçš„æ•°æ®é›†æˆåŠŸèƒ½</p>

        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h3>1. ç³»ç»Ÿç»„ä»¶çŠ¶æ€æ£€æŸ¥</h3>
            <button onclick="checkSystemComponents()">æ£€æŸ¥ç³»ç»Ÿç»„ä»¶</button>
            <div id="systemStatus"></div>
        </div>

        <!-- ChatBoxé›†æˆæµ‹è¯• -->
        <div class="test-section">
            <h3>2. ChatBoxé›†æˆæµ‹è¯•</h3>
            <button onclick="testChatBoxIntegration()">æµ‹è¯•ChatBoxé›†æˆ</button>
            <div id="chatboxStatus"></div>
        </div>

        <!-- Evolutionæ•°æ®æµæµ‹è¯• -->
        <div class="test-section">
            <h3>3. Evolutionæ•°æ®æµæµ‹è¯•</h3>
            <button onclick="testEvolutionDataFlow()">æµ‹è¯•æ•°æ®æµ</button>
            <div id="dataFlowStatus"></div>
        </div>

        <!-- å¯¹è¯æ¨¡æ‹Ÿæµ‹è¯• -->
        <div class="test-section">
            <h3>4. å¯¹è¯æ¨¡æ‹Ÿæµ‹è¯•</h3>
            <button onclick="simulateConversation()">æ¨¡æ‹Ÿå¯¹è¯</button>
            <div id="conversationStatus"></div>
        </div>

        <!-- å®æ—¶ç»Ÿè®¡ -->
        <div class="test-section">
            <h3>5. å®æ—¶ç»Ÿè®¡</h3>
            <div class="metrics" id="metricsDisplay"></div>
            <button onclick="updateMetrics()">æ›´æ–°ç»Ÿè®¡</button>
        </div>

        <!-- æ•°æ®æŸ¥çœ‹ -->
        <div class="test-section">
            <h3>6. æ•°æ®æŸ¥çœ‹</h3>
            <button onclick="viewEvolutionData()">æŸ¥çœ‹Evolutionæ•°æ®</button>
            <button onclick="viewChatBoxData()">æŸ¥çœ‹ChatBoxæ•°æ®</button>
            <div class="data-display" id="dataDisplay"></div>
        </div>
    </div>

    <!-- Load required modules -->
    <script src="src/renderer/modules/ConfigManager.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionStorageManager.js"></script>
    <script src="src/renderer/modules/ConversationAnalysisEngine.js"></script>
    <script src="src/renderer/modules/AutoPluginGenerator.js"></script>
    <script src="src/renderer/modules/ConversationEvolutionManager.js"></script>
    <script src="src/renderer/modules/LLMConfigManager.js"></script>
    <script src="src/renderer/modules/ChatManager.js"></script>

    <script>
        let configManager;
        let evolutionManager;
        let chatManager;
        let testResults = {};

        // åˆå§‹åŒ–ç³»ç»Ÿ
        async function initializeSystem() {
            try {
                console.log('Initializing test system...');
                
                // åˆå§‹åŒ–ConfigManager
                configManager = new ConfigManager();
                await configManager.waitForInitialization();

                // åˆ›å»ºæ¨¡æ‹Ÿappå¯¹è±¡
                const mockApp = {
                    currentChromosome: 'test_chr',
                    currentPosition: { start: 1000, end: 2000 },
                    getCurrentState: () => ({
                        chromosome: 'test_chr',
                        position: { start: 1000, end: 2000 },
                        loadedFiles: ['test.gb'],
                        tracks: ['genes', 'cds']
                    })
                };

                // åˆå§‹åŒ–ChatManager (æ¨¡æ‹Ÿæ¨¡å¼)
                chatManager = new ChatManager(mockApp, configManager);
                window.chatManager = chatManager;

                // åˆå§‹åŒ–EvolutionManager
                evolutionManager = new ConversationEvolutionManager(mockApp, configManager, chatManager);
                window.evolutionManager = evolutionManager;

                // ç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
                await new Promise(resolve => setTimeout(resolve, 2000));

                console.log('Test system initialized successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize test system:', error);
                return false;
            }
        }

        // æ£€æŸ¥ç³»ç»Ÿç»„ä»¶
        async function checkSystemComponents() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ£€æŸ¥ç³»ç»Ÿç»„ä»¶...</div>';

            const components = {
                'ConfigManager': !!configManager,
                'ChatManager': !!chatManager,
                'EvolutionManager': !!evolutionManager,
                'Evolution Storage': !!(evolutionManager?.storageManager),
                'ChatBox Integration': !!(chatManager?.evolutionManager)
            };

            let html = '';
            let allPassed = true;

            for (const [name, status] of Object.entries(components)) {
                const statusClass = status ? 'success' : 'error';
                const statusText = status ? 'âœ… æ­£å¸¸' : 'âŒ æœªæ‰¾åˆ°';
                html += `<div class="status ${statusClass}">${name}: ${statusText}</div>`;
                if (!status) allPassed = false;
            }

            testResults.systemComponents = allPassed;
            statusDiv.innerHTML = html;
        }

        // æµ‹è¯•ChatBoxé›†æˆ
        async function testChatBoxIntegration() {
            const statusDiv = document.getElementById('chatboxStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•ChatBoxé›†æˆ...</div>';

            let html = '';
            let allPassed = true;

            try {
                // æµ‹è¯•1: æ£€æŸ¥Evolutioné›†æˆæ–¹æ³•æ˜¯å¦å­˜åœ¨
                const hasEvolutionMethods = !!(
                    chatManager.addToEvolutionData &&
                    chatManager.resetCurrentConversationData &&
                    chatManager.syncCurrentConversationToEvolution
                );
                
                html += `<div class="status ${hasEvolutionMethods ? 'success' : 'error'}">
                    Evolutioné›†æˆæ–¹æ³•: ${hasEvolutionMethods ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}
                </div>`;

                // æµ‹è¯•2: æ£€æŸ¥å½“å‰å¯¹è¯æ•°æ®ç»“æ„
                const hasConversationData = !!(chatManager.currentConversationData);
                html += `<div class="status ${hasConversationData ? 'success' : 'error'}">
                    å¯¹è¯æ•°æ®ç»“æ„: ${hasConversationData ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}
                </div>`;

                // æµ‹è¯•3: æ£€æŸ¥Evolution Managerè¿æ¥
                const isConnected = !!(chatManager.evolutionManager);
                html += `<div class="status ${isConnected ? 'success' : 'error'}">
                    Evolution Managerè¿æ¥: ${isConnected ? 'âœ… å·²è¿æ¥' : 'âŒ æœªè¿æ¥'}
                </div>`;

                // æµ‹è¯•4: æµ‹è¯•Evolutionæ•°æ®æµ‹è¯•
                const testResult = chatManager.testEvolutionIntegration();
                html += `<div class="status success">Evolutioné›†æˆæµ‹è¯•: âœ… å®Œæˆ</div>`;
                html += `<div class="data-display">${JSON.stringify(testResult, null, 2)}</div>`;

                allPassed = hasEvolutionMethods && hasConversationData && isConnected;

            } catch (error) {
                html += `<div class="status error">æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                allPassed = false;
            }

            testResults.chatboxIntegration = allPassed;
            statusDiv.innerHTML = html;
        }

        // æµ‹è¯•Evolutionæ•°æ®æµ
        async function testEvolutionDataFlow() {
            const statusDiv = document.getElementById('dataFlowStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯•æ•°æ®æµ...</div>';

            let html = '';
            let allPassed = true;

            try {
                // æµ‹è¯•1: æ£€æŸ¥Evolution Managerçš„æ•°æ®æ¥æ”¶æ–¹æ³•
                const hasDataMethods = !!(
                    evolutionManager.addConversationData &&
                    evolutionManager.processConversationForAnalysis &&
                    evolutionManager.extractAnalysisPatterns
                );
                
                html += `<div class="status ${hasDataMethods ? 'success' : 'error'}">
                    æ•°æ®æ¥æ”¶æ–¹æ³•: ${hasDataMethods ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}
                </div>`;

                // æµ‹è¯•2: æ£€æŸ¥å­˜å‚¨ç®¡ç†å™¨çš„æ–¹æ³•
                const hasStorageMethods = !!(
                    evolutionManager.storageManager?.addConversationRecord &&
                    evolutionManager.storageManager?.addAnalysisRecord
                );
                
                html += `<div class="status ${hasStorageMethods ? 'success' : 'error'}">
                    å­˜å‚¨æ–¹æ³•: ${hasStorageMethods ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±'}
                </div>`;

                // æµ‹è¯•3: æµ‹è¯•å®é™…æ•°æ®æµ
                const testData = {
                    id: 'test_conversation_' + Date.now(),
                    startTime: new Date().toISOString(),
                    endTime: null,
                    events: [
                        {
                            type: 'message',
                            timestamp: new Date().toISOString(),
                            sender: 'user',
                            content: 'Test message for data flow',
                            isError: false
                        }
                    ],
                    stats: { messageCount: 1, userMessageCount: 1 },
                    metadata: { source: 'test' }
                };

                evolutionManager.addConversationData(testData);
                html += `<div class="status success">æ•°æ®æµæµ‹è¯•: âœ… å®Œæˆ</div>`;

                allPassed = hasDataMethods && hasStorageMethods;

            } catch (error) {
                html += `<div class="status error">æ•°æ®æµæµ‹è¯•å¤±è´¥: ${error.message}</div>`;
                allPassed = false;
            }

            testResults.dataFlow = allPassed;
            statusDiv.innerHTML = html;
        }

        // æ¨¡æ‹Ÿå¯¹è¯
        async function simulateConversation() {
            const statusDiv = document.getElementById('conversationStatus');
            statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æ¨¡æ‹Ÿå¯¹è¯...</div>';

            let html = '';

            try {
                // å¼€å§‹æ–°å¯¹è¯
                chatManager.startNewConversationForEvolution();
                html += `<div class="status success">âœ… å¼€å§‹æ–°å¯¹è¯</div>`;

                // æ¨¡æ‹Ÿç”¨æˆ·æ¶ˆæ¯
                chatManager.addMessageToChat('Hello, can you help me analyze a gene?', 'user');
                html += `<div class="status success">âœ… æ·»åŠ ç”¨æˆ·æ¶ˆæ¯</div>`;

                // æ¨¡æ‹ŸAIæ€è€ƒè¿‡ç¨‹
                chatManager.addThinkingMessage('Analyzing user request for gene analysis...');
                html += `<div class="status success">âœ… æ·»åŠ æ€è€ƒè¿‡ç¨‹</div>`;

                // æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨
                const mockTools = [
                    { tool_name: 'search_gene', parameters: { query: 'test_gene' } }
                ];
                chatManager.addToolCallMessage(mockTools);
                html += `<div class="status success">âœ… æ·»åŠ å·¥å…·è°ƒç”¨</div>`;

                // æ¨¡æ‹Ÿå·¥å…·ç»“æœ
                const mockResults = [
                    { tool: 'search_gene', success: true, result: 'Gene found' }
                ];
                chatManager.addToolResultMessage(mockResults);
                html += `<div class="status success">âœ… æ·»åŠ å·¥å…·ç»“æœ</div>`;

                // æ¨¡æ‹ŸAIå›å¤
                chatManager.addMessageToChat('I found the gene you requested. Here are the details...', 'assistant');
                html += `<div class="status success">âœ… æ·»åŠ AIå›å¤</div>`;

                // è·å–å¯¹è¯æ€»ç»“
                const summary = chatManager.getEvolutionDataSummary();
                html += `<div class="data-display">${JSON.stringify(summary, null, 2)}</div>`;

            } catch (error) {
                html += `<div class="status error">å¯¹è¯æ¨¡æ‹Ÿå¤±è´¥: ${error.message}</div>`;
            }

            statusDiv.innerHTML = html;
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateMetrics() {
            const metricsDiv = document.getElementById('metricsDisplay');

            try {
                const chatBoxSummary = chatManager.getEvolutionDataSummary();
                const storageStats = evolutionManager.storageManager?.getStorageInfo();

                const metrics = [
                    {
                        label: 'å½“å‰å¯¹è¯äº‹ä»¶',
                        value: chatBoxSummary.eventCount || 0
                    },
                    {
                        label: 'æ¶ˆæ¯æ•°é‡',
                        value: chatBoxSummary.statistics?.messageCount || 0
                    },
                    {
                        label: 'æ€è€ƒè¿‡ç¨‹',
                        value: chatBoxSummary.statistics?.thinkingProcessCount || 0
                    },
                    {
                        label: 'å·¥å…·è°ƒç”¨',
                        value: chatBoxSummary.statistics?.toolCallCount || 0
                    },
                    {
                        label: 'å­˜å‚¨çš„å¯¹è¯',
                        value: storageStats?.totalConversations || 0
                    },
                    {
                        label: 'Evolutionè¿æ¥',
                        value: chatBoxSummary.evolutionManagerConnected ? 1 : 0
                    }
                ];

                let html = '';
                metrics.forEach(metric => {
                    html += `
                        <div class="metric-card">
                            <div class="metric-value">${metric.value}</div>
                            <div class="metric-label">${metric.label}</div>
                        </div>
                    `;
                });

                metricsDiv.innerHTML = html;

            } catch (error) {
                metricsDiv.innerHTML = `<div class="status error">ç»Ÿè®¡æ›´æ–°å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æŸ¥çœ‹Evolutionæ•°æ®
        function viewEvolutionData() {
            const dataDiv = document.getElementById('dataDisplay');
            
            try {
                const storageData = evolutionManager.storageManager?.historyData;
                dataDiv.textContent = JSON.stringify(storageData, null, 2);
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
            }
        }

        // æŸ¥çœ‹ChatBoxæ•°æ®
        function viewChatBoxData() {
            const dataDiv = document.getElementById('dataDisplay');
            
            try {
                const chatBoxData = chatManager.currentConversationData;
                dataDiv.textContent = JSON.stringify(chatBoxData, null, 2);
            } catch (error) {
                dataDiv.textContent = `Error: ${error.message}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            const success = await initializeSystem();
            if (success) {
                setTimeout(() => {
                    checkSystemComponents();
                    updateMetrics();
                }, 1000);
            } else {
                document.getElementById('systemStatus').innerHTML = 
                    '<div class="status error">âŒ ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</div>';
            }
        });

        // å®šæœŸæ›´æ–°ç»Ÿè®¡
        setInterval(updateMetrics, 5000);
    </script>
</body>
</html> 