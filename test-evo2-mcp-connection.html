<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evo2 MCP Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .test-header {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .test-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .test-section h3 {
            margin: 0 0 20px 0;
            color: #2c5530;
            font-size: 1.4em;
            font-weight: 600;
        }

        .test-button {
            background: linear-gradient(135deg, #4a7c59, #2c5530);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
            width: 100%;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
        }

        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .test-log {
            background: #1e1e1e;
            color: #fff;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-connected { background: #4caf50; }
        .status-disconnected { background: #f44336; }
        .status-connecting { background: #ff9800; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .iframe-container {
            grid-column: 1 / -1;
            height: 600px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .error-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #856404;
        }

        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß¨ Evo2 MCP Connection Test</h1>
            <p>Debug and test MCP server connection and function call issues</p>
        </div>

        <div class="test-content">
            <!-- MCP Connection Tests -->
            <div class="test-section">
                <h3>üîå MCP Connection Tests</h3>
                
                <div style="margin-bottom: 15px;">
                    <span class="status-indicator status-disconnected" id="mcpStatusIndicator"></span>
                    <span id="mcpStatusText">MCP Disconnected</span>
                </div>

                <button class="test-button" onclick="testMCPEndpoints()">Test MCP Endpoints</button>
                <button class="test-button" onclick="testMCPConnection()">Test Connection</button>
                <button class="test-button" onclick="testMCPServerStart()">Check if Server Running</button>
                <button class="test-button" onclick="simulateSuccessfulConnection()">Simulate Successful Connection</button>

                <div id="mcpLog" class="test-log">
                    MCP Connection Test Log:
                    Ready to test MCP server connection...
                </div>
            </div>

            <!-- Function Call Tests -->
            <div class="test-section">
                <h3>‚öôÔ∏è Function Call Tests</h3>
                
                <button class="test-button" onclick="testGenerateSequenceAction()">Test generateSequenceAction</button>
                <button class="test-button" onclick="testPredictFunctionAction()">Test predictFunctionAction</button>
                <button class="test-button" onclick="testFunctionMapping()">Test Function Name Mapping</button>
                <button class="test-button" onclick="testMCPToolCall()">Test MCP Tool Call</button>

                <div id="functionLog" class="test-log">
                    Function Call Test Log:
                    Testing function definitions and calls...
                </div>
            </div>

            <!-- Server Status Check -->
            <div class="test-section" style="grid-column: 1 / -1;">
                <h3>üñ•Ô∏è Server Status & Debugging</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    <button class="test-button" onclick="checkServerStatus()">Check Server Status</button>
                    <button class="test-button" onclick="testAPIConnection()">Test API Connection</button>
                    <button class="test-button" onclick="showServerHelp()">Show Server Start Instructions</button>
                    <button class="test-button" onclick="clearAllLogs()">Clear All Logs</button>
                </div>

                <div id="serverStatus" class="test-log">
                    Server Status Check:
                    Click "Check Server Status" to verify MCP server...
                </div>

                <div id="debugInfo" style="margin-top: 15px;">
                    <!-- Debug information will be displayed here -->
                </div>
            </div>

            <!-- Live Evo2 Tool -->
            <div class="iframe-container">
                <iframe src="src/bioinformatics-tools/evo2-designer.html" 
                        title="Evo2 DNA Designer"
                        id="evo2iframe"></iframe>
            </div>
        </div>
    </div>

    <script>
        let testResults = [];

        function logToElement(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            logElement.textContent += `\n[${timestamp}] ${typeIcon} ${message}`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        async function testMCPEndpoints() {
            logToElement('mcpLog', 'Testing MCP endpoints...');
            
            const endpoints = [
                'http://localhost:3000/health',
                'http://localhost:3000/',
                'http://localhost:3000/execute-tool',
                'http://localhost:3000/status'
            ];

            for (const endpoint of endpoints) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    logToElement('mcpLog', `${endpoint}: ${response.status} ${response.statusText}`, 'success');
                } catch (error) {
                    logToElement('mcpLog', `${endpoint}: Failed - ${error.message}`, 'error');
                }
            }
        }

        async function testMCPConnection() {
            const statusIndicator = document.getElementById('mcpStatusIndicator');
            const statusText = document.getElementById('mcpStatusText');
            
            statusIndicator.className = 'status-indicator status-connecting';
            statusText.textContent = 'Testing Connection...';
            
            logToElement('mcpLog', 'Attempting MCP connection...');
            
            try {
                const response = await fetch('http://localhost:3000/', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok || response.status === 404) {
                    statusIndicator.className = 'status-indicator status-connected';
                    statusText.textContent = 'MCP Connected';
                    logToElement('mcpLog', 'MCP server is running and accessible', 'success');
                } else {
                    throw new Error(`Server responded with ${response.status}`);
                }
            } catch (error) {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'MCP Disconnected';
                logToElement('mcpLog', `Connection failed: ${error.message}`, 'error');
            }
        }

        async function testMCPServerStart() {
            logToElement('mcpLog', 'Checking if MCP server is running...');
            
            try {
                const response = await fetch('http://localhost:3000/execute-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toolName: 'test',
                        parameters: {},
                        clientId: 'test'
                    })
                });
                
                logToElement('mcpLog', `Server response: ${response.status} - Server is running`, 'success');
            } catch (error) {
                logToElement('mcpLog', 'Server is NOT running. Please start with: node src/mcp-server.js', 'error');
            }
        }

        function simulateSuccessfulConnection() {
            const statusIndicator = document.getElementById('mcpStatusIndicator');
            const statusText = document.getElementById('mcpStatusText');
            
            statusIndicator.className = 'status-indicator status-connected';
            statusText.textContent = 'MCP Connected (Simulated)';
            
            logToElement('mcpLog', 'Simulated successful MCP connection', 'success');
        }

        function testGenerateSequenceAction() {
            logToElement('functionLog', 'Testing generateSequenceAction function...');
            
            try {
                // Test if the function is defined in the iframe
                const iframe = document.getElementById('evo2iframe');
                if (iframe.contentWindow && iframe.contentWindow.generateSequenceAction) {
                    logToElement('functionLog', 'generateSequenceAction function is defined', 'success');
                    
                    // Try to call it
                    iframe.contentWindow.generateSequenceAction();
                    logToElement('functionLog', 'generateSequenceAction called successfully', 'success');
                } else {
                    logToElement('functionLog', 'generateSequenceAction function is NOT defined', 'error');
                }
            } catch (error) {
                logToElement('functionLog', `Error testing generateSequenceAction: ${error.message}`, 'error');
            }
        }

        function testPredictFunctionAction() {
            logToElement('functionLog', 'Testing predictFunctionAction function...');
            
            try {
                const iframe = document.getElementById('evo2iframe');
                if (iframe.contentWindow && iframe.contentWindow.predictFunctionAction) {
                    logToElement('functionLog', 'predictFunctionAction function is defined', 'success');
                } else {
                    logToElement('functionLog', 'predictFunctionAction function is NOT defined', 'error');
                }
            } catch (error) {
                logToElement('functionLog', `Error testing predictFunctionAction: ${error.message}`, 'error');
            }
        }

        function testFunctionMapping() {
            logToElement('functionLog', 'Testing function name mapping...');
            
            const expectedFunctions = [
                'generateSequenceAction',
                'predictFunctionAction',
                'designCrisprAction',
                'optimizeSequenceAction',
                'analyzeEssentialityAction',
                'generateSequenceMain',
                'predictFunctionMain',
                'designCrisprMain',
                'optimizeSequenceMain',
                'analyzeEssentialityMain'
            ];
            
            try {
                const iframe = document.getElementById('evo2iframe');
                if (iframe.contentWindow) {
                    let foundFunctions = 0;
                    expectedFunctions.forEach(funcName => {
                        if (typeof iframe.contentWindow[funcName] === 'function') {
                            logToElement('functionLog', `‚úì ${funcName} is defined`, 'success');
                            foundFunctions++;
                        } else {
                            logToElement('functionLog', `‚úó ${funcName} is NOT defined`, 'error');
                        }
                    });
                    
                    logToElement('functionLog', `Found ${foundFunctions}/${expectedFunctions.length} expected functions`);
                } else {
                    logToElement('functionLog', 'Cannot access iframe content window', 'error');
                }
            } catch (error) {
                logToElement('functionLog', `Error testing function mapping: ${error.message}`, 'error');
            }
        }

        async function testMCPToolCall() {
            logToElement('functionLog', 'Testing MCP tool call...');
            
            try {
                const response = await fetch('http://localhost:3000/execute-tool', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        toolName: 'evo2_generate_sequence',
                        parameters: {
                            prompt: 'ATGCGT',
                            maxTokens: 50,
                            temperature: 1.0
                        },
                        clientId: 'test-client'
                    })
                });
                
                const result = await response.json();
                logToElement('functionLog', `MCP Tool Call Response: ${JSON.stringify(result, null, 2)}`, 'success');
                
            } catch (error) {
                logToElement('functionLog', `MCP Tool Call Failed: ${error.message}`, 'error');
            }
        }

        async function checkServerStatus() {
            logToElement('serverStatus', 'Checking server status...');
            
            const checks = [
                { name: 'Port 3000 Health', url: 'http://localhost:3000/health' },
                { name: 'Port 3000 Root', url: 'http://localhost:3000/' },
                { name: 'Port 3000 Execute Tool', url: 'http://localhost:3000/execute-tool' }
            ];
            
            for (const check of checks) {
                try {
                    const response = await fetch(check.url, { 
                        method: 'GET',
                        signal: AbortSignal.timeout(2000)
                    });
                    logToElement('serverStatus', `${check.name}: OK (${response.status})`, 'success');
                } catch (error) {
                    logToElement('serverStatus', `${check.name}: FAILED (${error.message})`, 'error');
                }
            }
        }

        function testAPIConnection() {
            logToElement('serverStatus', 'Testing API connection...');
            
            // Simulate API test
            const config = {
                apiKey: localStorage.getItem('evo2_api_key'),
                apiUrl: localStorage.getItem('evo2_api_url')
            };
            
            if (config.apiKey && config.apiUrl) {
                logToElement('serverStatus', `API Config Found: ${config.apiUrl}`, 'success');
                logToElement('serverStatus', `API Key: ${config.apiKey.substring(0, 12)}...`, 'success');
            } else {
                logToElement('serverStatus', 'No API configuration found', 'warning');
            }
        }

        function showServerHelp() {
            const helpInfo = `
=== MCP Server Start Instructions ===

1. Open terminal in the project directory
2. Run: node src/mcp-server.js
3. Server should start on port 3000
4. Look for message: "MCP server listening on port 3000"

=== Troubleshooting ===

If server won't start:
- Check if port 3000 is in use: lsof -i :3000
- Kill existing process: kill -9 <PID>
- Restart server: node src/mcp-server.js

If functions are undefined:
- Check browser console for JavaScript errors
- Verify function names match in HTML onclick handlers
- Ensure all functions are properly defined
            `;
            
            document.getElementById('debugInfo').innerHTML = `<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-size: 12px; line-height: 1.4;">${helpInfo}</pre>`;
        }

        function clearAllLogs() {
            document.getElementById('mcpLog').textContent = 'MCP Connection Test Log:\nLogs cleared...';
            document.getElementById('functionLog').textContent = 'Function Call Test Log:\nLogs cleared...';
            document.getElementById('serverStatus').textContent = 'Server Status Check:\nLogs cleared...';
            document.getElementById('debugInfo').innerHTML = '';
        }

        // Auto-run basic checks on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testMCPConnection();
                testFunctionMapping();
            }, 1000);
        });

        // Listen for messages from iframe
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'evo2-test') {
                logToElement('functionLog', `Iframe message: ${JSON.stringify(event.data)}`, 'info');
            }
        });
    </script>
</body>
</html> 