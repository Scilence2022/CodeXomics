<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Call Parsing Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .llm-response {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
        }
        .analysis-result {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Function Call Parsing Fix Test</h1>
    
    <div class="test-section">
        <h2>üìã LLM Response Analysis</h2>
        
        <div class="llm-response">
            <h3>üß† Sample LLM Response:</h3>
            <div class="code-block">{
  "choices": [
    {
      "message": {
        "role": "assistant",
        "content": "&lt;think&gt;\nOkay, the user wants to search for the gene lacZ. Let me check the available tools. The relevant function here is search_gene_by_name, which is under the SEARCH & NAVIGATION category. The parameters needed are the name of the gene. Since the user specified \"lacZ\", I should use that as the parameter. I need to make sure the tool call is correctly formatted in JSON. Also, according to the priority, local tools are first, so this should be okay. No other parameters are needed, just the gene name. Let me structure the JSON accordingly.\n&lt;/think&gt;\n\n{\"tool_name\": \"search_gene_by_name\", \"parameters\": {\"name\": \"lacZ\"}}"
      }
    }
  ]
}</div>
        </div>

        <div class="analysis-result">
            <h3>üîç Parsed Content:</h3>
            <p><strong>Thinking Content:</strong></p>
            <div class="code-block">Okay, the user wants to search for the gene lacZ. Let me check the available tools. The relevant function here is search_gene_by_name, which is under the SEARCH & NAVIGATION category. The parameters needed are the name of the gene. Since the user specified "lacZ", I should use that as the parameter. I need to make sure the tool call is correctly formatted in JSON. Also, according to the priority, local tools are first, so this should be okay. No other parameters are needed, just the gene name. Let me structure the JSON accordingly.</div>
            
            <p><strong>Function Call:</strong></p>
            <div class="code-block">{
  "tool_name": "search_gene_by_name",
  "parameters": {
    "name": "lacZ"
  }
}</div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Fixes Implemented</h2>
        
        <div class="success">
            <h3>1. Enhanced Thinking Content Display</h3>
            <p><strong>Method:</strong> <code>displayLLMThinking()</code> and <code>formatThinkingContent()</code></p>
            <ul>
                <li>‚úÖ Improved <code>&lt;think&gt;</code> tag extraction using regex pattern</li>
                <li>‚úÖ Added content formatting for better readability</li>
                <li>‚úÖ Enhanced display with proper line breaks and structure</li>
                <li>‚úÖ Added content length handling for long thinking processes</li>
            </ul>
        </div>

        <div class="success">
            <h3>2. Function Call Parsing Verification</h3>
            <p><strong>Method:</strong> <code>parseToolCall()</code></p>
            <ul>
                <li>‚úÖ Already correctly handles <code>&lt;think&gt;</code> tag removal</li>
                <li>‚úÖ Extracts JSON function call after thinking content</li>
                <li>‚úÖ Multiple parsing strategies (direct, regex, flexible extraction)</li>
                <li>‚úÖ Robust error handling and fallback mechanisms</li>
            </ul>
        </div>

        <div class="success">
            <h3>3. Test Function Added</h3>
            <p><strong>Method:</strong> <code>testFunctionCallParsing()</code></p>
            <ul>
                <li>‚úÖ Comprehensive testing with sample LLM response</li>
                <li>‚úÖ Validates both thinking display and function call parsing</li>
                <li>‚úÖ Expected result verification</li>
                <li>‚úÖ Debug logging for troubleshooting</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Technical Analysis</h2>
        
        <div class="info">
            <h3>Function Call Parsing Logic:</h3>
            <ol>
                <li><strong>Input Processing:</strong> Raw LLM response with thinking tags</li>
                <li><strong>Tag Removal:</strong> Extract content after <code>&lt;/think&gt;</code></li>
                <li><strong>JSON Extraction:</strong> Multiple strategies for robust parsing</li>
                <li><strong>Validation:</strong> Verify tool_name and parameters structure</li>
                <li><strong>Return:</strong> Parsed function call object</li>
            </ol>
        </div>

        <div class="info">
            <h3>Thinking Content Display Logic:</h3>
            <ol>
                <li><strong>Pattern Matching:</strong> Regex to find <code>&lt;think&gt;...&lt;/think&gt;</code></li>
                <li><strong>Content Extraction:</strong> Get text between tags</li>
                <li><strong>Formatting:</strong> Clean up whitespace and add structure</li>
                <li><strong>Display:</strong> Show formatted thinking in ChatBox</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Expected Behavior</h2>
        
        <div class="success">
            <h3>‚úÖ Correct Function Call Extraction:</h3>
            <div class="code-block">{
  "tool_name": "search_gene_by_name",
  "parameters": {
    "name": "lacZ"
  }
}</div>
            <p>Should be successfully parsed and executed by ChatManager.</p>
        </div>

        <div class="success">
            <h3>‚úÖ Enhanced Thinking Display:</h3>
            <div class="code-block">üí≠ Model thinking:

Okay, the user wants to search for the gene lacZ. Let me check the available tools. The relevant function here is search_gene_by_name, which is under the SEARCH & NAVIGATION category.

The parameters needed are the name of the gene. Since the user specified "lacZ", I should use that as the parameter. I need to make sure the tool call is correctly formatted in JSON.

Also, according to the priority, local tools are first, so this should be okay. No other parameters are needed, just the gene name. Let me structure the JSON accordingly.</div>
            <p>Should display formatted thinking content when "Show Thinking Process" is enabled.</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üîß Manual Testing Instructions</h2>
        
        <div class="warning">
            <h3>To Test the Fixes:</h3>
            <ol>
                <li><strong>Open GenomeExplorer</strong> and ensure it's running</li>
                <li><strong>Configure LLM</strong> (Options ‚Üí Configure LLMs)</li>
                <li><strong>Enable Thinking Display:</strong> In ChatBox settings, ensure "Show Thinking Process" is enabled</li>
                <li><strong>Send Test Message:</strong> "Search for the gene lacZ"</li>
                <li><strong>Observe Behavior:</strong>
                    <ul>
                        <li>Thinking content should display in formatted way</li>
                        <li>Function call should be executed correctly</li>
                        <li>Gene search should complete successfully</li>
                    </ul>
                </li>
                <li><strong>Run Test Function:</strong> Open browser console and run <code>window.chatManager.testFunctionCallParsing()</code></li>
            </ol>
        </div>

        <button onclick="runTest()">üß™ Run Automated Test</button>
        <button onclick="showCode()">üìù Show Implementation Code</button>
    </div>

    <div class="test-section">
        <h2>üìä Summary</h2>
        
        <div class="success">
            <h3>‚úÖ Issues Resolved:</h3>
            <ul>
                <li><strong>Function Call Parsing:</strong> Already working correctly, handles thinking tags properly</li>
                <li><strong>Thinking Content Display:</strong> Enhanced with better formatting and readability</li>
                <li><strong>Error Handling:</strong> Robust parsing with multiple fallback strategies</li>
                <li><strong>Testing:</strong> Added comprehensive test function for validation</li>
            </ul>
        </div>

        <div class="info">
            <p><strong>Result:</strong> The ChatBox function call parsing and thinking content display are now optimized to handle LLM responses with <code>&lt;think&gt;</code> tags correctly, providing better user experience and reliable function execution.</p>
        </div>
    </div>

    <script>
        function runTest() {
            alert('üß™ To run the test:\n\n1. Open GenomeExplorer\n2. Open browser console (F12)\n3. Run: window.chatManager.testFunctionCallParsing()\n4. Check console output for results');
        }

        function showCode() {
            const code = `
// Enhanced displayLLMThinking method
displayLLMThinking(response) {
    const thinkingMatch = response.match(/<think>([\\s\\S]*?)<\\/think>/);
    if (thinkingMatch) {
        const thinkingContent = thinkingMatch[1].trim();
        const formattedThinking = this.formatThinkingContent(thinkingContent);
        this.updateThinkingMessage(\`üí≠ Model thinking:\\n\\n\${formattedThinking}\`);
    }
}

// Function call parsing (already working correctly)
parseToolCall(response) {
    let cleanResponse = response.trim();
    
    // Remove thinking tags
    if (cleanResponse.includes('</think>')) {
        const thinkEndIndex = cleanResponse.lastIndexOf('</think>');
        cleanResponse = cleanResponse.substring(thinkEndIndex + 8).trim();
    }
    
    // Parse JSON function call
    return JSON.parse(cleanResponse);
}`;
            
            alert('Implementation Code:\n\n' + code);
        }

        // Add some interactive elements
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Function Call Parsing Fix Test Page Loaded');
            
            // Add click handlers for code blocks
            const codeBlocks = document.querySelectorAll('.code-block');
            codeBlocks.forEach(block => {
                block.style.cursor = 'pointer';
                block.title = 'Click to copy';
                block.addEventListener('click', function() {
                    navigator.clipboard.writeText(this.textContent).then(() => {
                        const originalBg = this.style.backgroundColor;
                        this.style.backgroundColor = '#d4edda';
                        setTimeout(() => {
                            this.style.backgroundColor = originalBg;
                        }, 1000);
                    });
                });
            });
        });
    </script>
</body>
</html>
