<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin System V2 - Phase 1 Refactoring Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .test-header {
            background: #343a40;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-content {
            padding: 20px;
            background: white;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: #ffc107; color: #856404; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .status-warning { background: #fd7e14; color: white; }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.4;
            margin-top: 15px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        
        .info-card h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1em;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .metric-label {
            font-weight: 600;
            color: #495057;
        }
        
        .metric-value {
            color: #007bff;
            font-weight: 600;
        }
        
        .plugin-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }
        
        .plugin-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plugin-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .plugin-type {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #495057;
        }
        
        .function-test {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .function-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .test-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .test-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 Plugin System V2 - Phase 1 Refactoring Test</h1>
            <p>Comprehensive testing suite for the refactored GenomeExplorer plugin architecture</p>
        </div>
        
        <div class="content">
            <!-- System Status Overview -->
            <div class="test-section">
                <div class="test-header">
                    <span>🚀 System Status Overview</span>
                    <span class="status-badge status-pending" id="system-status">Pending</span>
                </div>
                <div class="test-content">
                    <button onclick="initializeSystem()">Initialize Plugin System V2</button>
                    <button onclick="checkSystemHealth()">Check System Health</button>
                    
                    <div class="info-grid">
                        <div class="info-card">
                            <h4>📊 System Metrics</h4>
                            <div id="system-metrics">
                                <div class="metric">
                                    <span class="metric-label">System Version:</span>
                                    <span class="metric-value" id="system-version">Not Loaded</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Initialization Status:</span>
                                    <span class="metric-value" id="init-status">Not Started</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Resource Management:</span>
                                    <span class="metric-value" id="resource-status">Not Loaded</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">API Layer:</span>
                                    <span class="metric-value" id="api-status">Not Loaded</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-card">
                            <h4>📦 Plugin Registry</h4>
                            <div id="plugin-registry">
                                <div class="metric">
                                    <span class="metric-label">Function Plugins:</span>
                                    <span class="metric-value" id="function-count">0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Visualization Plugins:</span>
                                    <span class="metric-value" id="visualization-count">0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Utility Plugins:</span>
                                    <span class="metric-value" id="utility-count">0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Total Plugins:</span>
                                    <span class="metric-value" id="total-plugins">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-container" id="system-log">
                        <div>🔧 System initialization log will appear here...</div>
                    </div>
                </div>
            </div>
            
            <!-- Component Testing -->
            <div class="test-section">
                <div class="test-header">
                    <span>🧪 Component Testing</span>
                    <span class="status-badge status-pending" id="component-status">Pending</span>
                </div>
                <div class="test-content">
                    <button onclick="testPluginAPI()">Test Plugin API</button>
                    <button onclick="testResourceManager()">Test Resource Manager</button>
                    <button onclick="testPluginManagerV2()">Test Plugin Manager V2</button>
                    
                    <div id="component-results"></div>
                </div>
            </div>
            
            <!-- Function Execution Testing -->
            <div class="test-section">
                <div class="test-header">
                    <span>⚡ Function Execution Testing</span>
                    <span class="status-badge status-pending" id="execution-status">Pending</span>
                </div>
                <div class="test-content">
                    <button onclick="testBuiltinFunctions()">Test Built-in Functions</button>
                    <button onclick="testPluginFunctions()">Test Plugin Functions</button>
                    <button onclick="testUtilityFunctions()">Test Utility Functions</button>
                    <button onclick="testPerformanceMetrics()">Test Performance Metrics</button>
                    
                    <div id="function-results"></div>
                </div>
            </div>
            
            <!-- Integration Testing -->
            <div class="test-section">
                <div class="test-header">
                    <span>🔗 Integration Testing</span>
                    <span class="status-badge status-pending" id="integration-status">Pending</span>
                </div>
                <div class="test-content">
                    <button onclick="testChatManagerIntegration()">Test ChatManager Integration</button>
                    <button onclick="testFunctionCallsOrganizer()">Test Function Calls Organizer</button>
                    <button onclick="testLegacyCompatibility()">Test Legacy Compatibility</button>
                    
                    <div id="integration-results"></div>
                </div>
            </div>
            
            <!-- Performance Analysis -->
            <div class="test-section">
                <div class="test-header">
                    <span>📈 Performance Analysis</span>
                    <span class="status-badge status-pending" id="performance-status">Pending</span>
                </div>
                <div class="test-content">
                    <button onclick="runPerformanceBenchmark()">Run Performance Benchmark</button>
                    <button onclick="testResourceUtilization()">Test Resource Utilization</button>
                    <button onclick="compareWithLegacy()">Compare with Legacy System</button>
                    
                    <div id="performance-results"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Plugin System Components -->
    <script src="src/renderer/modules/PluginAPI.js"></script>
    <script src="src/renderer/modules/PluginResourceManager.js"></script>
    <script src="src/renderer/modules/PluginManagerV2.js"></script>
    <script src="src/renderer/modules/FunctionCallsOrganizer.js"></script>

    <script>
        let pluginManagerV2 = null;
        let mockApp = null;
        let testResults = {
            systemTests: [],
            componentTests: [],
            functionTests: [],
            integrationTests: [],
            performanceTests: []
        };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#00ff00',
                'warn': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff88'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colorMap[type] || '#00ff00';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.className = `status-badge status-${status}`;
            element.textContent = message || status.toUpperCase();
        }

        function createMockApp() {
            return {
                // Mock genome data access
                genomeViewer: {
                    currentGenome: {
                        sequences: new Map([
                            ['chr1', 'ATGCGATCGATCGATCGATCG'],
                            ['chr2', 'CGATCGATCGATCGATCGATC']
                        ]),
                        annotations: new Map([
                            ['gene1', { start: 100, end: 500, type: 'gene', name: 'testGene1' }],
                            ['gene2', { start: 600, end: 900, type: 'gene', name: 'testGene2' }]
                        ]),
                        features: new Map([
                            ['feature1', { start: 200, end: 300, type: 'CDS', strand: '+' }]
                        ])
                    },
                    tracks: new Map([
                        ['genes', { visible: true, data: [] }],
                        ['annotations', { visible: false, data: [] }]
                    ])
                },
                // Mock UI components
                ui: {
                    showNotification: (msg) => log(msg, 'info'),
                    updateProgress: (percent) => log(`Progress: ${percent}%`, 'info')
                }
            };
        }

        async function initializeSystem() {
            try {
                updateStatus('system-status', 'pending', 'Initializing...');
                log('🔧 Starting Plugin System V2 initialization...', 'info');
                
                // Create mock application context
                mockApp = createMockApp();
                log('✅ Mock application context created', 'success');
                
                // Check if components are loaded
                if (typeof PluginAPI === 'undefined') {
                    throw new Error('PluginAPI not loaded');
                }
                if (typeof PluginResourceManager === 'undefined') {
                    throw new Error('PluginResourceManager not loaded');
                }
                if (typeof PluginManagerV2 === 'undefined') {
                    throw new Error('PluginManagerV2 not loaded');
                }
                
                log('✅ All core components loaded successfully', 'success');
                
                // Initialize Plugin Manager V2
                pluginManagerV2 = new PluginManagerV2(mockApp, null, {
                    enableResourceManagement: true,
                    enableCaching: true,
                    maxConcurrentExecutions: 3
                });
                
                // Wait for initialization to complete
                await pluginManagerV2.initialize();
                
                log('🚀 Plugin Manager V2 initialized successfully', 'success');
                updateStatus('system-status', 'success', 'Initialized');
                
                // Update UI metrics
                updateSystemMetrics();
                
                return true;
                
            } catch (error) {
                log(`❌ System initialization failed: ${error.message}`, 'error');
                updateStatus('system-status', 'error', 'Failed');
                throw error;
            }
        }

        function updateSystemMetrics() {
            if (!pluginManagerV2) return;
            
            document.getElementById('system-version').textContent = 'V2.0.0';
            document.getElementById('init-status').textContent = pluginManagerV2.isInitialized ? 'Initialized' : 'Not Initialized';
            document.getElementById('resource-status').textContent = pluginManagerV2.resourceManager ? 'Active' : 'Disabled';
            document.getElementById('api-status').textContent = pluginManagerV2.api ? 'Active' : 'Disabled';
            
            const stats = pluginManagerV2.getSystemStats();
            if (stats) {
                document.getElementById('function-count').textContent = stats.plugins.byType.function || 0;
                document.getElementById('visualization-count').textContent = stats.plugins.byType.visualization || 0;
                document.getElementById('utility-count').textContent = stats.plugins.byType.utility || 0;
                document.getElementById('total-plugins').textContent = stats.plugins.total || 0;
            }
        }

        async function checkSystemHealth() {
            try {
                log('🏥 Performing system health check...', 'info');
                
                const healthChecks = [
                    {
                        name: 'Plugin Manager V2 Status',
                        check: () => pluginManagerV2 && pluginManagerV2.isInitialized
                    },
                    {
                        name: 'API Layer Status',
                        check: () => pluginManagerV2.api && typeof pluginManagerV2.api.getSequence === 'function'
                    },
                    {
                        name: 'Resource Manager Status',
                        check: () => pluginManagerV2.resourceManager && typeof pluginManagerV2.resourceManager.requestExecution === 'function'
                    },
                    {
                        name: 'Plugin Registry Status',
                        check: () => {
                            const stats = pluginManagerV2.getSystemStats();
                            return stats && stats.plugins.total > 0;
                        }
                    }
                ];
                
                let passed = 0;
                for (const check of healthChecks) {
                    const result = check.check();
                    if (result) {
                        log(`✅ ${check.name}: PASS`, 'success');
                        passed++;
                    } else {
                        log(`❌ ${check.name}: FAIL`, 'error');
                    }
                }
                
                log(`🏥 Health check complete: ${passed}/${healthChecks.length} checks passed`, 
                    passed === healthChecks.length ? 'success' : 'warn');
                
            } catch (error) {
                log(`❌ Health check failed: ${error.message}`, 'error');
            }
        }

        async function testPluginAPI() {
            try {
                log('🧪 Testing Plugin API...', 'info');
                updateStatus('component-status', 'pending', 'Testing API...');
                
                const api = pluginManagerV2.api;
                if (!api) {
                    throw new Error('Plugin API not available');
                }
                
                // Test sequence access
                const sequence = await api.getSequence('chr1', 1, 10);
                log(`✅ Sequence access test: Retrieved ${sequence?.length || 0} bases`, 'success');
                
                // Test caching
                const cachedSequence = await api.getSequence('chr1', 1, 10);
                log('✅ Cache test: Sequence retrieved from cache', 'success');
                
                // Test statistics
                const stats = api.getStats();
                log(`✅ Statistics test: ${stats.cacheHits} hits, ${stats.cacheMisses} misses`, 'success');
                
                updateStatus('component-status', 'success', 'API OK');
                
            } catch (error) {
                log(`❌ Plugin API test failed: ${error.message}`, 'error');
                updateStatus('component-status', 'error', 'API Failed');
            }
        }

        async function testResourceManager() {
            try {
                log('🧪 Testing Resource Manager...', 'info');
                
                const rm = pluginManagerV2.resourceManager;
                if (!rm) {
                    log('⚠️ Resource Manager disabled, skipping test', 'warn');
                    return;
                }
                
                // Test execution request
                const request = await rm.requestExecution('test-plugin', 'test-function', 'normal');
                log(`✅ Execution request test: ${request.granted ? 'Granted' : 'Denied'}`, 'success');
                
                if (request.granted) {
                    // Test execution release
                    rm.releaseExecution(request.executionId, 'success');
                    log('✅ Execution release test: Released successfully', 'success');
                }
                
                // Test resource statistics
                const stats = rm.getResourceStats();
                log(`✅ Resource stats test: ${stats.activeExecutions} active, queue size: ${stats.queueSize}`, 'success');
                
            } catch (error) {
                log(`❌ Resource Manager test failed: ${error.message}`, 'error');
            }
        }

        async function testPluginManagerV2() {
            try {
                log('🧪 Testing Plugin Manager V2...', 'info');
                
                // Test plugin registration
                const testPlugin = {
                    type: 'function',
                    name: 'Test Plugin',
                    description: 'A test plugin for validation',
                    version: '1.0.0',
                    functions: {
                        testFunction: {
                            description: 'A test function',
                            parameters: {
                                type: 'object',
                                properties: {
                                    input: { type: 'string' }
                                },
                                required: ['input']
                            },
                            executor: (context) => `Hello ${context.parameters.input}!`
                        }
                    }
                };
                
                await pluginManagerV2.registerPlugin('test-plugin', testPlugin);
                log('✅ Plugin registration test: Test plugin registered', 'success');
                
                // Test function execution
                const result = await pluginManagerV2.executeFunction('test-plugin', 'testFunction', { input: 'World' });
                log(`✅ Function execution test: ${result}`, 'success');
                
                // Test available functions
                const functions = pluginManagerV2.getAvailableFunctions();
                log(`✅ Function listing test: ${functions.length} functions available`, 'success');
                
            } catch (error) {
                log(`❌ Plugin Manager V2 test failed: ${error.message}`, 'error');
            }
        }

        async function testBuiltinFunctions() {
            try {
                log('⚡ Testing built-in functions...', 'info');
                updateStatus('execution-status', 'pending', 'Testing...');
                
                const resultsContainer = document.getElementById('function-results');
                resultsContainer.innerHTML = '';
                
                const functions = pluginManagerV2.getAvailableFunctions();
                log(`Found ${functions.length} available functions`, 'info');
                
                let testsPassed = 0;
                let testsTotal = 0;
                
                // Test a few key functions
                const testCases = [
                    {
                        name: 'genomic-analysis.analyzeGCContent',
                        params: { chromosome: 'chr1', start: 1, end: 20, windowSize: 10 }
                    },
                    {
                        name: 'sequence-utils.reverseComplement',
                        params: { sequence: 'ATGC' }
                    }
                ];
                
                for (const testCase of testCases) {
                    testsTotal++;
                    const testDiv = document.createElement('div');
                    testDiv.className = 'function-test';
                    
                    try {
                        const result = await pluginManagerV2.executeFunctionByName(testCase.name, testCase.params);
                        testDiv.innerHTML = `
                            <div class="function-name">${testCase.name}</div>
                            <div class="test-result test-success">
                                ✅ Success: ${JSON.stringify(result)}
                            </div>
                        `;
                        testsPassed++;
                        log(`✅ Function ${testCase.name}: Success`, 'success');
                    } catch (error) {
                        testDiv.innerHTML = `
                            <div class="function-name">${testCase.name}</div>
                            <div class="test-result test-error">
                                ❌ Error: ${error.message}
                            </div>
                        `;
                        log(`❌ Function ${testCase.name}: ${error.message}`, 'error');
                    }
                    
                    resultsContainer.appendChild(testDiv);
                }
                
                const status = testsPassed === testsTotal ? 'success' : 'warning';
                updateStatus('execution-status', status, `${testsPassed}/${testsTotal} passed`);
                
            } catch (error) {
                log(`❌ Built-in function tests failed: ${error.message}`, 'error');
                updateStatus('execution-status', 'error', 'Failed');
            }
        }

        async function runPerformanceBenchmark() {
            try {
                log('📈 Running performance benchmark...', 'info');
                updateStatus('performance-status', 'pending', 'Benchmarking...');
                
                const resultsContainer = document.getElementById('performance-results');
                resultsContainer.innerHTML = '';
                
                const startTime = performance.now();
                
                // Test multiple concurrent executions
                const promises = [];
                for (let i = 0; i < 10; i++) {
                    promises.push(
                        pluginManagerV2.executeFunctionByName('sequence-utils.reverseComplement', {
                            sequence: 'ATGCGATCGATCGATCG'.repeat(i + 1)
                        })
                    );
                }
                
                await Promise.all(promises);
                const endTime = performance.now();
                
                const totalTime = endTime - startTime;
                const avgTime = totalTime / promises.length;
                
                // Get system statistics
                const stats = pluginManagerV2.getSystemStats();
                
                const benchmarkHTML = `
                    <div class="info-card">
                        <h4>⚡ Performance Metrics</h4>
                        <div class="metric">
                            <span class="metric-label">Total Execution Time:</span>
                            <span class="metric-value">${totalTime.toFixed(2)}ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average Execution Time:</span>
                            <span class="metric-value">${avgTime.toFixed(2)}ms</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Concurrent Executions:</span>
                            <span class="metric-value">${promises.length}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Success Rate:</span>
                            <span class="metric-value">100%</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h4>📊 System Statistics</h4>
                        <div class="metric">
                            <span class="metric-label">Total Executions:</span>
                            <span class="metric-value">${stats.execution.totalExecutions}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Success Rate:</span>
                            <span class="metric-value">${((stats.execution.successfulExecutions / stats.execution.totalExecutions) * 100).toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average Execution Time:</span>
                            <span class="metric-value">${stats.execution.averageExecutionTime.toFixed(2)}ms</span>
                        </div>
                    </div>
                `;
                
                resultsContainer.innerHTML = benchmarkHTML;
                
                log(`✅ Performance benchmark completed: ${totalTime.toFixed(2)}ms total, ${avgTime.toFixed(2)}ms average`, 'success');
                updateStatus('performance-status', 'success', 'Complete');
                
            } catch (error) {
                log(`❌ Performance benchmark failed: ${error.message}`, 'error');
                updateStatus('performance-status', 'error', 'Failed');
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('🌟 Plugin System V2 Test Suite Ready', 'info');
            log('Click "Initialize Plugin System V2" to begin testing', 'info');
        });
    </script>
</body>
</html> 