<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improved Get Coding Sequence Function Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .result {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #e1e8ed;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            border-left: 4px solid #27ae60;
            background: #d5f4e6;
        }

        .error {
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
        }

        .info {
            border-left: 4px solid #3498db;
            background: #ebf3fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ Improved Get Coding Sequence Function Test</h1>
        
        <div class="test-section">
            <h2>üîß Test Controls</h2>
            <div class="controls">
                <button class="btn-primary" onclick="testEnvironmentCheck()">Check Environment</button>
                <button class="btn-success" onclick="testWithGenomeData()">Test with Genome Data</button>
                <button class="btn-warning" onclick="testErrorHandling()">Test Error Handling</button>
                <button class="btn-primary" onclick="testWorkflow()">Test Complete Workflow</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Mock ChatManager for testing
        class MockChatManager {
            checkGenomicsEnvironment() {
                // Simulate different environment states
                if (!window.MicrobeFns) {
                    return {
                        valid: false,
                        message: 'MicrobeGenomicsFunctions not available. The genomics module may not be loaded properly.'
                    };
                }

                if (!window.genomeBrowser) {
                    return {
                        valid: false,
                        message: 'GenomeBrowser not initialized. Please ensure the application is fully loaded.'
                    };
                }

                if (!window.genomeBrowser.currentSequence || Object.keys(window.genomeBrowser.currentSequence).length === 0) {
                    return {
                        valid: false,
                        message: 'No genome sequence data loaded. Please load a genome file (GenBank, FASTA, etc.) first using the File menu or Project Manager.'
                    };
                }

                return {
                    valid: true,
                    message: 'Genomics environment is properly configured',
                    details: {
                        chromosomes: Object.keys(window.genomeBrowser.currentSequence),
                        currentChromosome: window.genomeBrowser.currentChromosome,
                        sequenceLength: window.genomeBrowser.currentSequence[window.genomeBrowser.currentChromosome]?.length,
                        annotationCount: window.genomeBrowser.currentAnnotations[window.genomeBrowser.currentChromosome]?.length
                    }
                };
            }

            async getCodingSequence(params) {
                const { identifier } = params;
                
                if (!identifier) {
                    throw new Error('Gene identifier (name or locus_tag) is required');
                }

                const environmentCheck = this.checkGenomicsEnvironment();
                if (!environmentCheck.valid) {
                    throw new Error(environmentCheck.message);
                }

                try {
                    const result = window.MicrobeFns.getCodingSequence(identifier);
                    
                    if (!result.success) {
                        let errorMessage = result.error;
                        if (result.error.includes('not found')) {
                            errorMessage += `\n\nSuggestions:
- Try using search_gene_by_name first to find the exact gene name
- Check if the gene exists using search_features
- Verify the genome data is loaded correctly`;
                        }
                        throw new Error(errorMessage);
                    }

                    return {
                        identifier: identifier,
                        success: true,
                        geneName: result.geneName,
                        locusTag: result.locusTag,
                        chromosome: result.chromosome,
                        position: `${result.start}-${result.end}`,
                        strand: result.strand,
                        length: result.length,
                        gcContent: result.gcContent,
                        geneType: result.geneType,
                        codingSequence: result.codingSequence,
                        proteinLength: result.proteinLength,
                        proteinSequence: result.proteinSequence
                    };
                    
                } catch (error) {
                    throw new Error(`Failed to get coding sequence for "${identifier}": ${error.message}`);
                }
            }
        }

        const mockChatManager = new MockChatManager();

        function displayResult(result, title, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultHtml = `
                <div class="test-section">
                    <h2>${title}</h2>
                    <div class="result ${type}">
${typeof result === 'object' ? JSON.stringify(result, null, 2) : result}
                    </div>
                </div>
            `;
            resultsDiv.innerHTML = resultHtml;
        }

        function testEnvironmentCheck() {
            try {
                const result = mockChatManager.checkGenomicsEnvironment();
                displayResult(result, 'üîç Environment Check Results', result.valid ? 'success' : 'error');
            } catch (error) {
                displayResult({ error: error.message }, '‚ùå Environment Check Error', 'error');
            }
        }

        function setupMockGenomeData() {
            // Setup mock genome data
            window.genomeBrowser = {
                currentChromosome: 'NC_000913.3',
                currentSequence: {
                    'NC_000913.3': 'ATGAAACGCATTAGCACCACCATTACCACCACCATCACCATTACCACAGGTAACGGTGCGGGCTGA'
                },
                currentAnnotations: {
                    'NC_000913.3': [
                        {
                            type: 'CDS',
                            start: 1,
                            end: 63,
                            strand: 1,
                            qualifiers: {
                                gene: 'lysC',
                                locus_tag: 'b0002',
                                product: 'aspartate kinase I'
                            }
                        }
                    ]
                }
            };

            window.MicrobeFns = {
                getCodingSequence: function(identifier) {
                    if (identifier === 'lysC' || identifier === 'b0002') {
                        return {
                            success: true,
                            identifier: identifier,
                            geneName: 'lysC',
                            locusTag: 'b0002',
                            chromosome: 'NC_000913.3',
                            start: 1,
                            end: 63,
                            strand: '+',
                            length: 63,
                            codingSequence: 'ATGAAACGCATTAGCACCACCATTACCACCACCATCACCATTACCACAGGTAACGGTGCGGGCTGA',
                            proteinSequence: 'MKRISLHHHYHHHHHYHRVTVRA*',
                            gcContent: 47.6,
                            proteinLength: 21,
                            geneType: 'CDS'
                        };
                    } else {
                        return {
                            success: false,
                            error: `Gene "${identifier}" not found`,
                            identifier: identifier
                        };
                    }
                }
            };
        }

        function testWithGenomeData() {
            setupMockGenomeData();
            
            mockChatManager.getCodingSequence({ identifier: 'lysC' })
                .then(result => {
                    displayResult(result, '‚úÖ Successful Gene Retrieval', 'success');
                })
                .catch(error => {
                    displayResult({ error: error.message }, '‚ùå Unexpected Error', 'error');
                });
        }

        function testErrorHandling() {
            const testCases = [
                { scenario: 'No genome data', setup: () => { window.genomeBrowser = null; window.MicrobeFns = null; } },
                { scenario: 'No MicrobeFns', setup: () => { setupMockGenomeData(); window.MicrobeFns = null; } },
                { scenario: 'No sequence data', setup: () => { setupMockGenomeData(); window.genomeBrowser.currentSequence = {}; } },
                { scenario: 'Gene not found', setup: () => { setupMockGenomeData(); }, identifier: 'nonexistent_gene' }
            ];

            let results = [];
            
            testCases.forEach((testCase, index) => {
                testCase.setup();
                const identifier = testCase.identifier || 'lysC';
                
                mockChatManager.getCodingSequence({ identifier })
                    .then(result => {
                        results.push(`Test ${index + 1} (${testCase.scenario}): Unexpected success`);
                    })
                    .catch(error => {
                        results.push(`Test ${index + 1} (${testCase.scenario}): ${error.message}`);
                    })
                    .finally(() => {
                        if (results.length === testCases.length) {
                            displayResult(results.join('\n\n'), 'üö® Error Handling Test Results', 'info');
                        }
                    });
            });
        }

        function testWorkflow() {
            const workflow = [
                { step: 1, action: 'Check Environment', func: () => mockChatManager.checkGenomicsEnvironment() },
                { step: 2, action: 'Setup Genome Data', func: () => { setupMockGenomeData(); return { success: true, message: 'Genome data loaded' }; } },
                { step: 3, action: 'Search Gene', func: () => ({ success: true, gene: 'lysC', found: true }) },
                { step: 4, action: 'Get Coding Sequence', func: () => mockChatManager.getCodingSequence({ identifier: 'lysC' }) }
            ];

            let workflowResults = [];
            
            const executeStep = async (stepIndex) => {
                if (stepIndex >= workflow.length) {
                    displayResult(workflowResults.join('\n\n'), 'üîÑ Complete Workflow Test Results', 'success');
                    return;
                }

                const step = workflow[stepIndex];
                try {
                    const result = await step.func();
                    workflowResults.push(`Step ${step.step} - ${step.action}: ‚úÖ Success`);
                } catch (error) {
                    workflowResults.push(`Step ${step.step} - ${step.action}: ‚ùå ${error.message}`);
                }
                
                executeStep(stepIndex + 1);
            };

            executeStep(0);
        }
    </script>
</body>
</html> 