<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAM Direct Query Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #45a049;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .log-container {
            background: #1e1e1e;
            color: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #87ceeb; }
        .log-success { color: #90ee90; }
        .log-warning { color: #ffa500; }
        .log-error { color: #ff6b6b; }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .comparison-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .highlight-new {
            background: #e8f5e8 !important;
            font-weight: bold;
        }
        .highlight-old {
            background: #ffe8e8 !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéØ BAM Direct Query Test</h1>
        <p>Testing the simplified direct region query mechanism (no expanded regions)</p>
    </div>

    <div class="test-section">
        <h3>üîÑ Changes Made</h3>
        <p><strong>Removed:</strong> Expanded region query mechanism with buffers and complex caching</p>
        <p><strong>Added:</strong> Direct target region queries with simple caching</p>
        
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>Old Mechanism</th>
                    <th>New Mechanism</th>
                    <th>Benefit</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Query Region</td>
                    <td class="highlight-old">Target + 50kb buffer</td>
                    <td class="highlight-new">Exact target region</td>
                    <td>‚úÖ No confusion</td>
                </tr>
                <tr>
                    <td>Cache Key</td>
                    <td class="highlight-old">Rounded to 50kb boundaries</td>
                    <td class="highlight-new">Exact region coordinates</td>
                    <td>‚úÖ Direct mapping</td>
                </tr>
                <tr>
                    <td>Read Filtering</td>
                    <td class="highlight-old">Query expanded ‚Üí Filter to target</td>
                    <td class="highlight-new">Query target directly</td>
                    <td>‚úÖ No filtering needed</td>
                </tr>
                <tr>
                    <td>BAM Query</td>
                    <td class="highlight-old">start-50kb to end+50kb</td>
                    <td class="highlight-new">start to end</td>
                    <td>‚úÖ Faster queries</td>
                </tr>
                <tr>
                    <td>Memory Usage</td>
                    <td class="highlight-old">Higher (expanded regions)</td>
                    <td class="highlight-new">Lower (exact regions)</td>
                    <td>‚úÖ More efficient</td>
                </tr>
                <tr>
                    <td>Debugging</td>
                    <td class="highlight-old">Complex cache/filter logic</td>
                    <td class="highlight-new">Simple direct queries</td>
                    <td>‚úÖ Easier to debug</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h3>üß™ Test Controls</h3>
        <button class="button" onclick="testDirectQuery()">Test Direct Query Logic</button>
        <button class="button" onclick="testCacheKeySimplification()">Test Cache Key Simplification</button>
        <button class="button" onclick="testCoordinateHandling()">Test Coordinate Handling</button>
        <button class="button" onclick="testReadsManagerIntegration()">Test ReadsManager Integration</button>
        <button class="button" onclick="clearResults()">Clear Results</button>
    </div>

    <div id="statusContainer"></div>
    <div id="logContainer" class="log-container"></div>
</body>

<script>
    function updateStatus(message) {
        const container = document.getElementById('statusContainer');
        const statusDiv = document.createElement('div');
        statusDiv.className = 'status';
        statusDiv.textContent = message;
        container.appendChild(statusDiv);
        
        setTimeout(() => {
            if (statusDiv.parentNode) {
                statusDiv.parentNode.removeChild(statusDiv);
            }
        }, 5000);
    }

    function log(message, type = 'info') {
        const container = document.getElementById('logContainer');
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        container.appendChild(logEntry);
        container.scrollTop = container.scrollHeight;
    }

    function clearResults() {
        document.getElementById('statusContainer').innerHTML = '';
        document.getElementById('logContainer').innerHTML = '';
    }

    function testDirectQuery() {
        log('üéØ Testing direct query logic...', 'info');
        
        // Test scenarios
        const testCases = [
            { start: 2061458, end: 2101458, desc: 'Current problematic case' },
            { start: 1000000, end: 1010000, desc: 'Small region (10kb)' },
            { start: 1500000, end: 1600000, desc: 'Large region (100kb)' },
            { start: 100, end: 500, desc: 'Very small region' }
        ];
        
        testCases.forEach(testCase => {
            const { start, end, desc } = testCase;
            
            log(`üìä ${desc}:`, 'info');
            log(`  Requested region: ${start}-${end}`, 'info');
            
            // OLD mechanism
            const regionSize = 50000;
            const oldBufferSize = regionSize;
            const oldSearchStart = Math.max(0, start - oldBufferSize);
            const oldSearchEnd = end + oldBufferSize;
            const oldBamStart = Math.max(0, oldSearchStart - 1);
            const oldBamEnd = oldSearchEnd - 1;
            
            log(`  OLD: Would query BAM ${oldBamStart}-${oldBamEnd + 1} (${oldBamEnd + 1 - oldBamStart} bp)`, 'warning');
            
            // NEW mechanism
            const newBamStart = Math.max(0, start - 1);
            const newBamEnd = end - 1;
            
            log(`  NEW: Query BAM ${newBamStart}-${newBamEnd + 1} (${newBamEnd + 1 - newBamStart} bp)`, 'success');
            
            const reduction = ((oldBamEnd + 1 - oldBamStart) - (newBamEnd + 1 - newBamStart)) / (oldBamEnd + 1 - oldBamStart) * 100;
            log(`  Query size reduction: ${reduction.toFixed(1)}%`, 'success');
            log('', 'info');
        });
        
        updateStatus('Direct query logic test completed');
    }

    function testCacheKeySimplification() {
        log('üîë Testing cache key simplification...', 'info');
        
        const testRegions = [
            { start: 2061458, end: 2101458 },
            { start: 1000000, end: 1010000 },
            { start: 1234567, end: 1245678 }
        ];
        
        const regionSize = 50000;
        
        testRegions.forEach((region, index) => {
            const { start, end } = region;
            
            // OLD cache key generation
            const oldRegionStart = Math.floor(start / regionSize) * regionSize;
            const oldRegionEnd = Math.ceil(end / regionSize) * regionSize;
            const oldCacheKey = `NC_000913.3:${oldRegionStart}-${oldRegionEnd}`;
            
            // NEW cache key generation
            const newCacheKey = `NC_000913.3:${start}-${end}`;
            
            log(`üîç Region ${index + 1}: ${start}-${end}`, 'info');
            log(`  OLD cache key: ${oldCacheKey}`, 'warning');
            log(`  NEW cache key: ${newCacheKey}`, 'success');
            log(`  Exact match: ${newCacheKey.includes(`${start}-${end}`) ? 'YES ‚úÖ' : 'NO ‚ùå'}`, 'success');
            log('', 'info');
        });
        
        updateStatus('Cache key simplification test completed');
    }

    function testCoordinateHandling() {
        log('üìê Testing coordinate handling consistency...', 'info');
        
        const testReads = [
            { bamPos: 2061457, length: 100 }, // 0-based BAM position
            { bamPos: 2070000, length: 150 },
            { bamPos: 2100000, length: 75 }
        ];
        
        const targetStart = 2061458;
        const targetEnd = 2101458;
        
        log(`üéØ Target region: ${targetStart}-${targetEnd}`, 'info');
        
        testReads.forEach((read, index) => {
            // BAM reader returns 1-based coordinates after our coordinate fix
            const readStart = read.bamPos + 1; // Convert from 0-based BAM to 1-based GenomeExplorer
            const readEnd = readStart + read.length - 1;
            
            // Direct overlap check (what the new mechanism does)
            const overlaps = readEnd >= targetStart && readStart <= targetEnd;
            
            log(`üìñ Read ${index + 1}:`, 'info');
            log(`  BAM position: ${read.bamPos} (0-based)`, 'info');
            log(`  GenomeExplorer position: ${readStart}-${readEnd} (1-based)`, 'info');
            log(`  Overlaps with target: ${overlaps ? 'YES ‚úÖ' : 'NO ‚ùå'}`, 
                overlaps ? 'success' : 'warning');
            log('', 'info');
        });
        
        updateStatus('Coordinate handling test completed');
    }

    function testReadsManagerIntegration() {
        log('üîå Testing ReadsManager integration...', 'info');
        
        try {
            if (typeof window.genomeBrowser !== 'undefined' && window.genomeBrowser.readsManager) {
                const readsManager = window.genomeBrowser.readsManager;
                
                log('‚úÖ ReadsManager found', 'success');
                log(`üìÅ Current file: ${readsManager.currentFile || 'None'}`, 'info');
                log(`üß¨ BAM mode: ${readsManager.isBamMode}`, 'info');
                log(`üìä Region size: ${readsManager.regionSize}`, 'info');
                
                // Test new cache key generation
                if (readsManager.getRegionKey) {
                    const testStart = 2061458;
                    const testEnd = 2101458;
                    const cacheKey = readsManager.getRegionKey('NC_000913.3', testStart, testEnd);
                    log(`üîë New cache key for ${testStart}-${testEnd}: ${cacheKey}`, 'success');
                    
                    const isExact = cacheKey === `NC_000913.3:${testStart}-${testEnd}`;
                    log(`üéØ Exact region match: ${isExact ? 'YES ‚úÖ' : 'NO ‚ùå'}`, 
                        isExact ? 'success' : 'error');
                } else {
                    log('‚ùå getRegionKey method not found', 'error');
                }
                
                // Test cache stats
                const cacheStats = readsManager.getCacheStats();
                log(`üíæ Cache stats:`, 'info');
                log(`  Size: ${cacheStats.cacheSize}/${cacheStats.maxCacheSize}`, 'info');
                log(`  Hit rate: ${Math.round(cacheStats.hitRate * 100)}%`, 'info');
                log(`  Memory usage: ${cacheStats.memoryUsage} reads`, 'info');
                
                // Check if filterReadsForExactRegion method still exists
                const hasFilterMethod = typeof readsManager.filterReadsForExactRegion === 'function';
                log(`üîç filterReadsForExactRegion method: ${hasFilterMethod ? 'EXISTS (should be removed)' : 'REMOVED ‚úÖ'}`, 
                    hasFilterMethod ? 'warning' : 'success');
                
                updateStatus('ReadsManager integration test completed successfully');
            } else {
                log('‚ùå ReadsManager not available', 'error');
                log('üí° This test requires GenomeBrowser to be loaded', 'warning');
                updateStatus('ReadsManager not available - load GenomeBrowser first');
            }
        } catch (error) {
            log(`‚ùå Error testing ReadsManager: ${error.message}`, 'error');
            updateStatus(`Error: ${error.message}`);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        log('üöÄ BAM Direct Query Test initialized', 'success');
        log('This test validates the new direct region query mechanism', 'info');
        updateStatus('Test environment ready');
    });
</script>
</html> 