<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAM File Validation Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #9b59b6;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .results {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .critical {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .warning {
            background: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .info {
            background: #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .file-info {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç BAM File Validation Tool</h1>
            <p>Comprehensive BAM file validation and diagnosis tool for troubleshooting "No References" issues</p>
        </div>

        <div class="critical">
            <strong>CRITICAL ISSUE DETECTED:</strong> Your BAM file shows 0 references in the header!<br>
            This tool will help diagnose the cause and suggest solutions.
        </div>

        <div class="test-section">
            <h3>üìã BAM File Information</h3>
            <div id="fileInfo" class="file-info">
                Loading BAM file information...
            </div>
        </div>

        <div class="test-section">
            <h3>üîç Quick Validation</h3>
            <button class="btn-danger" onclick="validateBAMFile()">Validate BAM File</button>
            <button class="btn-warning" onclick="checkBAMHeader()">Check Header Details</button>
            <button class="btn-primary" onclick="testBAMReading()">Test BAM Reading</button>
            <button class="btn-primary" onclick="clearLog('validationResults')">Clear</button>
            <div class="results" id="validationResults"></div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Diagnostic Tests</h3>
            <button class="btn-success" onclick="runFullDiagnostics()">Run Full Diagnostics</button>
            <button class="btn-warning" onclick="checkFileIntegrity()">Check File Integrity</button>
            <button class="btn-warning" onclick="compareWithSamtools()">Compare with Samtools</button>
            <button class="btn-primary" onclick="clearLog('diagnosticResults')">Clear</button>
            <div class="results" id="diagnosticResults"></div>
        </div>

        <div class="test-section">
            <h3>üí° Suggested Solutions</h3>
            <div id="solutions">
                <div class="info">
                    <strong>Possible Solutions:</strong>
                    <ol>
                        <li><strong>Rebuild Index:</strong> <code>samtools index your_file.bam</code></li>
                        <li><strong>Check File Integrity:</strong> <code>samtools quickcheck your_file.bam</code></li>
                        <li><strong>View Header:</strong> <code>samtools view -H your_file.bam</code></li>
                        <li><strong>Reprocess BAM:</strong> <code>samtools sort your_file.bam -o new_file.bam</code></li>
                        <li><strong>Convert SAM to BAM:</strong> <code>samtools view -bS your_file.sam > your_file.bam</code></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        function log(message, elementId = 'validationResults') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent += `${new Date().toLocaleTimeString()}: ${message}\n`;
                element.scrollTop = element.scrollHeight;
            }
            console.log(message);
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = '';
            }
        }

        function updateFileInfo() {
            const fileInfoElement = document.getElementById('fileInfo');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const readsManager = browser?.readsManager;
                const bamReader = readsManager?.bamReader;
                
                if (!bamReader) {
                    fileInfoElement.innerHTML = '<span style="color: red;">‚ùå No BAM reader available</span>';
                    return;
                }
                
                fileInfoElement.innerHTML = `
                    <strong>File Path:</strong> ${bamReader.filePath || 'Unknown'}<br>
                    <strong>Initialized:</strong> ${bamReader.isInitialized ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Has Index:</strong> ${bamReader.hasIndex ? '‚úÖ Yes' : '‚ùå No'}<br>
                    <strong>Index Type:</strong> ${bamReader.indexType || 'None'}<br>
                    <strong>Index Path:</strong> ${bamReader.indexPath || 'None'}<br>
                    <strong>References Count:</strong> <span style="color: ${bamReader.references?.length > 0 ? 'green' : 'red'}; font-weight: bold;">${bamReader.references?.length || 0}</span><br>
                    <strong>File Size:</strong> ${bamReader.getFormattedFileSize ? bamReader.getFormattedFileSize() : 'Unknown'}
                `;
                
            } catch (error) {
                fileInfoElement.innerHTML = `<span style="color: red;">‚ùå Error getting file info: ${error.message}</span>`;
            }
        }

        async function validateBAMFile() {
            clearLog('validationResults');
            log('üîç === BAM FILE VALIDATION ===', 'validationResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const readsManager = browser?.readsManager;
                const bamReader = readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå FATAL: No BAM reader available', 'validationResults');
                    return;
                }
                
                log(`File: ${bamReader.filePath}`, 'validationResults');
                log(`Initialized: ${bamReader.isInitialized}`, 'validationResults');
                log(`Has Index: ${bamReader.hasIndex}`, 'validationResults');
                
                // Check references
                const references = bamReader.getReferences();
                log(`References Count: ${references.length}`, 'validationResults');
                
                if (references.length === 0) {
                    log('‚ùå CRITICAL ISSUE: No references found!', 'validationResults');
                    log('This indicates a serious problem with the BAM file.', 'validationResults');
                } else {
                    log('‚úÖ References found:', 'validationResults');
                    references.slice(0, 10).forEach((ref, index) => {
                        log(`  ${index + 1}. ${ref.name} (${ref.length.toLocaleString()} bp)`, 'validationResults');
                    });
                    if (references.length > 10) {
                        log(`  ... and ${references.length - 10} more`, 'validationResults');
                    }
                }
                
                // Check header
                const header = bamReader.getHeader();
                log(`Header available: ${!!header}`, 'validationResults');
                
                if (header) {
                    log('Header keys:', 'validationResults');
                    Object.keys(header).forEach(key => {
                        log(`  - ${key}`, 'validationResults');
                    });
                }
                
                // Check file stats
                const stats = bamReader.getStats();
                log('File Statistics:', 'validationResults');
                log(`  Total reads: ${stats.totalReads}`, 'validationResults');
                log(`  File size: ${stats.fileSize} bytes`, 'validationResults');
                log(`  Index size: ${stats.indexSize} bytes`, 'validationResults');
                log(`  References: ${stats.references}`, 'validationResults');
                
            } catch (error) {
                log(`‚ùå Validation error: ${error.message}`, 'validationResults');
                log(`Stack: ${error.stack}`, 'validationResults');
            }
        }

        async function checkBAMHeader() {
            clearLog('validationResults');
            log('üìã === BAM HEADER ANALYSIS ===', 'validationResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'validationResults');
                    return;
                }
                
                // Force re-read the header
                log('Re-reading BAM header...', 'validationResults');
                
                try {
                    const header = await bamReader.bamFile.getHeader();
                    log('‚úÖ Header read successfully', 'validationResults');
                    log('Header structure:', 'validationResults');
                    log(JSON.stringify(header, null, 2), 'validationResults');
                    
                    if (header.references) {
                        log(`References in header: ${header.references.length}`, 'validationResults');
                        header.references.slice(0, 5).forEach(ref => {
                            log(`  ${ref.name}: ${ref.length} bp`, 'validationResults');
                        });
                    } else {
                        log('‚ùå No references property in header!', 'validationResults');
                    }
                    
                } catch (headerError) {
                    log(`‚ùå Failed to read header: ${headerError.message}`, 'validationResults');
                    log(`Header error stack: ${headerError.stack}`, 'validationResults');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'validationResults');
            }
        }

        async function testBAMReading() {
            clearLog('validationResults');
            log('üß™ === BAM READING TEST ===', 'validationResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'validationResults');
                    return;
                }
                
                // Test if we can create a new BamFile instance
                log('Testing @gmod/bam library...', 'validationResults');
                
                try {
                    // Check if BamFile is available
                    if (typeof BamFile === 'undefined') {
                        log('‚ùå BamFile class not available!', 'validationResults');
                        log('This suggests @gmod/bam library is not loaded properly.', 'validationResults');
                        return;
                    }
                    
                    log('‚úÖ BamFile class is available', 'validationResults');
                    
                    // Try to create a new instance
                    const testBamFile = new BamFile({
                        bamPath: bamReader.filePath,
                        baiPath: bamReader.indexPath
                    });
                    
                    log('‚úÖ BamFile instance created successfully', 'validationResults');
                    
                    // Try to read header
                    const testHeader = await testBamFile.getHeader();
                    log('‚úÖ Header read from new instance', 'validationResults');
                    log(`Test header references: ${testHeader.references ? testHeader.references.length : 0}`, 'validationResults');
                    
                    if (testHeader.references && testHeader.references.length > 0) {
                        log('‚úÖ References found in test instance!', 'validationResults');
                        log('This suggests the BAM file is valid but there may be an issue with the original instance.', 'validationResults');
                        
                        // Try a small query
                        const firstRef = testHeader.references[0];
                        log(`Testing query on ${firstRef.name}:1-1000...`, 'validationResults');
                        
                        try {
                            const records = await testBamFile.getRecordsForRange(firstRef.name, 0, 1000);
                            log(`‚úÖ Query successful: ${records.length} records found`, 'validationResults');
                        } catch (queryError) {
                            log(`‚ùå Query failed: ${queryError.message}`, 'validationResults');
                        }
                    } else {
                        log('‚ùå Still no references in test instance', 'validationResults');
                        log('This confirms the BAM file has issues.', 'validationResults');
                    }
                    
                } catch (testError) {
                    log(`‚ùå Test failed: ${testError.message}`, 'validationResults');
                    log(`Test error stack: ${testError.stack}`, 'validationResults');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'validationResults');
            }
        }

        async function runFullDiagnostics() {
            clearLog('diagnosticResults');
            log('üõ†Ô∏è === FULL DIAGNOSTIC SUITE ===', 'diagnosticResults');
            
            // Run all tests
            log('1. Validating BAM file...', 'diagnosticResults');
            await validateBAMFile();
            
            log('2. Checking header details...', 'diagnosticResults');
            await checkBAMHeader();
            
            log('3. Testing BAM reading...', 'diagnosticResults');
            await testBAMReading();
            
            log('4. File system checks...', 'diagnosticResults');
            await checkFileIntegrity();
            
            log('‚úÖ Full diagnostics completed!', 'diagnosticResults');
        }

        async function checkFileIntegrity() {
            clearLog('diagnosticResults');
            log('üîß === FILE INTEGRITY CHECK ===', 'diagnosticResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'diagnosticResults');
                    return;
                }
                
                const filePath = bamReader.filePath;
                log(`Checking file: ${filePath}`, 'diagnosticResults');
                
                try {
                    const fs = require('fs');
                    
                    // Check if file exists
                    if (!fs.existsSync(filePath)) {
                        log('‚ùå File does not exist!', 'diagnosticResults');
                        return;
                    }
                    
                    log('‚úÖ File exists', 'diagnosticResults');
                    
                    // Get file stats
                    const stats = fs.statSync(filePath);
                    log(`File size: ${stats.size.toLocaleString()} bytes`, 'diagnosticResults');
                    log(`Modified: ${stats.mtime}`, 'diagnosticResults');
                    
                    // Check BAM magic number
                    const buffer = Buffer.alloc(4);
                    const fd = fs.openSync(filePath, 'r');
                    fs.readSync(fd, buffer, 0, 4, 0);
                    fs.closeSync(fd);
                    
                    const magic = buffer.toString('ascii');
                    log(`File magic: "${magic}"`, 'diagnosticResults');
                    
                    if (magic === 'BAM\u0001') {
                        log('‚úÖ Valid BAM magic number', 'diagnosticResults');
                    } else {
                        log('‚ùå Invalid BAM magic number!', 'diagnosticResults');
                        log('This file is not a valid BAM file.', 'diagnosticResults');
                    }
                    
                    // Check index file
                    const indexPath = bamReader.indexPath;
                    if (indexPath && fs.existsSync(indexPath)) {
                        const indexStats = fs.statSync(indexPath);
                        log(`Index file size: ${indexStats.size.toLocaleString()} bytes`, 'diagnosticResults');
                        log('‚úÖ Index file exists', 'diagnosticResults');
                    } else {
                        log('‚ö†Ô∏è Index file missing or not found', 'diagnosticResults');
                    }
                    
                } catch (fsError) {
                    log(`‚ùå File system error: ${fsError.message}`, 'diagnosticResults');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'diagnosticResults');
            }
        }

        async function compareWithSamtools() {
            clearLog('diagnosticResults');
            log('üî¨ === SAMTOOLS COMPARISON ===', 'diagnosticResults');
            
            log('This section provides commands to run with samtools for comparison:', 'diagnosticResults');
            log('', 'diagnosticResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'diagnosticResults');
                    return;
                }
                
                const filePath = bamReader.filePath;
                log(`Commands for file: ${filePath}`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('1. Check file integrity:', 'diagnosticResults');
                log(`   samtools quickcheck "${filePath}"`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('2. View header:', 'diagnosticResults');
                log(`   samtools view -H "${filePath}"`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('3. Count references:', 'diagnosticResults');
                log(`   samtools view -H "${filePath}" | grep "^@SQ" | wc -l`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('4. List references:', 'diagnosticResults');
                log(`   samtools view -H "${filePath}" | grep "^@SQ"`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('5. Count total reads:', 'diagnosticResults');
                log(`   samtools view -c "${filePath}"`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('6. Check index:', 'diagnosticResults');
                log(`   samtools index "${filePath}"`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('7. Test query (first 1000 bp of first chromosome):', 'diagnosticResults');
                log(`   samtools view "${filePath}" | head -10`, 'diagnosticResults');
                log('', 'diagnosticResults');
                
                log('üí° Run these commands in your terminal to compare results with GenomeExplorer.', 'diagnosticResults');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'diagnosticResults');
            }
        }

        // Auto-update file info on load
        setTimeout(() => {
            updateFileInfo();
            if (window.parent?.genomeBrowser) {
                validateBAMFile();
            }
        }, 1000);

        // Refresh file info every 5 seconds
        setInterval(updateFileInfo, 5000);
    </script>
</body>
</html> 