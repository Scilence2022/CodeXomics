<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefSeq Genome Search Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-test {
            background: #27ae60;
        }
        .btn-test:hover {
            background: #229954;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
        }
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background: #fafafa;
        }
        .result-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        .result-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading {
            background: #e8f4f8;
            color: #1b4f72;
        }
        .status.error {
            background: #fadbd8;
            color: #922b21;
        }
        .status.success {
            background: #d5f4e6;
            color: #145a32;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .api-call {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ RefSeq Genome Search Debug Test</h1>
        <p>Testing and debugging RefSeq genome search functionality in the NCBI unified interface</p>

        <div class="test-section">
            <div class="test-title">üî¨ Test 1: Basic NCBI Genome Database Search</div>
            <div class="form-group">
                <label class="form-label">Search Term</label>
                <input type="text" id="searchTerm1" class="form-input" value="Escherichia coli K12" placeholder="e.g., Escherichia coli K12">
            </div>
            <div class="form-group">
                <label class="form-label">Database</label>
                <select id="database1" class="form-select">
                    <option value="genome">Genome Database</option>
                    <option value="nucleotide">Nucleotide Database</option>
                    <option value="assembly">Assembly Database</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Results Limit</label>
                <select id="limit1" class="form-select">
                    <option value="10">10 results</option>
                    <option value="25" selected>25 results</option>
                    <option value="50">50 results</option>
                </select>
            </div>
            <button class="btn btn-test" onclick="testBasicSearch()">üîç Test Basic Search</button>
            <button class="btn" onclick="clearResults('results1')">üóëÔ∏è Clear</button>
            <div id="results1" class="results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">üî¨ Test 2: Direct NCBI E-utilities API Test</div>
            <div class="form-group">
                <label class="form-label">Search Term</label>
                <input type="text" id="searchTerm2" class="form-input" value="Escherichia coli str. K-12" placeholder="e.g., Escherichia coli str. K-12">
            </div>
            <div class="form-group">
                <label class="form-label">Database</label>
                <select id="database2" class="form-select">
                    <option value="genome">Genome</option>
                    <option value="assembly">Assembly</option>
                    <option value="nucleotide">Nucleotide</option>
                </select>
            </div>
            <button class="btn btn-test" onclick="testDirectAPI()">üîç Test Direct API</button>
            <button class="btn" onclick="clearResults('results2')">üóëÔ∏è Clear</button>
            <div id="results2" class="results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">üî¨ Test 3: Compare Different Search Terms</div>
            <div class="form-group">
                <label class="form-label">Test Multiple Variations</label>
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-test" onclick="testSearchVariations()">üîç Test All Variations</button>
                    <button class="btn" onclick="clearResults('results3')">üóëÔ∏è Clear</button>
                </div>
            </div>
            <div id="results3" class="results"></div>
        </div>

        <div class="test-section">
            <div class="test-title">üî¨ Test 4: GenomicDataDownloader Simulation</div>
            <div class="form-group">
                <label class="form-label">Search Term</label>
                <input type="text" id="searchTerm4" class="form-input" value="Escherichia coli" placeholder="Enter search term">
            </div>
            <div class="form-group">
                <label class="form-label">Database Type</label>
                <select id="database4" class="form-select">
                    <option value="nucleotide">GenBank Nucleotide Sequences</option>
                    <option value="genome" selected>RefSeq Genomes</option>
                    <option value="sra">SRA Sequencing Data</option>
                    <option value="assembly">Assembly Data</option>
                </select>
            </div>
            <button class="btn btn-test" onclick="testGenomicDownloader()">üîç Test Genomic Downloader Logic</button>
            <button class="btn" onclick="clearResults('results4')">üóëÔ∏è Clear</button>
            <div id="results4" class="results"></div>
        </div>
    </div>

    <script>
        let debugInfo = [];

        function showStatus(containerId, message, type = 'loading') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addDebugInfo(info) {
            debugInfo.push(info);
        }

        function displayResults(containerId, results, title = '') {
            const container = document.getElementById(containerId);
            
            let html = '';
            if (title) {
                html += `<h4>${title}</h4>`;
            }

            // Show debug info
            if (debugInfo.length > 0) {
                html += '<div class="debug-info"><strong>Debug Information:</strong><br>';
                debugInfo.forEach(info => {
                    html += `‚Ä¢ ${info}<br>`;
                });
                html += '</div>';
                debugInfo = []; // Clear after displaying
            }

            if (results.length === 0) {
                html += '<div class="status error">‚ùå No results found</div>';
            } else {
                html += `<div class="status success">‚úÖ Found ${results.length} results</div>`;
                results.forEach((result, index) => {
                    html += `
                        <div class="result-item">
                            <div class="result-title">${result.title || result.summary?.title || 'No title'}</div>
                            <div class="result-details">
                                <strong>ID:</strong> ${result.id || 'N/A'} | 
                                <strong>Accession:</strong> ${result.accession || result.summary?.caption || 'N/A'}
                            </div>
                            <div class="result-details">
                                <strong>Organism:</strong> ${result.organism || result.summary?.organism || 'Unknown'} | 
                                <strong>Length:</strong> ${result.length || result.summary?.slen || 0} bp
                            </div>
                            <div class="result-details">${result.description || result.summary?.extra || 'No description'}</div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
            debugInfo = [];
        }

        async function testBasicSearch() {
            const searchTerm = document.getElementById('searchTerm1').value;
            const database = document.getElementById('database1').value;
            const limit = document.getElementById('limit1').value;

            showStatus('results1', 'üîç Searching NCBI database...');
            addDebugInfo(`Search Term: ${searchTerm}`);
            addDebugInfo(`Database: ${database}`);
            addDebugInfo(`Limit: ${limit}`);

            try {
                const results = await performNCBISearch(searchTerm, database, limit);
                displayResults('results1', results, `Basic Search Results (${database} database)`);
            } catch (error) {
                addDebugInfo(`Error: ${error.message}`);
                displayResults('results1', [], 'Basic Search Failed');
            }
        }

        async function testDirectAPI() {
            const searchTerm = document.getElementById('searchTerm2').value;
            const database = document.getElementById('database2').value;

            showStatus('results2', 'üîç Testing direct NCBI E-utilities API...');

            try {
                // Step 1: Search
                const searchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=${database}&term=${encodeURIComponent(searchTerm)}&retmax=10&retmode=json`;
                addDebugInfo(`Search URL: ${searchUrl}`);

                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                addDebugInfo(`Search found ${searchData.esearchresult?.count || 0} total results`);
                addDebugInfo(`Retrieved ${searchData.esearchresult?.idlist?.length || 0} IDs`);

                if (!searchData.esearchresult?.idlist?.length) {
                    displayResults('results2', [], 'Direct API Test - No IDs found');
                    return;
                }

                // Step 2: Get summaries
                const ids = searchData.esearchresult.idlist.join(',');
                const summaryUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=${database}&id=${ids}&retmode=json`;
                addDebugInfo(`Summary URL: ${summaryUrl}`);

                const summaryResponse = await fetch(summaryUrl);
                const summaryData = await summaryResponse.json();

                const results = [];
                for (const id of searchData.esearchresult.idlist) {
                    const summary = summaryData.result?.[id];
                    if (summary) {
                        results.push({
                            id: id,
                            accession: summary.caption || summary.accessionversion || id,
                            title: summary.title || 'No title available',
                            organism: summary.organism || 'Unknown',
                            length: summary.slen || 0,
                            description: summary.extra || '',
                            summary: summary
                        });
                    }
                }

                displayResults('results2', results, 'Direct API Test Results');
            } catch (error) {
                addDebugInfo(`API Error: ${error.message}`);
                displayResults('results2', [], 'Direct API Test Failed');
            }
        }

        async function testSearchVariations() {
            showStatus('results3', 'üîç Testing multiple search term variations...');

            const variations = [
                'Escherichia coli K12',
                'Escherichia coli str. K-12',
                'Escherichia coli K-12',
                'E. coli K12',
                'E. coli str. K-12',
                'Escherichia coli[organism]',
                '"Escherichia coli str. K-12"[organism]'
            ];

            let allResults = [];

            for (const term of variations) {
                try {
                    addDebugInfo(`Testing: "${term}"`);
                    const results = await performNCBISearch(term, 'genome', 5);
                    allResults.push({
                        searchTerm: term,
                        count: results.length,
                        results: results
                    });
                } catch (error) {
                    addDebugInfo(`Error with "${term}": ${error.message}`);
                    allResults.push({
                        searchTerm: term,
                        count: 0,
                        results: [],
                        error: error.message
                    });
                }
            }

            // Display comparison results
            let html = '<h4>Search Term Variation Results</h4>';
            allResults.forEach(test => {
                html += `
                    <div class="result-item">
                        <div class="result-title">Search: "${test.searchTerm}"</div>
                        <div class="result-details">
                            <strong>Results Found:</strong> ${test.count}
                            ${test.error ? ` | <span style="color: red;">Error: ${test.error}</span>` : ''}
                        </div>
                        ${test.results.slice(0, 2).map(r => `
                            <div class="result-details" style="margin-left: 20px; font-size: 12px;">
                                ‚Üí ${r.title} (${r.organism})
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            document.getElementById('results3').innerHTML = html;
        }

        async function testGenomicDownloader() {
            const searchTerm = document.getElementById('searchTerm4').value;
            const database = document.getElementById('database4').value;

            showStatus('results4', 'üîç Testing GenomicDataDownloader logic...');
            
            try {
                // Simulate the exact logic from GenomicDataDownloader
                addDebugInfo('Simulating GenomicDataDownloader.searchNCBIUnified()');
                addDebugInfo(`Search term: ${searchTerm}`);
                addDebugInfo(`Selected database: ${database}`);

                // Build query with potential filters (simulate form inputs)
                let query = searchTerm;
                
                // Add organism filter if specified
                // const organism = ''; // No organism filter for this test
                
                // Add length filters if specified  
                // const minLength = '', maxLength = ''; // No length filters for this test

                const baseUrl = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
                const resultsLimit = 25;

                // Step 1: Search
                const searchUrl = `${baseUrl}esearch.fcgi?db=${database}&term=${encodeURIComponent(query)}&retmax=${resultsLimit}&retmode=json`;
                addDebugInfo(`Generated search URL: ${searchUrl}`);

                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                addDebugInfo(`Search response count: ${searchData.esearchresult?.count || 0}`);
                addDebugInfo(`IDs returned: ${searchData.esearchresult?.idlist?.length || 0}`);

                if (!searchData.esearchresult?.idlist?.length) {
                    displayResults('results4', [], 'GenomicDataDownloader Simulation - No results');
                    return;
                }

                // Step 2: Get detailed info
                const ids = searchData.esearchresult.idlist.join(',');
                const summaryUrl = `${baseUrl}esummary.fcgi?db=${database}&id=${ids}&retmode=json`;
                addDebugInfo(`Generated summary URL: ${summaryUrl}`);

                const summaryResponse = await fetch(summaryUrl);
                const summaryData = await summaryResponse.json();

                const results = [];
                for (const id of searchData.esearchresult.idlist) {
                    const summary = summaryData.result[id];
                    if (summary) {
                        results.push({
                            id: id,
                            accession: summary.caption || summary.accessionversion || id,
                            title: summary.title || 'No title available',
                            organism: summary.organism || 'Unknown',
                            length: summary.slen || 0,
                            description: summary.extra || '',
                            database: database,
                            downloadUrl: getNCBIDownloadUrl(id, database)
                        });
                    }
                }

                addDebugInfo(`Processed ${results.length} results successfully`);
                displayResults('results4', results, 'GenomicDataDownloader Simulation Results');

            } catch (error) {
                addDebugInfo(`Simulation error: ${error.message}`);
                displayResults('results4', [], 'GenomicDataDownloader Simulation Failed');
            }
        }

        async function performNCBISearch(searchTerm, database, limit = 25) {
            const baseUrl = 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/';
            
            // Search step
            const searchUrl = `${baseUrl}esearch.fcgi?db=${database}&term=${encodeURIComponent(searchTerm)}&retmax=${limit}&retmode=json`;
            const searchResponse = await fetch(searchUrl);
            const searchData = await searchResponse.json();

            if (!searchData.esearchresult?.idlist?.length) {
                return [];
            }

            // Summary step
            const ids = searchData.esearchresult.idlist.join(',');
            const summaryUrl = `${baseUrl}esummary.fcgi?db=${database}&id=${ids}&retmode=json`;
            
            const summaryResponse = await fetch(summaryUrl);
            const summaryData = await summaryResponse.json();

            const results = [];
            for (const id of searchData.esearchresult.idlist) {
                const summary = summaryData.result[id];
                if (summary) {
                    results.push({
                        id: id,
                        accession: summary.caption || summary.accessionversion || id,
                        title: summary.title || 'No title available',
                        organism: summary.organism || 'Unknown',
                        length: summary.slen || 0,
                        description: summary.extra || '',
                        database: database
                    });
                }
            }

            return results;
        }

        function getNCBIDownloadUrl(id, database) {
            const formatMap = {
                'nucleotide': 'fasta',
                'genome': 'fasta',
                'assembly': 'fasta',
                'sra': 'runinfo'
            };
            
            const format = formatMap[database] || 'fasta';
            return `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=${database}&id=${id}&rettype=${format}&retmode=text`;
        }

        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Page loaded, ready for testing RefSeq genome search functionality');
            }, 1000);
        });
    </script>
</body>
</html> 