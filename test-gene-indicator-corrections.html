<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Indicator Bar Corrections Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            margin: 20px;
            line-height: 1.6;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-header {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .correction-controls {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .control-section {
            margin-bottom: 20px;
        }
        
        .control-section h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        .control-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .control-group .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 3px;
        }
        
        .apply-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .apply-btn:hover {
            background: #0056b3;
        }
        
        .reset-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        
        .reset-btn:hover {
            background: #545b62;
        }
        
        .demo-section {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .sequence-line-group {
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .sequence-line {
            display: flex;
            margin-bottom: 4px;
            font-size: 14px;
            align-items: flex-start;
        }

        .sequence-position {
            display: inline-block;
            width: 100px;
            color: #666;
            text-align: right;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .sequence-bases {
            flex: 1;
        }

        .gene-indicator-line {
            margin-left: 115px;
            margin-top: 2px;
            margin-bottom: 8px;
        }

        .gene-indicator-svg {
            display: block;
        }

        .correction-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .correction-info h4 {
            color: #0066cc;
            margin-bottom: 10px;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
        }
        
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .feature-list li:last-child {
            border-bottom: none;
        }
        
        .feature-list strong {
            color: #2c3e50;
        }
        
        .test-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .test-instructions h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .current-values {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-header">üéõÔ∏è Gene Indicator Bar Position & Size Corrections Test</h1>
        
        <div class="correction-info">
            <h4>üîß New Correction Features</h4>
            <ul class="feature-list">
                <li><strong>Horizontal Offset:</strong> Move indicators left/right (¬±50px)</li>
                <li><strong>Vertical Offset:</strong> Move indicators up/down (¬±20px)</li>
                <li><strong>Height Correction:</strong> Scale indicator height (50-200%)</li>
                <li><strong>Width Correction:</strong> Scale indicator width (50-200%)</li>
            </ul>
        </div>
        
        <div class="correction-controls">
            <h3>üéöÔ∏è Correction Controls</h3>
            
            <div class="control-section">
                <h4>Position Corrections</h4>
                <div class="control-row">
                    <div class="control-group">
                        <label for="horizontalOffset">Horizontal Offset (px)</label>
                        <input type="number" id="horizontalOffset" min="-50" max="50" step="0.5" value="0">
                        <div class="help-text">Positive = right, Negative = left</div>
                    </div>
                    <div class="control-group">
                        <label for="verticalOffset">Vertical Offset (px)</label>
                        <input type="number" id="verticalOffset" min="-20" max="20" step="0.5" value="0">
                        <div class="help-text">Positive = down, Negative = up</div>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h4>Size Corrections</h4>
                <div class="control-row">
                    <div class="control-group">
                        <label for="heightCorrection">Height Correction (%)</label>
                        <input type="number" id="heightCorrection" min="50" max="200" step="5" value="100">
                        <div class="help-text">100% = normal, 150% = 1.5x height</div>
                    </div>
                    <div class="control-group">
                        <label for="widthCorrection">Width Correction (%)</label>
                        <input type="number" id="widthCorrection" min="50" max="200" step="5" value="100">
                        <div class="help-text">100% = normal, 120% = 1.2x width</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="apply-btn" onclick="applyCorrections()">Apply Corrections</button>
                <button class="reset-btn" onclick="resetCorrections()">Reset to Default</button>
            </div>
            
            <div class="current-values" id="currentValues">
                Current: H=0px, V=0px, Height=100%, Width=100%
            </div>
        </div>
        
        <div class="demo-section">
            <h3>üìä Live Demo - Gene Indicators with Corrections</h3>
            <div id="sequence-demo">
                <!-- Demo content will be inserted here -->
            </div>
        </div>
        
        <div class="test-instructions">
            <h4>üìã Testing Instructions</h4>
            <ol>
                <li><strong>Horizontal Offset:</strong> Try values like -10, 0, +10 to see left/right movement</li>
                <li><strong>Vertical Offset:</strong> Try values like -5, 0, +5 to see up/down movement</li>
                <li><strong>Height Correction:</strong> Try 75%, 100%, 150% to see height scaling</li>
                <li><strong>Width Correction:</strong> Try 80%, 100%, 120% to see width scaling</li>
                <li><strong>Combined Effects:</strong> Test multiple corrections together</li>
                <li><strong>Extreme Values:</strong> Test edge cases like 50% and 200%</li>
            </ol>
        </div>
    </div>

    <script>
        // Settings object with correction values
        let settings = {
            horizontalOffset: 0,
            verticalOffset: 0,
            heightCorrection: 100,
            widthCorrection: 100,
            indicatorHeight: 12,
            indicatorOpacity: 0.7,
            showStartMarkers: true,
            showEndArrows: true,
            startMarkerWidth: 6,
            startMarkerHeight: 200,
            arrowSize: 12,
            arrowHeight: 200
        };
        
        function applyCorrections() {
            // Get values from controls
            settings.horizontalOffset = parseFloat(document.getElementById('horizontalOffset').value) || 0;
            settings.verticalOffset = parseFloat(document.getElementById('verticalOffset').value) || 0;
            settings.heightCorrection = parseInt(document.getElementById('heightCorrection').value) || 100;
            settings.widthCorrection = parseInt(document.getElementById('widthCorrection').value) || 100;
            
            // Update display
            updateCurrentValues();
            generateDemo();
        }
        
        function resetCorrections() {
            // Reset all controls to default
            document.getElementById('horizontalOffset').value = 0;
            document.getElementById('verticalOffset').value = 0;
            document.getElementById('heightCorrection').value = 100;
            document.getElementById('widthCorrection').value = 100;
            
            // Apply reset
            applyCorrections();
        }
        
        function updateCurrentValues() {
            const display = document.getElementById('currentValues');
            display.textContent = `Current: H=${settings.horizontalOffset}px, V=${settings.verticalOffset}px, Height=${settings.heightCorrection}%, Width=${settings.widthCorrection}%`;
        }
        
        function createCorrectedGeneIndicator(x, width, height, type, color, isForward, hasStart, hasEnd, charWidth) {
            if (!settings) return '';
            
            // Apply corrections
            const heightCorrection = settings.heightCorrection / 100;
            const widthCorrection = settings.widthCorrection / 100;
            
            const correctedHeight = height * heightCorrection;
            const correctedWidth = width * widthCorrection;
            const correctedCharWidth = charWidth * widthCorrection;
            const correctedX = x * widthCorrection;
            
            let indicator = '';
            const opacity = settings.indicatorOpacity;
            
            // Gene body with corrected dimensions
            if (type === 'Promoter') {
                if (isForward) {
                    indicator += `<path d="M ${correctedX} 3 L ${correctedX + correctedWidth - 6} 3 L ${correctedX + correctedWidth} ${correctedHeight/2} L ${correctedX + correctedWidth - 6} ${correctedHeight - 3} L ${correctedX} ${correctedHeight - 3} Z" fill="${color}" opacity="${opacity}"/>`;
                } else {
                    indicator += `<path d="M ${correctedX + 6} 3 L ${correctedX + correctedWidth} 3 L ${correctedX + correctedWidth} ${correctedHeight - 3} L ${correctedX + 6} ${correctedHeight - 3} L ${correctedX} ${correctedHeight/2} Z" fill="${color}" opacity="${opacity}"/>`;
                }
            } else if (type === 'Terminator') {
                indicator += `<rect x="${correctedX}" y="3" width="${correctedWidth}" height="${correctedHeight - 6}" rx="3" ry="3" fill="${color}" opacity="${opacity}"/>`;
            } else if (['tRNA', 'rRNA'].includes(type)) {
                indicator += `<path d="M ${correctedX} 5 Q ${correctedX + correctedWidth/4} 3 ${correctedX + correctedWidth/2} 4 Q ${correctedX + 3*correctedWidth/4} 3 ${correctedX + correctedWidth} 5 L ${correctedX + correctedWidth} ${correctedHeight - 3} L ${correctedX} ${correctedHeight - 3} Z" fill="${color}" opacity="${opacity}"/>`;
            } else {
                indicator += `<rect x="${correctedX}" y="3" width="${correctedWidth}" height="${correctedHeight - 6}" fill="${color}" opacity="${opacity}"/>`;
            }
            
            // Start marker with corrected height and position
            if (hasStart && settings.showStartMarkers) {
                const markerWidth = settings.startMarkerWidth;
                const markerHeightPercent = settings.startMarkerHeight;
                const markerHeight = (correctedHeight * markerHeightPercent / 100);
                const markerOffset = (correctedHeight - markerHeight) / 2;
                
                const markerX = isForward ? correctedX : correctedX + correctedWidth;
                indicator += `<line x1="${markerX}" y1="${markerOffset}" x2="${markerX}" y2="${markerOffset + markerHeight}" 
                                   stroke="${darkenColor(color, 30)}" stroke-width="${markerWidth}" opacity="0.9"/>`;
            }
            
            // End arrow with corrected height and position
            if (hasEnd && settings.showEndArrows) {
                const arrowSize = settings.arrowSize;
                const arrowHeightPercent = settings.arrowHeight;
                const arrowHeight = (correctedHeight * arrowHeightPercent / 100);
                const arrowOffset = (correctedHeight - arrowHeight) / 2;
                const darkColor = darkenColor(color, 40);
                
                const arrowTop = arrowOffset;
                const arrowMiddle = correctedHeight / 2;
                const arrowBottom = arrowOffset + arrowHeight;
                
                if (isForward) {
                    const arrowX = correctedX + correctedWidth;
                    indicator += `<path d="M ${arrowX-arrowSize} ${arrowTop} L ${arrowX} ${arrowMiddle} L ${arrowX-arrowSize} ${arrowBottom} Z" 
                                       fill="${darkColor}" opacity="1"/>`;
                } else {
                    const arrowX = correctedX;
                    indicator += `<path d="M ${arrowX+arrowSize} ${arrowTop} L ${arrowX} ${arrowMiddle} L ${arrowX+arrowSize} ${arrowBottom} Z" 
                                       fill="${darkColor}" opacity="1"/>`;
                }
            }
            
            return indicator;
        }
        
        function darkenColor(hex, percent) {
            // Simple color darkening function
            const r = parseInt(hex.substring(1, 3), 16);
            const g = parseInt(hex.substring(3, 5), 16);
            const b = parseInt(hex.substring(5, 7), 16);
            
            const factor = (100 - percent) / 100;
            const newR = Math.round(r * factor);
            const newG = Math.round(g * factor);
            const newB = Math.round(b * factor);
            
            const toHex = (n) => {
                const hex = n.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            
            return `#${toHex(newR)}${toHex(newG)}${toHex(newB)}`;
        }
        
        function generateDemo() {
            const container = document.getElementById('sequence-demo');
            const charWidth = 12; // Character width in pixels
            
            // Apply position corrections to the indicator line
            const horizontalOffset = settings.horizontalOffset || 0;
            const verticalOffset = settings.verticalOffset || 0;
            const heightCorrection = settings.heightCorrection / 100;
            const widthCorrection = settings.widthCorrection / 100;
            
            const baseHeight = settings.indicatorHeight;
            const correctedHeight = baseHeight * heightCorrection;
            const correctedLineWidth = 60 * charWidth * widthCorrection; // 60 characters per line
            
            const correctedMarginLeft = 115 + horizontalOffset; // 115px base margin + offset
            const correctedMarginTop = 2 + verticalOffset;
            const correctedMarginBottom = 8 - verticalOffset;
            
            container.innerHTML = `
                <div class="sequence-line-group">
                    <div class="sequence-line">
                        <span class="sequence-position">1</span>
                        <div class="sequence-bases">ATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCC</div>
                    </div>
                    <div class="gene-indicator-line" style="margin-left: ${correctedMarginLeft}px; margin-top: ${correctedMarginTop}px; margin-bottom: ${correctedMarginBottom}px;">
                        <svg class="gene-indicator-svg" style="width: ${correctedLineWidth}px; height: ${correctedHeight}px;">
                            ${createCorrectedGeneIndicator(0, 60, baseHeight, 'Promoter', '#f1c40f', true, true, true, charWidth)}
                            ${createCorrectedGeneIndicator(80, 180, baseHeight, 'CDS', '#8e44ad', true, true, true, charWidth)}
                            ${createCorrectedGeneIndicator(280, 60, baseHeight, 'Terminator', '#d35400', true, true, true, charWidth)}
                        </svg>
                    </div>
                </div>
                
                <div class="sequence-line-group">
                    <div class="sequence-line">
                        <span class="sequence-position">61</span>
                        <div class="sequence-bases">GCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGC</div>
                    </div>
                    <div class="gene-indicator-line" style="margin-left: ${correctedMarginLeft}px; margin-top: ${correctedMarginTop}px; margin-bottom: ${correctedMarginBottom}px;">
                        <svg class="gene-indicator-svg" style="width: ${correctedLineWidth}px; height: ${correctedHeight}px;">
                            ${createCorrectedGeneIndicator(0, 120, baseHeight, 'tRNA', '#2196F3', false, true, true, charWidth)}
                            ${createCorrectedGeneIndicator(160, 200, baseHeight, 'CDS', '#4CAF50', false, true, true, charWidth)}
                        </svg>
                    </div>
                </div>
                
                <div class="sequence-line-group">
                    <div class="sequence-line">
                        <span class="sequence-position">121</span>
                        <div class="sequence-bases">TACGCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAAAGCCATGCGTAA</div>
                    </div>
                    <div class="gene-indicator-line" style="margin-left: ${correctedMarginLeft}px; margin-top: ${correctedMarginTop}px; margin-bottom: ${correctedMarginBottom}px;">
                        <svg class="gene-indicator-svg" style="width: ${correctedLineWidth}px; height: ${correctedHeight}px;">
                            ${createCorrectedGeneIndicator(40, 100, baseHeight, 'rRNA', '#2196F3', true, true, true, charWidth)}
                            ${createCorrectedGeneIndicator(200, 80, baseHeight, 'Promoter', '#FF9800', false, true, true, charWidth)}
                            ${createCorrectedGeneIndicator(320, 120, baseHeight, 'CDS', '#9C27B0', true, true, true, charWidth)}
                        </svg>
                    </div>
                </div>
            `;
        }
        
        // Initialize demo
        updateCurrentValues();
        generateDemo();
        
        // Add event listeners for real-time updates
        document.getElementById('horizontalOffset').addEventListener('input', applyCorrections);
        document.getElementById('verticalOffset').addEventListener('input', applyCorrections);
        document.getElementById('heightCorrection').addEventListener('input', applyCorrections);
        document.getElementById('widthCorrection').addEventListener('input', applyCorrections);
    </script>
</body>
</html> 