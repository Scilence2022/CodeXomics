<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reads Drag-to-Follow Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h3 {
            color: #495057;
            margin-top: 0;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        .fix-details {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .fix-details h4 {
            color: #155724;
            margin-top: 0;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .error-block {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            color: #721c24;
            margin: 10px 0;
        }
        .success-block {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            padding: 15px;
            color: #0c5460;
            margin: 10px 0;
        }
        .test-steps {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        .test-steps h4 {
            color: #856404;
            margin-top: 0;
        }
        .step-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        .step-list li {
            margin-bottom: 8px;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üñ±Ô∏è BAM Reads Drag-to-Follow Functionality Fix</h1>
        <p>Fix for "navigateToPosition is not a function" error in reads track drag interaction</p>
        <p><strong>Test Date:</strong> <span id="currentDate"></span></p>
    </div>

    <div class="test-section">
        <h3>üêõ Problem Description</h3>
        <p>When enabling the "drag-to-follow interaction" setting in BAM reads track, dragging the track caused JavaScript errors:</p>
        
        <div class="error-block">
            <strong>Error:</strong> <code>Uncaught TypeError: this.genomeBrowser.navigateToPosition is not a function</code><br>
            <strong>Location:</strong> TrackRenderer.js:6768<br>
            <strong>Trigger:</strong> Mouse drag events on reads track with drag-to-follow enabled
        </div>

        <p><strong>Root Cause:</strong> The TrackRenderer was calling a non-existent method <code>this.genomeBrowser.navigateToPosition()</code> instead of using the correct navigation API.</p>
    </div>

    <div class="test-section">
        <h3>üîç Investigation Results</h3>
        <p>Analysis of the GenomeExplorer navigation system revealed:</p>
        
        <div class="code-block">
<strong>‚ùå Incorrect approach:</strong>
this.genomeBrowser.navigateToPosition(newStart, newEnd);

<strong>‚úÖ Correct approach:</strong>
MicrobeGenomicsFunctions.navigateTo(chromosome, newStart, newEnd);
        </div>

        <p><strong>Key findings:</strong></p>
        <ul>
            <li>GenomeBrowser class does not have a <code>navigateToPosition</code> method</li>
            <li>Navigation functionality is provided by <code>MicrobeGenomicsFunctions.navigateTo()</code></li>
            <li>NavigationManager handles UI-triggered navigation but doesn't expose a direct API</li>
            <li>MicrobeGenomicsFunctions is the standard API for programmatic navigation</li>
        </ul>
    </div>

    <div class="fix-details">
        <h4>üõ†Ô∏è Applied Fix</h4>
        <p><strong>File:</strong> <code>src/renderer/modules/TrackRenderer.js</code></p>
        <p><strong>Method:</strong> <code>addReadsTrackDragFollow()</code> - line ~6768</p>
        
        <div class="code-block">
<strong>Before (broken):</strong>
// Update the genome browser view
this.genomeBrowser.navigateToPosition(newStart, newEnd);

<strong>After (fixed):</strong>
// Update the genome browser view using MicrobeGenomicsFunctions
if (window.MicrobeGenomicsFunctions) {
    MicrobeGenomicsFunctions.navigateTo(this.genomeBrowser.currentChromosome, newStart, newEnd);
} else {
    console.warn('MicrobeGenomicsFunctions not available for navigation');
}
        </div>

        <p><strong>Fix Benefits:</strong></p>
        <ul>
            <li>‚úÖ Uses the correct navigation API</li>
            <li>‚úÖ Includes safety check for MicrobeGenomicsFunctions availability</li>
            <li>‚úÖ Maintains backward compatibility</li>
            <li>‚úÖ Provides proper error handling and logging</li>
        </ul>
    </div>

    <div class="test-steps">
        <h4>üß™ Testing Instructions</h4>
        <ol class="step-list">
            <li><strong>Load BAM File:</strong> Open a BAM file in GenomeExplorer</li>
            <li><strong>Enable Reads Track:</strong> Make sure aligned reads track is visible</li>
            <li><strong>Open Track Settings:</strong> Click the settings button on reads track</li>
            <li><strong>Enable Drag-to-Follow:</strong> Check "Enable drag-to-follow interaction" in Advanced Options</li>
            <li><strong>Apply Settings:</strong> Click "Apply Settings" to save changes</li>
            <li><strong>Test Dragging:</strong> Try dragging left/right on the reads track</li>
            <li><strong>Verify Navigation:</strong> Confirm the view position updates without console errors</li>
            <li><strong>Check Console:</strong> Ensure no "navigateToPosition is not a function" errors appear</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>‚úÖ Expected Results</h3>
        <div class="success-block">
            <strong>Successful Test Criteria:</strong>
            <ul>
                <li>No JavaScript errors in console when dragging reads track</li>
                <li>Smooth navigation when dragging left/right on reads track</li>
                <li>View position updates correctly during drag operations</li>
                <li>Drag-to-follow functionality works as intended</li>
                <li>Console shows proper drag logging: "üñ±Ô∏è [Reads Drag] Moving view by X bp to Y - Z"</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h3>üîß Technical Details</h3>
        
        <h4>Navigation API Usage:</h4>
        <div class="code-block">
// MicrobeGenomicsFunctions.navigateTo() signature:
MicrobeGenomicsFunctions.navigateTo(chromosome, start, end)

// Parameters:
// - chromosome: Target chromosome/contig name
// - start: Start position (1-based)  
// - end: End position (1-based)

// Example usage:
MicrobeGenomicsFunctions.navigateTo('NC_000913.3', 2280068, 2290068);
        </div>

        <h4>Drag-to-Follow Logic:</h4>
        <ul>
            <li><strong>Drag Detection:</strong> Invisible SVG overlay captures mouse events</li>
            <li><strong>Position Calculation:</strong> Mouse delta converted to base pairs using basePairsPerPixel ratio</li>
            <li><strong>Navigation Throttling:</strong> Updates only when movement exceeds 1% of current view range</li>
            <li><strong>Coordinate System:</strong> Drag right moves view left (inverted for intuitive interaction)</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>üìù Related Components</h3>
        <p><strong>Files involved in this fix:</strong></p>
        <ul>
            <li><code>src/renderer/modules/TrackRenderer.js</code> - Fixed drag-to-follow navigation call</li>
            <li><code>src/renderer/modules/MicrobeGenomicsFunctions.js</code> - Provides navigation API</li>
            <li><code>src/renderer/renderer-modular.js</code> - GenomeBrowser main class</li>
            <li><code>src/renderer/modules/NavigationManager.js</code> - UI navigation handling</li>
        </ul>
    </div>

    <script>
        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        
        // Add some interactive testing helpers
        console.log('üß™ Reads Drag-to-Follow Fix Test loaded');
        console.log('üìã To test: Enable drag-to-follow in reads track settings and try dragging');
        
        // Helper function to validate MicrobeGenomicsFunctions availability
        window.validateNavigationAPI = function() {
            if (typeof MicrobeGenomicsFunctions !== 'undefined' && MicrobeGenomicsFunctions.navigateTo) {
                console.log('‚úÖ MicrobeGenomicsFunctions.navigateTo is available');
                return true;
            } else {
                console.log('‚ùå MicrobeGenomicsFunctions.navigateTo is NOT available');
                return false;
            }
        };
        
        // Helper function to test navigation API
        window.testNavigationAPI = function(chromosome = 'NC_000913.3', start = 1000000, end = 1010000) {
            if (validateNavigationAPI()) {
                try {
                    console.log(`üîÑ Testing navigation to ${chromosome}:${start}-${end}`);
                    MicrobeGenomicsFunctions.navigateTo(chromosome, start, end);
                    console.log('‚úÖ Navigation API test successful');
                    return true;
                } catch (error) {
                    console.error('‚ùå Navigation API test failed:', error);
                    return false;
                }
            }
            return false;
        };
        
        // Make test functions available globally
        window.testFunctions = {
            validateNavigationAPI,
            testNavigationAPI
        };
        
        console.log('üõ†Ô∏è Test functions available: window.testFunctions.validateNavigationAPI() and window.testFunctions.testNavigationAPI()');
    </script>
</body>
</html> 