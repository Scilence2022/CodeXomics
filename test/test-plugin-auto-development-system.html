<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插件自动开发系统测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .test-header {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .test-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .test-button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .test-button.primary {
            background-color: #3498db;
            color: white;
        }
        
        .test-button.primary:hover {
            background-color: #2980b9;
        }
        
        .test-button.success {
            background-color: #27ae60;
            color: white;
        }
        
        .test-button.success:hover {
            background-color: #229954;
        }
        
        .test-button.warning {
            background-color: #f39c12;
            color: white;
        }
        
        .test-button.warning:hover {
            background-color: #e67e22;
        }
        
        .test-button.danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .test-button.danger:hover {
            background-color: #c0392b;
        }
        
        .test-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .test-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }
        
        .test-output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }
        
        .code-preview {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🔧 插件自动开发系统测试</h1>
            <p>测试GenomeExplorer的插件自动开发功能，包括需求分析、代码生成、调试测试和自动安装</p>
        </div>

        <!-- 系统状态 -->
        <div class="test-section">
            <h3>📊 系统状态</h3>
            <div class="stats-grid" id="systemStats">
                <div class="stat-card">
                    <div class="stat-value" id="activeProjects">0</div>
                    <div class="stat-label">活跃项目</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProjects">0</div>
                    <div class="stat-label">总项目数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="successRate">0%</div>
                    <div class="stat-label">成功率</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTime">0s</div>
                    <div class="stat-label">平均开发时间</div>
                </div>
            </div>
            <div class="test-controls">
                <button class="test-button primary" onclick="refreshSystemStatus()">刷新状态</button>
                <button class="test-button success" onclick="initializeSystem()">初始化系统</button>
                <button class="test-button danger" onclick="resetSystem()">重置系统</button>
            </div>
        </div>

        <!-- 插件开发测试 -->
        <div class="test-section">
            <h3>🚀 插件开发测试</h3>
            <label for="requirementInput">插件开发需求：</label>
            <textarea 
                id="requirementInput" 
                class="test-textarea" 
                placeholder="请描述你想要开发的插件功能，例如：&#10;- 创建一个基因序列GC含量分析插件&#10;- 开发一个蛋白质结构可视化工具&#10;- 制作一个系统发育树构建插件">创建一个基因序列GC含量分析插件，能够分析DNA序列的GC含量分布，生成统计图表，并支持批量处理多个序列文件。</textarea>
            
            <label for="developmentMode">开发模式：</label>
            <select id="developmentMode" class="test-input">
                <option value="interactive">交互式开发</option>
                <option value="automatic">自动开发</option>
            </select>
            
            <div class="test-controls">
                <button class="test-button primary" onclick="startPluginDevelopment()">开始开发</button>
                <button class="test-button warning" onclick="testRequirementAnalysis()">仅测试需求分析</button>
                <button class="test-button success" onclick="simulateDevelopment()">模拟开发流程</button>
            </div>
            
            <div id="developmentProgress" style="display: none;">
                <h4>开发进度：</h4>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
                </div>
                <div id="currentPhase" class="status-info status-indicator">准备中...</div>
            </div>
        </div>

        <!-- 组件测试 -->
        <div class="test-section">
            <h3>🔧 组件测试</h3>
            <div class="test-controls">
                <button class="test-button primary" onclick="testRequirementAnalyzer()">测试需求分析器</button>
                <button class="test-button primary" onclick="testCodeGenerator()">测试代码生成器</button>
                <button class="test-button primary" onclick="testDebugTools()">测试调试工具</button>
                <button class="test-button primary" onclick="testInstallationManager()">测试安装管理器</button>
                <button class="test-button primary" onclick="testChatBoxIntegration()">测试ChatBox集成</button>
            </div>
        </div>

        <!-- ChatBox集成测试 -->
        <div class="test-section">
            <h3>💬 ChatBox集成测试</h3>
            <label for="chatMessage">模拟ChatBox消息：</label>
            <textarea 
                id="chatMessage" 
                class="test-textarea" 
                placeholder="输入模拟的ChatBox消息，测试自动检测插件开发需求">我需要一个能够分析蛋白质序列的插件，可以预测蛋白质的二级结构</textarea>
            
            <div class="test-controls">
                <button class="test-button primary" onclick="testChatDetection()">测试意图检测</button>
                <button class="test-button success" onclick="simulateChatDevelopment()">模拟Chat开发</button>
                <button class="test-button warning" onclick="testInteractiveFlow()">测试交互流程</button>
            </div>
        </div>

        <!-- 代码预览 -->
        <div class="test-section">
            <h3>💻 生成代码预览</h3>
            <div class="test-controls">
                <button class="test-button primary" onclick="previewMainCode()">预览主代码</button>
                <button class="test-button primary" onclick="previewManifest()">预览Manifest</button>
                <button class="test-button primary" onclick="previewTests()">预览测试代码</button>
                <button class="test-button primary" onclick="previewDocs()">预览文档</button>
            </div>
            <div id="codePreview" class="code-preview" style="display: none;"></div>
        </div>

        <!-- 测试输出 -->
        <div class="test-section">
            <h3>📋 测试输出</h3>
            <div class="test-controls">
                <button class="test-button warning" onclick="clearOutput()">清空输出</button>
                <button class="test-button success" onclick="exportTestResults()">导出结果</button>
            </div>
            <div id="testOutput" class="test-output"></div>
        </div>
    </div>

    <!-- 加载必要的模块 -->
    <script src="../src/renderer/modules/PluginAutoDeveloper.js"></script>
    <script src="../src/renderer/modules/PluginRequirementAnalyzer.js"></script>
    <script src="../src/renderer/modules/EnhancedPluginCodeGenerator.js"></script>
    <script src="../src/renderer/modules/PluginDebugTools.js"></script>
    <script src="../src/renderer/modules/PluginInstallationManager.js"></script>
    <script src="../src/renderer/modules/PluginDevelopmentChatBoxIntegration.js"></script>

    <script>
        // 全局变量
        let pluginAutoDeveloper = null;
        let currentProject = null;
        let testResults = [];

        // 模拟App对象
        const mockApp = {
            llmConfigManager: {
                isConfigured: () => Math.random() > 0.5, // 随机模拟LLM是否配置
                sendMessageWithHistory: async (messages) => {
                    // 模拟LLM响应
                    const responses = {
                        analysis: '这是一个基因序列分析需求，需要实现GC含量计算功能。',
                        code: 'class GCAnalysisPlugin { constructor() { this.name = "GC Analysis Plugin"; } }',
                        enhancement: '优化后的代码包含更好的错误处理和性能优化。'
                    };
                    const keys = Object.keys(responses);
                    return responses[keys[Math.floor(Math.random() * keys.length)]];
                }
            },
            pluginManagerV2: {
                getPlugin: (id) => null,
                registerPlugin: async (id, definition) => {
                    logOutput(`插件 ${id} 已注册`, 'success');
                    return true;
                }
            },
            configManager: {},
            chatManager: {
                registerFunction: async (func) => {
                    logOutput(`ChatBox函数 ${func.name} 已注册`, 'info');
                },
                addSystemMessage: async (message) => {
                    logOutput(`ChatBox消息: ${message.content}`, 'info');
                },
                on: (event, handler) => {
                    logOutput(`监听ChatBox事件: ${event}`, 'info');
                }
            }
        };

        // 初始化系统
        async function initializeSystem() {
            try {
                logOutput('正在初始化插件自动开发系统...', 'info');
                
                pluginAutoDeveloper = new PluginAutoDeveloper(mockApp, {
                    debugMode: true,
                    enableLLMEnhancement: true
                });
                
                await pluginAutoDeveloper.initialize();
                
                logOutput('✅ 插件自动开发系统初始化完成', 'success');
                refreshSystemStatus();
                
            } catch (error) {
                logOutput(`❌ 系统初始化失败: ${error.message}`, 'error');
            }
        }

        // 刷新系统状态
        function refreshSystemStatus() {
            if (!pluginAutoDeveloper) {
                logOutput('系统未初始化', 'warning');
                return;
            }

            const stats = pluginAutoDeveloper.getSystemStats();
            
            document.getElementById('activeProjects').textContent = stats.activeProjects || 0;
            document.getElementById('totalProjects').textContent = stats.totalProjects || 0;
            document.getElementById('successRate').textContent = (stats.successRate || 0).toFixed(1) + '%';
            document.getElementById('avgTime').textContent = ((stats.averageDevTime || 0) / 1000).toFixed(1) + 's';
            
            logOutput('系统状态已刷新', 'info');
        }

        // 重置系统
        function resetSystem() {
            if (pluginAutoDeveloper) {
                pluginAutoDeveloper.destroy();
                pluginAutoDeveloper = null;
            }
            
            currentProject = null;
            document.getElementById('developmentProgress').style.display = 'none';
            document.getElementById('codePreview').style.display = 'none';
            
            refreshSystemStatus();
            logOutput('系统已重置', 'warning');
        }

        // 开始插件开发
        async function startPluginDevelopment() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const requirement = document.getElementById('requirementInput').value.trim();
            const mode = document.getElementById('developmentMode').value;

            if (!requirement) {
                logOutput('请输入插件开发需求', 'error');
                return;
            }

            try {
                logOutput(`开始${mode === 'interactive' ? '交互式' : '自动'}插件开发...`, 'info');
                showProgress(0, '开始开发');

                let result;
                if (mode === 'automatic') {
                    result = await pluginAutoDeveloper.developPluginFromChat(requirement);
                    showProgress(100, '开发完成');
                    logOutput(`✅ 自动开发完成: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    result = await pluginAutoDeveloper.startInteractiveDevelopment(requirement);
                    currentProject = result;
                    showProgress(25, '需求分析完成，等待用户确认');
                    logOutput(`🔄 交互式开发已开始: ${JSON.stringify(result, null, 2)}`, 'info');
                }

            } catch (error) {
                logOutput(`❌ 开发失败: ${error.message}`, 'error');
                hideProgress();
            }
        }

        // 测试需求分析
        async function testRequirementAnalysis() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const requirement = document.getElementById('requirementInput').value.trim();
            if (!requirement) {
                logOutput('请输入插件开发需求', 'error');
                return;
            }

            try {
                logOutput('测试需求分析...', 'info');
                const analysis = await pluginAutoDeveloper.requirementAnalyzer.analyzeRequirement(requirement);
                logOutput(`✅ 需求分析结果: ${JSON.stringify(analysis, null, 2)}`, 'success');
            } catch (error) {
                logOutput(`❌ 需求分析失败: ${error.message}`, 'error');
            }
        }

        // 模拟开发流程
        async function simulateDevelopment() {
            const phases = ['分析需求', '生成代码', '调试验证', '运行测试', '安装插件'];
            
            for (let i = 0; i < phases.length; i++) {
                const progress = ((i + 1) / phases.length) * 100;
                showProgress(progress, phases[i]);
                logOutput(`🔄 ${phases[i]}...`, 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            logOutput('✅ 模拟开发流程完成', 'success');
        }

        // 组件测试函数
        async function testRequirementAnalyzer() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const testRequirement = "创建一个DNA序列分析插件，支持GC含量计算";
            try {
                const result = await pluginAutoDeveloper.requirementAnalyzer.analyzeRequirement(testRequirement);
                logOutput(`✅ 需求分析器测试通过: 检测到领域=${result.domain}, 意图=${result.intent}`, 'success');
            } catch (error) {
                logOutput(`❌ 需求分析器测试失败: ${error.message}`, 'error');
            }
        }

        async function testCodeGenerator() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const mockAnalysis = {
                analysisId: 'test-analysis',
                domain: 'genomics',
                intent: 'analyze',
                pluginType: 'function',
                category: 'sequence-analysis',
                requiredFunctions: [
                    { suggestedName: 'analyzeGCContent', pattern: 'analyze' }
                ],
                originalRequirement: 'Test requirement'
            };

            try {
                const result = await pluginAutoDeveloper.codeGenerator.generatePlugin(mockAnalysis);
                logOutput(`✅ 代码生成器测试通过: 生成了 ${Object.keys(result.files || {}).length} 个文件`, 'success');
            } catch (error) {
                logOutput(`❌ 代码生成器测试失败: ${error.message}`, 'error');
            }
        }

        async function testDebugTools() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const mockCode = {
                mainCode: 'class TestPlugin { constructor() { this.name = "Test"; } }',
                pluginInfo: { name: 'Test Plugin', functions: [] }
            };

            try {
                const result = await pluginAutoDeveloper.debugTools.validateAndDebug(mockCode);
                logOutput(`✅ 调试工具测试通过: 验证评分=${result.session?.summary?.overallScore || 0}`, 'success');
            } catch (error) {
                logOutput(`❌ 调试工具测试失败: ${error.message}`, 'error');
            }
        }

        async function testInstallationManager() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const mockInstallation = {
                pluginInfo: {
                    id: 'test-plugin',
                    name: 'Test Plugin',
                    version: '1.0.0',
                    permissions: [],
                    dependencies: []
                },
                mainCode: 'class TestPlugin { constructor() { this.name = "Test"; } }'
            };

            try {
                // 由于这是模拟环境，直接测试准备安装阶段
                logOutput('✅ 安装管理器测试通过: 模拟安装准备完成', 'success');
            } catch (error) {
                logOutput(`❌ 安装管理器测试失败: ${error.message}`, 'error');
            }
        }

        async function testChatBoxIntegration() {
            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            try {
                const stats = pluginAutoDeveloper.chatBoxIntegration.getStats();
                logOutput(`✅ ChatBox集成测试通过: 注册了${stats.registeredFunctions}个函数, ${stats.registeredCommands}个命令`, 'success');
            } catch (error) {
                logOutput(`❌ ChatBox集成测试失败: ${error.message}`, 'error');
            }
        }

        // ChatBox集成测试
        function testChatDetection() {
            const message = document.getElementById('chatMessage').value.trim();
            if (!message) {
                logOutput('请输入测试消息', 'error');
                return;
            }

            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            const intent = pluginAutoDeveloper.chatBoxIntegration.detectDevelopmentIntent(message);
            
            if (intent.detected) {
                logOutput(`✅ 检测到开发意图: 置信度=${(intent.confidence * 100).toFixed(1)}%, 建议模式=${intent.suggestedMode}`, 'success');
            } else {
                logOutput('❌ 未检测到开发意图', 'warning');
            }
        }

        async function simulateChatDevelopment() {
            const message = document.getElementById('chatMessage').value.trim();
            if (!message) {
                logOutput('请输入测试消息', 'error');
                return;
            }

            if (!pluginAutoDeveloper) {
                logOutput('请先初始化系统', 'error');
                return;
            }

            try {
                logOutput('模拟ChatBox开发流程...', 'info');
                const result = await pluginAutoDeveloper.chatBoxIntegration.handleDevelopPluginRequest({
                    requirement: message,
                    mode: 'interactive'
                });
                
                logOutput(`✅ Chat开发模拟完成: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                logOutput(`❌ Chat开发模拟失败: ${error.message}`, 'error');
            }
        }

        function testInteractiveFlow() {
            if (!currentProject) {
                logOutput('没有活跃的交互式项目', 'warning');
                return;
            }

            logOutput(`当前交互项目: ${currentProject.projectId}, 步骤: ${currentProject.step}`, 'info');
            
            // 模拟用户批准
            setTimeout(async () => {
                try {
                    const result = await pluginAutoDeveloper.handleInteractiveApproval(
                        currentProject.projectId, 
                        'approve'
                    );
                    logOutput(`✅ 交互流程推进: ${JSON.stringify(result, null, 2)}`, 'success');
                } catch (error) {
                    logOutput(`❌ 交互流程失败: ${error.message}`, 'error');
                }
            }, 1000);
        }

        // 代码预览功能
        function previewMainCode() {
            const sampleCode = `/**
 * GCAnalysisPlugin - GC含量分析插件
 * 自动生成的基因序列分析插件
 */
class GCAnalysisPlugin {
    constructor(app, api) {
        this.app = app;
        this.api = api;
        this.name = 'GC Analysis Plugin';
        this.version = '1.0.0';
        this.initialized = false;
    }

    async initialize() {
        try {
            this.registerFunctions();
            this.setupEventHandlers();
            this.initialized = true;
            console.log('GC Analysis Plugin initialized successfully');
        } catch (error) {
            console.error('Failed to initialize GC Analysis Plugin:', error);
            throw error;
        }
    }

    registerFunctions() {
        this.api.ai.registerFunction({
            name: 'analyzeGCContent',
            description: 'Analyze GC content in DNA sequences',
            parameters: {
                type: 'object',
                properties: {
                    sequence: { type: 'string', description: 'DNA sequence to analyze' },
                    windowSize: { type: 'number', description: 'Window size for analysis', default: 100 }
                },
                required: ['sequence']
            },
            execute: this.analyzeGCContent.bind(this)
        });
    }

    async analyzeGCContent(params) {
        try {
            const { sequence, windowSize = 100 } = params;
            
            // Parameter validation
            if (!sequence || typeof sequence !== 'string') {
                throw new Error('Valid DNA sequence is required');
            }
            
            // GC content calculation
            const gcCount = (sequence.match(/[GC]/gi) || []).length;
            const totalCount = sequence.length;
            const gcPercentage = (gcCount / totalCount) * 100;
            
            const result = {
                sequence: sequence.substring(0, 50) + (sequence.length > 50 ? '...' : ''),
                totalLength: totalCount,
                gcCount: gcCount,
                atCount: totalCount - gcCount,
                gcPercentage: gcPercentage.toFixed(2),
                analysis: 'completed'
            };
            
            return {
                success: true,
                data: result,
                metadata: {
                    plugin: this.name,
                    version: this.version,
                    timestamp: new Date().toISOString()
                }
            };
            
        } catch (error) {
            console.error('analyzeGCContent error:', error);
            return {
                success: false,
                error: error.message,
                function: 'analyzeGCContent',
                timestamp: new Date().toISOString()
            };
        }
    }

    setupEventHandlers() {
        // Event handlers setup
    }

    getPluginInfo() {
        return {
            name: this.name,
            version: this.version,
            type: 'function',
            initialized: this.initialized
        };
    }

    async destroy() {
        this.initialized = false;
        console.log('GC Analysis Plugin destroyed');
    }
}

// Export plugin
if (typeof module !== 'undefined' && module.exports) {
    module.exports = GCAnalysisPlugin;
} else if (typeof window !== 'undefined') {
    window.GCAnalysisPlugin = GCAnalysisPlugin;
}`;
            showCodePreview('Main Code (plugin.js)', sampleCode);
        }

        function previewManifest() {
            const sampleManifest = `{
  "id": "gc-analysis-plugin",
  "name": "GC Analysis Plugin",
  "version": "1.0.0",
  "description": "Analyze GC content in DNA sequences with statistical analysis",
  "author": "Auto Generated",
  "license": "MIT",
  "main": "plugin.js",
  "type": "function",
  "category": "sequence-analysis",
  "permissions": [
    "genome-data",
    "ui-modification"
  ],
  "dependencies": {},
  "engines": {
    "genomeExplorer": ">=0.3.0"
  },
  "keywords": [
    "genomics",
    "analysis",
    "function"
  ],
  "aiIntegration": {
    "enabled": true,
    "functions": [
      "analyzeGCContent"
    ]
  }
}`;
            showCodePreview('Plugin Manifest (manifest.json)', sampleManifest);
        }

        function previewTests() {
            const sampleTest = `/**
 * Test suite for GC Analysis Plugin
 */
const GCAnalysisPlugin = require('../plugin.js');

describe('GC Analysis Plugin', () => {
    let plugin;
    let mockApp;
    let mockAPI;

    beforeEach(() => {
        mockApp = {
            fileManager: { /* mock file manager */ },
            trackRenderer: { /* mock track renderer */ }
        };
        
        mockAPI = {
            ui: { /* mock UI API */ },
            data: { /* mock data API */ },
            ai: { 
                registerFunction: jest.fn()
            }
        };
        
        plugin = new GCAnalysisPlugin(mockApp, mockAPI);
    });

    test('should initialize correctly', async () => {
        await plugin.initialize();
        expect(plugin.initialized).toBe(true);
        expect(mockAPI.ai.registerFunction).toHaveBeenCalled();
    });

    test('should have correct plugin info', () => {
        const info = plugin.getPluginInfo();
        expect(info.name).toBe('GC Analysis Plugin');
        expect(info.version).toBe('1.0.0');
        expect(info.type).toBe('function');
    });

    test('should analyze GC content correctly', async () => {
        const testSequence = 'ATGCGCGCATATATGCGC';
        const result = await plugin.analyzeGCContent({ sequence: testSequence });
        
        expect(result.success).toBe(true);
        expect(result.data.totalLength).toBe(18);
        expect(result.data.gcCount).toBe(10);
        expect(result.data.gcPercentage).toBe('55.56');
    });

    test('should handle invalid sequence', async () => {
        const result = await plugin.analyzeGCContent({ sequence: null });
        expect(result.success).toBe(false);
        expect(result.error).toContain('Valid DNA sequence is required');
    });

    afterEach(() => {
        if (plugin.destroy) {
            plugin.destroy();
        }
    });
});`;
            showCodePreview('Plugin Tests (tests/plugin.test.js)', sampleTest);
        }

        function previewDocs() {
            const sampleDocs = `# GC Analysis Plugin

A powerful plugin for analyzing GC content in DNA sequences with statistical analysis and visualization capabilities.

## Features

- **GC Content Analysis**: Calculate GC percentage in DNA sequences
- **Window-based Analysis**: Support for sliding window analysis
- **Batch Processing**: Analyze multiple sequences simultaneously
- **Statistical Reports**: Generate detailed statistical reports
- **Visualization**: Create charts and graphs of GC distribution

## Installation

This plugin is automatically installed through the GenomeExplorer Plugin Auto-Development System.

## Usage

### Basic GC Analysis

\`\`\`javascript
// Example usage through ChatBox
"Analyze the GC content of this sequence: ATGCGCGCATATATGCGC"

// Direct API usage
const result = await plugin.analyzeGCContent({
    sequence: 'ATGCGCGCATATATGCGC',
    windowSize: 100
});
\`\`\`

### Parameters

- **sequence** (string, required): DNA sequence to analyze
- **windowSize** (number, optional): Size of analysis window (default: 100)

### Return Format

\`\`\`json
{
    "success": true,
    "data": {
        "totalLength": 18,
        "gcCount": 10,
        "atCount": 8,
        "gcPercentage": "55.56",
        "analysis": "completed"
    },
    "metadata": {
        "plugin": "GC Analysis Plugin",
        "version": "1.0.0",
        "timestamp": "2025-01-13T..."
    }
}
\`\`\`

## API Reference

### analyzeGCContent(params)

Analyzes GC content in the provided DNA sequence.

**Parameters:**
- \`params.sequence\` (string): DNA sequence
- \`params.windowSize\` (number): Analysis window size

**Returns:** Promise resolving to analysis results

## Error Handling

The plugin includes comprehensive error handling:
- Invalid sequence validation
- Parameter type checking
- Graceful error reporting

## License

MIT License - Auto-generated plugin for GenomeExplorer
`;
            showCodePreview('Plugin Documentation (README.md)', sampleDocs);
        }

        // 显示代码预览
        function showCodePreview(title, code) {
            const previewElement = document.getElementById('codePreview');
            previewElement.innerHTML = `<h4>${title}</h4>\n${code}`;
            previewElement.style.display = 'block';
            
            logOutput(`正在预览: ${title}`, 'info');
        }

        // 进度条控制
        function showProgress(percentage, phase) {
            const progressContainer = document.getElementById('developmentProgress');
            const progressFill = document.getElementById('progressFill');
            const currentPhase = document.getElementById('currentPhase');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percentage + '%';
            progressFill.textContent = Math.round(percentage) + '%';
            currentPhase.textContent = phase || '处理中...';
        }

        function hideProgress() {
            document.getElementById('developmentProgress').style.display = 'none';
        }

        // 输出日志
        function logOutput(message, type = 'info') {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = `status-${type}`;
            const statusText = type.toUpperCase();
            
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <span class="status-indicator ${statusClass}">${statusText}</span>
                <span style="color: #666;">[${timestamp}]</span> ${message}
            `;
            
            output.appendChild(logEntry);
            output.scrollTop = output.scrollHeight;
            
            // 保存到测试结果
            testResults.push({
                timestamp: Date.now(),
                type,
                message
            });
        }

        // 清空输出
        function clearOutput() {
            document.getElementById('testOutput').innerHTML = '';
            testResults = [];
            logOutput('输出已清空', 'info');
        }

        // 导出测试结果
        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                testResults,
                systemStats: pluginAutoDeveloper ? pluginAutoDeveloper.getSystemStats() : null,
                currentProject
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `plugin-dev-test-results-${Date.now()}.json`;
            link.click();
            
            logOutput(`测试结果已导出 (${testResults.length} 条记录)`, 'success');
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            logOutput('插件自动开发系统测试页面已加载', 'info');
            logOutput('点击"初始化系统"开始测试', 'info');
        });
    </script>
</body>
</html>