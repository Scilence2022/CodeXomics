<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAM Reads "No Reads" Debug Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .results {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® BAM Reads "No Reads" Debug Test</h1>
            <p>Focused debugging tool for the "No Reads in this region" issue</p>
        </div>

        <div class="warning">
            <strong>Issue:</strong> BAM file shows "No Reads in this region" but samtools shows reads exist.<br>
            <strong>Possible causes:</strong> Mapping quality filtering, chromosome name mismatch, coordinate issues, unmapped reads filtering
        </div>

        <div class="test-section">
            <h3>üîç Quick Diagnosis</h3>
            <button class="btn-danger" onclick="runQuickDiagnosis()">Run Quick Diagnosis</button>
            <button class="btn-warning" onclick="testCurrentViewport()">Test Current Viewport</button>
            <button class="btn-primary" onclick="clearLog('quickResults')">Clear</button>
            <div class="results" id="quickResults"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Detailed Analysis</h3>
            <div class="input-group">
                <label for="testChromosome">Chromosome:</label>
                <input type="text" id="testChromosome" value="NC_000913.3">
            </div>
            <div class="input-group">
                <label for="testStart">Start Position:</label>
                <input type="number" id="testStart" value="1">
            </div>
            <div class="input-group">
                <label for="testEnd">End Position:</label>
                <input type="number" id="testEnd" value="1000">
            </div>
            
            <button class="btn-primary" onclick="testDetailedQuery()">Test Detailed Query</button>
            <button class="btn-warning" onclick="testAllFilterSettings()">Test All Filter Settings</button>
            <button class="btn-success" onclick="testChromosomeVariations()">Test Chromosome Variations</button>
            <button class="btn-primary" onclick="clearLog('detailedResults')">Clear</button>
            <div class="results" id="detailedResults"></div>
        </div>

        <div class="test-section">
            <h3>üîß Fix Attempts</h3>
            <button class="btn-success" onclick="tryFixIgnoreChromosome()">Try: Ignore Chromosome</button>
            <button class="btn-success" onclick="tryFixShowAll()">Try: Show All Reads</button>
            <button class="btn-success" onclick="tryFixCoordinates()">Try: Different Coordinates</button>
            <button class="btn-primary" onclick="clearLog('fixResults')">Clear</button>
            <div class="results" id="fixResults"></div>
        </div>
    </div>

    <script>
        function log(message, elementId = 'quickResults') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent += `${new Date().toLocaleTimeString()}: ${message}\n`;
                element.scrollTop = element.scrollHeight;
            }
            console.log(message);
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = '';
            }
        }

        async function runQuickDiagnosis() {
            clearLog('quickResults');
            log('üö® === QUICK DIAGNOSIS FOR "NO READS" ISSUE ===', 'quickResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                if (!browser) {
                    log('‚ùå FATAL: GenomeBrowser not found', 'quickResults');
                    return;
                }

                const readsManager = browser.readsManager;
                if (!readsManager) {
                    log('‚ùå FATAL: ReadsManager not found', 'quickResults');
                    return;
                }

                const bamReader = readsManager.bamReader;
                if (!bamReader) {
                    log('‚ùå FATAL: BAM Reader not found', 'quickResults');
                    return;
                }

                log('‚úÖ All components found', 'quickResults');
                log(`BAM file: ${bamReader.filePath}`, 'quickResults');
                log(`Has index: ${bamReader.hasIndex}`, 'quickResults');
                log(`Initialized: ${bamReader.isInitialized}`, 'quickResults');

                // Get current viewport
                const viewport = browser.getCurrentViewport ? browser.getCurrentViewport() : null;
                if (!viewport) {
                    log('‚ùå No viewport information', 'quickResults');
                    return;
                }

                log(`Current viewport: ${viewport.chromosome}:${viewport.start}-${viewport.end}`, 'quickResults');

                // Check references
                const references = bamReader.getReferences();
                log(`Available references: ${references.length}`, 'quickResults');
                
                const currentChromExists = references.some(ref => ref.name === viewport.chromosome);
                if (!currentChromExists) {
                    log(`‚ùå ISSUE FOUND: Current chromosome '${viewport.chromosome}' not in BAM references!`, 'quickResults');
                    log('Available chromosomes:', 'quickResults');
                    references.slice(0, 10).forEach(ref => {
                        log(`  - ${ref.name}`, 'quickResults');
                    });
                } else {
                    log(`‚úÖ Current chromosome found in references`, 'quickResults');
                }

                // Test query with default settings
                log('--- Testing query with default settings ---', 'quickResults');
                try {
                    const reads1 = await readsManager.getReadsForRegion(
                        viewport.chromosome, viewport.start, viewport.end, {}
                    );
                    log(`Default query result: ${reads1.length} reads`, 'quickResults');
                } catch (error) {
                    log(`‚ùå Default query error: ${error.message}`, 'quickResults');
                }

                // Test query with ignore chromosome
                log('--- Testing query with ignoreChromosome=true ---', 'quickResults');
                try {
                    const reads2 = await readsManager.getReadsForRegion(
                        viewport.chromosome, viewport.start, viewport.end, { ignoreChromosome: true }
                    );
                    log(`Ignore chromosome query result: ${reads2.length} reads`, 'quickResults');
                } catch (error) {
                    log(`‚ùå Ignore chromosome query error: ${error.message}`, 'quickResults');
                }

                // Test query with show all reads
                log('--- Testing query with show all reads ---', 'quickResults');
                try {
                    const reads3 = await readsManager.getReadsForRegion(
                        viewport.chromosome, viewport.start, viewport.end, {
                            minMappingQuality: 0,
                            showUnmapped: true,
                            showSecondary: true,
                            showSupplementary: true
                        }
                    );
                    log(`Show all query result: ${reads3.length} reads`, 'quickResults');
                } catch (error) {
                    log(`‚ùå Show all query error: ${error.message}`, 'quickResults');
                }

                log('üö® === DIAGNOSIS COMPLETE ===', 'quickResults');

            } catch (error) {
                log(`‚ùå FATAL ERROR: ${error.message}`, 'quickResults');
                log(`Stack: ${error.stack}`, 'quickResults');
            }
        }

        async function testCurrentViewport() {
            clearLog('quickResults');
            log('üéØ === TESTING CURRENT VIEWPORT ===', 'quickResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const viewport = browser?.getCurrentViewport?.();
                
                if (!viewport) {
                    log('‚ùå No viewport available', 'quickResults');
                    return;
                }

                log(`Testing viewport: ${viewport.chromosome}:${viewport.start}-${viewport.end}`, 'quickResults');

                const bamReader = browser?.readsManager?.bamReader;
                if (!bamReader) {
                    log('‚ùå No BAM reader', 'quickResults');
                    return;
                }

                // Test direct BAM query
                log('--- Direct BAM query ---', 'quickResults');
                const reads = await bamReader.getRecordsForRange(
                    viewport.chromosome, 
                    viewport.start - 1,  // Convert to 0-based
                    viewport.end, 
                    {}
                );
                
                log(`Direct BAM query: ${reads.length} reads`, 'quickResults');
                
                if (reads.length > 0) {
                    log('Sample reads:', 'quickResults');
                    reads.slice(0, 3).forEach(read => {
                        log(`  ${read.id}: ${read.start}-${read.end} MQ=${read.mappingQuality} Flags=${read.flags}`, 'quickResults');
                    });
                } else {
                    log('‚ùå NO READS FOUND - This is the issue!', 'quickResults');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'quickResults');
            }
        }

        async function testDetailedQuery() {
            clearLog('detailedResults');
            log('üî¨ === DETAILED QUERY ANALYSIS ===', 'detailedResults');
            
            const chromosome = document.getElementById('testChromosome').value;
            const start = parseInt(document.getElementById('testStart').value);
            const end = parseInt(document.getElementById('testEnd').value);

            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'detailedResults');
                    return;
                }

                log(`Testing query: ${chromosome}:${start}-${end}`, 'detailedResults');

                // Test with detailed logging enabled
                const settings = {
                    minMappingQuality: 0,
                    showUnmapped: true,
                    showSecondary: true,
                    showSupplementary: true
                };

                log('Settings:', 'detailedResults');
                log(JSON.stringify(settings, null, 2), 'detailedResults');

                const reads = await bamReader.getRecordsForRange(
                    chromosome, start - 1, end, settings
                );

                log(`Query result: ${reads.length} reads`, 'detailedResults');

                if (reads.length > 0) {
                    // Analyze the reads
                    const mappingQualities = reads.map(r => r.mappingQuality || 0);
                    const flags = reads.map(r => r.flags || 0);
                    
                    log('Analysis:', 'detailedResults');
                    log(`  MQ range: ${Math.min(...mappingQualities)} - ${Math.max(...mappingQualities)}`, 'detailedResults');
                    log(`  Average MQ: ${(mappingQualities.reduce((a,b) => a+b, 0) / mappingQualities.length).toFixed(1)}`, 'detailedResults');
                    
                    const unmapped = reads.filter(r => (r.flags & 4) !== 0).length;
                    const secondary = reads.filter(r => (r.flags & 256) !== 0).length;
                    const supplementary = reads.filter(r => (r.flags & 2048) !== 0).length;
                    
                    log(`  Unmapped: ${unmapped}`, 'detailedResults');
                    log(`  Secondary: ${secondary}`, 'detailedResults');
                    log(`  Supplementary: ${supplementary}`, 'detailedResults');
                    
                    log('Sample reads:', 'detailedResults');
                    reads.slice(0, 5).forEach((read, i) => {
                        log(`  ${i+1}. ${read.id}: ${read.chromosome}:${read.start}-${read.end} MQ=${read.mappingQuality} Flags=${read.flags}`, 'detailedResults');
                    });
                    
                } else {
                    log('‚ùå NO READS FOUND!', 'detailedResults');
                    log('This suggests one of the following issues:', 'detailedResults');
                    log('1. No reads actually exist in this region', 'detailedResults');
                    log('2. Chromosome name mismatch', 'detailedResults');
                    log('3. Coordinate system issues', 'detailedResults');
                    log('4. BAM file corruption or indexing issues', 'detailedResults');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'detailedResults');
                log(`Stack: ${error.stack}`, 'detailedResults');
            }
        }

        async function testAllFilterSettings() {
            clearLog('detailedResults');
            log('üß™ === TESTING ALL FILTER COMBINATIONS ===', 'detailedResults');
            
            const chromosome = document.getElementById('testChromosome').value;
            const start = parseInt(document.getElementById('testStart').value);
            const end = parseInt(document.getElementById('testEnd').value);

            const filterCombinations = [
                { name: 'Default', settings: {} },
                { name: 'Show All', settings: { minMappingQuality: 0, showUnmapped: true, showSecondary: true, showSupplementary: true } },
                { name: 'No Unmapped', settings: { showUnmapped: false } },
                { name: 'No Secondary', settings: { showSecondary: false } },
                { name: 'No Supplementary', settings: { showSupplementary: false } },
                { name: 'High Quality Only', settings: { minMappingQuality: 30 } },
                { name: 'Medium Quality', settings: { minMappingQuality: 10 } },
                { name: 'Primary Only', settings: { showSecondary: false, showSupplementary: false, showUnmapped: false } }
            ];

            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'detailedResults');
                    return;
                }

                for (const combo of filterCombinations) {
                    log(`--- ${combo.name} ---`, 'detailedResults');
                    try {
                        const reads = await bamReader.getRecordsForRange(
                            chromosome, start - 1, end, combo.settings
                        );
                        log(`${combo.name}: ${reads.length} reads`, 'detailedResults');
                        
                        if (reads.length > 0) {
                            const avgMQ = reads.reduce((sum, r) => sum + (r.mappingQuality || 0), 0) / reads.length;
                            log(`  Average MQ: ${avgMQ.toFixed(1)}`, 'detailedResults');
                        }
                    } catch (error) {
                        log(`‚ùå ${combo.name} error: ${error.message}`, 'detailedResults');
                    }
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'detailedResults');
            }
        }

        async function testChromosomeVariations() {
            clearLog('detailedResults');
            log('üß¨ === TESTING CHROMOSOME VARIATIONS ===', 'detailedResults');
            
            const start = parseInt(document.getElementById('testStart').value);
            const end = parseInt(document.getElementById('testEnd').value);

            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader available', 'detailedResults');
                    return;
                }

                const references = bamReader.getReferences();
                log(`Available references: ${references.length}`, 'detailedResults');

                // Test first few chromosomes
                const testRefs = references.slice(0, 5);
                
                for (const ref of testRefs) {
                    log(`--- Testing ${ref.name} ---`, 'detailedResults');
                    try {
                        const reads = await bamReader.getRecordsForRange(
                            ref.name, start - 1, Math.min(end, ref.length), {}
                        );
                        log(`${ref.name}: ${reads.length} reads`, 'detailedResults');
                    } catch (error) {
                        log(`‚ùå ${ref.name} error: ${error.message}`, 'detailedResults');
                    }
                }

                // Test with ignore chromosome
                log('--- Testing with ignoreChromosome=true ---', 'detailedResults');
                try {
                    const reads = await bamReader.getRecordsForRange(
                        'any_chromosome', start - 1, end, { ignoreChromosome: true }
                    );
                    log(`Ignore chromosome: ${reads.length} reads`, 'detailedResults');
                } catch (error) {
                    log(`‚ùå Ignore chromosome error: ${error.message}`, 'detailedResults');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'detailedResults');
            }
        }

        async function tryFixIgnoreChromosome() {
            clearLog('fixResults');
            log('üîß === TRYING FIX: IGNORE CHROMOSOME ===', 'fixResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const viewport = browser?.getCurrentViewport?.();
                
                if (!viewport) {
                    log('‚ùå No viewport', 'fixResults');
                    return;
                }

                log(`Attempting fix for: ${viewport.chromosome}:${viewport.start}-${viewport.end}`, 'fixResults');

                const reads = await browser.readsManager.getReadsForRegion(
                    viewport.chromosome, viewport.start, viewport.end, 
                    { ignoreChromosome: true }
                );

                if (reads.length > 0) {
                    log(`‚úÖ SUCCESS! Found ${reads.length} reads with ignoreChromosome=true`, 'fixResults');
                    log('This suggests a chromosome name mismatch issue.', 'fixResults');
                    log('Recommendation: Enable "Ignore Chromosome" in reads track settings.', 'fixResults');
                } else {
                    log('‚ùå Still no reads found even with ignoreChromosome=true', 'fixResults');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'fixResults');
            }
        }

        async function tryFixShowAll() {
            clearLog('fixResults');
            log('üîß === TRYING FIX: SHOW ALL READS ===', 'fixResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const viewport = browser?.getCurrentViewport?.();
                
                if (!viewport) {
                    log('‚ùå No viewport', 'fixResults');
                    return;
                }

                log(`Attempting fix for: ${viewport.chromosome}:${viewport.start}-${viewport.end}`, 'fixResults');

                const settings = {
                    minMappingQuality: 0,
                    showUnmapped: true,
                    showSecondary: true,
                    showSupplementary: true,
                    ignoreChromosome: true
                };

                const reads = await browser.readsManager.getReadsForRegion(
                    viewport.chromosome, viewport.start, viewport.end, settings
                );

                if (reads.length > 0) {
                    log(`‚úÖ SUCCESS! Found ${reads.length} reads with show all settings`, 'fixResults');
                    log('This suggests reads were being filtered out.', 'fixResults');
                    log('Recommendation: Adjust reads track filter settings.', 'fixResults');
                    
                    // Analyze what types of reads were found
                    const unmapped = reads.filter(r => (r.flags & 4) !== 0).length;
                    const secondary = reads.filter(r => (r.flags & 256) !== 0).length;
                    const supplementary = reads.filter(r => (r.flags & 2048) !== 0).length;
                    const lowQuality = reads.filter(r => (r.mappingQuality || 0) < 10).length;
                    
                    log(`Breakdown:`, 'fixResults');
                    log(`  Unmapped: ${unmapped}`, 'fixResults');
                    log(`  Secondary: ${secondary}`, 'fixResults');
                    log(`  Supplementary: ${supplementary}`, 'fixResults');
                    log(`  Low quality (MQ<10): ${lowQuality}`, 'fixResults');
                    
                } else {
                    log('‚ùå Still no reads found even with all filters disabled', 'fixResults');
                    log('This suggests a more fundamental issue.', 'fixResults');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'fixResults');
            }
        }

        async function tryFixCoordinates() {
            clearLog('fixResults');
            log('üîß === TRYING FIX: DIFFERENT COORDINATES ===', 'fixResults');
            
            try {
                const browser = window.parent?.genomeBrowser;
                const bamReader = browser?.readsManager?.bamReader;
                
                if (!bamReader) {
                    log('‚ùå No BAM reader', 'fixResults');
                    return;
                }

                const references = bamReader.getReferences();
                if (references.length === 0) {
                    log('‚ùå No references found', 'fixResults');
                    return;
                }

                const firstRef = references[0];
                log(`Testing different coordinate ranges on ${firstRef.name}:`, 'fixResults');

                const testRanges = [
                    [1, 100],
                    [1, 1000],
                    [1000, 2000],
                    [10000, 11000],
                    [Math.floor(firstRef.length / 2), Math.floor(firstRef.length / 2) + 1000]
                ];

                for (const [start, end] of testRanges) {
                    try {
                        const reads = await bamReader.getRecordsForRange(
                            firstRef.name, start - 1, Math.min(end, firstRef.length), 
                            { showUnmapped: true, showSecondary: true, showSupplementary: true }
                        );
                        
                        if (reads.length > 0) {
                            log(`‚úÖ SUCCESS! Found ${reads.length} reads at ${start}-${end}`, 'fixResults');
                            log('This suggests reads exist but not in the current viewport.', 'fixResults');
                            break;
                        } else {
                            log(`Range ${start}-${end}: 0 reads`, 'fixResults');
                        }
                    } catch (error) {
                        log(`‚ùå Range ${start}-${end} error: ${error.message}`, 'fixResults');
                    }
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'fixResults');
            }
        }

        // Auto-run quick diagnosis on load
        setTimeout(() => {
            if (window.parent?.genomeBrowser) {
                runQuickDiagnosis();
            }
        }, 1000);
    </script>
</body>
</html> 