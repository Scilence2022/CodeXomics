<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Indicator Bar Alignment Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .alignment-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .sequence-line {
            display: flex;
            margin-bottom: 4px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .sequence-position {
            width: 100px;
            color: #6c757d;
            font-weight: 600;
            margin-right: 15px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .sequence-bases {
            flex: 1;
            word-break: break-all;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .gene-indicator-line {
            height: 12px;
            margin-bottom: 4px;
            margin-top: -2px;
        }
        
        .base-a { color: #FF6B6B; }
        .base-t { color: #4ECDC4; }
        .base-g { color: #45B7D1; }
        .base-c { color: #96CEB4; }
        
        .alignment-grid {
            background: linear-gradient(90deg, transparent 0px, transparent 9px, #ddd 9px, #ddd 10px);
            background-size: 10px 1px;
            background-repeat: repeat-x;
            position: relative;
        }
        
        .alignment-ruler {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 115px;
        }
        
        .fix-highlight {
            background: #e7f3ff;
            border: 1px solid #007bff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .before, .after {
            padding: 15px;
            border-radius: 6px;
        }
        
        .before {
            background: #fff5f5;
            border: 1px solid #fed7d7;
        }
        
        .after {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .metrics {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>🎯 Gene Indicator Bar Alignment Test</h1>
            <p>验证Gene Indicator Bar与DNA序列的位置对齐修复</p>
        </div>

        <!-- Problem Description -->
        <div class="test-section">
            <h3>🔍 Position Alignment Issues</h3>
            <div class="fix-highlight">
                <h4>发现的问题：</h4>
                <ul>
                    <li><strong>横向偏移</strong>：Gene Indicator需要向左调整约0.8个碱基位置</li>
                    <li><strong>竖向偏移</strong>：Indicator Bar需要上移相同距离</li>
                    <li><strong>字符宽度</strong>：测量方法可能与实际渲染有差异</li>
                </ul>
                
                <h4>修复措施：</h4>
                <ul>
                    <li>在<code>createGeneIndicator</code>中添加-0.8字符宽度的横向偏移</li>
                    <li>调整indicator line的margin-left计算，加入偏移量</li>
                    <li>添加margin-top: -2px上移indicator bar</li>
                    <li>改进字符宽度测量，使用更长字符串和getBoundingClientRect</li>
                </ul>
            </div>
        </div>

        <!-- Character Width Test -->
        <div class="test-section">
            <h3>📏 Character Width Measurement Test</h3>
            <p>测试字符宽度测量的准确性</p>
            
            <button class="btn" onclick="testCharacterWidth()">Test Character Width</button>
            
            <div id="charWidthResults" class="metrics" style="display: none;">
                <div>Measured Character Width: <span id="measuredWidth">0</span>px</div>
                <div>Expected Width (9.5px): <span id="expectedWidth">9.5</span>px</div>
                <div>Difference: <span id="widthDifference">0</span>px</div>
                <div>Accuracy: <span id="widthAccuracy">0</span>%</div>
            </div>
        </div>

        <!-- Alignment Visualization -->
        <div class="test-section">
            <h3>📐 Alignment Visualization</h3>
            <p>可视化对比修复前后的对齐效果</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>修复前 (Before)</h4>
                    <div class="alignment-test">
                        <div class="alignment-ruler">1234567890123456789012345678901234567890</div>
                        <div class="sequence-line">
                            <span class="sequence-position">1,001</span>
                            <div class="sequence-bases">
                                <span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span>
                            </div>
                        </div>
                        <div class="gene-indicator-line" style="margin-left: 115px;">
                            <svg style="width: 95px; height: 12px; margin-left: 0;">
                                <!-- 模拟修复前的位置 - 偏右0.8个字符 -->
                                <rect x="7.6" y="3" width="38" height="6" fill="#4CAF50" opacity="0.7"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="after">
                    <h4>修复后 (After)</h4>
                    <div class="alignment-test">
                        <div class="alignment-ruler">1234567890123456789012345678901234567890</div>
                        <div class="sequence-line">
                            <span class="sequence-position">1,001</span>
                            <div class="sequence-bases">
                                <span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span>
                            </div>
                        </div>
                        <div class="gene-indicator-line" id="fixedIndicatorLine">
                            <svg style="width: 95px; height: 12px; margin-left: 0;">
                                <!-- 修复后的位置 - 左移0.8个字符 -->
                                <rect x="0" y="3" width="38" height="6" fill="#4CAF50" opacity="0.7"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Position Calculation Test -->
        <div class="test-section">
            <h3>🧮 Position Calculation Test</h3>
            <p>测试位置计算的准确性</p>
            
            <button class="btn" onclick="testPositionCalculation()">Test Position Calculation</button>
            <button class="btn" onclick="simulateAlignment()">Simulate Alignment</button>
            
            <div id="positionResults" class="metrics" style="display: none;">
                <div>Gene Start Position: <span id="geneStart">1001</span></div>
                <div>Gene End Position: <span id="geneEnd">1005</span></div>
                <div>Line Start Position: <span id="lineStart">1001</span></div>
                <div>Calculated Start X: <span id="startX">0</span>px</div>
                <div>Calculated End X: <span id="endX">0</span>px</div>
                <div>Horizontal Offset Applied: <span id="horizontalOffset">0</span>px</div>
                <div>Final Start X: <span id="finalStartX">0</span>px</div>
            </div>
        </div>

        <!-- Real-world Test -->
        <div class="test-section">
            <h3>🧪 Real-world Alignment Test</h3>
            <p>使用实际的基因数据测试对齐效果</p>
            
            <button class="btn" onclick="createRealWorldTest()">Create Real-world Test</button>
            
            <div id="realWorldTest" style="display: none;">
                <!-- 这里会动态生成实际的序列和指示器 -->
            </div>
        </div>

        <!-- Verification Checklist -->
        <div class="test-section">
            <h3>✅ Verification Checklist</h3>
            <div class="fix-highlight">
                <h4>验证要点：</h4>
                <ul>
                    <li>□ Gene Indicator的起始位置与对应碱基精确对齐</li>
                    <li>□ Gene Indicator的结束位置与对应碱基精确对齐</li>
                    <li>□ 竖向位置紧贴序列行，无明显偏移</li>
                    <li>□ 不同长度的基因都能正确对齐</li>
                    <li>□ 正向和反向基因的对齐都正确</li>
                    <li>□ 字符宽度测量准确，与实际渲染一致</li>
                </ul>
                
                <h4>测试步骤：</h4>
                <ol>
                    <li>在GenomeExplorer中加载包含基因注释的文件</li>
                    <li>切换到View Mode</li>
                    <li>观察Gene Indicator Bar与DNA序列的对齐</li>
                    <li>验证不同基因的起始和结束位置</li>
                    <li>检查竖向对齐是否改善</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Mock character width measurement
        function measureCharacterWidth() {
            const testElement = document.createElement('span');
            testElement.textContent = 'ATCGATCGATCGATCG'; // 16 characters
            testElement.style.fontFamily = "'Courier New', monospace";
            testElement.style.fontSize = '14px';
            testElement.style.fontWeight = 'normal';
            testElement.style.display = 'inline-block';
            testElement.style.padding = '0';
            testElement.style.margin = '0';
            testElement.style.verticalAlign = 'top';
            testElement.style.visibility = 'hidden';
            testElement.style.position = 'absolute';
            testElement.style.whiteSpace = 'nowrap';
            
            document.body.appendChild(testElement);
            const measuredWidth = testElement.getBoundingClientRect().width / 16;
            document.body.removeChild(testElement);
            
            return Math.max(8, measuredWidth);
        }

        function testCharacterWidth() {
            const resultsElement = document.getElementById('charWidthResults');
            resultsElement.style.display = 'block';
            
            const measuredWidth = measureCharacterWidth();
            const expectedWidth = 9.5;
            const difference = Math.abs(measuredWidth - expectedWidth);
            const accuracy = ((1 - difference / expectedWidth) * 100).toFixed(1);
            
            document.getElementById('measuredWidth').textContent = measuredWidth.toFixed(2);
            document.getElementById('widthDifference').textContent = difference.toFixed(2);
            document.getElementById('widthAccuracy').textContent = accuracy;
            
            console.log('Character width test:', {
                measured: measuredWidth,
                expected: expectedWidth,
                difference: difference,
                accuracy: accuracy + '%'
            });
        }

        function testPositionCalculation() {
            const resultsElement = document.getElementById('positionResults');
            resultsElement.style.display = 'block';
            
            // Mock gene and line data
            const gene = { start: 1001, end: 1005 };
            const lineStartAbs = 1001;
            const charWidth = measureCharacterWidth();
            
            // Calculate positions (simulating the fixed algorithm)
            const geneStartInLine = Math.max(gene.start, lineStartAbs + 1) - lineStartAbs - 1;
            const geneEndInLine = Math.min(gene.end, lineStartAbs + 1000) - lineStartAbs - 1; // Assume line end
            
            const horizontalOffset = -0.8 * charWidth;
            const startX = geneStartInLine * charWidth;
            const endX = (geneEndInLine + 1) * charWidth;
            const finalStartX = startX + horizontalOffset;
            
            document.getElementById('geneStart').textContent = gene.start;
            document.getElementById('geneEnd').textContent = gene.end;
            document.getElementById('lineStart').textContent = lineStartAbs;
            document.getElementById('startX').textContent = startX.toFixed(2);
            document.getElementById('endX').textContent = endX.toFixed(2);
            document.getElementById('horizontalOffset').textContent = horizontalOffset.toFixed(2);
            document.getElementById('finalStartX').textContent = finalStartX.toFixed(2);
            
            console.log('Position calculation test:', {
                gene,
                lineStartAbs,
                charWidth,
                geneStartInLine,
                geneEndInLine,
                startX,
                endX,
                horizontalOffset,
                finalStartX
            });
        }

        function simulateAlignment() {
            const charWidth = measureCharacterWidth();
            const horizontalOffset = -0.8 * charWidth;
            const indicatorMarginLeft = 115 + (0.8 * charWidth);
            
            // Update the fixed indicator line
            const fixedLine = document.getElementById('fixedIndicatorLine');
            fixedLine.style.marginLeft = indicatorMarginLeft + 'px';
            fixedLine.style.marginTop = '-2px';
            
            console.log('Alignment simulation:', {
                charWidth,
                horizontalOffset,
                indicatorMarginLeft
            });
            
            alert(`Alignment simulated with:\n` +
                  `Character Width: ${charWidth.toFixed(2)}px\n` +
                  `Horizontal Offset: ${horizontalOffset.toFixed(2)}px\n` +
                  `Indicator Margin Left: ${indicatorMarginLeft.toFixed(2)}px`);
        }

        function createRealWorldTest() {
            const testContainer = document.getElementById('realWorldTest');
            testContainer.style.display = 'block';
            
            const charWidth = measureCharacterWidth();
            const sequence = 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG';
            const lineStartPos = 1001;
            
            // Mock gene data
            const genes = [
                { start: 1005, end: 1015, type: 'CDS', name: 'Gene1' },
                { start: 1020, end: 1030, type: 'mRNA', name: 'Gene2' },
                { start: 1035, end: 1040, type: 'promoter', name: 'Promoter1' }
            ];
            
            let html = '<div class="alignment-test">';
            html += '<div class="alignment-ruler">1234567890123456789012345678901234567890</div>';
            
            // Create sequence line
            html += '<div class="sequence-line">';
            html += `<span class="sequence-position">${(lineStartPos + 1).toLocaleString()}</span>`;
            html += '<div class="sequence-bases">';
            for (let i = 0; i < sequence.length; i++) {
                const base = sequence[i];
                html += `<span class="base-${base.toLowerCase()}">${base}</span>`;
            }
            html += '</div></div>';
            
            // Create indicator line
            const indicatorMarginLeft = 115 + (0.8 * charWidth);
            html += `<div class="gene-indicator-line" style="margin-left: ${indicatorMarginLeft}px; margin-top: -2px;">`;
            html += `<svg style="width: ${sequence.length * charWidth}px; height: 12px; margin-left: 0;">`;
            
            // Add gene indicators
            genes.forEach(gene => {
                const geneStartInLine = Math.max(gene.start, lineStartPos + 1) - lineStartPos - 1;
                const geneEndInLine = Math.min(gene.end, lineStartPos + sequence.length) - lineStartPos - 1;
                
                if (geneStartInLine >= 0 && geneEndInLine < sequence.length) {
                    const horizontalOffset = -0.8 * charWidth;
                    const startX = geneStartInLine * charWidth + horizontalOffset;
                    const width = (geneEndInLine - geneStartInLine + 1) * charWidth;
                    
                    const colors = {
                        'CDS': '#4CAF50',
                        'mRNA': '#2196F3',
                        'promoter': '#FF9800'
                    };
                    
                    html += `<rect x="${startX}" y="3" width="${width}" height="6" ` +
                           `fill="${colors[gene.type]}" opacity="0.7" ` +
                           `title="${gene.name} (${gene.start}-${gene.end})"/>`;
                }
            });
            
            html += '</svg></div>';
            html += '</div>';
            
            testContainer.innerHTML = html;
            
            console.log('Real-world test created with genes:', genes);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Gene Indicator Bar Alignment Test Page Loaded');
            
            // Auto-run character width test
            setTimeout(testCharacterWidth, 500);
        });
    </script>
</body>
</html> 