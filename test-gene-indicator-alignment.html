<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Indicator Bar Alignment Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .alignment-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .sequence-line-demo {
            display: flex;
            margin-bottom: 8px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .position-demo {
            width: 100px;
            color: #6c757d;
            font-weight: 600;
            margin-right: 15px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .bases-demo {
            flex: 1;
            word-break: break-all;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .base-demo {
            display: inline-block;
            padding: 0;
            margin: 0;
            vertical-align: top;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .indicator-demo {
            height: 12px;
            margin-bottom: 2px;
            margin-top: -2px;
            position: relative;
        }
        
        .indicator-old {
            margin-left: 115px; /* Old hardcoded value */
        }
        
        .indicator-new {
            /* New calculated value: 100px (position) + 15px (margin) - 7.6px (0.8 * 9.5px charWidth) */
            margin-left: 107.4px;
        }
        
        .gene-rect {
            height: 6px;
            background: #4CAF50;
            opacity: 0.7;
            position: absolute;
            top: 3px;
            border-radius: 2px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .improvement {
            color: #28a745;
            font-weight: 600;
        }
        
        .issue {
            color: #dc3545;
            font-weight: 600;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .test-instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>🎯 Gene Indicator Bar Alignment Test</h1>
            <p>验证Gene Indicator Bar与DNA序列的精确对齐</p>
        </div>

        <!-- Problem Description -->
        <div class="test-section">
            <h3>🔍 Problem Analysis</h3>
            <div class="test-instructions">
                <h4>对齐问题描述：</h4>
                <ul>
                    <li><strong>横向偏移</strong>：Gene Indicator Bar相对于DNA序列向右偏移约0.8个碱基位置</li>
                    <li><strong>竖向偏移</strong>：Indicator Bar与序列行之间的垂直间距不够紧密</li>
                    <li><strong>坐标系不匹配</strong>：基因坐标(1-based)与序列显示(0-based)之间的转换有误</li>
                    <li><strong>字符居中</strong>：没有考虑字符宽度的中心对齐</li>
                </ul>
            </div>
        </div>

        <!-- Alignment Comparison -->
        <div class="test-section">
            <h3>📐 Alignment Comparison</h3>
            
            <h4>Before Fix (Misaligned):</h4>
            <div class="alignment-test">
                <div class="sequence-line-demo">
                    <span class="position-demo">1001</span>
                    <div class="bases-demo">
                        <span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">G</span><span class="base-demo">C</span><span class="base-demo">G</span><span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">T</span><span class="base-demo">C</span><span class="base-demo">G</span>
                    </div>
                </div>
                <div class="indicator-demo indicator-old">
                    <div class="gene-rect" style="left: 0px; width: 95px;"></div>
                    <small style="color: #dc3545;">❌ 偏移约0.8个字符位置</small>
                </div>
            </div>
            
            <h4>After Fix (Aligned):</h4>
            <div class="alignment-test">
                <div class="sequence-line-demo">
                    <span class="position-demo">1001</span>
                    <div class="bases-demo">
                        <span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">G</span><span class="base-demo">C</span><span class="base-demo">G</span><span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">T</span><span class="base-demo">C</span><span class="base-demo">G</span>
                    </div>
                </div>
                <div class="indicator-demo indicator-new">
                    <div class="gene-rect" style="left: 4.75px; width: 95px;"></div>
                    <small style="color: #28a745;">✅ 精确对齐到字符中心</small>
                </div>
            </div>
        </div>

        <!-- Fix Details -->
        <div class="test-section">
            <h3>🔧 Fix Implementation</h3>
            
            <h4>1. Horizontal Alignment Fix:</h4>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Improvement</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Coordinate Conversion</td>
                        <td class="issue">Math.max(gene.start, lineStartAbs + 1) - lineStartAbs - 1</td>
                        <td class="improvement">visibleStart1Based - lineStart1Based</td>
                        <td>Clearer 1-based to 0-based conversion</td>
                    </tr>
                    <tr>
                        <td>Pixel Position</td>
                        <td class="issue">geneStartInLine * charWidth</td>
                        <td class="improvement">geneStartInLine * charWidth + (charWidth * 0.5)</td>
                        <td>Character center alignment</td>
                    </tr>
                    <tr>
                        <td>Indicator Margin</td>
                        <td class="issue">margin-left: 115px (hardcoded)</td>
                        <td class="improvement">margin-left: ${finalLeftMargin}px (calculated)</td>
                        <td>Precise alignment calculation</td>
                    </tr>
                </tbody>
            </table>
            
            <h4>2. Vertical Alignment Fix:</h4>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Effect</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Margin Bottom</td>
                        <td class="issue">margin-bottom: 4px</td>
                        <td class="improvement">margin-bottom: 2px</td>
                        <td>Closer to sequence line</td>
                    </tr>
                    <tr>
                        <td>Margin Top</td>
                        <td class="issue">Not set</td>
                        <td class="improvement">margin-top: -2px</td>
                        <td>Pulls indicator closer</td>
                    </tr>
                    <tr>
                        <td>Left Adjustment</td>
                        <td class="issue">No horizontal compensation</td>
                        <td class="improvement">charWidth * 0.8 adjustment</td>
                        <td>Compensates for visual offset</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Code Changes -->
        <div class="test-section">
            <h3>💻 Code Changes</h3>
            
            <h4>1. renderSequenceLine() Method:</h4>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"><code>// Calculate exact left margin to align with sequence bases
const positionWidth = 100; // position span width
const marginRight = 15;    // margin-right of position span
const alignmentOffset = positionWidth + marginRight;
// Add horizontal offset to compensate for character centering (~0.8 characters)
const horizontalAdjustment = charWidth * 0.8;
const finalLeftMargin = alignmentOffset - horizontalAdjustment;

indicatorLine.style.cssText = `height: 12px; margin-left: ${finalLeftMargin}px; margin-bottom: 2px; margin-top: -2px;`;</code></pre>
            
            <h4>2. createGeneIndicator() Method:</h4>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"><code>// Calculate the actual start and end positions within this line
const geneStart1Based = gene.start;
const geneEnd1Based = gene.end;
const lineStart1Based = lineStartAbs + 1; // Convert to 1-based
const lineEnd1Based = lineEndAbs;         // lineEndAbs is already 1-based equivalent

// Find the portion of the gene that overlaps with this line
const visibleStart1Based = Math.max(geneStart1Based, lineStart1Based);
const visibleEnd1Based = Math.min(geneEnd1Based, lineEnd1Based);

// Convert to 0-based positions relative to the start of this line
const geneStartInLine = visibleStart1Based - lineStart1Based;
const geneEndInLine = visibleEnd1Based - lineStart1Based;

// Convert to pixel positions with character centering
// Add 0.5 * charWidth to center the indicator on the character
const startX = geneStartInLine * charWidth + (charWidth * 0.5);
const endX = (geneEndInLine + 1) * charWidth + (charWidth * 0.5);</code></pre>
        </div>

        <!-- Testing Instructions -->
        <div class="test-section">
            <h3>🧪 Testing Instructions</h3>
            <div class="test-instructions">
                <h4>验证步骤：</h4>
                <ol>
                    <li>在GenomeExplorer中加载包含基因注释的基因组文件</li>
                    <li>切换到View Mode（确保不是Edit Mode）</li>
                    <li>观察DNA序列下方的Gene Indicator Bar</li>
                    <li>验证以下对齐效果：
                        <ul>
                            <li>✅ Indicator bar的左边缘与对应基因起始碱基对齐</li>
                            <li>✅ Indicator bar的右边缘与对应基因终止碱基对齐</li>
                            <li>✅ Indicator bar与序列行之间的垂直间距合适</li>
                            <li>✅ 基因方向箭头指向正确</li>
                        </ul>
                    </li>
                    <li>测试不同长度的基因和不同的序列行</li>
                    <li>验证跨行基因的部分显示是否正确</li>
                </ol>
            </div>
            
            <button class="btn" onclick="showCalculationDetails()">Show Calculation Details</button>
            <button class="btn" onclick="testAlignment()">Test Current Alignment</button>
        </div>

        <!-- Calculation Details -->
        <div class="test-section" id="calculationDetails" style="display: none;">
            <h3>📊 Alignment Calculation Details</h3>
            <div id="calculationOutput" style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                <!-- Calculation results will be shown here -->
            </div>
        </div>
    </div>

    <script>
        function showCalculationDetails() {
            const detailsSection = document.getElementById('calculationDetails');
            const output = document.getElementById('calculationOutput');
            
            // Simulate the calculation
            const charWidth = 9.5; // Default character width
            const positionWidth = 100;
            const marginRight = 15;
            const alignmentOffset = positionWidth + marginRight;
            const horizontalAdjustment = charWidth * 0.8;
            const finalLeftMargin = alignmentOffset - horizontalAdjustment;
            
            output.innerHTML = `
<strong>Alignment Calculation:</strong>

Character Width: ${charWidth}px
Position Span Width: ${positionWidth}px
Position Margin Right: ${marginRight}px
Basic Alignment Offset: ${positionWidth} + ${marginRight} = ${alignmentOffset}px

Horizontal Adjustment: ${charWidth} * 0.8 = ${horizontalAdjustment}px
Final Left Margin: ${alignmentOffset} - ${horizontalAdjustment} = ${finalLeftMargin}px

<strong>Gene Position Calculation Example:</strong>
Gene Start (1-based): 1005
Gene End (1-based): 1015
Line Start (0-based): 1000
Line Start (1-based): 1001

Visible Start (1-based): max(1005, 1001) = 1005
Visible End (1-based): min(1015, 1050) = 1015

Gene Start In Line (0-based): 1005 - 1001 = 4
Gene End In Line (0-based): 1015 - 1001 = 14

Pixel Start X: 4 * ${charWidth} + (${charWidth} * 0.5) = ${4 * charWidth + (charWidth * 0.5)}px
Pixel End X: (14 + 1) * ${charWidth} + (${charWidth} * 0.5) = ${(14 + 1) * charWidth + (charWidth * 0.5)}px
Indicator Width: ${(14 + 1) * charWidth + (charWidth * 0.5)} - ${4 * charWidth + (charWidth * 0.5)} = ${((14 + 1) * charWidth + (charWidth * 0.5)) - (4 * charWidth + (charWidth * 0.5))}px
            `;
            
            detailsSection.style.display = 'block';
        }
        
        function testAlignment() {
            alert('请在GenomeExplorer中加载基因组文件并切换到View Mode来测试实际的对齐效果。\n\n验证要点：\n1. Gene Indicator Bar是否与DNA序列精确对齐\n2. 横向位置是否准确对应基因起止位置\n3. 竖向间距是否合适\n4. 基因方向指示是否正确');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎯 Gene Indicator Bar Alignment Test Page Loaded');
        });
    </script>
</body>
</html> 