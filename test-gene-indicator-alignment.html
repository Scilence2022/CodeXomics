<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Indicator Bar Alignment Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .alignment-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .sequence-line-demo {
            display: flex;
            margin-bottom: 8px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .position-demo {
            width: 100px;
            color: #6c757d;
            font-weight: 600;
            margin-right: 15px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .bases-demo {
            flex: 1;
            word-break: break-all;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .base-demo {
            display: inline-block;
            padding: 0;
            margin: 0;
            vertical-align: top;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .indicator-demo {
            height: 12px;
            margin-bottom: 2px;
            margin-top: -2px;
            position: relative;
        }
        
        .indicator-old {
            margin-left: 115px; /* Old hardcoded value */
        }
        
        .indicator-new {
            /* New calculated value: 100px (position) + 15px (margin) - 7.6px (0.8 * 9.5px charWidth) */
            margin-left: 107.4px;
        }
        
        .gene-rect {
            height: 6px;
            background: #4CAF50;
            opacity: 0.7;
            position: absolute;
            top: 3px;
            border-radius: 2px;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .improvement {
            color: #28a745;
            font-weight: 600;
        }
        
        .issue {
            color: #dc3545;
            font-weight: 600;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .test-instructions {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ¯ Gene Indicator Bar Alignment Test</h1>
            <p>éªŒè¯Gene Indicator Barä¸DNAåºåˆ—çš„ç²¾ç¡®å¯¹é½</p>
        </div>

        <!-- Problem Description -->
        <div class="test-section">
            <h3>ğŸ” Problem Analysis</h3>
            <div class="test-instructions">
                <h4>å¯¹é½é—®é¢˜æè¿°ï¼š</h4>
                <ul>
                    <li><strong>æ¨ªå‘åç§»</strong>ï¼šGene Indicator Barç›¸å¯¹äºDNAåºåˆ—å‘å³åç§»çº¦0.8ä¸ªç¢±åŸºä½ç½®</li>
                    <li><strong>ç«–å‘åç§»</strong>ï¼šIndicator Barä¸åºåˆ—è¡Œä¹‹é—´çš„å‚ç›´é—´è·ä¸å¤Ÿç´§å¯†</li>
                    <li><strong>åæ ‡ç³»ä¸åŒ¹é…</strong>ï¼šåŸºå› åæ ‡(1-based)ä¸åºåˆ—æ˜¾ç¤º(0-based)ä¹‹é—´çš„è½¬æ¢æœ‰è¯¯</li>
                    <li><strong>å­—ç¬¦å±…ä¸­</strong>ï¼šæ²¡æœ‰è€ƒè™‘å­—ç¬¦å®½åº¦çš„ä¸­å¿ƒå¯¹é½</li>
                </ul>
            </div>
        </div>

        <!-- Alignment Comparison -->
        <div class="test-section">
            <h3>ğŸ“ Alignment Comparison</h3>
            
            <h4>Before Fix (Misaligned):</h4>
            <div class="alignment-test">
                <div class="sequence-line-demo">
                    <span class="position-demo">1001</span>
                    <div class="bases-demo">
                        <span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">G</span><span class="base-demo">C</span><span class="base-demo">G</span><span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">T</span><span class="base-demo">C</span><span class="base-demo">G</span>
                    </div>
                </div>
                <div class="indicator-demo indicator-old">
                    <div class="gene-rect" style="left: 0px; width: 95px;"></div>
                    <small style="color: #dc3545;">âŒ åç§»çº¦0.8ä¸ªå­—ç¬¦ä½ç½®</small>
                </div>
            </div>
            
            <h4>After Fix (Aligned):</h4>
            <div class="alignment-test">
                <div class="sequence-line-demo">
                    <span class="position-demo">1001</span>
                    <div class="bases-demo">
                        <span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">G</span><span class="base-demo">C</span><span class="base-demo">G</span><span class="base-demo">A</span><span class="base-demo">T</span><span class="base-demo">T</span><span class="base-demo">C</span><span class="base-demo">G</span>
                    </div>
                </div>
                <div class="indicator-demo indicator-new">
                    <div class="gene-rect" style="left: 4.75px; width: 95px;"></div>
                    <small style="color: #28a745;">âœ… ç²¾ç¡®å¯¹é½åˆ°å­—ç¬¦ä¸­å¿ƒ</small>
                </div>
            </div>
        </div>

        <!-- Fix Details -->
        <div class="test-section">
            <h3>ğŸ”§ Fix Implementation</h3>
            
            <h4>1. Horizontal Alignment Fix:</h4>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Improvement</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Coordinate Conversion</td>
                        <td class="issue">Math.max(gene.start, lineStartAbs + 1) - lineStartAbs - 1</td>
                        <td class="improvement">visibleStart1Based - lineStart1Based</td>
                        <td>Clearer 1-based to 0-based conversion</td>
                    </tr>
                    <tr>
                        <td>Pixel Position</td>
                        <td class="issue">geneStartInLine * charWidth</td>
                        <td class="improvement">geneStartInLine * charWidth + (charWidth * 0.5)</td>
                        <td>Character center alignment</td>
                    </tr>
                    <tr>
                        <td>Indicator Margin</td>
                        <td class="issue">margin-left: 115px (hardcoded)</td>
                        <td class="improvement">margin-left: ${finalLeftMargin}px (calculated)</td>
                        <td>Precise alignment calculation</td>
                    </tr>
                </tbody>
            </table>
            
            <h4>2. Vertical Alignment Fix:</h4>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Before</th>
                        <th>After</th>
                        <th>Effect</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Margin Bottom</td>
                        <td class="issue">margin-bottom: 4px</td>
                        <td class="improvement">margin-bottom: 2px</td>
                        <td>Closer to sequence line</td>
                    </tr>
                    <tr>
                        <td>Margin Top</td>
                        <td class="issue">Not set</td>
                        <td class="improvement">margin-top: -2px</td>
                        <td>Pulls indicator closer</td>
                    </tr>
                    <tr>
                        <td>Left Adjustment</td>
                        <td class="issue">No horizontal compensation</td>
                        <td class="improvement">charWidth * 0.8 adjustment</td>
                        <td>Compensates for visual offset</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Code Changes -->
        <div class="test-section">
            <h3>ğŸ’» Code Changes</h3>
            
            <h4>1. renderSequenceLine() Method:</h4>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"><code>// Calculate exact left margin to align with sequence bases
const positionWidth = 100; // position span width
const marginRight = 15;    // margin-right of position span
const alignmentOffset = positionWidth + marginRight;
// Add horizontal offset to compensate for character centering (~0.8 characters)
const horizontalAdjustment = charWidth * 0.8;
const finalLeftMargin = alignmentOffset - horizontalAdjustment;

indicatorLine.style.cssText = `height: 12px; margin-left: ${finalLeftMargin}px; margin-bottom: 2px; margin-top: -2px;`;</code></pre>
            
            <h4>2. createGeneIndicator() Method:</h4>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 6px; overflow-x: auto;"><code>// Calculate the actual start and end positions within this line
const geneStart1Based = gene.start;
const geneEnd1Based = gene.end;
const lineStart1Based = lineStartAbs + 1; // Convert to 1-based
const lineEnd1Based = lineEndAbs;         // lineEndAbs is already 1-based equivalent

// Find the portion of the gene that overlaps with this line
const visibleStart1Based = Math.max(geneStart1Based, lineStart1Based);
const visibleEnd1Based = Math.min(geneEnd1Based, lineEnd1Based);

// Convert to 0-based positions relative to the start of this line
const geneStartInLine = visibleStart1Based - lineStart1Based;
const geneEndInLine = visibleEnd1Based - lineStart1Based;

// Convert to pixel positions with character centering
// Add 0.5 * charWidth to center the indicator on the character
const startX = geneStartInLine * charWidth + (charWidth * 0.5);
const endX = (geneEndInLine + 1) * charWidth + (charWidth * 0.5);</code></pre>
        </div>

        <!-- Testing Instructions -->
        <div class="test-section">
            <h3>ğŸ§ª Testing Instructions</h3>
            <div class="test-instructions">
                <h4>éªŒè¯æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>åœ¨GenomeExplorerä¸­åŠ è½½åŒ…å«åŸºå› æ³¨é‡Šçš„åŸºå› ç»„æ–‡ä»¶</li>
                    <li>åˆ‡æ¢åˆ°View Modeï¼ˆç¡®ä¿ä¸æ˜¯Edit Modeï¼‰</li>
                    <li>è§‚å¯ŸDNAåºåˆ—ä¸‹æ–¹çš„Gene Indicator Bar</li>
                    <li>éªŒè¯ä»¥ä¸‹å¯¹é½æ•ˆæœï¼š
                        <ul>
                            <li>âœ… Indicator barçš„å·¦è¾¹ç¼˜ä¸å¯¹åº”åŸºå› èµ·å§‹ç¢±åŸºå¯¹é½</li>
                            <li>âœ… Indicator barçš„å³è¾¹ç¼˜ä¸å¯¹åº”åŸºå› ç»ˆæ­¢ç¢±åŸºå¯¹é½</li>
                            <li>âœ… Indicator barä¸åºåˆ—è¡Œä¹‹é—´çš„å‚ç›´é—´è·åˆé€‚</li>
                            <li>âœ… åŸºå› æ–¹å‘ç®­å¤´æŒ‡å‘æ­£ç¡®</li>
                        </ul>
                    </li>
                    <li>æµ‹è¯•ä¸åŒé•¿åº¦çš„åŸºå› å’Œä¸åŒçš„åºåˆ—è¡Œ</li>
                    <li>éªŒè¯è·¨è¡ŒåŸºå› çš„éƒ¨åˆ†æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®</li>
                </ol>
            </div>
            
            <button class="btn" onclick="showCalculationDetails()">Show Calculation Details</button>
            <button class="btn" onclick="testAlignment()">Test Current Alignment</button>
        </div>

        <!-- Calculation Details -->
        <div class="test-section" id="calculationDetails" style="display: none;">
            <h3>ğŸ“Š Alignment Calculation Details</h3>
            <div id="calculationOutput" style="font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 6px;">
                <!-- Calculation results will be shown here -->
            </div>
        </div>
    </div>

    <script>
        function showCalculationDetails() {
            const detailsSection = document.getElementById('calculationDetails');
            const output = document.getElementById('calculationOutput');
            
            // Simulate the calculation
            const charWidth = 9.5; // Default character width
            const positionWidth = 100;
            const marginRight = 15;
            const alignmentOffset = positionWidth + marginRight;
            const horizontalAdjustment = charWidth * 0.8;
            const finalLeftMargin = alignmentOffset - horizontalAdjustment;
            
            output.innerHTML = `
<strong>Alignment Calculation:</strong>

Character Width: ${charWidth}px
Position Span Width: ${positionWidth}px
Position Margin Right: ${marginRight}px
Basic Alignment Offset: ${positionWidth} + ${marginRight} = ${alignmentOffset}px

Horizontal Adjustment: ${charWidth} * 0.8 = ${horizontalAdjustment}px
Final Left Margin: ${alignmentOffset} - ${horizontalAdjustment} = ${finalLeftMargin}px

<strong>Gene Position Calculation Example:</strong>
Gene Start (1-based): 1005
Gene End (1-based): 1015
Line Start (0-based): 1000
Line Start (1-based): 1001

Visible Start (1-based): max(1005, 1001) = 1005
Visible End (1-based): min(1015, 1050) = 1015

Gene Start In Line (0-based): 1005 - 1001 = 4
Gene End In Line (0-based): 1015 - 1001 = 14

Pixel Start X: 4 * ${charWidth} + (${charWidth} * 0.5) = ${4 * charWidth + (charWidth * 0.5)}px
Pixel End X: (14 + 1) * ${charWidth} + (${charWidth} * 0.5) = ${(14 + 1) * charWidth + (charWidth * 0.5)}px
Indicator Width: ${(14 + 1) * charWidth + (charWidth * 0.5)} - ${4 * charWidth + (charWidth * 0.5)} = ${((14 + 1) * charWidth + (charWidth * 0.5)) - (4 * charWidth + (charWidth * 0.5))}px
            `;
            
            detailsSection.style.display = 'block';
        }
        
        function testAlignment() {
            alert('è¯·åœ¨GenomeExplorerä¸­åŠ è½½åŸºå› ç»„æ–‡ä»¶å¹¶åˆ‡æ¢åˆ°View Modeæ¥æµ‹è¯•å®é™…çš„å¯¹é½æ•ˆæœã€‚\n\néªŒè¯è¦ç‚¹ï¼š\n1. Gene Indicator Baræ˜¯å¦ä¸DNAåºåˆ—ç²¾ç¡®å¯¹é½\n2. æ¨ªå‘ä½ç½®æ˜¯å¦å‡†ç¡®å¯¹åº”åŸºå› èµ·æ­¢ä½ç½®\n3. ç«–å‘é—´è·æ˜¯å¦åˆé€‚\n4. åŸºå› æ–¹å‘æŒ‡ç¤ºæ˜¯å¦æ­£ç¡®');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ Gene Indicator Bar Alignment Test Page Loaded');
        });
    </script>
</body>
</html> 