<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Indicator Bar Alignment Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-top: 0;
        }
        
        .alignment-test {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .sequence-line {
            display: flex;
            margin-bottom: 4px;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .sequence-position {
            width: 100px;
            color: #6c757d;
            font-weight: 600;
            margin-right: 15px;
            text-align: right;
            flex-shrink: 0;
        }
        
        .sequence-bases {
            flex: 1;
            word-break: break-all;
            font-family: "Courier New", monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .gene-indicator-line {
            height: 12px;
            margin-bottom: 4px;
            margin-top: -2px;
        }
        
        .base-a { color: #FF6B6B; }
        .base-t { color: #4ECDC4; }
        .base-g { color: #45B7D1; }
        .base-c { color: #96CEB4; }
        
        .alignment-grid {
            background: linear-gradient(90deg, transparent 0px, transparent 9px, #ddd 9px, #ddd 10px);
            background-size: 10px 1px;
            background-repeat: repeat-x;
            position: relative;
        }
        
        .alignment-ruler {
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #666;
            margin-bottom: 10px;
            padding-left: 115px;
        }
        
        .fix-highlight {
            background: #e7f3ff;
            border: 1px solid #007bff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .before, .after {
            padding: 15px;
            border-radius: 6px;
        }
        
        .before {
            background: #fff5f5;
            border: 1px solid #fed7d7;
        }
        
        .after {
            background: #f0fff4;
            border: 1px solid #c6f6d5;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .metrics {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ¯ Gene Indicator Bar Alignment Test</h1>
            <p>éªŒè¯Gene Indicator Barä¸DNAåºåˆ—çš„ä½ç½®å¯¹é½ä¿®å¤</p>
        </div>

        <!-- Problem Description -->
        <div class="test-section">
            <h3>ğŸ” Position Alignment Issues</h3>
            <div class="fix-highlight">
                <h4>å‘ç°çš„é—®é¢˜ï¼š</h4>
                <ul>
                    <li><strong>æ¨ªå‘åç§»</strong>ï¼šGene Indicatoréœ€è¦å‘å·¦è°ƒæ•´çº¦0.8ä¸ªç¢±åŸºä½ç½®</li>
                    <li><strong>ç«–å‘åç§»</strong>ï¼šIndicator Baréœ€è¦ä¸Šç§»ç›¸åŒè·ç¦»</li>
                    <li><strong>å­—ç¬¦å®½åº¦</strong>ï¼šæµ‹é‡æ–¹æ³•å¯èƒ½ä¸å®é™…æ¸²æŸ“æœ‰å·®å¼‚</li>
                </ul>
                
                <h4>ä¿®å¤æªæ–½ï¼š</h4>
                <ul>
                    <li>åœ¨<code>createGeneIndicator</code>ä¸­æ·»åŠ -0.8å­—ç¬¦å®½åº¦çš„æ¨ªå‘åç§»</li>
                    <li>è°ƒæ•´indicator lineçš„margin-leftè®¡ç®—ï¼ŒåŠ å…¥åç§»é‡</li>
                    <li>æ·»åŠ margin-top: -2pxä¸Šç§»indicator bar</li>
                    <li>æ”¹è¿›å­—ç¬¦å®½åº¦æµ‹é‡ï¼Œä½¿ç”¨æ›´é•¿å­—ç¬¦ä¸²å’ŒgetBoundingClientRect</li>
                </ul>
            </div>
        </div>

        <!-- Character Width Test -->
        <div class="test-section">
            <h3>ğŸ“ Character Width Measurement Test</h3>
            <p>æµ‹è¯•å­—ç¬¦å®½åº¦æµ‹é‡çš„å‡†ç¡®æ€§</p>
            
            <button class="btn" onclick="testCharacterWidth()">Test Character Width</button>
            
            <div id="charWidthResults" class="metrics" style="display: none;">
                <div>Measured Character Width: <span id="measuredWidth">0</span>px</div>
                <div>Expected Width (9.5px): <span id="expectedWidth">9.5</span>px</div>
                <div>Difference: <span id="widthDifference">0</span>px</div>
                <div>Accuracy: <span id="widthAccuracy">0</span>%</div>
            </div>
        </div>

        <!-- Alignment Visualization -->
        <div class="test-section">
            <h3>ğŸ“ Alignment Visualization</h3>
            <p>å¯è§†åŒ–å¯¹æ¯”ä¿®å¤å‰åçš„å¯¹é½æ•ˆæœ</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>ä¿®å¤å‰ (Before)</h4>
                    <div class="alignment-test">
                        <div class="alignment-ruler">1234567890123456789012345678901234567890</div>
                        <div class="sequence-line">
                            <span class="sequence-position">1,001</span>
                            <div class="sequence-bases">
                                <span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span>
                            </div>
                        </div>
                        <div class="gene-indicator-line" style="margin-left: 115px;">
                            <svg style="width: 95px; height: 12px; margin-left: 0;">
                                <!-- æ¨¡æ‹Ÿä¿®å¤å‰çš„ä½ç½® - åå³0.8ä¸ªå­—ç¬¦ -->
                                <rect x="7.6" y="3" width="38" height="6" fill="#4CAF50" opacity="0.7"/>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="after">
                    <h4>ä¿®å¤å (After)</h4>
                    <div class="alignment-test">
                        <div class="alignment-ruler">1234567890123456789012345678901234567890</div>
                        <div class="sequence-line">
                            <span class="sequence-position">1,001</span>
                            <div class="sequence-bases">
                                <span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span><span class="base-c">C</span><span class="base-g">G</span><span class="base-a">A</span><span class="base-t">T</span>
                            </div>
                        </div>
                        <div class="gene-indicator-line" id="fixedIndicatorLine">
                            <svg style="width: 95px; height: 12px; margin-left: 0;">
                                <!-- ä¿®å¤åçš„ä½ç½® - å·¦ç§»0.8ä¸ªå­—ç¬¦ -->
                                <rect x="0" y="3" width="38" height="6" fill="#4CAF50" opacity="0.7"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Position Calculation Test -->
        <div class="test-section">
            <h3>ğŸ§® Position Calculation Test</h3>
            <p>æµ‹è¯•ä½ç½®è®¡ç®—çš„å‡†ç¡®æ€§</p>
            
            <button class="btn" onclick="testPositionCalculation()">Test Position Calculation</button>
            <button class="btn" onclick="simulateAlignment()">Simulate Alignment</button>
            
            <div id="positionResults" class="metrics" style="display: none;">
                <div>Gene Start Position: <span id="geneStart">1001</span></div>
                <div>Gene End Position: <span id="geneEnd">1005</span></div>
                <div>Line Start Position: <span id="lineStart">1001</span></div>
                <div>Calculated Start X: <span id="startX">0</span>px</div>
                <div>Calculated End X: <span id="endX">0</span>px</div>
                <div>Horizontal Offset Applied: <span id="horizontalOffset">0</span>px</div>
                <div>Final Start X: <span id="finalStartX">0</span>px</div>
            </div>
        </div>

        <!-- Real-world Test -->
        <div class="test-section">
            <h3>ğŸ§ª Real-world Alignment Test</h3>
            <p>ä½¿ç”¨å®é™…çš„åŸºå› æ•°æ®æµ‹è¯•å¯¹é½æ•ˆæœ</p>
            
            <button class="btn" onclick="createRealWorldTest()">Create Real-world Test</button>
            
            <div id="realWorldTest" style="display: none;">
                <!-- è¿™é‡Œä¼šåŠ¨æ€ç”Ÿæˆå®é™…çš„åºåˆ—å’ŒæŒ‡ç¤ºå™¨ -->
            </div>
        </div>

        <!-- Verification Checklist -->
        <div class="test-section">
            <h3>âœ… Verification Checklist</h3>
            <div class="fix-highlight">
                <h4>éªŒè¯è¦ç‚¹ï¼š</h4>
                <ul>
                    <li>â–¡ Gene Indicatorçš„èµ·å§‹ä½ç½®ä¸å¯¹åº”ç¢±åŸºç²¾ç¡®å¯¹é½</li>
                    <li>â–¡ Gene Indicatorçš„ç»“æŸä½ç½®ä¸å¯¹åº”ç¢±åŸºç²¾ç¡®å¯¹é½</li>
                    <li>â–¡ ç«–å‘ä½ç½®ç´§è´´åºåˆ—è¡Œï¼Œæ— æ˜æ˜¾åç§»</li>
                    <li>â–¡ ä¸åŒé•¿åº¦çš„åŸºå› éƒ½èƒ½æ­£ç¡®å¯¹é½</li>
                    <li>â–¡ æ­£å‘å’Œåå‘åŸºå› çš„å¯¹é½éƒ½æ­£ç¡®</li>
                    <li>â–¡ å­—ç¬¦å®½åº¦æµ‹é‡å‡†ç¡®ï¼Œä¸å®é™…æ¸²æŸ“ä¸€è‡´</li>
                </ul>
                
                <h4>æµ‹è¯•æ­¥éª¤ï¼š</h4>
                <ol>
                    <li>åœ¨GenomeExplorerä¸­åŠ è½½åŒ…å«åŸºå› æ³¨é‡Šçš„æ–‡ä»¶</li>
                    <li>åˆ‡æ¢åˆ°View Mode</li>
                    <li>è§‚å¯ŸGene Indicator Barä¸DNAåºåˆ—çš„å¯¹é½</li>
                    <li>éªŒè¯ä¸åŒåŸºå› çš„èµ·å§‹å’Œç»“æŸä½ç½®</li>
                    <li>æ£€æŸ¥ç«–å‘å¯¹é½æ˜¯å¦æ”¹å–„</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Mock character width measurement
        function measureCharacterWidth() {
            const testElement = document.createElement('span');
            testElement.textContent = 'ATCGATCGATCGATCG'; // 16 characters
            testElement.style.fontFamily = "'Courier New', monospace";
            testElement.style.fontSize = '14px';
            testElement.style.fontWeight = 'normal';
            testElement.style.display = 'inline-block';
            testElement.style.padding = '0';
            testElement.style.margin = '0';
            testElement.style.verticalAlign = 'top';
            testElement.style.visibility = 'hidden';
            testElement.style.position = 'absolute';
            testElement.style.whiteSpace = 'nowrap';
            
            document.body.appendChild(testElement);
            const measuredWidth = testElement.getBoundingClientRect().width / 16;
            document.body.removeChild(testElement);
            
            return Math.max(8, measuredWidth);
        }

        function testCharacterWidth() {
            const resultsElement = document.getElementById('charWidthResults');
            resultsElement.style.display = 'block';
            
            const measuredWidth = measureCharacterWidth();
            const expectedWidth = 9.5;
            const difference = Math.abs(measuredWidth - expectedWidth);
            const accuracy = ((1 - difference / expectedWidth) * 100).toFixed(1);
            
            document.getElementById('measuredWidth').textContent = measuredWidth.toFixed(2);
            document.getElementById('widthDifference').textContent = difference.toFixed(2);
            document.getElementById('widthAccuracy').textContent = accuracy;
            
            console.log('Character width test:', {
                measured: measuredWidth,
                expected: expectedWidth,
                difference: difference,
                accuracy: accuracy + '%'
            });
        }

        function testPositionCalculation() {
            const resultsElement = document.getElementById('positionResults');
            resultsElement.style.display = 'block';
            
            // Mock gene and line data
            const gene = { start: 1001, end: 1005 };
            const lineStartAbs = 1001;
            const charWidth = measureCharacterWidth();
            
            // Calculate positions (simulating the fixed algorithm)
            const geneStartInLine = Math.max(gene.start, lineStartAbs + 1) - lineStartAbs - 1;
            const geneEndInLine = Math.min(gene.end, lineStartAbs + 1000) - lineStartAbs - 1; // Assume line end
            
            const horizontalOffset = -0.8 * charWidth;
            const startX = geneStartInLine * charWidth;
            const endX = (geneEndInLine + 1) * charWidth;
            const finalStartX = startX + horizontalOffset;
            
            document.getElementById('geneStart').textContent = gene.start;
            document.getElementById('geneEnd').textContent = gene.end;
            document.getElementById('lineStart').textContent = lineStartAbs;
            document.getElementById('startX').textContent = startX.toFixed(2);
            document.getElementById('endX').textContent = endX.toFixed(2);
            document.getElementById('horizontalOffset').textContent = horizontalOffset.toFixed(2);
            document.getElementById('finalStartX').textContent = finalStartX.toFixed(2);
            
            console.log('Position calculation test:', {
                gene,
                lineStartAbs,
                charWidth,
                geneStartInLine,
                geneEndInLine,
                startX,
                endX,
                horizontalOffset,
                finalStartX
            });
        }

        function simulateAlignment() {
            const charWidth = measureCharacterWidth();
            const horizontalOffset = -0.8 * charWidth;
            const indicatorMarginLeft = 115 + (0.8 * charWidth);
            
            // Update the fixed indicator line
            const fixedLine = document.getElementById('fixedIndicatorLine');
            fixedLine.style.marginLeft = indicatorMarginLeft + 'px';
            fixedLine.style.marginTop = '-2px';
            
            console.log('Alignment simulation:', {
                charWidth,
                horizontalOffset,
                indicatorMarginLeft
            });
            
            alert(`Alignment simulated with:\n` +
                  `Character Width: ${charWidth.toFixed(2)}px\n` +
                  `Horizontal Offset: ${horizontalOffset.toFixed(2)}px\n` +
                  `Indicator Margin Left: ${indicatorMarginLeft.toFixed(2)}px`);
        }

        function createRealWorldTest() {
            const testContainer = document.getElementById('realWorldTest');
            testContainer.style.display = 'block';
            
            const charWidth = measureCharacterWidth();
            const sequence = 'ATCGATCGATCGATCGATCGATCGATCGATCGATCGATCG';
            const lineStartPos = 1001;
            
            // Mock gene data
            const genes = [
                { start: 1005, end: 1015, type: 'CDS', name: 'Gene1' },
                { start: 1020, end: 1030, type: 'mRNA', name: 'Gene2' },
                { start: 1035, end: 1040, type: 'promoter', name: 'Promoter1' }
            ];
            
            let html = '<div class="alignment-test">';
            html += '<div class="alignment-ruler">1234567890123456789012345678901234567890</div>';
            
            // Create sequence line
            html += '<div class="sequence-line">';
            html += `<span class="sequence-position">${(lineStartPos + 1).toLocaleString()}</span>`;
            html += '<div class="sequence-bases">';
            for (let i = 0; i < sequence.length; i++) {
                const base = sequence[i];
                html += `<span class="base-${base.toLowerCase()}">${base}</span>`;
            }
            html += '</div></div>';
            
            // Create indicator line
            const indicatorMarginLeft = 115 + (0.8 * charWidth);
            html += `<div class="gene-indicator-line" style="margin-left: ${indicatorMarginLeft}px; margin-top: -2px;">`;
            html += `<svg style="width: ${sequence.length * charWidth}px; height: 12px; margin-left: 0;">`;
            
            // Add gene indicators
            genes.forEach(gene => {
                const geneStartInLine = Math.max(gene.start, lineStartPos + 1) - lineStartPos - 1;
                const geneEndInLine = Math.min(gene.end, lineStartPos + sequence.length) - lineStartPos - 1;
                
                if (geneStartInLine >= 0 && geneEndInLine < sequence.length) {
                    const horizontalOffset = -0.8 * charWidth;
                    const startX = geneStartInLine * charWidth + horizontalOffset;
                    const width = (geneEndInLine - geneStartInLine + 1) * charWidth;
                    
                    const colors = {
                        'CDS': '#4CAF50',
                        'mRNA': '#2196F3',
                        'promoter': '#FF9800'
                    };
                    
                    html += `<rect x="${startX}" y="3" width="${width}" height="6" ` +
                           `fill="${colors[gene.type]}" opacity="0.7" ` +
                           `title="${gene.name} (${gene.start}-${gene.end})"/>`;
                }
            });
            
            html += '</svg></div>';
            html += '</div>';
            
            testContainer.innerHTML = html;
            
            console.log('Real-world test created with genes:', genes);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ¯ Gene Indicator Bar Alignment Test Page Loaded');
            
            // Auto-run character width test
            setTimeout(testCharacterWidth, 500);
        });
    </script>
</body>
</html> 