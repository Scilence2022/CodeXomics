<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatBox Settings Test</title>
    <link rel="stylesheet" href="src/renderer/styles.css">
    <link rel="stylesheet" href="src/renderer/chatbox-settings-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .test-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .test-btn:hover {
            background: #5a67d8;
        }
        .settings-display {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            padding: 8px 16px;
            border-radius: 6px;
            margin: 12px 0;
            font-weight: 500;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #faeeba;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-panel">
            <h1>üß™ ChatBox Settings Test</h1>
            <p>Test the ChatBox settings system with various scenarios.</p>
            
            <h3>üì± Settings Management</h3>
            <button class="test-btn" onclick="openSettings()">
                <i class="fas fa-cog"></i> Open Settings Modal
            </button>
            <button class="test-btn" onclick="resetSettings()">
                <i class="fas fa-undo"></i> Reset to Defaults
            </button>
            <button class="test-btn" onclick="showCurrentSettings()">
                <i class="fas fa-info"></i> Show Current Settings
            </button>
            
            <h3>üîß Thinking Process Tests</h3>
            <button class="test-btn" onclick="testThinkingProcess()">
                Test Thinking Process
            </button>
            <button class="test-btn" onclick="testToolCalls()">
                Test Tool Calls
            </button>
            <button class="test-btn" onclick="testConversationEnd()">
                Test Conversation End
            </button>
            
            <h3>‚öôÔ∏è Settings Integration Tests</h3>
            <button class="test-btn" onclick="testSettingsChange('showThinkingProcess', false)">
                Disable Thinking Process
            </button>
            <button class="test-btn" onclick="testSettingsChange('showThinkingProcess', true)">
                Enable Thinking Process
            </button>
            <button class="test-btn" onclick="testSettingsChange('hideThinkingAfterConversation', true)">
                Hide After Conversation
            </button>
            <button class="test-btn" onclick="testSettingsChange('hideThinkingAfterConversation', false)">
                Keep After Conversation
            </button>
            
            <div id="statusIndicator" class="status-indicator status-success">
                Ready to test. Click any button above to start.
            </div>
        </div>

        <div class="test-panel">
            <h2>üìä Settings Monitor</h2>
            <div id="settingsDisplay" class="settings-display">
                Settings will be displayed here...
            </div>
            
            <h3>üéõÔ∏è Live Controls</h3>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" id="liveShowThinking" class="setting-checkbox" checked onchange="updateLiveSetting('showThinkingProcess', this.checked)">
                    <span class="setting-text">Show Thinking Process</span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" id="liveShowToolCalls" class="setting-checkbox" checked onchange="updateLiveSetting('showToolCalls', this.checked)">
                    <span class="setting-text">Show Tool Calls</span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" id="liveHideAfterConversation" class="setting-checkbox" onchange="updateLiveSetting('hideThinkingAfterConversation', this.checked)">
                    <span class="setting-text">Hide After Conversation</span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" id="liveAutoScroll" class="setting-checkbox" checked onchange="updateLiveSetting('autoScrollToBottom', this.checked)">
                    <span class="setting-text">Auto Scroll to Bottom</span>
                </label>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">
                    <span class="setting-text">Max History Messages</span>
                    <input type="number" id="liveMaxHistory" class="setting-input" value="1000" min="10" max="10000" step="10" onchange="updateLiveSetting('maxHistoryMessages', parseInt(this.value))">
                </label>
            </div>
        </div>
    </div>

    <div id="app"></div>

    <!-- Mock dependencies -->
    <script>
        class MockConfigManager {
            constructor() {
                this.config = {};
                this.chatHistory = [];
            }
            
            get(key, defaultValue) {
                return this.config[key] || defaultValue;
            }
            
            set(key, value) {
                this.config[key] = value;
            }
            
            addChatMessage(message, sender, timestamp) {
                const messageId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                this.chatHistory.push({ message, sender, timestamp, id: messageId });
                return messageId;
            }
            
            getChatHistory() {
                return this.chatHistory;
            }
            
            clearChatHistory() {
                this.chatHistory = [];
            }
        }

        class MockApp {
            constructor() {
                this.genomeBrowser = {
                    currentChromosome: 'chr1',
                    currentPosition: { start: 1000, end: 2000 },
                    loadedFiles: ['genome.fasta'],
                    availableTools: ['navigate_to_position', 'search_features', 'get_sequence'],
                    toolSources: { local: 10, plugins: 5, mcp: 3 }
                };
            }
        }

        // Initialize mock environment
        const mockApp = new MockApp();
        const mockConfigManager = new MockConfigManager();
        
        window.LLMConfigManager = class { 
            isConfigured() { return true; } 
            async sendMessageWithHistory() { return 'Mock response'; }
        };
        window.MCPServerManager = class { constructor() {} on() {} };
        window.PluginManager = class { constructor() {} on() {} };
        window.PluginFunctionCallsIntegrator = class { constructor() {} };
        window.SmartExecutor = class { constructor() {} };
        window.FunctionCallsOrganizer = class { constructor() {} };
    </script>

    <script src="src/renderer/modules/ChatBoxSettingsManager.js"></script>
    <script src="src/renderer/modules/ChatManager.js"></script>

    <script>
        // Initialize managers
        const chatBoxSettingsManager = new ChatBoxSettingsManager(mockConfigManager);
        const chatManager = new ChatManager(mockApp, mockConfigManager);
        
        // Set global references
        window.chatBoxSettingsManager = chatBoxSettingsManager;
        window.chatManager = chatManager;

        // Status update helper
        function updateStatus(message, type = 'success') {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator status-${type}`;
            indicator.textContent = message;
        }

        // Open settings modal
        function openSettings() {
            chatBoxSettingsManager.showSettingsModal();
            updateStatus('Settings modal opened');
        }

        // Reset settings
        function resetSettings() {
            chatBoxSettingsManager.resetToDefaults();
            updateStatus('Settings reset to defaults');
            updateLiveControls();
            showCurrentSettings();
        }

        // Show current settings
        function showCurrentSettings() {
            const settings = chatBoxSettingsManager.getAllSettings();
            document.getElementById('settingsDisplay').textContent = JSON.stringify(settings, null, 2);
            updateStatus('Settings displayed');
        }

        // Test thinking process
        function testThinkingProcess() {
            chatManager.startConversation();
            chatManager.addThinkingMessage('üîÑ Testing thinking process display...');
            
            setTimeout(() => {
                chatManager.updateThinkingMessage('üß¨ Analyzing genome data...');
            }, 1000);
            
            setTimeout(() => {
                chatManager.updateThinkingMessage('üìä Computing statistics...');
            }, 2000);
            
            setTimeout(() => {
                chatManager.endConversation();
                updateStatus('Thinking process test completed');
            }, 3000);
        }

        // Test tool calls
        function testToolCalls() {
            const mockTools = [
                { tool_name: 'get_sequence', parameters: { chromosome: 'chr1', start: 1000, end: 2000 } },
                { tool_name: 'calculate_gc_content', parameters: { sequence: 'ATCGATCG' } }
            ];
            
            chatManager.startConversation();
            chatManager.addToolCallMessage(mockTools);
            
            setTimeout(() => {
                const mockResults = [
                    { tool: 'get_sequence', success: true, result: 'Retrieved 1000bp sequence' },
                    { tool: 'calculate_gc_content', success: true, result: 'GC content: 45.2%' }
                ];
                chatManager.addToolResultMessage(mockResults);
            }, 2000);
            
            setTimeout(() => {
                chatManager.endConversation();
                updateStatus('Tool calls test completed');
            }, 3000);
        }

        // Test conversation end behavior
        function testConversationEnd() {
            chatManager.startConversation();
            chatManager.addThinkingMessage('üîÑ Starting conversation...');
            
            setTimeout(() => {
                chatManager.updateThinkingMessage('üí≠ This message should disappear or stay based on settings');
            }, 1000);
            
            setTimeout(() => {
                chatManager.endConversation();
                const hideAfter = chatBoxSettingsManager.getSetting('hideThinkingAfterConversation');
                updateStatus(`Conversation ended. Thinking process ${hideAfter ? 'hidden' : 'kept'} per settings.`);
            }, 2000);
        }

        // Test settings change
        function testSettingsChange(key, value) {
            const oldValue = chatBoxSettingsManager.getSetting(key);
            chatBoxSettingsManager.setSetting(key, value);
            updateStatus(`Setting '${key}' changed from ${oldValue} to ${value}`);
            updateLiveControls();
            showCurrentSettings();
        }

        // Update live setting
        function updateLiveSetting(key, value) {
            chatBoxSettingsManager.setSetting(key, value);
            updateStatus(`Live setting '${key}' updated to ${value}`);
            showCurrentSettings();
        }

        // Update live controls to match settings
        function updateLiveControls() {
            document.getElementById('liveShowThinking').checked = chatBoxSettingsManager.getSetting('showThinkingProcess');
            document.getElementById('liveShowToolCalls').checked = chatBoxSettingsManager.getSetting('showToolCalls');
            document.getElementById('liveHideAfterConversation').checked = chatBoxSettingsManager.getSetting('hideThinkingAfterConversation');
            document.getElementById('liveAutoScroll').checked = chatBoxSettingsManager.getSetting('autoScrollToBottom');
            document.getElementById('liveMaxHistory').value = chatBoxSettingsManager.getSetting('maxHistoryMessages');
        }

        // Listen for settings changes
        window.addEventListener('chatbox-settingsChanged', (event) => {
            updateStatus('Settings changed externally, updating display');
            updateLiveControls();
            showCurrentSettings();
        });

        // Auto-start test
        window.addEventListener('load', () => {
            setTimeout(() => {
                chatManager.addMessageToChat(
                    'üß™ ChatBox Settings Test Environment Loaded\n\n' +
                    '‚ú® Features available:\n' +
                    '‚Ä¢ Complete settings management\n' +
                    '‚Ä¢ Live settings updates\n' +
                    '‚Ä¢ Thinking process control\n' +
                    '‚Ä¢ Tool call visualization\n\n' +
                    'Use the controls on the left to test different scenarios.', 
                    'assistant'
                );
                updateStatus('Test environment ready');
                showCurrentSettings();
                updateLiveControls();
            }, 500);
        });

        // Periodically check settings consistency
        setInterval(() => {
            if (window.chatManager && window.chatManager.chatBoxSettingsManager) {
                const managerSettings = window.chatManager.chatBoxSettingsManager.getAllSettings();
                const currentSettings = chatBoxSettingsManager.getAllSettings();
                
                // Check if settings are in sync
                let inSync = true;
                for (const key in currentSettings) {
                    if (managerSettings[key] !== currentSettings[key]) {
                        inSync = false;
                        break;
                    }
                }
                
                if (!inSync) {
                    updateStatus('Settings out of sync, refreshing...', 'warning');
                    chatManager.updateSettingsFromManager();
                    updateLiveControls();
                }
            }
        }, 5000);

        // Test menu simulation
        function simulateMenuAction() {
            window.dispatchEvent(new CustomEvent('chatbox-settings'));
            updateStatus('Menu action simulated');
        }

        // Add menu simulation button
        setTimeout(() => {
            const menuTestBtn = document.createElement('button');
            menuTestBtn.className = 'test-btn';
            menuTestBtn.innerHTML = '<i class="fas fa-bars"></i> Simulate Menu Action';
            menuTestBtn.onclick = simulateMenuAction;
            document.querySelector('.test-panel').appendChild(menuTestBtn);
        }, 1000);
    </script>
</body>
</html> 