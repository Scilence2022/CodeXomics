<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefSeq Genome Search Fix Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .fix-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .fix-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #27ae60;
            padding-bottom: 5px;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .before, .after {
            padding: 15px;
            border-radius: 5px;
        }
        .before {
            background: #fadbd8;
            border-left: 4px solid #e74c3c;
        }
        .after {
            background: #d5f4e6;
            border-left: 4px solid #27ae60;
        }
        .code-block {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .test-button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #2980b9;
        }
        .test-results {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
        }
        .improvement {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .improvement-title {
            font-weight: bold;
            color: #155724;
            margin-bottom: 5px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d5f4e6;
            color: #145a32;
        }
        .status.error {
            background: #fadbd8;
            color: #922b21;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ RefSeq Genome Search Fix Verification</h1>
        <p>This page verifies the fixes implemented for RefSeq genome search issues in the NCBI unified interface.</p>

        <div class="fix-section">
            <div class="fix-title">üîß Fix 1: Database Mapping Correction</div>
            <p><strong>Issue:</strong> RefSeq genomes were incorrectly mapped to the 'genome' database instead of 'assembly'.</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>‚ùå Before</h4>
                    <div class="code-block">
&lt;option value="genome"&gt;RefSeq Genomes&lt;/option&gt;
&lt;option value="assembly"&gt;Assembly Data&lt;/option&gt;</div>
                    <p>RefSeq genomes searched in wrong database</p>
                </div>
                <div class="after">
                    <h4>‚úÖ After</h4>
                    <div class="code-block">
&lt;option value="assembly"&gt;RefSeq Genomes&lt;/option&gt;
&lt;option value="genome"&gt;Genome Records&lt;/option&gt;</div>
                    <p>RefSeq genomes now correctly use assembly database</p>
                </div>
            </div>
            
            <div class="improvement">
                <div class="improvement-title">Improvement:</div>
                RefSeq genome searches now use the correct NCBI assembly database which contains the actual RefSeq genome assemblies, providing proper genome-level data instead of individual sequence records.
            </div>
        </div>

        <div class="fix-section">
            <div class="fix-title">üîß Fix 2: Enhanced Query Optimization</div>
            <p><strong>Issue:</strong> Generic search queries didn't work well with the assembly database.</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>‚ùå Before</h4>
                    <div class="code-block">
// Basic query only
let query = searchTerm;</div>
                    <p>Simple search often returned no results</p>
                </div>
                <div class="after">
                    <h4>‚úÖ After</h4>
                    <div class="code-block">
// Assembly-specific query optimization
if (config.searchDb === 'assembly') {
    query = `"${searchTerm}"[Organism] OR ${searchTerm}[Infraspecific name] OR ${searchTerm}[Assembly name]`;
    query += ' AND ("latest refseq"[Filter] OR "refseq"[Filter])';
}</div>
                    <p>Optimized queries for assembly database</p>
                </div>
            </div>
            
            <div class="improvement">
                <div class="improvement-title">Improvement:</div>
                Search queries are now optimized for the assembly database with proper organism filters and RefSeq-specific filters, dramatically improving search result relevance and quantity.
            </div>
        </div>

        <div class="fix-section">
            <div class="fix-title">üîß Fix 3: Database-Specific Result Processing</div>
            <p><strong>Issue:</strong> Assembly results were processed using generic nucleotide sequence logic.</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>‚ùå Before</h4>
                    <div class="code-block">
// Generic processing for all databases
results.push({
    accession: summary.caption || id,
    title: summary.title || 'No title',
    organism: summary.organism || 'Unknown',
    length: summary.slen || 0
});</div>
                    <p>Assembly-specific fields ignored</p>
                </div>
                <div class="after">
                    <h4>‚úÖ After</h4>
                    <div class="code-block">
// Assembly-specific processing
case 'assembly':
    return {
        accession: summary.assemblyaccession || summary.caption,
        title: summary.title || summary.assemblydescription,
        organism: summary.organism || summary.infraspecificname,
        length: summary.totallength || summary.slen,
        assemblyLevel: summary.assemblylevel,
        assemblyStatus: summary.assemblystatus
    };</div>
                    <p>Proper assembly-specific field extraction</p>
                </div>
            </div>
            
            <div class="improvement">
                <div class="improvement-title">Improvement:</div>
                Results now properly extract assembly-specific metadata including assembly accession, assembly level (Complete/Chromosome/Scaffold/Contig), assembly status, and total genome size.
            </div>
        </div>

        <div class="fix-section">
            <div class="fix-title">üîß Fix 4: Enhanced Results Display</div>
            <p><strong>Issue:</strong> Results display didn't differentiate between database types.</p>
            
            <div class="before-after">
                <div class="before">
                    <h4>‚ùå Before</h4>
                    <div class="code-block">
&lt;strong&gt;Length:&lt;/strong&gt; ${result.length.toLocaleString()} bp</div>
                    <p>All lengths shown as base pairs</p>
                </div>
                <div class="after">
                    <h4>‚úÖ After</h4>
                    <div class="code-block">
// Smart length formatting
if (result.database === 'assembly' && result.length > 1000000) {
    lengthDisplay = `${(result.length / 1000000).toFixed(2)} Mb`;
} else if (result.database === 'protein') {
    lengthDisplay = `${result.length.toLocaleString()} aa`;
}</div>
                    <p>Context-appropriate size display</p>
                </div>
            </div>
            
            <div class="improvement">
                <div class="improvement-title">Improvement:</div>
                Results now display sizes appropriately (Mb for genomes, aa for proteins, bp for sequences) and include assembly-specific details like assembly level and status for better user understanding.
            </div>
        </div>

        <div class="fix-section">
            <div class="fix-title">üß™ Testing the Fixes</div>
            <p>Test the improved RefSeq genome search functionality:</p>
            
            <button class="test-button" onclick="testEcoliSearch()">Test E. coli K-12 Search</button>
            <button class="test-button" onclick="testSalmonellaSearch()">Test Salmonella Search</button>
            <button class="test-button" onclick="testBacillusSearch()">Test Bacillus subtilis Search</button>
            <button class="test-button" onclick="clearTestResults()">Clear Results</button>
            
            <div id="testResults" class="test-results">
                <p style="color: #666; text-align: center;">Click a test button to verify RefSeq genome search functionality</p>
            </div>
        </div>

        <div class="fix-section">
            <div class="fix-title">üìä Expected Improvements</div>
            <div class="improvement">
                <div class="improvement-title">‚úÖ Better Search Results</div>
                RefSeq genome searches now return actual genome assemblies instead of individual sequence records.
            </div>
            <div class="improvement">
                <div class="improvement-title">‚úÖ More Relevant Data</div>
                Results include assembly-specific metadata like completion level and assembly statistics.
            </div>
            <div class="improvement">
                <div class="improvement-title">‚úÖ Improved Query Success Rate</div>
                Enhanced query optimization dramatically increases the likelihood of finding relevant results.
            </div>
            <div class="improvement">
                <div class="improvement-title">‚úÖ Better User Experience</div>
                Clear display of genome sizes in Mb and assembly-specific information helps users make informed decisions.
            </div>
        </div>
    </div>

    <script>
        function showStatus(message, type = 'loading') {
            const container = document.getElementById('testResults');
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function testAssemblySearch(searchTerm, testName) {
            showStatus(`üîç Testing ${testName}...`, 'loading');
            
            try {
                // Test the new assembly-based search
                const query = `"${searchTerm}"[Organism] OR ${searchTerm}[Infraspecific name] OR ${searchTerm}[Assembly name]`;
                const fullQuery = query + ' AND ("latest refseq"[Filter] OR "refseq"[Filter])';
                
                const searchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=assembly&term=${encodeURIComponent(fullQuery)}&retmax=10&retmode=json`;
                
                console.log(`Testing search URL: ${searchUrl}`);
                
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                const resultCount = searchData.esearchresult?.count || 0;
                const retrievedIds = searchData.esearchresult?.idlist?.length || 0;
                
                if (retrievedIds > 0) {
                    // Get sample summary data
                    const ids = searchData.esearchresult.idlist.slice(0, 3).join(',');
                    const summaryUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=assembly&id=${ids}&retmode=json`;
                    
                    const summaryResponse = await fetch(summaryUrl);
                    const summaryData = await summaryResponse.json();
                    
                    let resultsHtml = `
                        <div class="status success">‚úÖ ${testName} Test Results</div>
                        <p><strong>Total assemblies found:</strong> ${resultCount.toLocaleString()}</p>
                        <p><strong>Sample results retrieved:</strong> ${retrievedIds}</p>
                        <h4>Sample Assembly Results:</h4>
                    `;
                    
                    for (const id of searchData.esearchresult.idlist.slice(0, 3)) {
                        const summary = summaryData.result?.[id];
                        if (summary) {
                            const assemblyAcc = summary.assemblyaccession || summary.caption || id;
                            const organism = summary.organism || summary.infraspecificname || 'Unknown';
                            const assemblyLevel = summary.assemblylevel || 'Unknown';
                            const assemblyStatus = summary.assemblystatus || 'Unknown';
                            const totalLength = summary.totallength || 0;
                            const lengthMb = totalLength > 0 ? (totalLength / 1000000).toFixed(2) : 'Unknown';
                            
                            resultsHtml += `
                                <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #28a745; border-radius: 4px;">
                                    <strong>${assemblyAcc}</strong> - ${organism}<br>
                                    <small>Level: ${assemblyLevel} | Status: ${assemblyStatus} | Size: ${lengthMb} Mb</small>
                                </div>
                            `;
                        }
                    }
                    
                    document.getElementById('testResults').innerHTML = resultsHtml;
                } else {
                    showStatus(`‚ùå ${testName} test found no results. This may indicate an issue with the search query.`, 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå ${testName} test failed: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        }

        function testEcoliSearch() {
            testAssemblySearch('Escherichia coli str. K-12', 'E. coli K-12');
        }

        function testSalmonellaSearch() {
            testAssemblySearch('Salmonella enterica', 'Salmonella enterica');
        }

        function testBacillusSearch() {
            testAssemblySearch('Bacillus subtilis', 'Bacillus subtilis');
        }

        function clearTestResults() {
            document.getElementById('testResults').innerHTML = '<p style="color: #666; text-align: center;">Click a test button to verify RefSeq genome search functionality</p>';
        }

        // Auto-load information
        window.addEventListener('load', () => {
            console.log('RefSeq Genome Search Fix Verification loaded');
            console.log('Fixes implemented:');
            console.log('1. Database mapping: RefSeq genomes now use assembly database');
            console.log('2. Query optimization: Assembly-specific search terms');
            console.log('3. Result processing: Database-specific field extraction');
            console.log('4. Display enhancement: Context-appropriate formatting');
        });
    </script>
</body>
</html> 