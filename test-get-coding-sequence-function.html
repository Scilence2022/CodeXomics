<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Coding Sequence Function Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(45deg, #2980b9, #3498db);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(45deg, #e67e22, #f39c12);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .result {
            background: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #e1e8ed;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .success {
            border-left: 4px solid #27ae60;
            background: #d5f4e6;
        }

        .error {
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
        }

        .info {
            border-left: 4px solid #3498db;
            background: #ebf3fd;
        }

        .gene-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .gene-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .gene-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .gene-card p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .sequence-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            margin: 10px 0;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: #ffffff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .stat-item strong {
            display: block;
            font-size: 1.2em;
            color: #3498db;
            margin-bottom: 5px;
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß¨ Get Coding Sequence Function Test</h1>
        
        <div class="test-section">
            <h2>üî¨ Function Testing Controls</h2>
            <div class="controls">
                <button class="btn-primary" onclick="setupMockEnvironment()">Setup Mock Environment</button>
                <button class="btn-success" onclick="testSingleGene()">Test Single Gene</button>
                <button class="btn-success" onclick="testMultipleGenes()">Test Multiple Genes</button>
                <button class="btn-warning" onclick="testErrorHandling()">Test Error Handling</button>
                <button class="btn-primary" onclick="testFastaExport()">Test FASTA Export</button>
            </div>
        </div>

        <div class="test-section">
            <h2>‚öôÔ∏è Manual Testing</h2>
            <div class="input-group">
                <label for="geneInput">Gene Name or Locus Tag:</label>
                <input type="text" id="geneInput" placeholder="e.g., lacZ, b0344, dnaA" value="lacZ">
            </div>
            <div class="input-group">
                <label for="formatSelect">Output Format:</label>
                <select id="formatSelect">
                    <option value="object">Detailed Object</option>
                    <option value="fasta">FASTA Format</option>
                    <option value="sequence_only">Sequence Only</option>
                </select>
            </div>
            <div class="controls">
                <button class="btn-primary" onclick="testManualInput()">Get Coding Sequence</button>
                <button class="btn-success" onclick="clearResults()">Clear Results</button>
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        // Mock data for testing
        const mockGenomeData = {
            currentSequence: {
                'NC_000913.3': 'ATGAAACGCATTAACCTTTACCCTTACGAGCAATGATGCAACCTAAACGGACAGCCGACGGAACCGCTGGAGAGCAACTGCATAACGGACGATGGCCGCTACAACAAGCTGACGGACAACGCCGGGCTGCGTAAACTGGCCGACAAGTTCACCGCCGACGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGGTGACCGCCGACGGCAACCTGGGCGACATGACCGACAACCTGCTGACCGACATCAACAAGTAG'
            },
            currentAnnotations: {
                'NC_000913.3': [
                    {
                        type: 'CDS',
                        start: 1,
                        end: 1020,
                        strand: 1,
                        qualifiers: {
                            gene: 'lacZ',
                            locus_tag: 'b0344',
                            product: 'beta-galactosidase'
                        }
                    },
                    {
                        type: 'CDS',
                        start: 1100,
                        end: 1800,
                        strand: -1,
                        qualifiers: {
                            gene: 'dnaA',
                            locus_tag: 'b3702',
                            product: 'chromosomal replication initiator protein DnaA'
                        }
                    },
                    {
                        type: 'CDS',
                        start: 2000,
                        end: 2600,
                        strand: 1,
                        qualifiers: {
                            gene: 'recA',
                            locus_tag: 'b2699',
                            product: 'DNA recombination/repair protein RecA'
                        }
                    }
                ]
            }
        };

        // Mock MicrobeGenomicsFunctions
        const mockMicrobeFns = {
            searchGeneByName: function(name) {
                const annotations = mockGenomeData.currentAnnotations['NC_000913.3'];
                const gene = annotations.find(g => 
                    g.qualifiers.gene === name || g.qualifiers.locus_tag === name
                );
                if (gene) {
                    return {
                        chromosome: 'NC_000913.3',
                        feature: gene
                    };
                }
                return null;
            },

            reverseComplement: function(sequence) {
                const complement = { 'A': 'T', 'T': 'A', 'G': 'C', 'C': 'G' };
                return sequence.split('').reverse().map(base => complement[base] || base).join('');
            },

            computeGC: function(sequence) {
                const g = (sequence.match(/G/gi) || []).length;
                const c = (sequence.match(/C/gi) || []).length;
                return ((g + c) / sequence.length) * 100;
            },

            translateDNA: function(sequence) {
                const geneticCode = {
                    'TTT': 'F', 'TTC': 'F', 'TTA': 'L', 'TTG': 'L',
                    'TCT': 'S', 'TCC': 'S', 'TCA': 'S', 'TCG': 'S',
                    'TAT': 'Y', 'TAC': 'Y', 'TAA': '*', 'TAG': '*',
                    'TGT': 'C', 'TGC': 'C', 'TGA': '*', 'TGG': 'W',
                    'CTT': 'L', 'CTC': 'L', 'CTA': 'L', 'CTG': 'L',
                    'CCT': 'P', 'CCC': 'P', 'CCA': 'P', 'CCG': 'P',
                    'CAT': 'H', 'CAC': 'H', 'CAA': 'Q', 'CAG': 'Q',
                    'CGT': 'R', 'CGC': 'R', 'CGA': 'R', 'CGG': 'R',
                    'ATT': 'I', 'ATC': 'I', 'ATA': 'I', 'ATG': 'M',
                    'ACT': 'T', 'ACC': 'T', 'ACA': 'T', 'ACG': 'T',
                    'AAT': 'N', 'AAC': 'N', 'AAA': 'K', 'AAG': 'K',
                    'AGT': 'S', 'AGC': 'S', 'AGA': 'R', 'AGG': 'R',
                    'GTT': 'V', 'GTC': 'V', 'GTA': 'V', 'GTG': 'V',
                    'GCT': 'A', 'GCC': 'A', 'GCA': 'A', 'GCG': 'A',
                    'GAT': 'D', 'GAC': 'D', 'GAA': 'E', 'GAG': 'E',
                    'GGT': 'G', 'GGC': 'G', 'GGA': 'G', 'GGG': 'G'
                };

                let protein = '';
                for (let i = 0; i < sequence.length - 2; i += 3) {
                    const codon = sequence.substring(i, i + 3);
                    protein += geneticCode[codon] || 'X';
                }
                return protein;
            },

            getCodingSequence: function(identifier) {
                const geneResult = this.searchGeneByName(identifier);
                if (!geneResult) {
                    return {
                        success: false,
                        error: `Gene "${identifier}" not found`,
                        identifier: identifier
                    };
                }

                const { chromosome, feature } = geneResult;
                const fullSequence = mockGenomeData.currentSequence[chromosome];
                let geneSequence = fullSequence.substring(feature.start - 1, feature.end);

                const geneName = feature.qualifiers?.gene || identifier;
                const locusTag = feature.qualifiers?.locus_tag || identifier;
                const isReverse = feature.strand === -1;

                let codingSequence = geneSequence;
                if (isReverse) {
                    codingSequence = this.reverseComplement(geneSequence);
                }

                const gcContent = this.computeGC(codingSequence);
                const proteinSequence = this.translateDNA(codingSequence);

                return {
                    success: true,
                    identifier: identifier,
                    geneName: geneName,
                    locusTag: locusTag,
                    chromosome: chromosome,
                    start: feature.start,
                    end: feature.end,
                    strand: isReverse ? '-' : '+',
                    length: codingSequence.length,
                    codingSequence: codingSequence,
                    proteinSequence: proteinSequence,
                    gcContent: parseFloat(gcContent.toFixed(2)),
                    proteinLength: proteinSequence.length,
                    geneType: feature.type || 'CDS',
                    qualifiers: feature.qualifiers || {}
                };
            },

            getMultipleCodingSequences: function(identifiers) {
                return identifiers.map(identifier => this.getCodingSequence(identifier));
            },

            exportCodingSequenceFasta: function(identifier, includeProtein = false) {
                const result = this.getCodingSequence(identifier);
                if (!result.success) {
                    throw new Error(result.error);
                }

                let fasta = '';
                const dnaHeader = `>${result.geneName || result.locusTag}_CDS ${result.chromosome}:${result.start}-${result.end} (${result.strand} strand) [${result.length} bp]`;
                fasta += `${dnaHeader}\n${result.codingSequence}\n`;

                if (includeProtein) {
                    const proteinHeader = `>${result.geneName || result.locusTag}_PROTEIN translated from ${result.chromosome}:${result.start}-${result.end} (${result.strand} strand) [${result.proteinLength} aa]`;
                    fasta += `\n${proteinHeader}\n${result.proteinSequence}\n`;
                }

                return fasta;
            }
        };

        function setupMockEnvironment() {
            // Setup mock environment
            window.genomeBrowser = mockGenomeData;
            window.MicrobeFns = mockMicrobeFns;

            displayResult({
                success: true,
                message: 'Mock environment setup complete',
                details: {
                    chromosomes: Object.keys(mockGenomeData.currentSequence),
                    sequenceLength: mockGenomeData.currentSequence['NC_000913.3'].length,
                    annotationsCount: mockGenomeData.currentAnnotations['NC_000913.3'].length,
                    availableGenes: mockGenomeData.currentAnnotations['NC_000913.3'].map(g => ({
                        gene: g.qualifiers.gene,
                        locus_tag: g.qualifiers.locus_tag,
                        strand: g.strand === -1 ? '-' : '+',
                        product: g.qualifiers.product
                    }))
                }
            }, 'Setup Complete', 'success');
        }

        function testSingleGene() {
            if (!window.MicrobeFns) {
                displayResult({ error: 'Mock environment not setup. Click "Setup Mock Environment" first.' }, 'Error', 'error');
                return;
            }

            try {
                const result = window.MicrobeFns.getCodingSequence('lacZ');
                
                if (result.success) {
                    displayGeneResult(result, 'Single Gene Test - lacZ');
                } else {
                    displayResult(result, 'Single Gene Test Failed', 'error');
                }
            } catch (error) {
                displayResult({ error: error.message }, 'Single Gene Test Error', 'error');
            }
        }

        function testMultipleGenes() {
            if (!window.MicrobeFns) {
                displayResult({ error: 'Mock environment not setup. Click "Setup Mock Environment" first.' }, 'Error', 'error');
                return;
            }

            try {
                const identifiers = ['lacZ', 'dnaA', 'recA'];
                const results = window.MicrobeFns.getMultipleCodingSequences(identifiers);
                
                const successful = results.filter(r => r.success);
                const failed = results.filter(r => !r.success);

                let html = `
                    <div class="test-section">
                        <h2>üìä Multiple Genes Test Results</h2>
                        <div class="stats">
                            <div class="stat-item">
                                <strong>${results.length}</strong>
                                Total Requested
                            </div>
                            <div class="stat-item">
                                <strong>${successful.length}</strong>
                                Successful
                            </div>
                            <div class="stat-item">
                                <strong>${failed.length}</strong>
                                Failed
                            </div>
                        </div>
                `;

                if (successful.length > 0) {
                    html += '<div class="gene-info">';
                    successful.forEach(result => {
                        html += `
                            <div class="gene-card">
                                <h4>${result.geneName} (${result.locusTag})</h4>
                                <p><strong>Position:</strong> ${result.chromosome}:${result.start}-${result.end}</p>
                                <p><strong>Strand:</strong> ${result.strand}</p>
                                <p><strong>Length:</strong> ${result.length} bp</p>
                                <p><strong>GC Content:</strong> ${result.gcContent}%</p>
                                <p><strong>Protein Length:</strong> ${result.proteinLength} aa</p>
                                <div class="sequence-display">${result.codingSequence.substring(0, 120)}${result.codingSequence.length > 120 ? '...' : ''}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (failed.length > 0) {
                    html += '<h3>‚ùå Failed Requests:</h3>';
                    failed.forEach(result => {
                        html += `<div class="result error">${result.identifier}: ${result.error}</div>`;
                    });
                }

                html += '</div>';
                document.getElementById('results').innerHTML = html;

            } catch (error) {
                displayResult({ error: error.message }, 'Multiple Genes Test Error', 'error');
            }
        }

        function testErrorHandling() {
            if (!window.MicrobeFns) {
                displayResult({ error: 'Mock environment not setup. Click "Setup Mock Environment" first.' }, 'Error', 'error');
                return;
            }

            const testCases = [
                { identifier: 'nonexistent_gene', expected: 'Gene not found' },
                { identifier: '', expected: 'Empty identifier' },
                { identifier: 'unknown_locus', expected: 'Unknown locus tag' }
            ];

            let html = `
                <div class="test-section">
                    <h2>üö® Error Handling Test Results</h2>
            `;

            testCases.forEach((testCase, index) => {
                try {
                    const result = window.MicrobeFns.getCodingSequence(testCase.identifier);
                    const status = result.success ? 'Unexpected Success' : 'Expected Failure';
                    const cssClass = result.success ? 'error' : 'success';
                    
                    html += `
                        <div class="result ${cssClass}">
                            <strong>Test ${index + 1}:</strong> "${testCase.identifier}"
                            <br><strong>Status:</strong> ${status}
                            <br><strong>Message:</strong> ${result.error || 'Success'}
                        </div>
                    `;
                } catch (error) {
                    html += `
                        <div class="result error">
                            <strong>Test ${index + 1}:</strong> "${testCase.identifier}"
                            <br><strong>Status:</strong> Exception Thrown
                            <br><strong>Error:</strong> ${error.message}
                        </div>
                    `;
                }
            });

            html += '</div>';
            document.getElementById('results').innerHTML = html;
        }

        function testFastaExport() {
            if (!window.MicrobeFns) {
                displayResult({ error: 'Mock environment not setup. Click "Setup Mock Environment" first.' }, 'Error', 'error');
                return;
            }

            try {
                const dnaOnly = window.MicrobeFns.exportCodingSequenceFasta('lacZ', false);
                const withProtein = window.MicrobeFns.exportCodingSequenceFasta('lacZ', true);

                let html = `
                    <div class="test-section">
                        <h2>üìÑ FASTA Export Test Results</h2>
                        
                        <h3>DNA Only:</h3>
                        <div class="sequence-display">${dnaOnly}</div>
                        
                        <h3>DNA + Protein:</h3>
                        <div class="sequence-display">${withProtein}</div>
                    </div>
                `;

                document.getElementById('results').innerHTML = html;

            } catch (error) {
                displayResult({ error: error.message }, 'FASTA Export Test Error', 'error');
            }
        }

        function testManualInput() {
            if (!window.MicrobeFns) {
                displayResult({ error: 'Mock environment not setup. Click "Setup Mock Environment" first.' }, 'Error', 'error');
                return;
            }

            const geneInput = document.getElementById('geneInput').value.trim();
            const format = document.getElementById('formatSelect').value;

            if (!geneInput) {
                displayResult({ error: 'Please enter a gene name or locus tag' }, 'Input Error', 'error');
                return;
            }

            try {
                if (format === 'fasta') {
                    const fasta = window.MicrobeFns.exportCodingSequenceFasta(geneInput, true);
                    let html = `
                        <div class="test-section">
                            <h2>üìÑ Manual Test - FASTA Format</h2>
                            <div class="sequence-display">${fasta}</div>
                        </div>
                    `;
                    document.getElementById('results').innerHTML = html;
                } else {
                    const result = window.MicrobeFns.getCodingSequence(geneInput);
                    if (result.success) {
                        displayGeneResult(result, `Manual Test - ${geneInput}`);
                    } else {
                        displayResult(result, 'Manual Test Failed', 'error');
                    }
                }
            } catch (error) {
                displayResult({ error: error.message }, 'Manual Test Error', 'error');
            }
        }

        function displayGeneResult(result, title) {
            let html = `
                <div class="test-section">
                    <h2>üß¨ ${title}</h2>
                    
                    <div class="stats">
                        <div class="stat-item">
                            <strong>${result.geneName}</strong>
                            Gene Name
                        </div>
                        <div class="stat-item">
                            <strong>${result.locusTag}</strong>
                            Locus Tag
                        </div>
                        <div class="stat-item">
                            <strong>${result.strand}</strong>
                            Strand
                        </div>
                        <div class="stat-item">
                            <strong>${result.length} bp</strong>
                            CDS Length
                        </div>
                        <div class="stat-item">
                            <strong>${result.gcContent}%</strong>
                            GC Content
                        </div>
                        <div class="stat-item">
                            <strong>${result.proteinLength} aa</strong>
                            Protein Length
                        </div>
                    </div>

                    <h3>üìç Location Information:</h3>
                    <div class="result info">
                        <strong>Chromosome:</strong> ${result.chromosome}
                        <br><strong>Position:</strong> ${result.start}-${result.end}
                        <br><strong>Product:</strong> ${result.qualifiers.product || 'Unknown'}
                    </div>

                    <h3>üß¨ Coding Sequence (DNA):</h3>
                    <div class="sequence-display">${result.codingSequence}</div>

                    <h3>üî§ Protein Sequence:</h3>
                    <div class="sequence-display">${result.proteinSequence}</div>
                </div>
            `;

            document.getElementById('results').innerHTML = html;
        }

        function displayResult(result, title, type = 'info') {
            const html = `
                <div class="test-section">
                    <h2>${title}</h2>
                    <div class="result ${type}">
                        ${JSON.stringify(result, null, 2)}
                    </div>
                </div>
            `;
            document.getElementById('results').innerHTML = html;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            displayResult({
                message: 'Get Coding Sequence Function Test Ready',
                instructions: [
                    '1. Click "Setup Mock Environment" to initialize test data',
                    '2. Run various tests to verify functionality',
                    '3. Use manual testing for custom inputs',
                    '4. Check error handling with invalid inputs'
                ],
                features: [
                    'Single gene coding sequence extraction',
                    'Multiple genes batch processing',
                    'Reverse complement for negative strand genes',
                    'FASTA format export',
                    'Protein translation',
                    'GC content calculation',
                    'Comprehensive error handling'
                ]
            }, 'Welcome to Get Coding Sequence Function Test', 'info');
        });
    </script>
</body>
</html> 