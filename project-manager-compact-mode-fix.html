<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager Compact Mode Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        }
        
        .fix-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
        }
        
        .fix-section h3 {
            color: #667eea;
            margin-top: 0;
        }
        
        .code-block {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .test-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .fix-result {
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .fix-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .fix-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .fix-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 Project Manager Compact Mode Fix</h1>
        
        <div class="fix-section">
            <h3>🎯 问题诊断</h3>
            <p>错误信息：<code>projectManagerWindow.toggleCompactMode is not a function</code></p>
            <p>原因分析：</p>
            <ul>
                <li>ProjectManagerWindow.js 脚本可能未正确加载</li>
                <li>projectManagerWindow 实例可能在DOM完全加载前被访问</li>
                <li>可能存在重复的变量声明</li>
            </ul>
        </div>
        
        <div class="fix-section">
            <h3>🛠️ 修复方案</h3>
            
            <h4>方案1: 添加安全包装函数</h4>
            <div class="code-block">
// 在 &lt;script&gt; 标签中添加安全包装函数
function toggleCompactMode() {
    if (window.projectManagerWindow && 
        typeof window.projectManagerWindow.toggleCompactMode === 'function') {
        window.projectManagerWindow.toggleCompactMode();
    } else {
        console.warn('ProjectManagerWindow not ready or toggleCompactMode method not available');
        // 延迟重试
        setTimeout(toggleCompactMode, 500);
    }
}
            </div>
            
            <h4>方案2: 使用事件委托</h4>
            <div class="code-block">
// 使用事件委托而不是内联事件处理器
document.addEventListener('DOMContentLoaded', () => {
    const compactToggle = document.getElementById('compactModeToggle');
    if (compactToggle) {
        compactToggle.addEventListener('change', (e) => {
            if (projectManagerWindow && projectManagerWindow.toggleCompactMode) {
                projectManagerWindow.toggleCompactMode();
            }
        });
    }
});
            </div>
            
            <h4>方案3: 确保脚本加载顺序</h4>
            <div class="code-block">
&lt;!-- 确保 ProjectManagerWindow.js 在使用前加载 --&gt;
&lt;script src="renderer/modules/ProjectManagerWindow.js"&gt;&lt;/script&gt;
&lt;script src="renderer/modules/ProjectXMLHandler.js"&gt;&lt;/script&gt;
&lt;script src="renderer/modules/ProjectManager.js"&gt;&lt;/script&gt;
            </div>
        </div>
        
        <div class="fix-section">
            <h3>✅ 推荐的完整修复</h3>
            <p>结合多种方案的最佳修复方式：</p>
            
            <div class="code-block">
&lt;!-- HTML 中的 toggle switch --&gt;
&lt;input type="checkbox" id="compactModeToggle"&gt;

&lt;script&gt;
// 安全的初始化函数
function initializeCompactMode() {
    const toggle = document.getElementById('compactModeToggle');
    if (toggle && window.projectManagerWindow) {
        toggle.addEventListener('change', () => {
            if (typeof projectManagerWindow.toggleCompactMode === 'function') {
                projectManagerWindow.toggleCompactMode();
            }
        });
        
        // 加载保存的偏好设置
        if (typeof projectManagerWindow.initializeCompactMode === 'function') {
            projectManagerWindow.initializeCompactMode();
        }
    }
}

// 等待 ProjectManagerWindow 实例化后再初始化
document.addEventListener('DOMContentLoaded', () => {
    // 延迟初始化以确保所有脚本都已加载
    setTimeout(initializeCompactMode, 100);
});
&lt;/script&gt;
            </div>
        </div>
        
        <div class="fix-section">
            <h3>🧪 测试修复结果</h3>
            <button class="test-btn" onclick="testProjectManagerWindowAvailable()">
                检查 ProjectManagerWindow 可用性
            </button>
            <button class="test-btn" onclick="testToggleFunctionAvailable()">
                检查 toggleCompactMode 方法
            </button>
            <button class="test-btn" onclick="applyQuickFix()">
                应用快速修复
            </button>
            
            <div id="fixResults"></div>
        </div>
        
        <div class="fix-section">
            <h3>📁 修复后的项目管理器</h3>
            <iframe src="src/project-manager.html" width="100%" height="600" style="border: 2px solid #dee2e6; border-radius: 12px;"></iframe>
        </div>
    </div>

    <script>
        function addFixResult(test, status, message) {
            const resultsDiv = document.getElementById('fixResults');
            const statusClass = status === 'SUCCESS' ? 'fix-success' : 
                              status === 'ERROR' ? 'fix-error' : 'fix-info';
            
            const resultHtml = `
                <div class="fix-result ${statusClass}">
                    <strong>${test}</strong><br>
                    ${message}
                </div>
            `;
            resultsDiv.innerHTML += resultHtml;
        }
        
        function testProjectManagerWindowAvailable() {
            try {
                const iframe = document.querySelector('iframe');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow.projectManagerWindow) {
                    addFixResult('ProjectManagerWindow 检查', 'SUCCESS', 
                        'ProjectManagerWindow 实例已创建并可访问');
                } else {
                    addFixResult('ProjectManagerWindow 检查', 'ERROR', 
                        'ProjectManagerWindow 实例不可用，需要检查脚本加载');
                }
            } catch (error) {
                addFixResult('ProjectManagerWindow 检查', 'ERROR', 
                    `检查失败: ${error.message}`);
            }
        }
        
        function testToggleFunctionAvailable() {
            try {
                const iframe = document.querySelector('iframe');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow.projectManagerWindow && 
                    typeof iframeWindow.projectManagerWindow.toggleCompactMode === 'function') {
                    addFixResult('toggleCompactMode 方法检查', 'SUCCESS', 
                        'toggleCompactMode 方法可用');
                } else {
                    addFixResult('toggleCompactMode 方法检查', 'ERROR', 
                        'toggleCompactMode 方法不可用');
                }
            } catch (error) {
                addFixResult('toggleCompactMode 方法检查', 'ERROR', 
                    `检查失败: ${error.message}`);
            }
        }
        
        function applyQuickFix() {
            addFixResult('快速修复', 'INFO', 
                '正在应用修复...');
            
            try {
                const iframe = document.querySelector('iframe');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeWindow = iframe.contentWindow;
                
                // 创建安全的包装函数
                iframeWindow.toggleCompactMode = function() {
                    if (iframeWindow.projectManagerWindow && 
                        typeof iframeWindow.projectManagerWindow.toggleCompactMode === 'function') {
                        iframeWindow.projectManagerWindow.toggleCompactMode();
                    } else {
                        console.warn('ProjectManagerWindow not ready, retrying...');
                        setTimeout(() => {
                            if (iframeWindow.projectManagerWindow && 
                                typeof iframeWindow.projectManagerWindow.toggleCompactMode === 'function') {
                                iframeWindow.projectManagerWindow.toggleCompactMode();
                            }
                        }, 500);
                    }
                };
                
                addFixResult('快速修复', 'SUCCESS', 
                    '安全包装函数已添加，现在可以尝试使用 Simple Mode 切换');
                    
            } catch (error) {
                addFixResult('快速修复', 'ERROR', 
                    `修复失败: ${error.message}`);
            }
        }
        
        // 清空之前的结果
        window.addEventListener('load', () => {
            document.getElementById('fixResults').innerHTML = '';
        });
    </script>
</body>
</html> 