<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强ChatBox功能测试</title>
    <link rel="stylesheet" href="src/renderer/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: 80vh;
        }
        .demo-info {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        .feature-demo {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #667eea;
        }
        .test-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 4px;
            transition: background 0.2s;
        }
        .test-btn:hover {
            background: #5a67d8;
        }
        .chat-wrapper {
            position: relative;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="demo-info">
            <h1>🚀 GenomeExplorer 增强ChatBox功能</h1>
            
            <div class="feature-demo">
                <h3>✨ 新功能概述</h3>
                <ul>
                    <li><strong>完整思考过程显示</strong> - 显示AI的推理和工具调用过程</li>
                    <li><strong>对话状态管理</strong> - 处理过程中禁用提交按钮</li>
                    <li><strong>中止功能</strong> - 允许用户停止正在进行的对话</li>
                    <li><strong>工具调用可视化</strong> - 详细展示每个工具的执行情况</li>
                </ul>
            </div>

            <div class="feature-demo">
                <h3>🧠 思考过程显示</h3>
                <p>当AI处理复杂请求时，会显示：</p>
                <ul>
                    <li>分析用户问题的过程</li>
                    <li>选择合适工具的推理</li>
                    <li>工具执行的实时状态</li>
                    <li>结果整合的思路</li>
                </ul>
                <button class="test-btn" onclick="testThinkingProcess()">
                    🧠 测试思考过程
                </button>
            </div>

            <div class="feature-demo">
                <h3>🔧 工具调用显示</h3>
                <p>详细展示：</p>
                <ul>
                    <li>调用的工具名称和参数</li>
                    <li>执行状态（成功/失败）</li>
                    <li>执行时间和结果摘要</li>
                    <li>错误信息（如果有）</li>
                </ul>
                <button class="test-btn" onclick="testToolCalls()">
                    🔧 测试工具调用
                </button>
            </div>

            <div class="feature-demo">
                <h3>⏹️ 对话中止功能</h3>
                <p>当对话处理时间过长时：</p>
                <ul>
                    <li>提交按钮变为禁用状态</li>
                    <li>显示红色中止按钮</li>
                    <li>点击可立即停止处理</li>
                    <li>恢复到待机状态</li>
                </ul>
                <button class="test-btn" onclick="testAbortFunction()">
                    ⏹️ 测试中止功能
                </button>
            </div>

            <div class="feature-demo">
                <h3>📊 状态监控</h3>
                <p>实时显示：</p>
                <ul>
                    <li>当前处理轮次</li>
                    <li>已执行的工具数量</li>
                    <li>处理耗时</li>
                    <li>系统资源状态</li>
                </ul>
                <button class="test-btn" onclick="testStatusMonitoring()">
                    📊 测试状态监控
                </button>
            </div>

            <div class="feature-demo">
                <h3>🎯 测试场景</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <button class="test-btn" onclick="runComplexAnalysis()">
                        复杂基因组分析
                    </button>
                    <button class="test-btn" onclick="runMultiToolQuery()">
                        多工具查询
                    </button>
                    <button class="test-btn" onclick="runLongRunningTask()">
                        长时间任务
                    </button>
                    <button class="test-btn" onclick="runErrorScenario()">
                        错误处理测试
                    </button>
                </div>
            </div>

            <div class="feature-demo">
                <h3>📈 性能优化</h3>
                <p>新功能包含的优化：</p>
                <ul>
                    <li>异步处理避免界面冻结</li>
                    <li>智能工具分类和优先级执行</li>
                    <li>内存使用优化</li>
                    <li>错误恢复机制</li>
                </ul>
            </div>
        </div>

        <div class="chat-wrapper">
            <!-- ChatBox 将在这里创建 -->
            <div id="app"></div>
        </div>
    </div>

    <!-- 模拟的依赖项 -->
    <script>
        // 模拟的全局配置
        class MockConfigManager {
            constructor() {
                this.config = {};
                this.chatHistory = [];
            }
            
            get(key, defaultValue) {
                return this.config[key] || defaultValue;
            }
            
            set(key, value) {
                this.config[key] = value;
            }
            
            addChatMessage(message, sender, timestamp) {
                const messageId = Date.now().toString();
                this.chatHistory.push({ message, sender, timestamp, id: messageId });
                return messageId;
            }
            
            getChatHistory() {
                return this.chatHistory;
            }
            
            clearChatHistory() {
                this.chatHistory = [];
            }
        }

        // 模拟的LLM配置管理器
        class MockLLMConfigManager {
            isConfigured() {
                return true;
            }
            
            async sendMessageWithHistory(history, context) {
                // 模拟延迟和响应
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 随机返回不同类型的响应
                const responses = [
                    'Sure, I\'ll help you analyze the genome data.',
                    '{"tool_name": "search_features", "parameters": {"query": "lacZ"}}',
                    'Based on your request, I need to execute several tools to get complete information.',
                    '<think>The user wants to analyze a genomic region. I need to first get sequence information, then analyze GC content.</think>This is a complex analysis request.'
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // 模拟的应用程序
        class MockApp {
            constructor() {
                this.genomeBrowser = {
                    currentChromosome: 'chr1',
                    currentPosition: { start: 1000, end: 2000 },
                    loadedFiles: ['genome.fasta'],
                    availableTools: ['navigate_to_position', 'search_features', 'get_sequence'],
                    toolSources: { local: 10, plugins: 5, mcp: 3 }
                };
            }
        }

        // 初始化模拟环境
        const mockApp = new MockApp();
        const mockConfigManager = new MockConfigManager();
        
        // 全局变量
        window.LLMConfigManager = MockLLMConfigManager;
        window.MCPServerManager = class { 
            constructor() {}
            on() {}
        };
        window.PluginManager = class {
            constructor() {}
            on() {}
        };
        window.PluginFunctionCallsIntegrator = class {
            constructor() {}
        };
        window.SmartExecutor = class {
            constructor() {}
        };
        window.FunctionCallsOrganizer = class {
            constructor() {}
        };
    </script>

    <!-- 加载ChatManager -->
    <script src="src/renderer/modules/ChatManager.js"></script>

    <script>
        // 初始化增强的ChatManager
        const chatManager = new ChatManager(mockApp, mockConfigManager);
        
        // 测试函数
        function testThinkingProcess() {
            chatManager.showThinkingProcess = true;
            chatManager.addThinkingMessage('🔄 Starting genome data analysis...');
            setTimeout(() => {
                chatManager.updateThinkingMessage('🧬 Detected gene sequence features');
            }, 1000);
            setTimeout(() => {
                chatManager.updateThinkingMessage('📊 Calculating GC content and statistics');
            }, 2000);
            setTimeout(() => {
                chatManager.removeThinkingMessages();
            }, 4000);
        }
        
        function testToolCalls() {
            const mockTools = [
                { tool_name: 'get_sequence', parameters: { start: 1000, end: 2000 } },
                { tool_name: 'calculate_gc_content', parameters: { sequence: 'ATCG...' } }
            ];
            chatManager.addToolCallMessage(mockTools);
            
            setTimeout(() => {
                const mockResults = [
                    { tool: 'get_sequence', success: true, result: 'Retrieved 1000bp sequence' },
                    { tool: 'calculate_gc_content', success: true, result: 'GC content: 45.2%' }
                ];
                chatManager.addToolResultMessage(mockResults);
            }, 2000);
        }
        
        function testAbortFunction() {
            chatManager.startConversation();
            setTimeout(() => {
                alert('Click the red abort button to test abort functionality');
            }, 1000);
        }
        
        function testStatusMonitoring() {
            chatManager.startConversation();
            let round = 0;
            const interval = setInterval(() => {
                round++;
                chatManager.updateThinkingMessage(`🔄 Round ${round}/3 processing...`);
                if (round >= 3) {
                    clearInterval(interval);
                    chatManager.endConversation();
                }
            }, 1500);
        }
        
        function runComplexAnalysis() {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = 'Analyze gene density and GC content distribution in chr1:1000-5000 region, and find all restriction enzyme sites';
                chatManager.sendMessage();
            }
        }
        
        function runMultiToolQuery() {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = 'Search for lacZ gene in current region, get its sequence, calculate GC content, and find nearby operons';
                chatManager.sendMessage();
            }
        }
        
        function runLongRunningTask() {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = 'Execute whole-genome BLAST search and analyze homology';
                chatManager.sendMessage();
            }
        }
        
        function runErrorScenario() {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = 'Call non-existent tools with invalid parameters';
                chatManager.sendMessage();
            }
        }
        
        // 页面加载完成后的提示
        window.addEventListener('load', () => {
            setTimeout(() => {
                chatManager.addMessageToChat(
                    '🎉 Enhanced ChatBox features are ready!\n\n✨ New features include:\n• Complete thinking process display\n• Tool call visualization\n• Conversation abort control\n• Intelligent state management\n\nTry sending complex genome analysis requests to experience the new features!', 
                    'assistant'
                );
            }, 1000);
        });
    </script>
</body>
</html> 