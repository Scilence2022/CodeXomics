<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Project Manager - Genome AI Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            color: #2c3e50;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.6;
            letter-spacing: -0.01em;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #2c3e50;
            padding: 20px 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-direction: column;
            align-items: flex-start;
        }

        /* 菜单栏样式 */
        .menu-bar {
            display: flex;
            gap: 0;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
            padding: 4px;
        }

        .menu-item {
            position: relative;
            display: inline-block;
        }

        .menu-title {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: block;
        }

        .menu-title:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            min-width: 220px;
            padding: 8px 0;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
        }

        .menu-item:hover .menu-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .menu-option {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            font-size: 13px;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .menu-option:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: #667eea;
        }

        .menu-option .menu-icon {
            width: 20px;
            margin-right: 12px;
            text-align: center;
        }

        .menu-option .menu-shortcut {
            margin-left: auto;
            font-size: 11px;
            color: #999;
            font-family: monospace;
        }

        .menu-option .menu-arrow {
            margin-left: auto;
            font-size: 10px;
            color: #999;
        }

        .menu-separator {
            height: 1px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            margin: 6px 16px;
        }

        /* Toggle Switch 样式 */
        .toggle-switch-container {
            display: flex;
            align-items: center;
            margin: 0 15px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch input[type="checkbox"] {
            display: none;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 22px;
            background: #ddd;
            border-radius: 22px;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        .toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input[type="checkbox"]:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-label {
            font-size: 13px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* 内容区域两栏布局 */
        .content-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .content-main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* 详细信息面板 */
        .details-panel {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .details-header {
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .details-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .details-close-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .details-close-btn:hover {
            background: rgba(108, 117, 125, 0.1);
            color: #495057;
        }

        .details-content {
            padding: 20px;
        }

        .details-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .details-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .details-section h5 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }

        .detail-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .stat-value {
            color: #2c3e50;
            font-weight: 600;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-actions .btn {
            justify-self: stretch;
            text-align: center;
        }

        /* 文件类型分布样式 */
        .file-type-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 12px;
        }

        .file-type-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-type-icon {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: white;
            font-weight: bold;
        }

        .file-type-count {
            color: #667eea;
            font-weight: 600;
        }

        /* 活动记录样式 */
        .activity-item {
            padding: 8px 0;
            font-size: 12px;
            color: #6c757d;
            border-bottom: 1px solid rgba(102, 126, 234, 0.05);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 10px;
            color: #999;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: none;
            letter-spacing: 0.01em;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            border-color: #667eea;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(54, 209, 220, 0.4);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(54, 209, 220, 0.6);
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            margin: 20px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .tree-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 12px;
            margin: 4px 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            font-weight: 500;
        }
        
        .tree-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(4px);
        }
        
        .tree-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            color: #667eea;
            border-left: 3px solid #667eea;
            font-weight: 600;
        }
        
        .tree-item.project {
            font-weight: 600;
            border-left: 3px solid #007bff;
            position: relative;
        }

        .tree-actions {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-item:hover .tree-actions {
            opacity: 1;
        }

        .tree-action-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .tree-action-btn:hover {
            background: #ddd;
            color: #333;
        }

        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        .context-menu-item .menu-icon {
            margin-right: 10px;
            width: 16px;
            text-align: center;
        }

        /* View Mode Selector Styles */
        .view-mode-selector {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }

        .view-mode-btn {
            background: white;
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border-right: 1px solid #ddd;
        }

        .view-mode-btn:last-child {
            border-right: none;
        }

        .view-mode-btn:hover {
            background: #f5f5f5;
        }

        .view-mode-btn.active {
            background: #007bff;
            color: white;
        }

        /* List View Styles */
        .file-list {
            display: block;
        }

        .file-list-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .file-list-item:hover {
            background: #f8f9fa;
        }

        .file-list-item.selected {
            background: #e3f2fd;
        }

        .file-list-item.dragging {
            opacity: 0.5;
            background: #fff3cd;
        }

        .file-list-item .file-icon-small {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .file-list-item .file-name {
            flex: 1;
            font-weight: 500;
            margin-right: 12px;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-list-item .file-size {
            width: 80px;
            text-align: right;
            color: #666;
            font-size: 12px;
            margin-right: 12px;
        }

        .file-list-item .file-date {
            width: 120px;
            text-align: right;
            color: #666;
            font-size: 12px;
        }

        /* Details View Styles */
        .file-details-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .file-details-table th {
            background: #f8f9fa;
            padding: 10px 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .file-details-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .file-details-table tr:hover {
            background: #f8f9fa;
        }

        .file-details-table tr.selected {
            background: #e3f2fd;
        }

        .file-details-table tr.dragging {
            opacity: 0.5;
            background: #fff3cd;
        }

        /* Drag and Drop Styles */
        .drag-over {
            background: #e8f5e8 !important;
            border: 2px dashed #28a745 !important;
        }

        .drag-drop-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            z-index: 1000;
            pointer-events: none;
        }

        /* 可拖拽分隔条样式 */
        .sidebar-splitter {
            width: 6px;
            background: linear-gradient(to right, #e1e5e9, #ced4da, #e1e5e9);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s ease;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-splitter:hover {
            background: linear-gradient(to right, #ced4da, #adb5bd, #ced4da);
            width: 8px;
        }

        .sidebar-splitter.active {
            background: linear-gradient(to right, #667eea, #764ba2, #667eea);
            width: 8px;
        }

        .splitter-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 40px;
            background: rgba(102, 126, 234, 0.6);
            border-radius: 4px;
            opacity: 0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-splitter:hover .splitter-handle,
        .sidebar-splitter.active .splitter-handle {
            opacity: 1;
        }

        .splitter-handle::before {
            content: '';
            width: 2px;
            height: 16px;
            background: white;
            border-radius: 1px;
            box-shadow: 4px 0 0 white, -4px 0 0 white;
        }
        
        .tree-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            position: relative;
        }
        
        .content-header {
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .content-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box {
            padding: 12px 16px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 14px;
            width: 280px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .content-body {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: transparent;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .file-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .file-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        .file-card:hover::before {
            opacity: 1;
        }
        
        .file-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            position: relative;
            z-index: 1;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .file-icon.fasta { background: #28a745; }
        .file-icon.gff { background: #17a2b8; }
        .file-icon.vcf { background: #ffc107; color: #000; }
        .file-icon.bam { background: #6f42c1; }
        .file-icon.folder { background: #6c757d; }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 8px;
            text-align: center;
            position: relative;
            z-index: 1;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .file-info {
            font-size: 13px;
            color: #667eea;
            text-align: center;
            position: relative;
            z-index: 1;
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .radio-option {
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: #fff;
        }

        .radio-option:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .radio-option input[type="radio"]:checked + strong {
            color: #007bff;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 80px;
            resize: vertical;
        }
        
        .status-bar {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 13px;
            color: #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            position: relative;
            z-index: 100;
        }
        
        .project-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 16px;
            padding: 20px 24px;
            text-align: center;
            flex: 1;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.15);
        }
        
        .stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }
        
        .stat-label {
            font-size: 13px;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        /* 保存按钮脉冲动画 */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>📁 Project Manager</h1>
            <span style="opacity: 0.8; font-size: 13px;">Organize and manage your genomic data projects</span>
            
            <!-- 独立菜单栏 -->
            <div class="menu-bar">
                <div class="menu-item">
                    <span class="menu-title">File</span>
                    <div class="menu-dropdown">
                        <div class="menu-option" onclick="projectManagerWindow.createNewProject()">
                            <span class="menu-icon">📁</span>
                            <span>New Project</span>
                            <span class="menu-shortcut">Ctrl+N</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.openProject()">
                            <span class="menu-icon">📂</span>
                            <span>Open Project</span>
                            <span class="menu-shortcut">Ctrl+O</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.openRecentProject()">
                            <span class="menu-icon">🕒</span>
                            <span>Open Recent</span>
                            <span class="menu-arrow">▶</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.saveCurrentProject()">
                            <span class="menu-icon">💾</span>
                            <span>Save Project</span>
                            <span class="menu-shortcut">Ctrl+S</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.saveProjectAs()">
                            <span class="menu-icon">💾</span>
                            <span>Save As...</span>
                            <span class="menu-shortcut">Ctrl+Shift+S</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.importProject()">
                            <span class="menu-icon">📥</span>
                            <span>Import Project</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.exportCurrentProject()">
                            <span class="menu-icon">📤</span>
                            <span>Export Project</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.closeCurrentProject()">
                            <span class="menu-icon">✖️</span>
                            <span>Close Project</span>
                        </div>
                    </div>
                </div>
                
                <div class="menu-item">
                    <span class="menu-title">Edit</span>
                    <div class="menu-dropdown">
                        <div class="menu-option" onclick="projectManagerWindow.addFiles()">
                            <span class="menu-icon">📄</span>
                            <span>Add Files</span>
                            <span class="menu-shortcut">Ctrl+A</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.createFolder()">
                            <span class="menu-icon">🗂️</span>
                            <span>New Folder</span>
                            <span class="menu-shortcut">Ctrl+Shift+N</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.selectAllFiles()">
                            <span class="menu-icon">☑️</span>
                            <span>Select All</span>
                            <span class="menu-shortcut">Ctrl+A</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.clearSelection()">
                            <span class="menu-icon">◻️</span>
                            <span>Clear Selection</span>
                            <span class="menu-shortcut">Esc</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.deleteSelectedFiles()">
                            <span class="menu-icon">🗑️</span>
                            <span>Delete Selected</span>
                            <span class="menu-shortcut">Del</span>
                        </div>
                    </div>
                </div>
                
                <div class="menu-item">
                    <span class="menu-title">View</span>
                    <div class="menu-dropdown">
                        <div class="menu-option" onclick="projectManagerWindow.manualRefreshProjects()">
                            <span class="menu-icon">🔄</span>
                            <span>Refresh</span>
                            <span class="menu-shortcut">F5</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.setViewMode('grid')">
                            <span class="menu-icon">⋮⋮⋮</span>
                            <span>Grid View</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.setViewMode('list')">
                            <span class="menu-icon">☰</span>
                            <span>List View</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.setViewMode('details')">
                            <span class="menu-icon">📋</span>
                            <span>Details View</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.toggleDetailsPanel()">
                            <span class="menu-icon">📊</span>
                            <span>Toggle Details Panel</span>
                            <span class="menu-shortcut">F9</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.toggleSidebar()">
                            <span class="menu-icon">📁</span>
                            <span>Toggle Sidebar</span>
                            <span class="menu-shortcut">F8</span>
                        </div>
                    </div>
                </div>
                
                <div class="menu-item">
                    <span class="menu-title">Tools</span>
                    <div class="menu-dropdown">
                        <div class="menu-option" onclick="projectManagerWindow.analyzeProject()">
                            <span class="menu-icon">📊</span>
                            <span>Analyze Project</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.validateFiles()">
                            <span class="menu-icon">✅</span>
                            <span>Validate Files</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.findDuplicateFiles()">
                            <span class="menu-icon">🔍</span>
                            <span>Find Duplicates</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.openInGenomeViewer()">
                            <span class="menu-icon">🧬</span>
                            <span>Open in Genome Viewer</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.runGenomicAnalysis()">
                            <span class="menu-icon">🔬</span>
                            <span>Run Genomic Analysis</span>
                        </div>
                    </div>
                </div>
                
                <div class="menu-item">
                    <span class="menu-title">Help</span>
                    <div class="menu-dropdown">
                        <div class="menu-option" onclick="projectManagerWindow.showDocumentation()">
                            <span class="menu-icon">📖</span>
                            <span>Documentation</span>
                            <span class="menu-shortcut">F1</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.showKeyboardShortcuts()">
                            <span class="menu-icon">⌨️</span>
                            <span>Keyboard Shortcuts</span>
                        </div>
                        <div class="menu-separator"></div>
                        <div class="menu-option" onclick="projectManagerWindow.reportBug()">
                            <span class="menu-icon">🐛</span>
                            <span>Report Bug</span>
                        </div>
                        <div class="menu-option" onclick="projectManagerWindow.showAbout()">
                            <span class="menu-icon">ℹ️</span>
                            <span>About</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="projectManagerWindow.createNewProject()">
                📂 New Project
            </button>
            <button class="btn btn-primary" onclick="projectManagerWindow.openProject()">
                📖 Open Project
            </button>
            <button class="btn btn-primary" onclick="projectManagerWindow.showSettings()">
                ⚙️ Settings
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Projects & Workspaces</h3>
                <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.refreshProjects()">
                    🔄
                </button>
            </div>
            <div class="sidebar-content">
                <div id="projectTree">
                    <!-- Project tree will be rendered here -->
                </div>
            </div>
        </div>

        <!-- 添加可拖拽的分隔条 -->
        <div class="sidebar-splitter" id="sidebarSplitter">
            <div class="splitter-handle"></div>
        </div>

        <div class="content-area">
            <div class="content-header">
                <div class="content-title" id="contentTitle">Welcome to Project Manager</div>
                                    <div class="toolbar">
                    <input type="text" class="search-box" placeholder="Search files..." id="searchBox">
                    
                    <!-- Toggle Switch for Details Panel -->
                    <div class="toggle-switch-container">
                        <label class="toggle-switch" title="Toggle Details Panel (F9)">
                            <input type="checkbox" id="detailsPanelToggle" onchange="projectManagerWindow.toggleDetailsPanel()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Details Panel</span>
                        </label>
                    </div>
                    
                    <!-- View Mode Selector -->
                    <div class="view-mode-selector">
                        <button class="view-mode-btn active" onclick="projectManagerWindow.setViewMode('grid')" data-mode="grid" title="Grid View">
                            ⋮⋮⋮
                        </button>
                        <button class="view-mode-btn" onclick="projectManagerWindow.setViewMode('list')" data-mode="list" title="List View">
                            ☰
                        </button>
                        <button class="view-mode-btn" onclick="projectManagerWindow.setViewMode('details')" data-mode="details" title="Details View">
                            📋
                        </button>
                    </div>
                    
                    <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.addFiles()">
                        📄 Add Files
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.createFolder()" title="Create new data type folder">
                        🗂️ New Data Folder
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="projectManagerWindow.saveCurrentProject()" title="Save current project (Ctrl/Cmd+S)">
                        💾 Save
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.saveProjectAs()" title="Save project as... (Ctrl/Cmd+Shift+S)">
                        💾 Save As...
                    </button>
                </div>
            </div>
            
            <div class="content-body">
                <div class="content-main">
                    <div id="projectOverview">
                        <div class="empty-state">
                            <div class="empty-state-icon">📂</div>
                            <h3>No Project Selected</h3>
                            <p>Create a new project or select an existing one to get started.</p>
                            <button class="btn btn-primary" onclick="projectManagerWindow.createNewProject()">
                                Create New Project
                            </button>
                            <button class="btn btn-warning" onclick="projectManagerWindow.createTestProject()" style="margin-top: 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
                                🧪 Create Test Project
                            </button>
                        </div>
                    </div>
                    
                    <div id="projectContent" style="display: none;">
                        <div class="project-stats" id="projectStats"></div>
                        <div class="file-view-container" id="fileViewContainer">
                            <div class="file-grid" id="fileGrid"></div>
                            <div class="file-list" id="fileList" style="display: none;"></div>
                            <div class="file-details" id="fileDetails" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 详细信息面板 -->
                <div class="details-panel" id="detailsPanel" style="display: none;">
                    <div class="details-header">
                        <h4>📊 Details Panel</h4>
                        <button class="details-close-btn" onclick="projectManagerWindow.toggleDetailsPanel()" title="Close Details Panel">×</button>
                    </div>
                    <div class="details-content" id="detailsContent">
                        <div class="details-section">
                            <h5>📁 Selection Info</h5>
                            <div id="selectionInfo">
                                <p>No files selected</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h5>📊 Project Statistics</h5>
                            <div id="projectDetailStats">
                                <div class="detail-stat">
                                    <span class="stat-label">Total Files:</span>
                                    <span class="stat-value" id="totalFilesCount">0</span>
                                </div>
                                <div class="detail-stat">
                                    <span class="stat-label">Total Size:</span>
                                    <span class="stat-value" id="totalSizeValue">0 B</span>
                                </div>
                                <div class="detail-stat">
                                    <span class="stat-label">File Types:</span>
                                    <span class="stat-value" id="fileTypesCount">0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h5>🏷️ File Type Distribution</h5>
                            <div id="fileTypeDistribution">
                                <p>No data available</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h5>📝 Recent Activity</h5>
                            <div id="recentActivity">
                                <p>No recent activity</p>
                            </div>
                        </div>
                        
                        <div class="details-section">
                            <h5>🔧 Quick Actions</h5>
                            <div class="quick-actions">
                                <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.selectAllFiles()">
                                    Select All
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.clearSelection()">
                                    Clear Selection
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="projectManagerWindow.analyzeProject()">
                                    Analyze Project
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Ready</span>
        <span id="fileCount">0 items</span>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="modal-close" onclick="projectManagerWindow.closeModal('newProjectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="projectDescription" placeholder="Enter project description (optional)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="projectLocation" placeholder="Select project location" readonly>
                    <button class="btn btn-secondary btn-sm" onclick="projectManagerWindow.selectProjectLocation()" style="margin-top: 8px;">
                        📁 Browse...
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="projectManagerWindow.closeModal('newProjectModal')">Cancel</button>
                <button class="btn btn-success" onclick="projectManagerWindow.createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Context Menus -->
    <div id="projectContextMenu" class="context-menu">
        <div class="context-menu-item" onclick="projectManagerWindow.renameProject()">
            <span class="menu-icon">✏️</span>
            Rename Project
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.duplicateProject()">
            <span class="menu-icon">📋</span>
            Duplicate Project
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.exportProjectAs()">
            <span class="menu-icon">📤</span>
            Export Project
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.showProjectProperties()">
            <span class="menu-icon">ℹ️</span>
            Properties
        </div>
        <div class="context-menu-item danger" onclick="projectManagerWindow.deleteProject()">
            <span class="menu-icon">🗑️</span>
            Delete Project
        </div>
    </div>

    <div id="folderContextMenu" class="context-menu">
        <div class="context-menu-item" onclick="projectManagerWindow.addFilesToFolder()">
            <span class="menu-icon">📁</span>
            Add Files
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.createSubfolder()">
            <span class="menu-icon">📂</span>
            New Subfolder
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.renameFolder()">
            <span class="menu-icon">✏️</span>
            Rename Folder
        </div>
        <div class="context-menu-item" onclick="projectManagerWindow.openFolderInExplorer()">
            <span class="menu-icon">🔍</span>
            Open in Explorer
        </div>
        <div class="context-menu-item danger" onclick="projectManagerWindow.deleteFolder()">
            <span class="menu-icon">🗑️</span>
            Delete Folder
        </div>
    </div>

    <!-- Add Files Options Modal -->
    <div id="addFilesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Files to Project</h3>
                <button class="modal-close" onclick="projectManagerWindow.closeModal('addFilesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">File Management Options</label>
                    <div style="margin: 15px 0;">
                        <label class="radio-option" style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="fileHandling" value="copy" checked style="margin-right: 8px;">
                            <strong>Copy files to project data folder</strong> (Recommended)
                            <div style="margin-left: 24px; font-size: 0.9em; color: #666; margin-top: 4px;">
                                Files will be copied to: <code>[Project]/data/[folder]/</code><br>
                                This ensures files are always available with the project.
                            </div>
                        </label>
                        <label class="radio-option" style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="fileHandling" value="reference" style="margin-right: 8px;">
                            <strong>Reference files at original location</strong>
                            <div style="margin-left: 24px; font-size: 0.9em; color: #666; margin-top: 4px;">
                                Files will remain at their current location.<br>
                                Project will reference the original file paths.
                            </div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Files</label>
                    <div id="selectedFilesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                        <!-- Selected files will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="projectManagerWindow.closeModal('addFilesModal')">Cancel</button>
                <button class="btn btn-success" onclick="projectManagerWindow.processFilesWithOptions()">Add Files</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ProjectManagerWindow - 项目管理器窗口核心类
         */
        class ProjectManagerWindow {
            constructor() {
                this.projects = new Map();
                this.currentProject = null;
                this.currentPath = [];
                this.selectedFiles = new Set();
                this.searchTerm = '';
                this.viewMode = 'grid'; // 默认网格视图
                this.projectFileLocks = new Map(); // 跟踪项目文件锁定状态
                
                // 拖拽相关变量
                this.draggedFile = null;
                this.dragOverTarget = null;
                
                // 文件类型配置
                this.fileTypes = {
                    'fasta': { icon: 'FA', color: '#28a745', extensions: ['.fasta', '.fa', '.fas'] },
                    'gff': { icon: 'GFF', color: '#17a2b8', extensions: ['.gff', '.gff3', '.gtf'] },
                    'vcf': { icon: 'VCF', color: '#ffc107', extensions: ['.vcf'] },
                    'bam': { icon: 'BAM', color: '#6f42c1', extensions: ['.bam', '.sam'] },
                    'wig': { icon: 'WIG', color: '#fd7e14', extensions: ['.wig', '.bw', '.bigwig'] },
                    'bed': { icon: 'BED', color: '#dc3545', extensions: ['.bed'] },
                    'genbank': { icon: 'GB', color: '#20c997', extensions: ['.gb', '.gbk', '.gbff'] }
                };
                
                this.initialize();
            }

            async initialize() {
                console.log('Initializing Project Manager Window...');
                
                // 初始化XML处理器
                if (typeof ProjectXMLHandler !== 'undefined') {
                    this.xmlHandler = new ProjectXMLHandler();
                    console.log('✅ XML Handler initialized');
                } else {
                    console.warn('⚠️ ProjectXMLHandler not available');
                }
                
                await this.loadProjects();
                this.setupEventListeners();
                this.initializeSidebarSplitter(); // 初始化分隔条拖拽功能
                this.renderProjectTree();
                this.updateStatusBar('Ready');
                console.log('Project Manager Window initialized successfully');
            }

            // 上下文菜单相关变量
            currentContextProjectId = null;
            currentContextFolderPath = null;

            // 显示项目右键菜单
            showProjectContextMenu(event, projectId) {
                event.preventDefault();
                this.currentContextProjectId = projectId;
                const menu = document.getElementById('projectContextMenu');
                this.showContextMenu(menu, event);
            }

            // 显示文件夹右键菜单
            showFolderContextMenu(event, folderPath) {
                event.preventDefault();
                this.currentContextFolderPath = folderPath;
                const menu = document.getElementById('folderContextMenu');
                this.showContextMenu(menu, event);
            }

            // 显示项目操作菜单
            showProjectActions(projectId) {
                this.currentContextProjectId = projectId;
                const menu = document.getElementById('projectContextMenu');
                this.showContextMenu(menu, { clientX: 0, clientY: 0 });
            }

            // 显示文件夹操作菜单
            showFolderActions(folderPath) {
                this.currentContextFolderPath = folderPath;
                const menu = document.getElementById('folderContextMenu');
                this.showContextMenu(menu, { clientX: 0, clientY: 0 });
            }

            // 通用显示上下文菜单方法
            showContextMenu(menu, event) {
                // 隐藏所有上下文菜单
                document.querySelectorAll('.context-menu').forEach(m => m.style.display = 'none');
                
                // 显示指定菜单
                menu.style.display = 'block';
                menu.style.left = (event.clientX + 10) + 'px';
                menu.style.top = (event.clientY + 10) + 'px';

                // 确保菜单在视窗内
                const rect = menu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    menu.style.left = (event.clientX - rect.width) + 'px';
                }
                if (rect.bottom > window.innerHeight) {
                    menu.style.top = (event.clientY - rect.height) + 'px';
                }
            }

            // 隐藏所有上下文菜单
            hideContextMenus() {
                document.querySelectorAll('.context-menu').forEach(menu => {
                    menu.style.display = 'none';
                });
            }

            // ================================
            // 项目操作方法
            // ================================
            
            renameProject() {
                this.hideContextMenus();
                if (!this.currentContextProjectId) return;
                
                const project = this.projects.get(this.currentContextProjectId);
                if (!project) return;
                
                const newName = prompt('Enter new project name:', project.name);
                if (newName && newName.trim() && newName.trim() !== project.name) {
                    project.name = newName.trim();
                    project.modified = new Date().toISOString();
                    this.projects.set(this.currentContextProjectId, project);
                    this.saveProjects();
                    this.renderProjectTree();
                    this.showNotification(`Project renamed to "${newName}"`, 'success');
                }
            }

            duplicateProject() {
                this.hideContextMenus();
                if (!this.currentContextProjectId) return;
                
                const project = this.projects.get(this.currentContextProjectId);
                if (!project) return;
                
                const newName = prompt('Enter name for duplicated project:', project.name + ' Copy');
                if (newName && newName.trim()) {
                    const newProject = {
                        ...project,
                        id: this.generateId(),
                        name: newName.trim(),
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        isCurrentlyOpen: false
                    };
                    
                    this.projects.set(newProject.id, newProject);
                    this.saveProjects();
                    this.renderProjectTree();
                    this.showNotification(`Project duplicated as "${newName}"`, 'success');
                }
            }

            exportProjectAs() {
                this.hideContextMenus();
                if (!this.currentContextProjectId) return;
                
                const project = this.projects.get(this.currentContextProjectId);
                if (!project) return;
                
                try {
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }
                    
                    const xmlContent = this.xmlHandler.projectToXML(project);
                    this.downloadXMLFile(xmlContent, `${project.name}.prj.GAI`);
                    this.showNotification(`Project "${project.name}" exported successfully`, 'success');
                } catch (error) {
                    console.error('Error exporting project:', error);
                    this.showNotification('Failed to export project', 'error');
                }
            }

            showProjectProperties() {
                this.hideContextMenus();
                if (!this.currentContextProjectId) return;
                
                const project = this.projects.get(this.currentContextProjectId);
                if (!project) return;
                
                const properties = `
Project: ${project.name}
Description: ${project.description || 'N/A'}
Location: ${project.location || 'N/A'}
Created: ${this.formatDate(project.created)}
Modified: ${this.formatDate(project.modified)}
Files: ${project.files ? project.files.length : 0}
Folders: ${project.folders ? project.folders.length : 0}
                `.trim();
                
                alert(properties);
            }

            deleteProject() {
                this.hideContextMenus();
                if (!this.currentContextProjectId) return;
                
                const project = this.projects.get(this.currentContextProjectId);
                if (!project) return;
                
                const confirm = window.confirm(`Are you sure you want to delete the project "${project.name}"?\n\nThis action cannot be undone.`);
                if (confirm) {
                    this.projects.delete(this.currentContextProjectId);
                    if (this.currentProject && this.currentProject.id === this.currentContextProjectId) {
                        this.currentProject = null;
                    }
                    this.saveProjects();
                    this.renderProjectTree();
                    this.renderProjectContent();
                    this.showNotification(`Project "${project.name}" deleted`, 'success');
                }
            }

            // ================================
            // 文件夹操作方法
            // ================================
            
            addFilesToFolder() {
                this.hideContextMenus();
                if (!this.currentContextFolderPath) return;
                
                // 设置当前路径为目标文件夹
                this.currentPath = this.currentContextFolderPath;
                this.renderProjectContent();
                
                // 触发添加文件
                this.addFiles();
            }

            createSubfolder() {
                this.hideContextMenus();
                if (!this.currentContextFolderPath || !this.currentProject) return;
                
                const folderName = prompt('Enter new subfolder name:');
                if (folderName && folderName.trim()) {
                    const newFolderPath = [...this.currentContextFolderPath, folderName.trim()];
                    const newFolder = {
                        name: folderName.trim(),
                        icon: '📁',
                        path: newFolderPath,
                        files: []
                    };
                    
                    this.currentProject.folders.push(newFolder);
                    this.currentProject.modified = new Date().toISOString();
                    this.projects.set(this.currentProject.id, this.currentProject);
                    this.saveProjects();
                    this.renderProjectTree();
                    this.showNotification(`Subfolder "${folderName}" created`, 'success');
                }
            }

            renameFolder() {
                this.hideContextMenus();
                if (!this.currentContextFolderPath || !this.currentProject) return;
                
                const folder = this.currentProject.folders.find(f => 
                    this.arraysEqual(f.path, this.currentContextFolderPath)
                );
                if (!folder) return;
                
                const newName = prompt('Enter new folder name:', folder.name);
                if (newName && newName.trim() && newName.trim() !== folder.name) {
                    folder.name = newName.trim();
                    this.currentProject.modified = new Date().toISOString();
                    this.projects.set(this.currentProject.id, this.currentProject);
                    this.saveProjects();
                    this.renderProjectTree();
                    this.showNotification(`Folder renamed to "${newName}"`, 'success');
                }
            }

            openFolderInExplorer() {
                this.hideContextMenus();
                if (!this.currentContextFolderPath || !this.currentProject) return;
                
                if (window.electronAPI && window.electronAPI.openFolderInExplorer) {
                    const folderPath = this.currentProject.dataFolderPath + '/' + this.currentContextFolderPath.join('/');
                    window.electronAPI.openFolderInExplorer(folderPath);
                } else {
                    this.showNotification('This feature requires Electron environment', 'warning');
                }
            }

            deleteFolder() {
                this.hideContextMenus();
                if (!this.currentContextFolderPath || !this.currentProject) return;
                
                const folder = this.currentProject.folders.find(f => 
                    this.arraysEqual(f.path, this.currentContextFolderPath)
                );
                if (!folder) return;
                
                const filesInFolder = this.currentProject.files.filter(file => 
                    file.folder && this.arraysEqual(file.folder, this.currentContextFolderPath)
                );
                
                let confirmMessage = `Are you sure you want to delete the folder "${folder.name}"?`;
                if (filesInFolder.length > 0) {
                    confirmMessage += `\n\nThis will also delete ${filesInFolder.length} file(s) in this folder.`;
                }
                confirmMessage += '\n\nThis action cannot be undone.';
                
                const confirm = window.confirm(confirmMessage);
                if (confirm) {
                    // 删除文件夹中的所有文件
                    this.currentProject.files = this.currentProject.files.filter(file => 
                        !file.folder || !this.arraysEqual(file.folder, this.currentContextFolderPath)
                    );
                    
                    // 删除文件夹
                    this.currentProject.folders = this.currentProject.folders.filter(f => 
                        !this.arraysEqual(f.path, this.currentContextFolderPath)
                    );
                    
                    // 如果当前在被删除的文件夹中，回到根目录
                    if (this.arraysEqual(this.currentPath, this.currentContextFolderPath)) {
                        this.currentPath = [];
                    }
                    
                    this.currentProject.modified = new Date().toISOString();
                    this.projects.set(this.currentProject.id, this.currentProject);
                    this.saveProjects();
                    this.renderProjectTree();
                    this.renderProjectContent();
                    this.showNotification(`Folder "${folder.name}" deleted`, 'success');
                }
            }

            setupEventListeners() {
                const searchBox = document.getElementById('searchBox');
                if (searchBox) {
                    searchBox.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value.toLowerCase();
                        this.renderProjectContent();
                    });
                }

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'n':
                                e.preventDefault();
                                this.createNewProject();
                                break;
                            case 'o':
                                e.preventDefault();
                                this.openProject();
                                break;
                            case 's':
                                e.preventDefault();
                                if (e.shiftKey) {
                                    this.saveProjectAs();
                                } else {
                                    this.saveCurrentProject();
                                }
                                break;
                        }
                    }
                });

                window.addEventListener('click', (e) => {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                    
                    // 隐藏上下文菜单
                    if (!e.target.closest('.context-menu') && !e.target.closest('.tree-action-btn')) {
                        this.hideContextMenus();
                    }
                });
            }

            createNewProject() {
                const modal = document.getElementById('newProjectModal');
                if (modal) {
                    document.getElementById('projectName').value = '';
                    document.getElementById('projectDescription').value = '';
                    document.getElementById('projectLocation').value = '';
                    modal.style.display = 'block';
                }
            }

            async selectProjectLocation() {
                try {
                    if (window.electronAPI && window.electronAPI.selectProjectDirectory) {
                        const result = await window.electronAPI.selectProjectDirectory();
                        if (result.success && !result.canceled) {
                            document.getElementById('projectLocation').value = result.filePath;
                        }
                    } else {
                        this.showNotification('Directory selection requires Electron API', 'warning');
                    }
                } catch (error) {
                    console.error('Error selecting project location:', error);
                    this.showNotification('Failed to select project location', 'error');
                }
            }

            async createProject() {
                const name = document.getElementById('projectName').value.trim();
                const description = document.getElementById('projectDescription').value.trim();
                const location = document.getElementById('projectLocation').value.trim();

                if (!name) {
                    this.showNotification('Project name is required', 'warning');
                    return;
                }

                if (!location) {
                    this.showNotification('Project location is required', 'warning');
                    return;
                }

                try {
                    // 创建项目文件和文件夹结构
                    if (window.electronAPI && window.electronAPI.createNewProjectStructure) {
                        const result = await window.electronAPI.createNewProjectStructure(location, name);
                        if (!result.success) {
                            throw new Error(result.error);
                        }

                        const projectId = this.generateId();
                        const project = {
                            id: projectId,
                            name: name,
                            description: description,
                            location: location,
                            projectFilePath: result.projectFilePath, // .prj.GAI 文件路径
                            dataFolderPath: result.dataFolderPath,   // 数据文件夹路径
                            created: new Date().toISOString(),
                            modified: new Date().toISOString(),
                            files: [],
                            folders: [
                                { name: 'Genomes', icon: '🧬', path: ['Genomes'], files: [] },
                                { name: 'Annotations', icon: '📋', path: ['Annotations'], files: [] },
                                { name: 'Variants', icon: '🔄', path: ['Variants'], files: [] },
                                { name: 'Reads', icon: '📊', path: ['Reads'], files: [] },
                                { name: 'Analysis', icon: '📈', path: ['Analysis'], files: [] }
                            ],
                            metadata: {
                                totalFiles: 0,
                                totalSize: 0,
                                lastOpened: new Date().toISOString()
                            },
                            isCurrentlyOpen: true, // 标记为当前打开的项目
                            hasUnsavedChanges: false // 跟踪未保存的更改
                        };

                        // 保存项目到 .prj.GAI 文件
                        await this.saveProjectToFile(project);

                        // 更新项目管理器状态
                        this.projects.set(projectId, project);
                        this.currentProject = project;
                        this.openProjectFilePath = project.projectFilePath; // 记录当前打开的项目文件

                        // 保存到本地项目列表（用于最近项目显示）
                        await this.saveProjects();

                        this.renderProjectTree();
                        this.selectProject(projectId);
                        this.closeModal('newProjectModal');

                        this.showNotification(`✅ Project "${name}" created successfully`, 'success');
                        console.log('✅ Project created successfully:', {
                            name: project.name,
                            projectFile: project.projectFilePath,
                            dataFolder: project.dataFolderPath
                        });
                    } else {
                        throw new Error('Project creation API not available');
                    }
                    
                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showNotification(`Failed to create project: ${error.message}`, 'error');
                }
            }

            async openProject() {
                console.log('📂 Opening project file...');
                
                try {
                    // 使用Electron API选择项目文件
                    if (window.electronAPI && window.electronAPI.selectProjectFile) {
                        const result = await window.electronAPI.selectProjectFile();
                        
                        if (result.success && !result.canceled && result.filePath) {
                            await this.loadProjectFromFile(result.filePath);
                        }
                    } else {
                        // 浏览器环境下的文件选择
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.prj.GAI,.xml,.json,.genomeproj';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = async (event) => {
                                    try {
                                        await this.loadProjectFromFileContent(event.target.result, file.name);
                                    } catch (error) {
                                        console.error('Error loading project from file:', error);
                                        this.showNotification('Failed to load project file', 'error');
                                    }
                                };
                                reader.readAsText(file);
                            }
                        };
                        input.click();
                    }
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showNotification('Failed to open project file', 'error');
                }
            }

            async loadProjectFromFile(filePath) {
                console.log('📁 Loading project from file:', filePath);
                
                try {
                    // 尝试锁定项目文件
                    const lockAcquired = await this.lockProjectFile(filePath);
                    if (!lockAcquired) {
                        // 锁定失败，说明文件可能被其他程序使用
                        return;
                    }
                    
                    // 读取文件内容
                    if (window.electronAPI && window.electronAPI.loadProjectFile) {
                        const result = await window.electronAPI.loadProjectFile(filePath);
                        
                        if (result.success) {
                            await this.loadProjectFromFileContent(result.content, result.fileName, filePath);
                        } else {
                            // 读取失败，释放锁定
                            await this.unlockProjectFile(filePath);
                            throw new Error(result.error || 'Failed to read project file');
                        }
                    } else {
                        // API不可用，释放锁定
                        await this.unlockProjectFile(filePath);
                        throw new Error('File reading API not available');
                    }
                } catch (error) {
                    console.error('Error loading project from file:', error);
                    this.showNotification(`Failed to load project: ${error.message}`, 'error');
                    // 确保释放锁定
                    await this.unlockProjectFile(filePath);
                }
            }

            async loadProjectFromFileContent(content, fileName, filePath = null) {
                console.log('📄 Processing project file content:', fileName);
                
                try {
                    let project = null;
                    const fileExtension = fileName.toLowerCase().split('.').pop();
                    
                    if (fileName.toLowerCase().endsWith('.prj.gai') || fileExtension === 'xml') {
                        // 处理XML格式项目文件
                        if (!this.xmlHandler) {
                            this.xmlHandler = new ProjectXMLHandler();
                        }
                        
                        // 验证XML格式
                        if (!this.xmlHandler.validateProjectXML(content)) {
                            throw new Error('Invalid project XML format');
                        }
                        
                        project = this.xmlHandler.xmlToProject(content);
                        console.log('✅ Loaded XML project:', project.name);
                        
                    } else if (fileExtension === 'json' || fileExtension === 'genomeproj') {
                        // 处理JSON格式项目文件
                        project = JSON.parse(content);
                        console.log('✅ Loaded JSON project:', project.name);
                        
                    } else {
                        throw new Error(`Unsupported file format: ${fileName}`);
                    }
                    
                    // 验证项目数据结构
                    if (!project || !project.id || !project.name) {
                        throw new Error('Invalid project data structure');
                    }
                    
                    // 设置项目文件路径信息
                    if (filePath) {
                        project.projectFilePath = filePath;
                        
                        // 根据项目文件路径推算数据文件夹路径
                        const projectDir = filePath.substring(0, filePath.lastIndexOf('/'));
                        project.dataFolderPath = `${projectDir}/${project.name}`;
                        project.location = projectDir;
                    }
                    
                    // 设置项目状态
                    project.xmlFileName = fileName;
                    project.loadedFromFile = true;
                    project.lastOpened = new Date().toISOString();
                    project.isCurrentlyOpen = true;
                    project.hasUnsavedChanges = false;
                    
                    // 关闭之前打开的项目
                    if (this.currentProject) {
                        this.currentProject.isCurrentlyOpen = false;
                    }
                    
                    // 设置为当前项目
                    this.currentProject = project;
                    this.openProjectFilePath = project.projectFilePath;
                    
                    // 添加到项目列表
                    this.projects.set(project.id, project);
                    await this.saveProjects();
                    
                    // 刷新界面并选择项目
                    this.renderProjectTree();
                    this.selectProject(project.id);
                    
                    // 修复：项目加载后立即刷新左侧项目树，确保显示Genomes、Annotations等文件夹
                    setTimeout(() => {
                        this.renderProjectTree();
                        if (this.currentProject) {
                            this.selectProject(this.currentProject.id);
                        }
                    }, 100);
                    
                    // 显示成功消息
                    const fileType = fileName.toLowerCase().endsWith('.prj.gai') ? 'XML (.prj.GAI)' : fileExtension.toUpperCase();
                    this.showNotification(`✅ Project "${project.name}" opened from ${fileType} file`, 'success');
                    
                    console.log('📊 Project loaded successfully:', {
                        id: project.id,
                        name: project.name,
                        files: project.files?.length || 0,
                        folders: project.folders?.length || 0,
                        projectFile: project.projectFilePath,
                        dataFolder: project.dataFolderPath
                    });
                    
                } catch (error) {
                    console.error('Error processing project file content:', error);
                    this.showNotification(`Failed to load project: ${error.message}`, 'error');
                    throw error;
                }
            }

            selectProject(projectId) {
                this.currentProject = this.projects.get(projectId);
                this.currentPath = [];
                
                if (this.currentProject) {
                    this.currentProject.metadata.lastOpened = new Date().toISOString();
                    
                    this.renderProjectContent();
                    this.updateActiveTreeItem(projectId);
                    this.updateContentTitle();
                    this.updateSaveButtonState(); // 更新保存按钮状态
                    
                    document.getElementById('projectOverview').style.display = 'none';
                    document.getElementById('projectContent').style.display = 'block';
                    
                    this.updateStatusBar(`Opened: ${this.currentProject.name}`);
                    this.saveProjects();
                }
            }

            renderProjectTree() {
                const projectTree = document.getElementById('projectTree');
                if (!projectTree) return;

                let html = '';
                
                if (this.projects.size === 0) {
                    html = `
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <div style="font-size: 2em; margin-bottom: 10px;">📂</div>
                            <div style="margin-bottom: 10px;">No projects found</div>
                            <button class="btn btn-primary" onclick="projectManager.createNewProject()" style="font-size: 12px; padding: 6px 12px;">
                                Create Project
                            </button>
                        </div>
                    `;
                } else {
                    this.projects.forEach((project, projectId) => {
                        const isActive = this.currentProject && this.currentProject.id === projectId;
                        html += `
                            <div class="tree-item project ${isActive ? 'active' : ''}" 
                                 onclick="projectManagerWindow.selectProject('${projectId}')"
                                 oncontextmenu="projectManagerWindow.showProjectContextMenu(event, '${projectId}')"
                                 data-project-id="${projectId}">
                                <div class="tree-icon">📂</div>
                                <span title="${project.description || project.name}">${project.name}</span>
                                <div class="tree-actions">
                                    <button class="tree-action-btn" onclick="event.stopPropagation(); projectManagerWindow.showProjectActions('${projectId}')" title="More options">⋯</button>
                                </div>
                            </div>
                        `;
                        
                        if (isActive && project.folders) {
                            project.folders.forEach(folder => {
                                const isCurrentPath = this.arraysEqual(this.currentPath, folder.path);
                                html += `
                                    <div class="tree-item folder ${isCurrentPath ? 'active' : ''}" 
                                         onclick="projectManagerWindow.navigateToFolder(${JSON.stringify(folder.path).replace(/"/g, '&quot;')})"
                                         oncontextmenu="projectManagerWindow.showFolderContextMenu(event, ${JSON.stringify(folder.path).replace(/"/g, '&quot;')})"
                                         style="margin-left: 20px;"
                                         data-folder-path="${JSON.stringify(folder.path).replace(/"/g, '&quot;')}">
                                        <div class="tree-icon">${folder.icon}</div>
                                        <span>${folder.name}</span>
                                        <div class="tree-actions">
                                            <button class="tree-action-btn" onclick="event.stopPropagation(); projectManagerWindow.showFolderActions(${JSON.stringify(folder.path).replace(/"/g, '&quot;')})" title="More options">⋯</button>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                projectTree.innerHTML = html;
                
                // 设置文件夹拖拽目标
                setTimeout(() => {
                    this.setupFolderDropTargets();
                }, 0);
            }

            navigateToFolder(path) {
                this.currentPath = path;
                this.renderProjectContent();
                this.updateContentTitle();
            }

            renderProjectContent() {
                if (!this.currentProject) return;

                this.renderProjectStats();
                this.renderFiles();
            }

            // ================================
            // 视图模式管理
            // ================================
            
            setViewMode(mode) {
                if (this.viewMode === mode) return;
                
                this.viewMode = mode;
                
                // 更新按钮状态
                document.querySelectorAll('.view-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.view-mode-btn[data-mode="${mode}"]`).classList.add('active');
                
                // 重新渲染文件视图
                this.renderFiles();
            }

            renderFiles() {
                switch (this.viewMode) {
                    case 'list':
                        this.renderFileList();
                        break;
                    case 'details':
                        this.renderFileDetails();
                        break;
                    default:
                        this.renderFileGrid();
                        break;
                }
            }

            hideAllViews() {
                document.getElementById('fileGrid').style.display = 'none';
                document.getElementById('fileList').style.display = 'none';
                document.getElementById('fileDetails').style.display = 'none';
            }

            renderFileList() {
                this.hideAllViews();
                const fileList = document.getElementById('fileList');
                fileList.style.display = 'block';

                const currentFiles = this.getCurrentFolderFiles();
                const filteredFiles = this.filterFiles(currentFiles);

                if (filteredFiles.length === 0) {
                    fileList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📄</div>
                            <h3>No files found</h3>
                            <p>Add some files to this folder to get started.</p>
                            <button class="btn btn-primary" onclick="projectManagerWindow.addFiles()">
                                Add Files
                            </button>
                        </div>
                    `;
                    return;
                }

                let html = '';
                filteredFiles.forEach(file => {
                    const fileType = this.detectFileType(file.name);
                    const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };

                    html += `
                        <div class="file-list-item" 
                             draggable="true"
                             ondragstart="projectManagerWindow.handleFileDragStart(event, '${file.id}')"
                             ondragend="projectManagerWindow.handleFileDragEnd(event)"
                             onclick="projectManagerWindow.selectFile('${file.id}')"
                             ondblclick="projectManagerWindow.openFileInMainWindow('${file.id}')"
                             data-file-id="${file.id}">
                            <div class="file-icon-small" style="background-color: ${typeConfig.color}">
                                ${typeConfig.icon}
                            </div>
                            <div class="file-name" title="${file.name}">${file.name}</div>
                            <div class="file-size">${this.formatFileSize(file.size || 0)}</div>
                            <div class="file-date">${file.modified ? this.formatDate(file.modified) : 'Unknown'}</div>
                        </div>
                    `;
                });

                fileList.innerHTML = html;
                this.updateFileCountDisplay(filteredFiles.length);
            }

            renderFileDetails() {
                this.hideAllViews();
                const fileDetails = document.getElementById('fileDetails');
                fileDetails.style.display = 'block';

                const currentFiles = this.getCurrentFolderFiles();
                const filteredFiles = this.filterFiles(currentFiles);

                if (filteredFiles.length === 0) {
                    fileDetails.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📄</div>
                            <h3>No files found</h3>
                            <p>Add some files to this folder to get started.</p>
                            <button class="btn btn-primary" onclick="projectManagerWindow.addFiles()">
                                Add Files
                            </button>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <table class="file-details-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>Name</th>
                                <th style="width: 100px;">Type</th>
                                <th style="width: 80px;">Size</th>
                                <th style="width: 120px;">Modified</th>
                                <th style="width: 200px;">Path</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                filteredFiles.forEach(file => {
                    const fileType = this.detectFileType(file.name);
                    const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };

                    html += `
                        <tr draggable="true"
                            ondragstart="projectManagerWindow.handleFileDragStart(event, '${file.id}')"
                            ondragend="projectManagerWindow.handleFileDragEnd(event)"
                            onclick="projectManagerWindow.selectFile('${file.id}')"
                            ondblclick="projectManagerWindow.openFileInMainWindow('${file.id}')"
                            data-file-id="${file.id}">
                            <td>
                                <div class="file-icon-small" style="background-color: ${typeConfig.color}">
                                    ${typeConfig.icon}
                                </div>
                            </td>
                            <td class="file-name" title="${file.name}">${file.name}</td>
                            <td>${fileType.toUpperCase()}</td>
                            <td>${this.formatFileSize(file.size || 0)}</td>
                            <td>${file.modified ? this.formatDate(file.modified) : 'Unknown'}</td>
                            <td title="${file.path || 'N/A'}">${this.truncatePath(file.path || 'N/A', 25)}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;

                fileDetails.innerHTML = html;
                this.updateFileCountDisplay(filteredFiles.length);
            }

            truncatePath(path, maxLength) {
                if (path.length <= maxLength) return path;
                return '...' + path.slice(-(maxLength - 3));
            }

            // ================================
            // 拖拽功能
            // ================================
            
            handleFileDragStart(event, fileId) {
                console.log('📋 Drag start for file:', fileId);
                this.draggedFile = fileId;
                
                // 设置拖拽效果
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', fileId);
                
                // 添加拖拽样式
                event.target.classList.add('dragging');
                
                // 设置拖拽图像
                const dragImage = event.target.cloneNode(true);
                dragImage.style.opacity = '0.8';
                dragImage.style.transform = 'rotate(5deg)';
                event.dataTransfer.setDragImage(dragImage, 0, 0);
            }

            handleFileDragEnd(event) {
                console.log('📋 Drag end');
                this.draggedFile = null;
                
                // 移除拖拽样式
                event.target.classList.remove('dragging');
                
                // 清理所有拖拽相关的样式
                this.clearDragStyles();
            }

            clearDragStyles() {
                // 移除所有文件夹的拖拽样式
                document.querySelectorAll('.tree-item.folder').forEach(item => {
                    item.classList.remove('drag-over');
                });
                
                // 移除拖拽提示
                const hint = document.querySelector('.drag-drop-hint');
                if (hint) {
                    hint.remove();
                }
            }

            setupFolderDropTargets() {
                // 为所有文件夹设置拖拽目标事件
                document.querySelectorAll('.tree-item.folder').forEach(folder => {
                    folder.addEventListener('dragover', (e) => {
                        if (this.draggedFile) {
                            e.preventDefault();
                            e.dataTransfer.dropEffect = 'move';
                            folder.classList.add('drag-over');
                            
                            // 显示拖拽提示
                            this.showDragHint(folder, 'Move file to this folder');
                        }
                    });

                    folder.addEventListener('dragleave', (e) => {
                        // 检查是否真的离开了文件夹区域
                        if (!folder.contains(e.relatedTarget)) {
                            folder.classList.remove('drag-over');
                            this.removeDragHint();
                        }
                    });

                    folder.addEventListener('drop', (e) => {
                        e.preventDefault();
                        if (this.draggedFile) {
                            const folderPath = JSON.parse(folder.dataset.folderPath);
                            this.moveFileToFolder(this.draggedFile, folderPath);
                        }
                        folder.classList.remove('drag-over');
                        this.removeDragHint();
                    });
                });
            }

            showDragHint(target, message) {
                this.removeDragHint();
                const hint = document.createElement('div');
                hint.className = 'drag-drop-hint';
                hint.textContent = message;
                target.appendChild(hint);
            }

            removeDragHint() {
                const hint = document.querySelector('.drag-drop-hint');
                if (hint) {
                    hint.remove();
                }
            }

            async moveFileToFolder(fileId, targetFolderPath) {
                console.log('📁 Moving file to folder:', fileId, targetFolderPath);
                
                if (!this.currentProject) {
                    this.showNotification('No project selected', 'error');
                    return;
                }

                const file = this.findFileById(fileId);
                if (!file) {
                    this.showNotification('File not found', 'error');
                    return;
                }

                // 检查是否移动到同一个文件夹
                if (file.folder && this.arraysEqual(file.folder, targetFolderPath)) {
                    this.showNotification('File is already in this folder', 'warning');
                    return;
                }

                try {
                    // 更新文件的文件夹路径
                    const oldFolder = file.folder ? file.folder.slice() : [];
                    file.folder = targetFolderPath.slice();
                    
                    // 如果文件被复制到项目中，需要物理移动文件
                    if (file.originalPath && window.electronAPI && window.electronAPI.moveFileInProject) {
                        const moveResult = await window.electronAPI.moveFileInProject(
                            file.path,
                            this.currentProject.name,
                            targetFolderPath.join('/')
                        );
                        
                        if (moveResult.success) {
                            file.path = moveResult.newPath;
                            console.log(`✅ File physically moved to: ${file.path}`);
                        } else {
                            console.warn('Failed to physically move file, but metadata updated');
                        }
                    }

                    // 更新项目修改时间
                    this.currentProject.modified = new Date().toISOString();
                    this.projects.set(this.currentProject.id, this.currentProject);

                    // 缓冲更改，不立即保存XML文件
                    this.markProjectAsModified();

                    // 重新渲染
                    this.renderProjectTree();
                    this.renderFiles();
                    this.updateSaveButtonState(); // 更新保存按钮状态

                    const targetFolderName = this.getFolderName(targetFolderPath);
                    this.showNotification(`File "${file.name}" moved to "${targetFolderName}" (changes buffered)`, 'success');

                } catch (error) {
                    console.error('Error moving file:', error);
                    this.showNotification('Failed to move file: ' + error.message, 'error');
                }
            }

            getFolderName(folderPath) {
                if (!folderPath || folderPath.length === 0) return 'Root';
                const folder = this.currentProject.folders.find(f => 
                    this.arraysEqual(f.path, folderPath)
                );
                return folder ? folder.name : folderPath[folderPath.length - 1];
            }

            // ================================
            // 项目文件锁定管理
            // ================================
            
            async lockProjectFile(filePath) {
                if (!window.electronAPI || !window.electronAPI.lockProjectFile) {
                    console.warn('File locking not available in this environment');
                    return false;
                }
                
                try {
                    const result = await window.electronAPI.lockProjectFile(filePath);
                    if (result.success) {
                        this.projectFileLocks.set(filePath, {
                            locked: true,
                            lockedAt: new Date().toISOString(),
                            lockId: result.lockId
                        });
                        console.log(`🔒 Project file locked: ${filePath}`);
                        return true;
                    } else {
                        console.warn(`Failed to lock project file: ${result.error}`);
                        this.showNotification(`Cannot open project: ${result.error}`, 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('Error locking project file:', error);
                    this.showNotification('Failed to lock project file', 'error');
                    return false;
                }
            }
            
            async unlockProjectFile(filePath) {
                if (!window.electronAPI || !window.electronAPI.unlockProjectFile) {
                    console.warn('File unlocking not available in this environment');
                    return;
                }
                
                const lockInfo = this.projectFileLocks.get(filePath);
                if (!lockInfo) {
                    console.warn(`No lock info found for file: ${filePath}`);
                    return;
                }
                
                try {
                    const result = await window.electronAPI.unlockProjectFile(filePath, lockInfo.lockId);
                    if (result.success) {
                        this.projectFileLocks.delete(filePath);
                        console.log(`🔓 Project file unlocked: ${filePath}`);
                    } else {
                        console.warn(`Failed to unlock project file: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error unlocking project file:', error);
                }
            }
            
            async unlockAllProjectFiles() {
                console.log('🔓 Unlocking all project files...');
                const promises = [];
                for (const filePath of this.projectFileLocks.keys()) {
                    promises.push(this.unlockProjectFile(filePath));
                }
                await Promise.all(promises);
                console.log('✅ All project files unlocked');
            }

            // ================================
            // 项目修改状态管理
            // ================================
            
            markProjectAsModified() {
                if (!this.currentProject) return;
                
                this.currentProject.hasUnsavedChanges = true;
                this.currentProject.modified = new Date().toISOString();
                
                // 保存到本地存储
                this.projects.set(this.currentProject.id, this.currentProject);
                this.saveProjects();
                
                console.log('📝 Project marked as modified (changes buffered)');
            }
            
            markProjectAsSaved() {
                if (!this.currentProject) return;
                
                this.currentProject.hasUnsavedChanges = false;
                
                // 保存到本地存储
                this.projects.set(this.currentProject.id, this.currentProject);
                this.saveProjects();
                
                this.updateProjectTitle();
                this.updateSaveButtonState();
                
                console.log('💾 Project marked as saved');
            }
            
            updateSaveButtonState() {
                const saveBtn = document.querySelector('[onclick="projectManagerWindow.saveCurrentProject()"]');
                const saveAsBtn = document.querySelector('[onclick="projectManagerWindow.saveProjectAs()"]');
                
                if (!saveBtn) return;
                
                const hasChanges = this.currentProject && this.currentProject.hasUnsavedChanges;
                
                if (hasChanges) {
                    saveBtn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                    saveBtn.style.boxShadow = '0 4px 15px rgba(255, 107, 107, 0.4)';
                    saveBtn.innerHTML = '💾 Save *';
                    saveBtn.title = 'Save project (Ctrl/Cmd+S) - You have unsaved changes';
                    
                    // 添加脉冲动画
                    saveBtn.style.animation = 'pulse 2s infinite';
                } else {
                    saveBtn.style.background = 'linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%)';
                    saveBtn.style.boxShadow = '0 4px 15px rgba(54, 209, 220, 0.4)';
                    saveBtn.innerHTML = '💾 Save';
                    saveBtn.title = 'Save current project (Ctrl/Cmd+S)';
                    saveBtn.style.animation = '';
                }
            }

            // ================================
            // 自动保存XML项目文件
            // ================================
            
            async saveProjectToXMLFile() {
                if (!this.currentProject) {
                    console.warn('No current project to save');
                    return;
                }

                try {
                    // 如果项目有XML文件路径，保存到该位置
                    if (this.currentProject.projectFilePath) {
                        const result = await this.saveProjectToFile(this.currentProject);
                        if (result.success) {
                            console.log('✅ Project XML file auto-saved');
                        }
                    } else {
                        // 如果没有XML文件路径，创建一个
                        await this.createProjectXMLFile(this.currentProject);
                        console.log('✅ Project XML file created and saved');
                    }
                } catch (error) {
                    console.error('Error auto-saving project XML:', error);
                    // 不显示错误通知，因为这是自动保存
                }
            }

            renderProjectStats() {
                const statsElement = document.getElementById('projectStats');
                if (!statsElement || !this.currentProject) return;

                const currentFiles = this.getCurrentFolderFiles();
                const totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);

                statsElement.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${currentFiles.length}</div>
                        <div class="stat-label">Files in Folder</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.currentProject.files.length}</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.formatFileSize(totalSize)}</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.currentProject.folders.length}</div>
                        <div class="stat-label">Folders</div>
                    </div>
                `;
            }

            renderFileGrid() {
                this.hideAllViews();
                const fileGrid = document.getElementById('fileGrid');
                fileGrid.style.display = 'grid';

                const currentFiles = this.getCurrentFolderFiles();
                const filteredFiles = this.filterFiles(currentFiles);

                if (filteredFiles.length === 0) {
                    fileGrid.innerHTML = `
                        <div style="grid-column: 1 / -1;">
                            <div class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <h3>No files found</h3>
                                <p>Add some files to this folder to get started.</p>
                                <button class="btn btn-primary" onclick="projectManagerWindow.addFiles()">
                                    Add Files
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = '';
                filteredFiles.forEach(file => {
                    const fileType = this.detectFileType(file.name);
                    const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };

                    html += `
                        <div class="file-card" 
                             draggable="true"
                             ondragstart="projectManagerWindow.handleFileDragStart(event, '${file.id}')"
                             ondragend="projectManagerWindow.handleFileDragEnd(event)"
                             onclick="projectManagerWindow.selectFile('${file.id}')"
                             ondblclick="projectManagerWindow.openFileInMainWindow('${file.id}')"
                             data-file-id="${file.id}">
                            <div class="file-icon ${fileType}" 
                                 style="background-color: ${typeConfig.color}">
                                ${typeConfig.icon}
                            </div>
                            <div class="file-name" title="${file.name}">${file.name}</div>
                            <div class="file-info">
                                ${this.formatFileSize(file.size || 0)}
                                ${file.modified ? `• ${this.formatDate(file.modified)}` : ''}
                            </div>
                        </div>
                    `;
                });

                fileGrid.innerHTML = html;
                this.updateFileCountDisplay(filteredFiles.length);
            }

            async addFiles() {
                console.log('📁 Add Files button clicked');
                
                if (!this.currentProject) {
                    this.showNotification('Please select a project first', 'warning');
                    return;
                }

                // 初始化临时文件存储
                this.tempSelectedFiles = null;
                this.tempFileSource = null;

                // 注释掉ProjectManager的直接调用，始终显示复制选项
                // if (this.projectManager) {
                //     console.log('✅ Using ProjectManager core logic for adding files');
                //     return await this.projectManager.addFiles();
                // }

                // 如果在Electron环境中，使用文件选择API
                if (window.electronAPI && window.electronAPI.selectMultipleFiles) {
                    console.log('🔧 Using Electron API for file selection');
                    try {
                        const result = await window.electronAPI.selectMultipleFiles();
                        if (result.success && !result.canceled && result.filePaths) {
                            // 存储选择的文件路径并显示选项对话框
                            this.tempSelectedFiles = result.filePaths;
                            this.tempFileSource = 'electron';
                            this.showAddFilesModal();
                        }
                    } catch (error) {
                        console.error('Error selecting files:', error);
                        this.showNotification('Failed to select files: ' + error.message, 'error');
                    }
                } else {
                    // 浏览器环境下的文件选择
                    console.log('🌐 Using browser file selection');
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = true;
                    input.accept = '.fasta,.fa,.gff,.gtf,.vcf,.bam,.sam,.wig,.bed,.gb,.gbk';
                    input.onchange = (e) => {
                        const files = Array.from(e.target.files);
                        // 存储选择的文件对象并显示选项对话框
                        this.tempSelectedFiles = files;
                        this.tempFileSource = 'browser';
                        this.showAddFilesModal();
                    };
                    input.click();
                }
            }

            showAddFilesModal() {
                // 显示选择的文件列表
                this.populateSelectedFilesList();
                
                // 显示模态框
                const modal = document.getElementById('addFilesModal');
                if (modal) {
                    modal.style.display = 'block';
                }
            }

            populateSelectedFilesList() {
                const listContainer = document.getElementById('selectedFilesList');
                if (!listContainer || !this.tempSelectedFiles) return;

                let html = '';
                const files = this.tempSelectedFiles;
                
                if (this.tempFileSource === 'electron') {
                    // 处理文件路径
                    files.forEach((filePath, index) => {
                        const fileName = filePath.split(/[/\\]/).pop();
                        const fileType = this.detectFileType(fileName);
                        const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };
                        
                        html += `
                            <div style="display: flex; align-items: center; margin: 5px 0; padding: 8px; border: 1px solid #e1e8ed; border-radius: 4px; background: white;">
                                <div style="width: 20px; height: 20px; background: ${typeConfig.color}; color: white; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 10px;">
                                    ${typeConfig.icon}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${fileName}</div>
                                    <div style="font-size: 0.8em; color: #666;">${filePath}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // 处理文件对象（浏览器）
                    files.forEach((file, index) => {
                        const fileType = this.detectFileType(file.name);
                        const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };
                        
                        html += `
                            <div style="display: flex; align-items: center; margin: 5px 0; padding: 8px; border: 1px solid #e1e8ed; border-radius: 4px; background: white;">
                                <div style="width: 20px; height: 20px; background: ${typeConfig.color}; color: white; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 10px;">
                                    ${typeConfig.icon}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${file.name}</div>
                                    <div style="font-size: 0.8em; color: #666;">${this.formatFileSize(file.size)} • ${new Date(file.lastModified).toLocaleDateString()}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (html === '') {
                    html = '<div style="text-align: center; color: #666; padding: 20px;">No files selected</div>';
                }

                listContainer.innerHTML = html;
            }

            async processFilesWithOptions() {
                if (!this.tempSelectedFiles) {
                    this.showNotification('No files selected', 'warning');
                    return;
                }

                // 获取选择的处理选项
                const fileHandling = document.querySelector('input[name="fileHandling"]:checked').value;
                const copyFiles = fileHandling === 'copy';

                console.log(`📁 Processing files with option: ${copyFiles ? 'Copy to project' : 'Reference original location'}`);

                try {
                    if (this.tempFileSource === 'electron') {
                        await this.processSelectedFiles(this.tempSelectedFiles, copyFiles);
                    } else {
                        await this.processFileObjects(this.tempSelectedFiles, copyFiles);
                    }

                    // 关闭模态框
                    this.closeModal('addFilesModal');
                    
                    // 清理临时数据
                    this.tempSelectedFiles = null;
                    this.tempFileSource = null;

                } catch (error) {
                    console.error('Error processing files:', error);
                    this.showNotification('Failed to process files: ' + error.message, 'error');
                }
            }

            // 处理文件路径（Electron环境）
            async processSelectedFiles(filePaths, copyFiles = true) {
                console.log('📂 Processing selected files:', filePaths);
                console.log('📋 Copy files to project:', copyFiles);
                let addedCount = 0;
                
                for (const filePath of filePaths) {
                    try {
                        // 获取文件名和统计信息
                        const fileName = filePath.split(/[/\\]/).pop();
                        let fileSize = 0;
                        let lastModified = new Date().toISOString();
                        let finalPath = filePath;

                        // 尝试获取文件信息
                        if (window.electronAPI && window.electronAPI.getFileInfo) {
                            try {
                                const fileInfo = await window.electronAPI.getFileInfo(filePath);
                                if (fileInfo.success) {
                                    fileSize = fileInfo.info.size;
                                    lastModified = fileInfo.info.mtime;
                                }
                            } catch (error) {
                                console.warn('Could not get file info for:', fileName);
                            }
                        }

                        // 如果选择复制文件，则复制到项目数据文件夹
                        if (copyFiles && window.electronAPI && window.electronAPI.copyFileToProject) {
                            try {
                                const copyResult = await window.electronAPI.copyFileToProject(
                                    filePath, 
                                    this.currentProject.name, 
                                    'Files'
                                );
                                
                                if (copyResult.success) {
                                    finalPath = copyResult.newPath;
                                    console.log(`✅ File copied to: ${finalPath}`);
                                } else {
                                    console.warn(`Failed to copy file ${fileName}, using original path`);
                                }
                            } catch (error) {
                                console.warn(`Error copying file ${fileName}:`, error);
                            }
                        }

                        const fileObj = {
                            id: this.generateId(),
                            name: fileName,
                            path: finalPath,
                            originalPath: copyFiles ? filePath : null, // 保存原始路径用于引用
                            size: fileSize,
                            type: this.detectFileType(fileName),
                            folder: [...this.currentPath],
                            added: new Date().toISOString(),
                            modified: lastModified,
                            copied: copyFiles, // 标记文件是否被复制
                            projectRelativePath: copyFiles ? this.getProjectRelativePath(finalPath) : null
                        };
                        
                        this.currentProject.files.push(fileObj);
                        addedCount++;
                        console.log(`✅ Added file: ${fileName} (${copyFiles ? 'copied' : 'referenced'})`);
                    } catch (error) {
                        console.error('Error processing file:', filePath, error);
                    }
                }
                
                if (addedCount > 0) {
                    this.currentProject.modified = new Date().toISOString();
                    this.currentProject.hasUnsavedChanges = true; // 标记为有未保存更改
                    this.currentProject.metadata.totalFiles = this.currentProject.files.length;
                    this.currentProject.metadata.totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);
                    
                    // 更新文件类型统计
                    this.updateProjectFileTypeStats();
                    
                    await this.saveProjects();
                    
                    // 缓冲更改，不立即保存XML文件
                    this.markProjectAsModified();
                    
                    this.renderProjectContent();
                    this.updateProjectTitle(); // 更新标题显示未保存状态
                    this.updateSaveButtonState(); // 更新保存按钮状态
                    
                    const action = copyFiles ? 'copied to' : 'referenced in';
                    this.showNotification(`✅ Added ${addedCount} file(s) ${action} project (changes buffered)`, 'success');
                    console.log(`📊 Project updated: ${this.currentProject.metadata.totalFiles} total files`);
                } else {
                    this.showNotification('No files were added', 'warning');
                }
            }

            // 处理文件对象（浏览器环境）
            async processFileObjects(files, copyFiles = true) {
                console.log('🌐 Processing file objects from browser:', files.length);
                console.log('📋 Copy files to project:', copyFiles);
                let addedCount = 0;
                
                for (const file of files) {
                    // 在浏览器环境中，文件总是"引用"的，不能真正复制到项目文件夹
                    const fileObj = {
                        id: this.generateId(),
                        name: file.name,
                        path: file.name, // 浏览器环境下只能获取文件名
                        size: file.size,
                        type: this.detectFileType(file.name),
                        folder: [...this.currentPath],
                        added: new Date().toISOString(),
                        modified: new Date(file.lastModified).toISOString(),
                        copied: false, // 浏览器环境下总是false
                        browserFile: true // 标记为浏览器文件
                    };
                    
                    this.currentProject.files.push(fileObj);
                    addedCount++;
                }
                
                if (addedCount > 0) {
                    this.currentProject.modified = new Date().toISOString();
                    this.currentProject.metadata.totalFiles = this.currentProject.files.length;
                    this.currentProject.metadata.totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);
                    
                    await this.saveProjects();
                    
                    // 自动保存XML项目文件
                    await this.saveProjectToXMLFile();
                    
                    this.renderProjectContent();
                    this.showNotification(`✅ Added ${addedCount} file(s) to project (browser mode)`, 'success');
                }
            }

            // 获取项目相对路径
            getProjectRelativePath(absolutePath) {
                if (!absolutePath) return null;
                
                // 尝试提取项目相对路径
                const projectName = this.currentProject.name;
                
                // 处理不同平台的路径分隔符
                const normalizedPath = absolutePath.replace(/\\/g, '/');
                
                // 新的项目结构：项目名文件夹直接包含子文件夹
                const newStructurePattern = `/${projectName}/`;
                const newIndex = normalizedPath.indexOf(newStructurePattern);
                
                if (newIndex !== -1) {
                    return normalizedPath.substring(newIndex + newStructurePattern.length);
                }
                
                // 兼容旧的Genome AI Studio Projects结构
                const oldDataPattern = `Genome AI Studio Projects/${projectName}/data/`;
                const oldDataIndex = normalizedPath.indexOf(oldDataPattern);
                
                if (oldDataIndex !== -1) {
                    return normalizedPath.substring(oldDataIndex + oldDataPattern.length);
                }
                
                // 如果没有找到标准路径，尝试其他模式
                const altPattern = `/${projectName}/data/`;
                const altIndex = normalizedPath.indexOf(altPattern);
                if (altIndex !== -1) {
                    return normalizedPath.substring(altIndex + altPattern.length);
                }
                
                return absolutePath;
            }

            createFolder() {
                if (!this.currentProject) {
                    this.showNotification('Please select a project first', 'warning');
                    return;
                }

                this.showCreateFolderModal();
            }
            
            showCreateFolderModal() {
                // 创建模态对话框
                const modalHtml = `
                    <div id="createFolderModal" class="modal" style="display: block;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>🗂️ Create New Data Folder</h3>
                                <span class="close" onclick="projectManagerWindow.closeModal('createFolderModal')">&times;</span>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label for="newFolderName">Folder Name:</label>
                                    <input type="text" id="newFolderName" placeholder="e.g., Proteomics, Metabolomics..." />
                                </div>
                                
                                <div class="form-group">
                                    <label for="newFolderIcon">Icon:</label>
                                    <select id="newFolderIcon">
                                        <option value="📁">📁 Default Folder</option>
                                        <option value="🧬">🧬 Genomes</option>
                                        <option value="📋">📋 Annotations</option>
                                        <option value="🔄">🔄 Variants</option>
                                        <option value="📊">📊 Reads/Data</option>
                                        <option value="📈">📈 Analysis</option>
                                        <option value="🧪">🧪 Experiments</option>
                                        <option value="⚡">⚡ Results</option>
                                        <option value="🎯">🎯 Targets</option>
                                        <option value="🔬">🔬 Microscopy</option>
                                        <option value="🌟">🌟 Important</option>
                                        <option value="📦">📦 Resources</option>
                                        <option value="🎨">🎨 Visualizations</option>
                                        <option value="📚">📚 References</option>
                                        <option value="🧮">🧮 Statistics</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="newFolderDescription">Description (optional):</label>
                                    <input type="text" id="newFolderDescription" placeholder="Brief description of folder purpose..." />
                                </div>
                                
                                <div class="modal-note">
                                    <strong>Note:</strong> This will create a new data type folder at the project root level.
                                    You can organize your files by dragging them into this folder.
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="projectManagerWindow.closeModal('createFolderModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="projectManagerWindow.createCustomFolder()">Create Folder</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 添加模态对话框到页面
                const existingModal = document.getElementById('createFolderModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // 聚焦到输入框
                setTimeout(() => {
                    document.getElementById('newFolderName').focus();
                }, 100);
            }
            
            async createCustomFolder() {
                const folderName = document.getElementById('newFolderName').value.trim();
                const folderIcon = document.getElementById('newFolderIcon').value;
                const folderDescription = document.getElementById('newFolderDescription').value.trim();
                
                if (!folderName) {
                    this.showNotification('Please enter a folder name', 'warning');
                    return;
                }
                
                // 检查是否已存在同名文件夹
                const existingFolder = this.currentProject.folders.find(f => 
                    f.name.toLowerCase() === folderName.toLowerCase()
                );
                
                if (existingFolder) {
                    this.showNotification(`Folder "${folderName}" already exists`, 'warning');
                    return;
                }
                
                try {
                    // 在文件系统中创建文件夹
                    if (window.electronAPI && window.electronAPI.createProjectFolder) {
                        const result = await window.electronAPI.createProjectFolder(
                            this.currentProject.name,
                            folderName
                        );
                        
                        if (!result.success) {
                            throw new Error(result.error || 'Failed to create folder');
                        }
                    }
                    
                    // 添加到项目配置
                    const newFolder = {
                        name: folderName,
                        icon: folderIcon,
                        path: [folderName.toLowerCase()],
                        files: [],
                        description: folderDescription || null,
                        custom: true, // 标记为用户自定义文件夹
                        created: new Date().toISOString()
                    };
                    
                    this.currentProject.folders.push(newFolder);
                    this.currentProject.modified = new Date().toISOString();
                    
                    // 标记项目为已修改
                    this.markProjectAsModified();
                    
                    // 保存和刷新界面
                    await this.saveProjects();
                    this.renderProjectTree();
                    this.updateSaveButtonState();
                    
                    this.closeModal('createFolderModal');
                    this.showNotification(`✅ Folder "${folderName}" created successfully`, 'success');
                    
                    console.log(`📁 Created custom folder: ${folderName} (${folderIcon})`);
                    
                } catch (error) {
                    console.error('Error creating custom folder:', error);
                    this.showNotification(`Failed to create folder: ${error.message}`, 'error');
                }
            }

            selectFile(fileId) {
                this.selectedFiles.clear();
                this.selectedFiles.add(fileId);
                this.updateFileCardSelection();
                this.updateStatusBar();
            }

            async openFileInMainWindow(fileId) {
                console.log('🎯 Opening file in main window - fileId:', fileId);
                console.log('🔧 ProjectManager available:', !!this.projectManager);
                
                const file = this.findFileById(fileId);
                console.log('📁 Found file:', file);
                console.log('📁 File path:', file?.path);
                console.log('📁 File type:', file?.type);
                console.log('📁 File name:', file?.name);
                if (!file) {
                    console.error('❌ File not found with ID:', fileId);
                    this.showNotification('File not found', 'error');
                    return;
                }

                try {
                    // 检查文件路径是否为测试/虚拟路径
                    if (file.path && file.path.startsWith('/test/')) {
                        console.log('⚠️ Test file detected, creating demo content');
                        await this.openTestFile(file);
                        return;
                    }

                    // 直接使用 IPC 打开文件
                    if (window.electronAPI) {
                        console.log('📤 Attempting to open file directly via IPC');
                        
                        // 检查主窗口状态
                        const mainWindowStatus = await window.electronAPI.checkMainWindowStatus();
                        
                        if (mainWindowStatus.hasOpenFile) {
                            // 主窗口已有文件，创建新窗口
                            const result = await window.electronAPI.createNewMainWindow(file.path);
                            if (result.success) {
                                this.showNotification(`✅ Opened "${file.name}" in new window`, 'success');
                            } else {
                                throw new Error(result.error);
                            }
                        } else {
                            // 主窗口没有文件，在当前主窗口打开
                            console.log('📤 Sending to main window via IPC, file path:', file.path);
                            const result = await window.electronAPI.openFileInMainWindow(file.path);
                            console.log('📥 Result from main window:', result);
                            if (result.success) {
                                this.showNotification(`✅ Opened "${file.name}" in Genome AI Studio`, 'success');
                            } else {
                                throw new Error(result.error);
                            }
                        }
                    } else {
                        // 如果没有 Electron API，显示通知
                        console.log('⚠️ No Electron API available');
                        this.showNotification(`Cannot open "${file.name}" - Electron API not available`, 'warning');
                    }
                } catch (error) {
                    console.error('Error opening file:', error);
                    this.showNotification(`Failed to open "${file.name}": ${error.message}`, 'error');
                }
            }

            // 打开项目文件
            async openProject() {
                try {
                    if (window.electronAPI && window.electronAPI.selectProjectFile) {
                        const result = await window.electronAPI.selectProjectFile();
                        if (result.success && !result.canceled && result.filePath) {
                            await this.loadProjectFromFile(result.filePath);
                        }
                    } else {
                        // 浏览器环境下使用文件输入
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.xml,.json,.genproj';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const text = await file.text();
                                await this.loadProjectFromText(text, file.name);
                            }
                        };
                        input.click();
                    }
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showNotification('Failed to open project: ' + error.message, 'error');
                }
            }

            // 从文件加载项目
            async loadProjectFromFile(filePath) {
                try {
                    if (window.electronAPI && window.electronAPI.readFile) {
                        const result = await window.electronAPI.readFile(filePath);
                        if (result.success) {
                            // main.js的read-file handler返回的是data字段，不是content字段
                            await this.loadProjectFromText(result.data, filePath);
                        } else {
                            throw new Error(result.error || 'Failed to read file');
                        }
                    } else {
                        throw new Error('File system access not available');
                    }
                } catch (error) {
                    console.error('Error loading project from file:', error);
                    this.showNotification('Failed to load project: ' + error.message, 'error');
                }
            }

            // 从文本内容加载项目
            async loadProjectFromText(content, fileName) {
                try {
                    let project;
                    
                    // 检测文件格式
                    if (content.trim().startsWith('<')) {
                        // XML格式
                        if (this.xmlHandler && this.xmlHandler.xmlToProject) {
                            project = this.xmlHandler.xmlToProject(content);
                        } else {
                            throw new Error('XML parser not available');
                        }
                    } else {
                        // JSON格式
                        project = JSON.parse(content);
                    }

                    if (project && project.id) {
                        this.projects.set(project.id, project);
                        await this.saveProjects();
                        this.renderProjectTree();
                        this.selectProject(project.id);
                        this.showNotification(`✅ Project "${project.name}" loaded successfully`, 'success');
                    } else {
                        throw new Error('Invalid project format');
                    }
                } catch (error) {
                    console.error('Error parsing project:', error);
                    this.showNotification('Failed to parse project file: ' + error.message, 'error');
                }
            }

            async refreshProjects() {
                // 如果有当前项目，扫描其目录并添加新文件/文件夹
                if (this.currentProject && this.currentProject.location) {
                    await this.scanAndAddNewFiles();
                    this.renderProjectTree();
                    this.renderProjectContent();
                    this.showNotification('🔄 Project directory scanned and refreshed', 'success');
                } else {
                    // 如果没有当前项目，则正常加载项目列表
                    this.loadProjects();
                    this.renderProjectTree();
                    this.showNotification('📂 Projects list refreshed', 'success');
                }
            }

            /**
             * 扫描项目目录并添加新文件和文件夹
             */
            async scanAndAddNewFiles() {
                if (!this.currentProject || !window.electronAPI || !window.electronAPI.scanProjectFolder) {
                    console.warn('Cannot scan project folder: missing project or API');
                    return;
                }

                try {
                    // Determine project path
                    let projectPath;
                    if (this.currentProject.dataFolderPath) {
                        projectPath = this.currentProject.dataFolderPath;
                    } else if (this.currentProject.location && this.currentProject.name) {
                        projectPath = `${this.currentProject.location}/${this.currentProject.name}`;
                    } else {
                        console.warn('Cannot determine project path for scanning');
                        return;
                    }

                    // Get existing file paths for comparison
                    const existingFilePaths = (this.currentProject.files || []).map(file => file.path);
                    
                    // Get existing folder structure for comparison
                    const existingFolderStructure = this.currentProject.folders || [];
                    
                    console.log(`🔍 Scanning project folder: ${projectPath}`);
                    console.log(`📋 Existing files: ${existingFilePaths.length}`);
                    console.log(`📂 Existing folders: ${existingFolderStructure.length}`);

                    // Scan project folder for both files and folders
                    const scanResult = await window.electronAPI.scanProjectFolder(
                        projectPath, 
                        existingFilePaths, 
                        existingFolderStructure
                    );

                    if (scanResult.success) {
                        const newFiles = scanResult.newFiles || [];
                        const newFolders = scanResult.newFolders || [];
                        const totalNewItems = newFiles.length + newFolders.length;
                        
                        if (totalNewItems > 0) {
                            console.log(`🆕 Found ${newFiles.length} new files and ${newFolders.length} new folders`);
                            
                            // Initialize arrays if they don't exist
                            if (!this.currentProject.files) {
                                this.currentProject.files = [];
                            }
                            if (!this.currentProject.folders) {
                                this.currentProject.folders = [];
                            }

                            // Add new files to the project
                            newFiles.forEach(file => {
                                // Generate proper project-unique ID
                                file.id = this.generateId();
                                
                                // Add metadata to indicate it was auto-discovered
                                if (!file.metadata) {
                                    file.metadata = {};
                                }
                                file.metadata.autoDiscovered = true;
                                file.metadata.discoveredDate = new Date().toISOString();
                                
                                this.currentProject.files.push(file);
                            });

                            // Add new folders to the project
                            newFolders.forEach(folder => {
                                // Ensure folder has proper structure
                                if (!folder.files) {
                                    folder.files = [];
                                }
                                
                                this.currentProject.folders.push(folder);
                            });

                            // Update project metadata
                            this.currentProject.modified = new Date().toISOString();
                            this.projects.set(this.currentProject.id, this.currentProject);

                            // Save changes to localStorage
                            await this.saveProjects();

                            // Create detailed summary message
                            let summaryMessage = `✅ Auto-scan completed: `;
                            const parts = [];
                            if (newFiles.length > 0) {
                                parts.push(`${newFiles.length} new file${newFiles.length === 1 ? '' : 's'}`);
                            }
                            if (newFolders.length > 0) {
                                parts.push(`${newFolders.length} new folder${newFolders.length === 1 ? '' : 's'}`);
                            }
                            summaryMessage += parts.join(' and ') + ' added to project';
                            
                            this.showNotification(summaryMessage, 'success');
                            
                            // Add to project history
                            if (!this.currentProject.history) {
                                this.currentProject.history = [];
                            }
                            this.currentProject.history.unshift({
                                timestamp: new Date().toISOString(),
                                action: 'auto-scan-enhanced',
                                description: `Auto-discovered ${totalNewItems} new item${totalNewItems === 1 ? '' : 's'}: ${newFiles.length} files, ${newFolders.length} folders`,
                                details: {
                                    files: newFiles.length,
                                    folders: newFolders.length,
                                    total: totalNewItems,
                                    scanPath: projectPath
                                }
                            });
                            
                            console.log(`📊 Scan Summary:`, {
                                newFiles: newFiles.length,
                                newFolders: newFolders.length,
                                totalAdded: totalNewItems,
                                projectPath: projectPath
                            });
                            
                        } else {
                            console.log('✅ No new files or folders found during scan');
                            this.showNotification('No new files or folders found in project directory', 'info');
                        }
                    } else {
                        console.error('Failed to scan project folder:', scanResult.error);
                        this.showNotification(`Failed to scan project folder: ${scanResult.error}`, 'error');
                    }

                } catch (error) {
                    console.error('Error during enhanced project folder scan:', error);
                    this.showNotification(`Error scanning project folder: ${error.message}`, 'error');
                }
            }

            showSettings() {
                this.showNotification('Settings feature coming soon', 'info');
            }

            // 创建测试项目，用于测试文件打开功能
            createTestProject() {
                console.log('📋 Creating test project...');
                
                const testProject = {
                    id: 'test_project_' + Date.now(),
                    name: 'Test Genomics Project',
                    description: 'A test project with sample files for testing Project Manager functionality',
                    location: '/test/project/location',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    files: [
                        {
                            id: 'test_file_1',
                            name: 'sample_genome.fasta',
                            path: '/test/project/location/genomes/sample_genome.fasta',
                            type: 'fasta',
                            size: 1234567,
                            added: new Date().toISOString(),
                            modified: new Date().toISOString(),
                            folder: ['genomes'],
                            metadata: {
                                organism: 'Escherichia coli',
                                description: 'Sample genome file for testing'
                            },
                            tags: ['test', 'sample']
                        },
                        {
                            id: 'test_file_2', 
                            name: 'sample_annotations.gff',
                            path: '/test/project/location/annotations/sample_annotations.gff',
                            type: 'gff',
                            size: 987654,
                            added: new Date().toISOString(),
                            folder: ['annotations'],
                            metadata: {
                                version: 'GFF3',
                                description: 'Sample annotation file for testing'
                            }
                        }
                    ],
                    folders: [
                        { name: 'Genomes', icon: '🧬', path: ['genomes'] },
                        { name: 'Annotations', icon: '📋', path: ['annotations'] },
                        { name: 'Variants', icon: '🔄', path: ['variants'] },
                        { name: 'Reads', icon: '📊', path: ['reads'] },
                        { name: 'Analysis', icon: '📈', path: ['analysis'] }
                    ],
                    settings: {
                        fileFilters: [],
                        customAnnotations: []
                    },
                    metadata: {
                        totalFiles: 2,
                        totalSize: 2222221,
                        lastOpened: new Date().toISOString(),
                        fileTypeStats: { fasta: 1, gff: 1 }
                    },
                    history: [{
                        timestamp: new Date().toISOString(),
                        action: 'created',
                        description: 'Test project created for functionality testing'
                    }]
                };

                // 添加到项目列表
                this.projects.set(testProject.id, testProject);
                
                // 如果有 ProjectManager，也添加到那里
                if (this.projectManager) {
                    this.projectManager.projects.set(testProject.id, testProject);
                }

                // 更新UI
                this.renderProjectTree();
                this.selectProject(testProject.id);
                
                this.showNotification('✅ Test project created with sample files! Try double-clicking a file.', 'success');
                console.log('✅ Test project created:', testProject);
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }

            // 打开测试文件（创建演示内容）
            async openTestFile(file) {
                console.log('🧪 Opening test file with demo content:', file.name);
                
                try {
                    // 根据文件类型创建不同的演示内容
                    let demoContent = '';
                    let demoFilePath = '';
                    
                    if (file.type === 'fasta') {
                        // 创建演示 FASTA 内容
                        demoContent = `>Demo_Genome_Chr1 Escherichia coli demonstration sequence
ATGGCAGAACGACGCGTAATCGTCGTATCGAAGGTCGTAATGCCGCTGCGCTGGCTGCGG
CTGAAGTTCAACATCGTCTGCGTATTCTGGAAAGCGAACTGGAAGATCTGCTGGCGAAAG
CGAAAGAAGCGGGTAAAAAAGCGGGCGAAACCATTGATGTTGCAGTGATGTGGGTTAACC
CGCAGCAGATGGTGATTGGTGAAGGCAAAGTGATTCGCGTTTTTGATGCGCTGCGCATTC
TGGATGAAACCGGCGTAAAAGGGATTCTGACCGCGTTTGTTGAAGCGCGTAACGTACTGC
CGGAAGAAACCATTATGGGTAACGCAGGTCGTCTGGCAAAACTGGGCGACAAAATCAAAG
GCGCAGGTGAAGTGATGGACGAAGTGATGGAGTTTGTTCAGAAAGCGGTGCGCGAAGACG
GTATCGATGTTGTGCGTACCCATGCGGCACATCGTCTGCCGATGACCGGTGAACAGCTGC
CGCTGGATGAAACCGAAGTGTTTACCGATATTGATCTGGTTTTTGCCGACTTCCGTGAAG
ATCTGCACGATCTGATTTGCCAGAAATTTAACGAGCCGGATGCAAACGCGATTGCCTATA
>Demo_Genome_Chr2 Synthetic sequence for testing
CGTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTA
GCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTA
GCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTA`;
                        demoFilePath = 'demo_genome.fasta';
                    } else if (file.type === 'gff') {
                        // 创建演示 GFF 内容
                        demoContent = `##gff-version 3
##sequence-region Demo_Genome_Chr1 1 600
Demo_Genome_Chr1\tGenome_AI_Studio\tgene\t1\t180\t.\t+\t.\tID=gene001;Name=demoA;description=Demo gene A
Demo_Genome_Chr1\tGenome_AI_Studio\tCDS\t1\t180\t.\t+\t0\tID=cds001;Parent=gene001;Name=demoA
Demo_Genome_Chr1\tGenome_AI_Studio\tgene\t200\t360\t.\t-\t.\tID=gene002;Name=demoB;description=Demo gene B
Demo_Genome_Chr1\tGenome_AI_Studio\tCDS\t200\t360\t.\t-\t0\tID=cds002;Parent=gene002;Name=demoB
Demo_Genome_Chr1\tGenome_AI_Studio\tgene\t400\t600\t.\t+\t.\tID=gene003;Name=demoC;description=Demo gene C
Demo_Genome_Chr1\tGenome_AI_Studio\tCDS\t400\t600\t.\t+\t0\tID=cds003;Parent=gene003;Name=demoC`;
                        demoFilePath = 'demo_annotations.gff';
                    } else {
                        // 其他文件类型的默认内容
                        demoContent = `# Demo file content for ${file.name}\n# File type: ${file.type}\n# This is a demonstration file.`;
                        demoFilePath = file.name;
                    }

                    // 创建临时文件
                    if (window.electronAPI && window.electronAPI.createTempFile) {
                        const result = await window.electronAPI.createTempFile(demoFilePath, demoContent);
                        if (result.success) {
                            // 使用临时文件路径打开文件
                            const openResult = await window.electronAPI.openFileInMainWindow(result.filePath);
                            if (openResult.success) {
                                this.showNotification(`✅ Opened demo file "${file.name}" in Genome AI Studio`, 'success');
                            } else {
                                throw new Error(openResult.error);
                            }
                        } else {
                            throw new Error(result.error || 'Failed to create temp file');
                        }
                    } else {
                        // 如果没有创建临时文件的API，至少显示内容预览
                        this.showDemoContentPreview(file, demoContent);
                    }
                } catch (error) {
                    console.error('Error opening test file:', error);
                    this.showNotification(`Test file "${file.name}" contains demo data. Add real files to work with actual genomic data.`, 'info');
                }
            }

            // 显示演示内容预览
            showDemoContentPreview(file, content) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Demo Content Preview: ${file.name}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 15px;">This is a test file with demonstration content. To work with real genomic data, please add actual files to your project.</p>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-family: 'Courier New', monospace; font-size: 12px;">${this.escapeHtml(content)}</pre>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // HTML转义
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // 初始化侧边栏分隔条拖拽功能
            initializeSidebarSplitter() {
                const splitter = document.getElementById('sidebarSplitter');
                const sidebar = document.querySelector('.sidebar');
                const contentArea = document.querySelector('.content-area');
                
                if (!splitter || !sidebar || !contentArea) {
                    console.warn('Sidebar splitter elements not found');
                    return;
                }
                
                let isResizing = false;
                let startX = 0;
                let startSidebarWidth = 0;
                
                const startResize = (e) => {
                    isResizing = true;
                    startX = e.clientX;
                    startSidebarWidth = sidebar.offsetWidth;
                    
                    splitter.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    
                    e.preventDefault();
                };
                
                const doResize = (e) => {
                    if (!isResizing) return;
                    
                    const deltaX = e.clientX - startX;
                    const newSidebarWidth = startSidebarWidth + deltaX;
                    
                    // 设置最小和最大宽度
                    const minWidth = 200;
                    const maxWidth = window.innerWidth * 0.6; // 最大60%屏幕宽度
                    
                    if (newSidebarWidth >= minWidth && newSidebarWidth <= maxWidth) {
                        sidebar.style.width = `${newSidebarWidth}px`;
                    }
                    
                    e.preventDefault();
                };
                
                const stopResize = () => {
                    if (!isResizing) return;
                    
                    isResizing = false;
                    splitter.classList.remove('active');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    
                    // 保存宽度设置到localStorage
                    const currentWidth = sidebar.offsetWidth;
                    localStorage.setItem('projectManagerSidebarWidth', currentWidth);
                };
                
                // 事件监听器
                splitter.addEventListener('mousedown', startResize);
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                
                // 键盘支持
                splitter.setAttribute('tabindex', '0');
                splitter.setAttribute('aria-label', 'Resize sidebar');
                
                splitter.addEventListener('keydown', (e) => {
                    const step = 20;
                    let deltaX = 0;
                    
                    switch(e.key) {
                        case 'ArrowLeft':
                            deltaX = -step;
                            break;
                        case 'ArrowRight':
                            deltaX = step;
                            break;
                        case 'Home':
                            sidebar.style.width = '320px'; // 重置为默认宽度
                            localStorage.setItem('projectManagerSidebarWidth', 320);
                            e.preventDefault();
                            return;
                        default:
                            return;
                    }
                    
                    e.preventDefault();
                    
                    const currentWidth = sidebar.offsetWidth;
                    const newWidth = currentWidth + deltaX;
                    const minWidth = 200;
                    const maxWidth = window.innerWidth * 0.6;
                    
                    if (newWidth >= minWidth && newWidth <= maxWidth) {
                        sidebar.style.width = `${newWidth}px`;
                        localStorage.setItem('projectManagerSidebarWidth', newWidth);
                    }
                });
                
                // 双击重置到默认宽度
                splitter.addEventListener('dblclick', () => {
                    sidebar.style.width = '320px';
                    localStorage.setItem('projectManagerSidebarWidth', 320);
                });
                
                // 从localStorage恢复宽度设置
                const savedWidth = localStorage.getItem('projectManagerSidebarWidth');
                if (savedWidth) {
                    const width = parseInt(savedWidth);
                    if (width >= 200 && width <= window.innerWidth * 0.6) {
                        sidebar.style.width = `${width}px`;
                    }
                }
                
                console.log('✅ Sidebar splitter initialized');
            }

            // 更新项目文件类型统计信息
            updateProjectFileTypeStats() {
                if (!this.currentProject || !this.currentProject.files) return;
                
                const stats = {};
                this.currentProject.files.forEach(file => {
                    const type = file.type || 'unknown';
                    stats[type] = (stats[type] || 0) + 1;
                });
                
                if (!this.currentProject.metadata) {
                    this.currentProject.metadata = {};
                }
                this.currentProject.metadata.fileTypeStats = stats;
                
                console.log('📊 Updated file type statistics:', stats);
            }

            // 工具方法
            getCurrentFolderFiles() {
                if (!this.currentProject) return [];
                return this.currentProject.files.filter(file => {
                    if (this.currentPath.length === 0) {
                        return !file.folder || file.folder.length === 0;
                    }
                    return file.folder && this.arraysEqual(file.folder, this.currentPath);
                });
            }

            filterFiles(files) {
                if (!this.searchTerm) return files;
                return files.filter(file => file.name.toLowerCase().includes(this.searchTerm));
            }

            updateFileCardSelection() {
                const fileCards = document.querySelectorAll('.file-card');
                fileCards.forEach(card => {
                    const fileId = card.dataset.fileId;
                    if (this.selectedFiles.has(fileId)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
            }

            updateContentTitle() {
                const titleElement = document.getElementById('contentTitle');
                if (!titleElement || !this.currentProject) return;

                let title = this.currentProject.name;
                if (this.currentPath.length > 0) {
                    title += ' / ' + this.currentPath.join(' / ');
                }
                titleElement.textContent = title;
            }

            updateProjectTitle() {
                // 更新窗口标题显示未保存状态
                const titleElement = document.querySelector('title');
                if (titleElement && this.currentProject) {
                    const hasChanges = this.currentProject.hasUnsavedChanges ? ' •' : '';
                    titleElement.textContent = `${this.currentProject.name}${hasChanges} - Project Manager`;
                }
                
                // 更新项目树中的显示
                this.renderProjectTree();
            }

            updateActiveTreeItem(projectId = null) {
                const treeItems = document.querySelectorAll('.tree-item');
                treeItems.forEach(item => item.classList.remove('active'));

                if (projectId) {
                    const activeItem = document.querySelector(`[data-project-id="${projectId}"]`);
                    if (activeItem) activeItem.classList.add('active');
                }
            }

            updateStatusBar(message = 'Ready') {
                const statusText = document.getElementById('statusText');
                if (statusText) statusText.textContent = message;
                this.updateFileCountDisplay();
            }

            updateFileCountDisplay(count = null) {
                const fileCountElement = document.getElementById('fileCount');
                if (!fileCountElement) return;

                if (count === null && this.currentProject) {
                    count = this.getCurrentFolderFiles().length;
                }
                
                let text = `${count || 0} items`;
                if (this.selectedFiles.size > 0) {
                    text += ` (${this.selectedFiles.size} selected)`;
                }
                
                fileCountElement.textContent = text;
            }

            async saveProjects() {
                try {
                    // 清理项目数据，移除不可序列化的属性
                    const cleanProjects = new Map();
                    for (const [id, project] of this.projects) {
                        const cleanProject = {
                            id: project.id,
                            name: project.name,
                            description: project.description,
                            location: project.location,
                            projectFilePath: project.projectFilePath,
                            dataFolderPath: project.dataFolderPath,
                            created: project.created,
                            modified: project.modified,
                            files: project.files || [],
                            folders: project.folders || [],
                            metadata: project.metadata || {},
                            isCurrentlyOpen: project.isCurrentlyOpen || false,
                            hasUnsavedChanges: project.hasUnsavedChanges || false
                        };
                        cleanProjects.set(id, cleanProject);
                    }
                    
                    const projectsData = {
                        projects: Object.fromEntries(cleanProjects),
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('genomeAIStudio_projects', JSON.stringify(projectsData));
                    console.log('Projects saved to localStorage');
                } catch (error) {
                    console.error('Error saving projects:', error);
                }
            }

            async loadProjects() {
                try {
                    const data = localStorage.getItem('genomeAIStudio_projects');
                    if (data) {
                        const projectsData = JSON.parse(data);
                        if (projectsData.projects) {
                            this.projects = new Map(Object.entries(projectsData.projects));
                        }
                    }
                    console.log(`Loaded ${this.projects.size} projects`);
                } catch (error) {
                    console.error('Error loading projects:', error);
                    this.projects = new Map();
                }
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            detectFileType(fileName) {
                const ext = '.' + fileName.toLowerCase().split('.').pop();
                for (const [type, config] of Object.entries(this.fileTypes)) {
                    if (config.extensions.includes(ext)) {
                        return type;
                    }
                }
                return 'unknown';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return Math.round(bytes / Math.pow(1024, i) * 10) / 10 + ' ' + sizes[i];
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString();
            }

            arraysEqual(a, b) {
                return a.length === b.length && a.every((val, i) => val === b[i]);
            }

            findFileById(fileId) {
                if (!this.currentProject) return null;
                return this.currentProject.files.find(f => f.id === fileId);
            }

            showNotification(message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${message}`);
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'};
                    color: white;
                    border-radius: 6px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // XML项目文件管理方法
            async createProjectXMLFile(project) {
                try {
                    // 初始化XML处理器
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }

                    // 生成XML文件名
                    const xmlFileName = `${project.name}.prj.GAI`;
                    
                    // 转换项目为XML
                    const xmlContent = this.xmlHandler.projectToXML(project);
                    
                    // 在Electron环境中保存文件
                    if (window.electronAPI && window.electronAPI.saveProjectFile) {
                        try {
                            const result = await window.electronAPI.saveProjectFile(xmlFileName, xmlContent);
                            if (result.success) {
                                // 将XML文件路径保存到项目中
                                project.xmlFilePath = result.filePath;
                                project.xmlFileName = xmlFileName;
                                
                                // 更新项目
                                this.projects.set(project.id, project);
                                await this.saveProjects();
                                
                                console.log(`✅ Created XML project file: ${result.filePath}`);
                                return result.filePath;
                            } else {
                                throw new Error(result.error || 'Failed to save XML file');
                            }
                        } catch (error) {
                            console.error('Error saving XML file via Electron:', error);
                            throw error;
                        }
                    } else {
                        // 浏览器环境中创建下载
                        this.downloadXMLFile(xmlContent, xmlFileName);
                        console.log(`✅ Created XML project file for download: ${xmlFileName}`);
                        return xmlFileName;
                    }
                } catch (error) {
                    console.error('Error creating project XML file:', error);
                    throw error;
                }
            }

            async saveCurrentProjectAsXML() {
                if (!this.currentProject) {
                    this.showNotification('No project selected to save', 'warning');
                    return;
                }

                try {
                    // 更新项目修改时间
                    this.currentProject.modified = new Date().toISOString();
                    
                    // 保存为XML
                    const result = await this.createProjectXMLFile(this.currentProject);
                    
                    this.showNotification(`Project saved as XML: ${this.currentProject.xmlFileName || this.currentProject.name + '.prj.GAI'}`, 'success');
                    return result;
                } catch (error) {
                    console.error('Error saving project as XML:', error);
                    this.showNotification('Failed to save project as XML', 'error');
                    throw error;
                }
            }

            async saveProjectAsXML(projectId = null) {
                const project = projectId ? this.projects.get(projectId) : this.currentProject;
                
                if (!project) {
                    this.showNotification('No project found to save', 'warning');
                    return;
                }

                try {
                    // 更新项目修改时间
                    project.modified = new Date().toISOString();
                    
                    // 保存为XML
                    const result = await this.createProjectXMLFile(project);
                    
                    this.showNotification(`Project "${project.name}" saved as XML`, 'success');
                    return result;
                } catch (error) {
                    console.error('Error saving project as XML:', error);
                    this.showNotification('Failed to save project as XML', 'error');
                    throw error;
                }
            }

            downloadXMLFile(xmlContent, fileName) {
                const blob = new Blob([xmlContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // 新的项目文件保存逻辑
            async saveProjectToFile(project) {
                try {
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }

                    // 更新项目修改时间
                    project.modified = new Date().toISOString();
                    
                    // 转换项目为XML
                    const xmlContent = this.xmlHandler.projectToXML(project);
                    
                    if (window.electronAPI && window.electronAPI.saveProjectToSpecificFile) {
                        // 保存到指定的项目文件路径
                        const result = await window.electronAPI.saveProjectToSpecificFile(
                            project.projectFilePath, 
                            xmlContent
                        );
                        
                        if (result.success) {
                            project.hasUnsavedChanges = false;
                            console.log(`✅ Project saved to: ${project.projectFilePath}`);
                            return result;
                        } else {
                            throw new Error(result.error || 'Failed to save project file');
                        }
                    } else {
                        // 浏览器环境下载
                        this.downloadXMLFile(xmlContent, `${project.name}.prj.GAI`);
                        project.hasUnsavedChanges = false;
                        return { success: true };
                    }
                    
                } catch (error) {
                    console.error('Error saving project to file:', error);
                    throw error;
                }
            }

            async saveCurrentProject() {
                if (!this.currentProject) {
                    this.showNotification('No project is currently open', 'warning');
                    return;
                }

                try {
                    // 如果没有项目文件路径，自动生成一个
                    if (!this.currentProject.projectFilePath) {
                        const documentsPath = window.electronAPI ? await window.electronAPI.getDocumentsPath() : 'Documents';
                        const projectsDir = `${documentsPath}/Genome AI Studio Projects`;
                        this.currentProject.projectFilePath = `${projectsDir}/${this.currentProject.name}.prj.GAI`;
                        this.currentProject.location = projectsDir;
                        console.log(`📁 Auto-generated project file path: ${this.currentProject.projectFilePath}`);
                    }

                    await this.saveProjectToFile(this.currentProject);
                    
                    // 标记为已保存状态
                    this.markProjectAsSaved();
                    
                    this.showNotification(`✅ Project "${this.currentProject.name}" saved successfully`, 'success');
                    
                } catch (error) {
                    console.error('Error saving current project:', error);
                    
                    // 如果保存失败，尝试另存为
                    if (error.message.includes('path') || error.message.includes('directory')) {
                        console.log('🔄 Save failed, attempting Save As...');
                        this.showNotification('Save failed, please choose a location', 'warning');
                        return await this.saveProjectAs();
                    } else {
                        this.showNotification(`Failed to save project: ${error.message}`, 'error');
                    }
                }
            }

            async saveProjectAs() {
                if (!this.currentProject) {
                    this.showNotification('No project is currently open', 'warning');
                    return;
                }

                try {
                    if (window.electronAPI && window.electronAPI.saveProjectAs) {
                        const result = await window.electronAPI.saveProjectAs(this.currentProject.name);
                        
                        if (result.success && !result.canceled) {
                            // 检查目标位置是否已存在同名项目
                            const targetDir = result.selectedDirectory;
                            const projectName = this.currentProject.name;
                            
                            const checkResult = await window.electronAPI.checkProjectExists(targetDir, projectName);
                            
                            if (checkResult.exists) {
                                const userChoice = confirm(
                                    `Project "${projectName}" already exists in the selected location.\n\n` +
                                    `This will overwrite:\n` +
                                    `• ${projectName}.prj.GAI (project file)\n` +
                                    `• ${projectName}/ (data folder)\n\n` +
                                    `Do you want to continue?`
                                );
                                
                                if (!userChoice) {
                                    this.showNotification('Save operation cancelled', 'info');
                                    return;
                                }
                            }

                            // 检查当前项目是否有未保存的更改
                            if (this.currentProject.hasUnsavedChanges) {
                                const saveFirst = confirm(
                                    `The current project has unsaved changes.\n\n` +
                                    `Do you want to save the current project before copying?`
                                );
                                
                                if (saveFirst) {
                                    await this.saveCurrentProject();
                                }
                            }

                            // 复制项目到新位置
                            const copyResult = await window.electronAPI.copyProject(
                                this.currentProject.projectFilePath,
                                this.currentProject.dataFolderPath,
                                targetDir,
                                projectName
                            );

                            if (copyResult.success) {
                                this.showNotification(
                                    `✅ Project "${projectName}" saved to: ${targetDir}`, 
                                    'success'
                                );
                            } else {
                                throw new Error(copyResult.error || 'Failed to copy project');
                            }
                        }
                    } else {
                        // 浏览器环境，只能下载XML文件
                        const xmlContent = this.xmlHandler.projectToXML(this.currentProject);
                        this.downloadXMLFile(xmlContent, `${this.currentProject.name}.prj.GAI`);
                        this.showNotification('Project XML file downloaded', 'success');
                    }
                    
                } catch (error) {
                    console.error('Error saving project as:', error);
                    this.showNotification(`Failed to save project: ${error.message}`, 'error');
                }
            }

            // 从XML文件加载项目
            async loadProjectFromXML(xmlContent, fileName = null) {
                try {
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }

                    const project = this.xmlHandler.xmlToProject(xmlContent);
                    
                    // 更新文件信息
                    if (fileName) {
                        project.xmlFileName = fileName;
                    }
                    
                    // 添加到项目列表
                    this.projects.set(project.id, project);
                    await this.saveProjects();
                    
                    // 刷新界面
                    this.renderProjectTree();
                    this.selectProject(project.id);
                    
                    this.showNotification(`Project "${project.name}" loaded from XML`, 'success');
                    return project;
                } catch (error) {
                    console.error('Error loading project from XML:', error);
                    this.showNotification('Failed to load project from XML', 'error');
                    throw error;
                }
            }
        }

        // 全局项目管理器实例
        let projectManager = null;
        let projectManagerWindow = null;
        
        // 窗口关闭时清理资源
        window.addEventListener('beforeunload', async () => {
            if (projectManagerWindow) {
                console.log('🔓 Releasing all file locks before window close...');
                await projectManagerWindow.unlockAllProjectFiles();
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing Project Manager...');
            
            // 创建 ProjectManagerWindow UI 实例
            projectManagerWindow = new ProjectManagerWindow();
            
            // 创建 ProjectManager 核心逻辑实例并集成
            if (typeof ProjectManager !== 'undefined') {
                projectManager = new ProjectManager();
                // 将 ProjectManager 集成到 ProjectManagerWindow
                projectManagerWindow.projectManager = projectManager;
                
                // 共享数据和状态
                projectManagerWindow.projects = projectManager.projects;
                projectManagerWindow.currentProject = projectManager.currentProject;
                projectManagerWindow.currentPath = projectManager.currentPath;
                
                console.log('✅ ProjectManager core logic integrated');
                console.log('ProjectManager instance:', projectManager);
                console.log('ProjectManagerWindow instance:', projectManagerWindow);
            } else {
                console.warn('⚠️ ProjectManager not available, using fallback UI only');
            }

            // 设置IPC事件监听器
            if (window.electronAPI && window.electronAPI.onCreateNewProject) {
                window.electronAPI.onCreateNewProject(() => {
                    console.log('📝 Create new project requested from main menu');
                    if (projectManagerWindow) {
                        projectManagerWindow.createNewProject();
                    }
                });
            }

            // 监听从菜单加载项目的事件
            if (window.electronAPI && window.electronAPI.onLoadProjectFromMenu) {
                window.electronAPI.onLoadProjectFromMenu((filePath) => {
                    console.log('📁 Load project requested from main menu:', filePath);
                    if (projectManagerWindow) {
                        projectManagerWindow.loadProjectFromFile(filePath);
                    }
                });
            }
        });
    </script>
    
    <!-- 依赖脚本 -->
    <script src="renderer/modules/ProjectXMLHandler.js"></script>
    <script src="renderer/modules/ProjectManager.js"></script>
</body>
</html> 