<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Manager - GenomeExplorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            color: #2c3e50;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn-primary:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .tree-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin: 2px 0;
            transition: all 0.2s ease;
        }
        
        .tree-item:hover {
            background: #f0f2f5;
        }
        
        .tree-item.active {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .tree-item.project {
            font-weight: 600;
            border-left: 3px solid #007bff;
        }
        
        .tree-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .content-header {
            padding: 15px 25px;
            border-bottom: 1px solid #e1e8ed;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            width: 250px;
        }
        
        .content-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .file-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-color: #007bff;
        }
        
        .file-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            color: white;
        }
        
        .file-icon.fasta { background: #28a745; }
        .file-icon.gff { background: #17a2b8; }
        .file-icon.vcf { background: #ffc107; color: #000; }
        .file-icon.bam { background: #6f42c1; }
        .file-icon.folder { background: #6c757d; }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .file-info {
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .radio-option {
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            transition: all 0.2s ease;
            background: #fff;
        }

        .radio-option:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .radio-option input[type="radio"]:checked + strong {
            color: #007bff;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e1e8ed;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            height: 80px;
            resize: vertical;
        }
        
        .status-bar {
            padding: 8px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px 20px;
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üìÅ Project Manager</h1>
            <span style="opacity: 0.8; font-size: 13px;">Organize and manage your genomic data projects</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="projectManagerWindow.createNewProject()">
                üìÇ New Project
            </button>
            <button class="btn btn-primary" onclick="projectManagerWindow.openProject()">
                üìñ Open Project
            </button>
            <button class="btn btn-primary" onclick="projectManagerWindow.showSettings()">
                ‚öôÔ∏è Settings
            </button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Projects & Workspaces</h3>
                <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.refreshProjects()">
                    üîÑ
                </button>
            </div>
            <div class="sidebar-content">
                <div id="projectTree">
                    <!-- Project tree will be rendered here -->
                </div>
            </div>
        </div>

        <div class="content-area">
            <div class="content-header">
                <div class="content-title" id="contentTitle">Welcome to Project Manager</div>
                <div class="toolbar">
                    <input type="text" class="search-box" placeholder="Search files..." id="searchBox">
                    <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.addFiles()">
                        üìÑ Add Files
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="projectManagerWindow.createFolder()">
                        üìÅ New Folder
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="projectManagerWindow.saveCurrentProjectAsXML()" title="Save current project as XML (.prj.GAI)">
                        üíæ Save as XML
                    </button>
                </div>
            </div>
            
            <div class="content-body">
                <div id="projectOverview">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <h3>No Project Selected</h3>
                        <p>Create a new project or select an existing one to get started.</p>
                        <button class="btn btn-primary" onclick="projectManagerWindow.createNewProject()">
                            Create New Project
                        </button>
                        <button class="btn btn-warning" onclick="projectManagerWindow.createTestProject()" style="margin-top: 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
                            üß™ Create Test Project
                        </button>
                    </div>
                </div>
                
                <div id="projectContent" style="display: none;">
                    <div class="project-stats" id="projectStats"></div>
                    <div class="file-grid" id="fileGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span id="statusText">Ready</span>
        <span id="fileCount">0 items</span>
    </div>

    <!-- New Project Modal -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="modal-close" onclick="projectManagerWindow.closeModal('newProjectModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="projectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="projectDescription" placeholder="Enter project description (optional)"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="projectLocation" placeholder="Select project location" readonly>
                    <button class="btn btn-secondary btn-sm" onclick="projectManagerWindow.selectProjectLocation()" style="margin-top: 8px;">
                        üìÅ Browse...
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="projectManagerWindow.closeModal('newProjectModal')">Cancel</button>
                <button class="btn btn-success" onclick="projectManagerWindow.createProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Add Files Options Modal -->
    <div id="addFilesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Files to Project</h3>
                <button class="modal-close" onclick="projectManagerWindow.closeModal('addFilesModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">File Management Options</label>
                    <div style="margin: 15px 0;">
                        <label class="radio-option" style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="fileHandling" value="copy" checked style="margin-right: 8px;">
                            <strong>Copy files to project data folder</strong> (Recommended)
                            <div style="margin-left: 24px; font-size: 0.9em; color: #666; margin-top: 4px;">
                                Files will be copied to: <code>[Project]/data/[folder]/</code><br>
                                This ensures files are always available with the project.
                            </div>
                        </label>
                        <label class="radio-option" style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="fileHandling" value="reference" style="margin-right: 8px;">
                            <strong>Reference files at original location</strong>
                            <div style="margin-left: 24px; font-size: 0.9em; color: #666; margin-top: 4px;">
                                Files will remain at their current location.<br>
                                Project will reference the original file paths.
                            </div>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Selected Files</label>
                    <div id="selectedFilesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                        <!-- Selected files will be listed here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="projectManagerWindow.closeModal('addFilesModal')">Cancel</button>
                <button class="btn btn-success" onclick="projectManagerWindow.processFilesWithOptions()">Add Files</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ProjectManagerWindow - È°πÁõÆÁÆ°ÁêÜÂô®Á™óÂè£Ê†∏ÂøÉÁ±ª
         */
        class ProjectManagerWindow {
            constructor() {
                this.projects = new Map();
                this.currentProject = null;
                this.currentPath = [];
                this.selectedFiles = new Set();
                this.searchTerm = '';
                
                // Êñá‰ª∂Á±ªÂûãÈÖçÁΩÆ
                this.fileTypes = {
                    'fasta': { icon: 'FA', color: '#28a745', extensions: ['.fasta', '.fa', '.fas'] },
                    'gff': { icon: 'GFF', color: '#17a2b8', extensions: ['.gff', '.gff3', '.gtf'] },
                    'vcf': { icon: 'VCF', color: '#ffc107', extensions: ['.vcf'] },
                    'bam': { icon: 'BAM', color: '#6f42c1', extensions: ['.bam', '.sam'] },
                    'wig': { icon: 'WIG', color: '#fd7e14', extensions: ['.wig', '.bw', '.bigwig'] },
                    'bed': { icon: 'BED', color: '#dc3545', extensions: ['.bed'] },
                    'genbank': { icon: 'GB', color: '#20c997', extensions: ['.gb', '.gbk', '.gbff'] }
                };
                
                this.initialize();
            }

            async initialize() {
                console.log('Initializing Project Manager Window...');
                await this.loadProjects();
                this.setupEventListeners();
                this.renderProjectTree();
                this.updateStatusBar('Ready');
                console.log('Project Manager Window initialized successfully');
            }

            setupEventListeners() {
                const searchBox = document.getElementById('searchBox');
                if (searchBox) {
                    searchBox.addEventListener('input', (e) => {
                        this.searchTerm = e.target.value.toLowerCase();
                        this.renderProjectContent();
                    });
                }

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'n':
                                e.preventDefault();
                                this.createNewProject();
                                break;
                            case 'o':
                                e.preventDefault();
                                this.openProject();
                                break;
                        }
                    }
                });

                window.addEventListener('click', (e) => {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });
            }

            createNewProject() {
                const modal = document.getElementById('newProjectModal');
                if (modal) {
                    document.getElementById('projectName').value = '';
                    document.getElementById('projectDescription').value = '';
                    document.getElementById('projectLocation').value = '';
                    modal.style.display = 'block';
                }
            }

            async selectProjectLocation() {
                try {
                    if (window.electronAPI && window.electronAPI.selectProjectDirectory) {
                        const result = await window.electronAPI.selectProjectDirectory();
                        if (result.success && !result.canceled) {
                            document.getElementById('projectLocation').value = result.filePath;
                        }
                    } else {
                        this.showNotification('Directory selection requires Electron API', 'warning');
                    }
                } catch (error) {
                    console.error('Error selecting project location:', error);
                    this.showNotification('Failed to select project location', 'error');
                }
            }

            async createProject() {
                const name = document.getElementById('projectName').value.trim();
                const description = document.getElementById('projectDescription').value.trim();
                const location = document.getElementById('projectLocation').value.trim();

                if (!name) {
                    this.showNotification('Project name is required', 'warning');
                    return;
                }

                try {
                    const projectId = this.generateId();
                    const project = {
                        id: projectId,
                        name: name,
                        description: description,
                        location: location || 'Default',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString(),
                        files: [],
                        folders: [
                            { name: 'Genomes', icon: 'üß¨', path: ['genomes'], files: [] },
                            { name: 'Annotations', icon: 'üìã', path: ['annotations'], files: [] },
                            { name: 'Variants', icon: 'üîÑ', path: ['variants'], files: [] },
                            { name: 'Reads', icon: 'üìä', path: ['reads'], files: [] },
                            { name: 'Analysis', icon: 'üìà', path: ['analysis'], files: [] }
                        ],
                        metadata: {
                            totalFiles: 0,
                            totalSize: 0,
                            lastOpened: new Date().toISOString()
                        }
                    };

                    this.projects.set(projectId, project);
                    await this.saveProjects();
                    
                    // ÂàõÂª∫È°πÁõÆXMLÊñá‰ª∂
                    await this.createProjectXMLFile(project);
                    
                    this.renderProjectTree();
                    this.selectProject(projectId);
                    this.closeModal('newProjectModal');
                    
                    this.showNotification(`Project "${name}" created successfully with XML file`, 'success');
                    
                } catch (error) {
                    console.error('Error creating project:', error);
                    this.showNotification('Failed to create project', 'error');
                }
            }

            async openProject() {
                console.log('üìÇ Opening project file...');
                
                try {
                    // ‰ΩøÁî®Electron APIÈÄâÊã©È°πÁõÆÊñá‰ª∂
                    if (window.electronAPI && window.electronAPI.selectProjectFile) {
                        const result = await window.electronAPI.selectProjectFile();
                        
                        if (result.success && !result.canceled && result.filePath) {
                            await this.loadProjectFromFile(result.filePath);
                        }
                    } else {
                        // ÊµèËßàÂô®ÁéØÂ¢É‰∏ãÁöÑÊñá‰ª∂ÈÄâÊã©
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.prj.GAI,.xml,.json,.genomeproj';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = async (event) => {
                                    try {
                                        await this.loadProjectFromFileContent(event.target.result, file.name);
                                    } catch (error) {
                                        console.error('Error loading project from file:', error);
                                        this.showNotification('Failed to load project file', 'error');
                                    }
                                };
                                reader.readAsText(file);
                            }
                        };
                        input.click();
                    }
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showNotification('Failed to open project file', 'error');
                }
            }

            async loadProjectFromFile(filePath) {
                console.log('üìÅ Loading project from file:', filePath);
                
                try {
                    // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
                    if (window.electronAPI && window.electronAPI.loadProjectFile) {
                        const result = await window.electronAPI.loadProjectFile(filePath);
                        
                        if (result.success) {
                            await this.loadProjectFromFileContent(result.content, result.fileName);
                        } else {
                            throw new Error(result.error || 'Failed to read project file');
                        }
                    } else {
                        throw new Error('File reading API not available');
                    }
                } catch (error) {
                    console.error('Error loading project from file:', error);
                    this.showNotification(`Failed to load project: ${error.message}`, 'error');
                }
            }

            async loadProjectFromFileContent(content, fileName) {
                console.log('üìÑ Processing project file content:', fileName);
                
                try {
                    let project = null;
                    const fileExtension = fileName.toLowerCase().split('.').pop();
                    
                    if (fileName.toLowerCase().endsWith('.prj.gai') || fileExtension === 'xml') {
                        // Â§ÑÁêÜXMLÊ†ºÂºèÈ°πÁõÆÊñá‰ª∂
                        if (!this.xmlHandler) {
                            this.xmlHandler = new ProjectXMLHandler();
                        }
                        
                        // È™åËØÅXMLÊ†ºÂºè
                        if (!this.xmlHandler.validateProjectXML(content)) {
                            throw new Error('Invalid project XML format');
                        }
                        
                        project = this.xmlHandler.xmlToProject(content);
                        console.log('‚úÖ Loaded XML project:', project.name);
                        
                    } else if (fileExtension === 'json' || fileExtension === 'genomeproj') {
                        // Â§ÑÁêÜJSONÊ†ºÂºèÈ°πÁõÆÊñá‰ª∂
                        project = JSON.parse(content);
                        console.log('‚úÖ Loaded JSON project:', project.name);
                        
                    } else {
                        throw new Error(`Unsupported file format: ${fileName}`);
                    }
                    
                    // È™åËØÅÈ°πÁõÆÊï∞ÊçÆÁªìÊûÑ
                    if (!project || !project.id || !project.name) {
                        throw new Error('Invalid project data structure');
                    }
                    
                    // ËÆæÁΩÆÂä†ËΩΩÁöÑÈ°πÁõÆ‰ø°ÊÅØ
                    project.xmlFileName = fileName;
                    project.loadedFromFile = true;
                    project.lastOpened = new Date().toISOString();
                    
                    // Ê∑ªÂä†Âà∞È°πÁõÆÂàóË°®
                    this.projects.set(project.id, project);
                    await this.saveProjects();
                    
                    // Âà∑Êñ∞ÁïåÈù¢Âπ∂ÈÄâÊã©È°πÁõÆ
                    this.renderProjectTree();
                    this.selectProject(project.id);
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    const fileType = fileName.toLowerCase().endsWith('.prj.gai') ? 'XML (.prj.GAI)' : fileExtension.toUpperCase();
                    this.showNotification(`‚úÖ Project "${project.name}" loaded from ${fileType} file`, 'success');
                    
                    console.log('üìä Project loaded successfully:', {
                        id: project.id,
                        name: project.name,
                        files: project.files?.length || 0,
                        folders: project.folders?.length || 0
                    });
                    
                } catch (error) {
                    console.error('Error processing project file content:', error);
                    this.showNotification(`Failed to load project: ${error.message}`, 'error');
                    throw error;
                }
            }

            selectProject(projectId) {
                this.currentProject = this.projects.get(projectId);
                this.currentPath = [];
                
                if (this.currentProject) {
                    this.currentProject.metadata.lastOpened = new Date().toISOString();
                    
                    this.renderProjectContent();
                    this.updateActiveTreeItem(projectId);
                    this.updateContentTitle();
                    
                    document.getElementById('projectOverview').style.display = 'none';
                    document.getElementById('projectContent').style.display = 'block';
                    
                    this.updateStatusBar(`Opened: ${this.currentProject.name}`);
                    this.saveProjects();
                }
            }

            renderProjectTree() {
                const projectTree = document.getElementById('projectTree');
                if (!projectTree) return;

                let html = '';
                
                if (this.projects.size === 0) {
                    html = `
                        <div style="padding: 20px; text-align: center; color: #6c757d;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìÇ</div>
                            <div style="margin-bottom: 10px;">No projects found</div>
                            <button class="btn btn-primary" onclick="projectManager.createNewProject()" style="font-size: 12px; padding: 6px 12px;">
                                Create Project
                            </button>
                        </div>
                    `;
                } else {
                    this.projects.forEach((project, projectId) => {
                        const isActive = this.currentProject && this.currentProject.id === projectId;
                        html += `
                            <div class="tree-item project ${isActive ? 'active' : ''}" 
                                 onclick="projectManagerWindow.selectProject('${projectId}')"
                                 data-project-id="${projectId}">
                                <div class="tree-icon">üìÇ</div>
                                <span title="${project.description || project.name}">${project.name}</span>
                            </div>
                        `;
                        
                        if (isActive && project.folders) {
                            project.folders.forEach(folder => {
                                const isCurrentPath = this.arraysEqual(this.currentPath, folder.path);
                                html += `
                                    <div class="tree-item folder ${isCurrentPath ? 'active' : ''}" 
                                         onclick="projectManagerWindow.navigateToFolder(${JSON.stringify(folder.path).replace(/"/g, '&quot;')})"
                                         style="margin-left: 20px;">
                                        <div class="tree-icon">${folder.icon}</div>
                                        <span>${folder.name}</span>
                                    </div>
                                `;
                            });
                        }
                    });
                }
                
                projectTree.innerHTML = html;
            }

            navigateToFolder(path) {
                this.currentPath = path;
                this.renderProjectContent();
                this.updateContentTitle();
            }

            renderProjectContent() {
                if (!this.currentProject) return;

                this.renderProjectStats();
                this.renderFileGrid();
            }

            renderProjectStats() {
                const statsElement = document.getElementById('projectStats');
                if (!statsElement || !this.currentProject) return;

                const currentFiles = this.getCurrentFolderFiles();
                const totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);

                statsElement.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${currentFiles.length}</div>
                        <div class="stat-label">Files in Folder</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.currentProject.files.length}</div>
                        <div class="stat-label">Total Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.formatFileSize(totalSize)}</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${this.currentProject.folders.length}</div>
                        <div class="stat-label">Folders</div>
                    </div>
                `;
            }

            renderFileGrid() {
                const fileGrid = document.getElementById('fileGrid');
                if (!fileGrid) return;

                const currentFiles = this.getCurrentFolderFiles();
                const filteredFiles = this.filterFiles(currentFiles);

                if (filteredFiles.length === 0) {
                    fileGrid.innerHTML = `
                        <div style="grid-column: 1 / -1;">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìÑ</div>
                                <h3>No files found</h3>
                                <p>Add some files to this folder to get started.</p>
                                                        <button class="btn btn-primary" onclick="projectManagerWindow.addFiles()">
                            Add Files
                        </button>
                            </div>
                        </div>
                    `;
                    return;
                }

                let html = '';
                filteredFiles.forEach(file => {
                    const fileType = this.detectFileType(file.name);
                    const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };

                    html += `
                        <div class="file-card" 
                             onclick="projectManagerWindow.selectFile('${file.id}')"
                             ondblclick="projectManagerWindow.openFileInMainWindow('${file.id}')"
                             data-file-id="${file.id}">
                            <div class="file-icon ${fileType}" 
                                 style="background-color: ${typeConfig.color}">
                                ${typeConfig.icon}
                            </div>
                            <div class="file-name" title="${file.name}">${file.name}</div>
                            <div class="file-info">
                                ${this.formatFileSize(file.size || 0)}
                                ${file.modified ? `‚Ä¢ ${this.formatDate(file.modified)}` : ''}
                            </div>
                        </div>
                    `;
                });

                fileGrid.innerHTML = html;
                this.updateFileCountDisplay(filteredFiles.length);
            }

            async addFiles() {
                console.log('üìÅ Add Files button clicked');
                
                if (!this.currentProject) {
                    this.showNotification('Please select a project first', 'warning');
                    return;
                }

                // ÂàùÂßãÂåñ‰∏¥Êó∂Êñá‰ª∂Â≠òÂÇ®
                this.tempSelectedFiles = null;
                this.tempFileSource = null;

                // ‰ºòÂÖà‰ΩøÁî®ProjectManagerÁöÑaddFilesÊñπÊ≥ï
                if (this.projectManager) {
                    console.log('‚úÖ Using ProjectManager core logic for adding files');
                    return await this.projectManager.addFiles();
                }

                // Â¶ÇÊûúÂú®ElectronÁéØÂ¢É‰∏≠Ôºå‰ΩøÁî®Êñá‰ª∂ÈÄâÊã©API
                if (window.electronAPI && window.electronAPI.selectMultipleFiles) {
                    console.log('üîß Using Electron API for file selection');
                    try {
                        const result = await window.electronAPI.selectMultipleFiles();
                        if (result.success && !result.canceled && result.filePaths) {
                            // Â≠òÂÇ®ÈÄâÊã©ÁöÑÊñá‰ª∂Ë∑ØÂæÑÂπ∂ÊòæÁ§∫ÈÄâÈ°πÂØπËØùÊ°Ü
                            this.tempSelectedFiles = result.filePaths;
                            this.tempFileSource = 'electron';
                            this.showAddFilesModal();
                        }
                    } catch (error) {
                        console.error('Error selecting files:', error);
                        this.showNotification('Failed to select files: ' + error.message, 'error');
                    }
                } else {
                    // ÊµèËßàÂô®ÁéØÂ¢É‰∏ãÁöÑÊñá‰ª∂ÈÄâÊã©
                    console.log('üåê Using browser file selection');
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.multiple = true;
                    input.accept = '.fasta,.fa,.gff,.gtf,.vcf,.bam,.sam,.wig,.bed,.gb,.gbk';
                    input.onchange = (e) => {
                        const files = Array.from(e.target.files);
                        // Â≠òÂÇ®ÈÄâÊã©ÁöÑÊñá‰ª∂ÂØπË±°Âπ∂ÊòæÁ§∫ÈÄâÈ°πÂØπËØùÊ°Ü
                        this.tempSelectedFiles = files;
                        this.tempFileSource = 'browser';
                        this.showAddFilesModal();
                    };
                    input.click();
                }
            }

            showAddFilesModal() {
                // ÊòæÁ§∫ÈÄâÊã©ÁöÑÊñá‰ª∂ÂàóË°®
                this.populateSelectedFilesList();
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                const modal = document.getElementById('addFilesModal');
                if (modal) {
                    modal.style.display = 'block';
                }
            }

            populateSelectedFilesList() {
                const listContainer = document.getElementById('selectedFilesList');
                if (!listContainer || !this.tempSelectedFiles) return;

                let html = '';
                const files = this.tempSelectedFiles;
                
                if (this.tempFileSource === 'electron') {
                    // Â§ÑÁêÜÊñá‰ª∂Ë∑ØÂæÑ
                    files.forEach((filePath, index) => {
                        const fileName = filePath.split(/[/\\]/).pop();
                        const fileType = this.detectFileType(fileName);
                        const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };
                        
                        html += `
                            <div style="display: flex; align-items: center; margin: 5px 0; padding: 8px; border: 1px solid #e1e8ed; border-radius: 4px; background: white;">
                                <div style="width: 20px; height: 20px; background: ${typeConfig.color}; color: white; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 10px;">
                                    ${typeConfig.icon}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${fileName}</div>
                                    <div style="font-size: 0.8em; color: #666;">${filePath}</div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    // Â§ÑÁêÜÊñá‰ª∂ÂØπË±°ÔºàÊµèËßàÂô®Ôºâ
                    files.forEach((file, index) => {
                        const fileType = this.detectFileType(file.name);
                        const typeConfig = this.fileTypes[fileType] || { icon: 'FILE', color: '#6c757d' };
                        
                        html += `
                            <div style="display: flex; align-items: center; margin: 5px 0; padding: 8px; border: 1px solid #e1e8ed; border-radius: 4px; background: white;">
                                <div style="width: 20px; height: 20px; background: ${typeConfig.color}; color: white; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-right: 10px;">
                                    ${typeConfig.icon}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">${file.name}</div>
                                    <div style="font-size: 0.8em; color: #666;">${this.formatFileSize(file.size)} ‚Ä¢ ${new Date(file.lastModified).toLocaleDateString()}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (html === '') {
                    html = '<div style="text-align: center; color: #666; padding: 20px;">No files selected</div>';
                }

                listContainer.innerHTML = html;
            }

            async processFilesWithOptions() {
                if (!this.tempSelectedFiles) {
                    this.showNotification('No files selected', 'warning');
                    return;
                }

                // Ëé∑ÂèñÈÄâÊã©ÁöÑÂ§ÑÁêÜÈÄâÈ°π
                const fileHandling = document.querySelector('input[name="fileHandling"]:checked').value;
                const copyFiles = fileHandling === 'copy';

                console.log(`üìÅ Processing files with option: ${copyFiles ? 'Copy to project' : 'Reference original location'}`);

                try {
                    if (this.tempFileSource === 'electron') {
                        await this.processSelectedFiles(this.tempSelectedFiles, copyFiles);
                    } else {
                        await this.processFileObjects(this.tempSelectedFiles, copyFiles);
                    }

                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    this.closeModal('addFilesModal');
                    
                    // Ê∏ÖÁêÜ‰∏¥Êó∂Êï∞ÊçÆ
                    this.tempSelectedFiles = null;
                    this.tempFileSource = null;

                } catch (error) {
                    console.error('Error processing files:', error);
                    this.showNotification('Failed to process files: ' + error.message, 'error');
                }
            }

            // Â§ÑÁêÜÊñá‰ª∂Ë∑ØÂæÑÔºàElectronÁéØÂ¢ÉÔºâ
            async processSelectedFiles(filePaths, copyFiles = true) {
                console.log('üìÇ Processing selected files:', filePaths);
                console.log('üìã Copy files to project:', copyFiles);
                let addedCount = 0;
                
                for (const filePath of filePaths) {
                    try {
                        // Ëé∑ÂèñÊñá‰ª∂ÂêçÂíåÁªüËÆ°‰ø°ÊÅØ
                        const fileName = filePath.split(/[/\\]/).pop();
                        let fileSize = 0;
                        let lastModified = new Date().toISOString();
                        let finalPath = filePath;

                        // Â∞ùËØïËé∑ÂèñÊñá‰ª∂‰ø°ÊÅØ
                        if (window.electronAPI && window.electronAPI.getFileInfo) {
                            try {
                                const fileInfo = await window.electronAPI.getFileInfo(filePath);
                                if (fileInfo.success) {
                                    fileSize = fileInfo.info.size;
                                    lastModified = fileInfo.info.mtime;
                                }
                            } catch (error) {
                                console.warn('Could not get file info for:', fileName);
                            }
                        }

                        // Â¶ÇÊûúÈÄâÊã©Â§çÂà∂Êñá‰ª∂ÔºåÂàôÂ§çÂà∂Âà∞È°πÁõÆÊï∞ÊçÆÊñá‰ª∂Â§π
                        if (copyFiles && window.electronAPI && window.electronAPI.copyFileToProject) {
                            try {
                                const copyResult = await window.electronAPI.copyFileToProject(
                                    filePath, 
                                    this.currentProject.name, 
                                    this.currentPath.length > 0 ? this.currentPath.join('/') : 'files'
                                );
                                
                                if (copyResult.success) {
                                    finalPath = copyResult.newPath;
                                    console.log(`‚úÖ File copied to: ${finalPath}`);
                                } else {
                                    console.warn(`Failed to copy file ${fileName}, using original path`);
                                }
                            } catch (error) {
                                console.warn(`Error copying file ${fileName}:`, error);
                            }
                        }

                        const fileObj = {
                            id: this.generateId(),
                            name: fileName,
                            path: finalPath,
                            originalPath: copyFiles ? filePath : null, // ‰øùÂ≠òÂéüÂßãË∑ØÂæÑÁî®‰∫éÂºïÁî®
                            size: fileSize,
                            type: this.detectFileType(fileName),
                            folder: [...this.currentPath],
                            added: new Date().toISOString(),
                            modified: lastModified,
                            copied: copyFiles, // Ê†áËÆ∞Êñá‰ª∂ÊòØÂê¶Ë¢´Â§çÂà∂
                            projectRelativePath: copyFiles ? this.getProjectRelativePath(finalPath) : null
                        };
                        
                        this.currentProject.files.push(fileObj);
                        addedCount++;
                        console.log(`‚úÖ Added file: ${fileName} (${copyFiles ? 'copied' : 'referenced'})`);
                    } catch (error) {
                        console.error('Error processing file:', filePath, error);
                    }
                }
                
                if (addedCount > 0) {
                    this.currentProject.modified = new Date().toISOString();
                    this.currentProject.metadata.totalFiles = this.currentProject.files.length;
                    this.currentProject.metadata.totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);
                    
                    await this.saveProjects();
                    this.renderProjectContent();
                    
                    const action = copyFiles ? 'copied to' : 'referenced in';
                    this.showNotification(`‚úÖ Added ${addedCount} file(s) ${action} project`, 'success');
                    console.log(`üìä Project updated: ${this.currentProject.metadata.totalFiles} total files`);
                } else {
                    this.showNotification('No files were added', 'warning');
                }
            }

            // Â§ÑÁêÜÊñá‰ª∂ÂØπË±°ÔºàÊµèËßàÂô®ÁéØÂ¢ÉÔºâ
            async processFileObjects(files, copyFiles = true) {
                console.log('üåê Processing file objects from browser:', files.length);
                console.log('üìã Copy files to project:', copyFiles);
                let addedCount = 0;
                
                for (const file of files) {
                    // Âú®ÊµèËßàÂô®ÁéØÂ¢É‰∏≠ÔºåÊñá‰ª∂ÊÄªÊòØ"ÂºïÁî®"ÁöÑÔºå‰∏çËÉΩÁúüÊ≠£Â§çÂà∂Âà∞È°πÁõÆÊñá‰ª∂Â§π
                    const fileObj = {
                        id: this.generateId(),
                        name: file.name,
                        path: file.name, // ÊµèËßàÂô®ÁéØÂ¢É‰∏ãÂè™ËÉΩËé∑ÂèñÊñá‰ª∂Âêç
                        size: file.size,
                        type: this.detectFileType(file.name),
                        folder: [...this.currentPath],
                        added: new Date().toISOString(),
                        modified: new Date(file.lastModified).toISOString(),
                        copied: false, // ÊµèËßàÂô®ÁéØÂ¢É‰∏ãÊÄªÊòØfalse
                        browserFile: true // Ê†áËÆ∞‰∏∫ÊµèËßàÂô®Êñá‰ª∂
                    };
                    
                    this.currentProject.files.push(fileObj);
                    addedCount++;
                }
                
                if (addedCount > 0) {
                    this.currentProject.modified = new Date().toISOString();
                    this.currentProject.metadata.totalFiles = this.currentProject.files.length;
                    this.currentProject.metadata.totalSize = this.currentProject.files.reduce((sum, file) => sum + (file.size || 0), 0);
                    
                    await this.saveProjects();
                    this.renderProjectContent();
                    this.showNotification(`‚úÖ Added ${addedCount} file(s) to project (browser mode)`, 'success');
                }
            }

            // Ëé∑ÂèñÈ°πÁõÆÁõ∏ÂØπË∑ØÂæÑ
            getProjectRelativePath(absolutePath) {
                if (!absolutePath) return null;
                
                // Â∞ùËØïÊèêÂèñÈ°πÁõÆÁõ∏ÂØπË∑ØÂæÑ
                const projectName = this.currentProject.name;
                
                // Â§ÑÁêÜ‰∏çÂêåÂπ≥Âè∞ÁöÑË∑ØÂæÑÂàÜÈöîÁ¨¶
                const normalizedPath = absolutePath.replace(/\\/g, '/');
                const dataPattern = `GenomeExplorer Projects/${projectName}/data/`;
                const dataIndex = normalizedPath.indexOf(dataPattern);
                
                if (dataIndex !== -1) {
                    return normalizedPath.substring(dataIndex + dataPattern.length);
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Ê†áÂáÜË∑ØÂæÑÔºåÂ∞ùËØïÂÖ∂‰ªñÊ®°Âºè
                const altPattern = `/${projectName}/data/`;
                const altIndex = normalizedPath.indexOf(altPattern);
                if (altIndex !== -1) {
                    return normalizedPath.substring(altIndex + altPattern.length);
                }
                
                return absolutePath;
            }

            createFolder() {
                if (!this.currentProject) {
                    this.showNotification('Please select a project first', 'warning');
                    return;
                }

                const folderName = prompt('Enter folder name:');
                if (!folderName || !folderName.trim()) return;

                const newPath = [...this.currentPath, folderName.trim().toLowerCase()];
                const folder = {
                    name: folderName.trim(),
                    icon: 'üìÅ',
                    path: newPath,
                    files: []
                };

                this.currentProject.folders.push(folder);
                this.currentProject.modified = new Date().toISOString();
                
                this.saveProjects();
                this.renderProjectTree();
                this.showNotification(`Folder "${folderName}" created`, 'success');
            }

            selectFile(fileId) {
                this.selectedFiles.clear();
                this.selectedFiles.add(fileId);
                this.updateFileCardSelection();
                this.updateStatusBar();
            }

            async openFileInMainWindow(fileId) {
                console.log('üéØ Opening file in main window - fileId:', fileId);
                console.log('üîß ProjectManager available:', !!this.projectManager);
                
                const file = this.findFileById(fileId);
                console.log('üìÅ Found file:', file);
                if (!file) {
                    console.error('‚ùå File not found with ID:', fileId);
                    this.showNotification('File not found', 'error');
                    return;
                }

                try {
                    // Ê£ÄÊü•Êñá‰ª∂Ë∑ØÂæÑÊòØÂê¶‰∏∫ÊµãËØï/ËôöÊãüË∑ØÂæÑ
                    if (file.path && file.path.startsWith('/test/')) {
                        console.log('‚ö†Ô∏è Test file detected, creating demo content');
                        await this.openTestFile(file);
                        return;
                    }

                    // ÂßîÊâòÁªô ProjectManager ÁöÑÂÆûÁé∞
                    if (this.projectManager) {
                        console.log('‚úÖ Using ProjectManager core logic for file opening');
                        return await this.projectManager.openFileInMainWindow(fileId);
                    }

                    // Â∞ùËØïÁõ¥Êé•‰ΩøÁî® IPC ÊâìÂºÄÊñá‰ª∂
                    if (window.electronAPI) {
                        console.log('üì§ Attempting to open file directly via IPC');
                        
                        // Ê£ÄÊü•‰∏ªÁ™óÂè£Áä∂ÊÄÅ
                        const mainWindowStatus = await window.electronAPI.checkMainWindowStatus();
                        
                        if (mainWindowStatus.hasOpenFile) {
                            // ‰∏ªÁ™óÂè£Â∑≤ÊúâÊñá‰ª∂ÔºåÂàõÂª∫Êñ∞Á™óÂè£
                            const result = await window.electronAPI.createNewMainWindow(file.path);
                            if (result.success) {
                                this.showNotification(`‚úÖ Opened "${file.name}" in new window`, 'success');
                            } else {
                                throw new Error(result.error);
                            }
                        } else {
                            // ‰∏ªÁ™óÂè£Ê≤°ÊúâÊñá‰ª∂ÔºåÂú®ÂΩìÂâç‰∏ªÁ™óÂè£ÊâìÂºÄ
                            const result = await window.electronAPI.openFileInMainWindow(file.path);
                            if (result.success) {
                                this.showNotification(`‚úÖ Opened "${file.name}" in GenomeExplorer`, 'success');
                            } else {
                                throw new Error(result.error);
                            }
                        }
                    } else {
                        // Â¶ÇÊûúÊ≤°Êúâ Electron APIÔºåÊòæÁ§∫ÈÄöÁü•
                        console.log('‚ö†Ô∏è No Electron API available');
                        this.showNotification(`Cannot open "${file.name}" - Electron API not available`, 'warning');
                    }
                } catch (error) {
                    console.error('Error opening file:', error);
                    this.showNotification(`Failed to open "${file.name}": ${error.message}`, 'error');
                }
            }

            // ÊâìÂºÄÈ°πÁõÆÊñá‰ª∂
            async openProject() {
                try {
                    if (window.electronAPI && window.electronAPI.selectProjectFile) {
                        const result = await window.electronAPI.selectProjectFile();
                        if (result.success && !result.canceled && result.filePath) {
                            await this.loadProjectFromFile(result.filePath);
                        }
                    } else {
                        // ÊµèËßàÂô®ÁéØÂ¢É‰∏ã‰ΩøÁî®Êñá‰ª∂ËæìÂÖ•
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.xml,.json,.genproj';
                        input.onchange = async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const text = await file.text();
                                await this.loadProjectFromText(text, file.name);
                            }
                        };
                        input.click();
                    }
                } catch (error) {
                    console.error('Error opening project:', error);
                    this.showNotification('Failed to open project: ' + error.message, 'error');
                }
            }

            // ‰ªéÊñá‰ª∂Âä†ËΩΩÈ°πÁõÆ
            async loadProjectFromFile(filePath) {
                try {
                    if (window.electronAPI && window.electronAPI.readFile) {
                        const result = await window.electronAPI.readFile(filePath);
                        if (result.success) {
                            await this.loadProjectFromText(result.content, filePath);
                        } else {
                            throw new Error(result.error || 'Failed to read file');
                        }
                    } else {
                        throw new Error('File system access not available');
                    }
                } catch (error) {
                    console.error('Error loading project from file:', error);
                    this.showNotification('Failed to load project: ' + error.message, 'error');
                }
            }

            // ‰ªéÊñáÊú¨ÂÜÖÂÆπÂä†ËΩΩÈ°πÁõÆ
            async loadProjectFromText(content, fileName) {
                try {
                    let project;
                    
                    // Ê£ÄÊµãÊñá‰ª∂Ê†ºÂºè
                    if (content.trim().startsWith('<')) {
                        // XMLÊ†ºÂºè
                        if (this.projectManager && this.projectManager.xmlHandler) {
                            project = this.projectManager.xmlHandler.parseXML(content);
                        } else {
                            throw new Error('XML parser not available');
                        }
                    } else {
                        // JSONÊ†ºÂºè
                        project = JSON.parse(content);
                    }

                    if (project && project.id) {
                        this.projects.set(project.id, project);
                        await this.saveProjects();
                        this.renderProjectTree();
                        this.selectProject(project.id);
                        this.showNotification(`‚úÖ Project "${project.name}" loaded successfully`, 'success');
                    } else {
                        throw new Error('Invalid project format');
                    }
                } catch (error) {
                    console.error('Error parsing project:', error);
                    this.showNotification('Failed to parse project file: ' + error.message, 'error');
                }
            }

            refreshProjects() {
                this.loadProjects();
                this.renderProjectTree();
                this.showNotification('Projects refreshed', 'success');
            }

            showSettings() {
                this.showNotification('Settings feature coming soon', 'info');
            }

            // ÂàõÂª∫ÊµãËØïÈ°πÁõÆÔºåÁî®‰∫éÊµãËØïÊñá‰ª∂ÊâìÂºÄÂäüËÉΩ
            createTestProject() {
                console.log('üìã Creating test project...');
                
                const testProject = {
                    id: 'test_project_' + Date.now(),
                    name: 'Test Genomics Project',
                    description: 'A test project with sample files for testing Project Manager functionality',
                    location: '/test/project/location',
                    created: new Date().toISOString(),
                    modified: new Date().toISOString(),
                    files: [
                        {
                            id: 'test_file_1',
                            name: 'sample_genome.fasta',
                            path: '/test/project/location/genomes/sample_genome.fasta',
                            type: 'fasta',
                            size: 1234567,
                            added: new Date().toISOString(),
                            modified: new Date().toISOString(),
                            folder: ['genomes'],
                            metadata: {
                                organism: 'Escherichia coli',
                                description: 'Sample genome file for testing'
                            },
                            tags: ['test', 'sample']
                        },
                        {
                            id: 'test_file_2', 
                            name: 'sample_annotations.gff',
                            path: '/test/project/location/annotations/sample_annotations.gff',
                            type: 'gff',
                            size: 987654,
                            added: new Date().toISOString(),
                            folder: ['annotations'],
                            metadata: {
                                version: 'GFF3',
                                description: 'Sample annotation file for testing'
                            }
                        }
                    ],
                    folders: [
                        { name: 'Genomes', icon: 'üß¨', path: ['genomes'] },
                        { name: 'Annotations', icon: 'üìã', path: ['annotations'] },
                        { name: 'Variants', icon: 'üîÑ', path: ['variants'] },
                        { name: 'Reads', icon: 'üìä', path: ['reads'] },
                        { name: 'Analysis', icon: 'üìà', path: ['analysis'] }
                    ],
                    settings: {
                        fileFilters: [],
                        customAnnotations: []
                    },
                    metadata: {
                        totalFiles: 2,
                        totalSize: 2222221,
                        lastOpened: new Date().toISOString(),
                        fileTypeStats: { fasta: 1, gff: 1 }
                    },
                    history: [{
                        timestamp: new Date().toISOString(),
                        action: 'created',
                        description: 'Test project created for functionality testing'
                    }]
                };

                // Ê∑ªÂä†Âà∞È°πÁõÆÂàóË°®
                this.projects.set(testProject.id, testProject);
                
                // Â¶ÇÊûúÊúâ ProjectManagerÔºå‰πüÊ∑ªÂä†Âà∞ÈÇ£Èáå
                if (this.projectManager) {
                    this.projectManager.projects.set(testProject.id, testProject);
                }

                // Êõ¥Êñ∞UI
                this.renderProjectTree();
                this.selectProject(testProject.id);
                
                this.showNotification('‚úÖ Test project created with sample files! Try double-clicking a file.', 'success');
                console.log('‚úÖ Test project created:', testProject);
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }

            // ÊâìÂºÄÊµãËØïÊñá‰ª∂ÔºàÂàõÂª∫ÊºîÁ§∫ÂÜÖÂÆπÔºâ
            async openTestFile(file) {
                console.log('üß™ Opening test file with demo content:', file.name);
                
                try {
                    // Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÂàõÂª∫‰∏çÂêåÁöÑÊºîÁ§∫ÂÜÖÂÆπ
                    let demoContent = '';
                    let demoFilePath = '';
                    
                    if (file.type === 'fasta') {
                        // ÂàõÂª∫ÊºîÁ§∫ FASTA ÂÜÖÂÆπ
                        demoContent = `>Demo_Genome_Chr1 Escherichia coli demonstration sequence
ATGGCAGAACGACGCGTAATCGTCGTATCGAAGGTCGTAATGCCGCTGCGCTGGCTGCGG
CTGAAGTTCAACATCGTCTGCGTATTCTGGAAAGCGAACTGGAAGATCTGCTGGCGAAAG
CGAAAGAAGCGGGTAAAAAAGCGGGCGAAACCATTGATGTTGCAGTGATGTGGGTTAACC
CGCAGCAGATGGTGATTGGTGAAGGCAAAGTGATTCGCGTTTTTGATGCGCTGCGCATTC
TGGATGAAACCGGCGTAAAAGGGATTCTGACCGCGTTTGTTGAAGCGCGTAACGTACTGC
CGGAAGAAACCATTATGGGTAACGCAGGTCGTCTGGCAAAACTGGGCGACAAAATCAAAG
GCGCAGGTGAAGTGATGGACGAAGTGATGGAGTTTGTTCAGAAAGCGGTGCGCGAAGACG
GTATCGATGTTGTGCGTACCCATGCGGCACATCGTCTGCCGATGACCGGTGAACAGCTGC
CGCTGGATGAAACCGAAGTGTTTACCGATATTGATCTGGTTTTTGCCGACTTCCGTGAAG
ATCTGCACGATCTGATTTGCCAGAAATTTAACGAGCCGGATGCAAACGCGATTGCCTATA
>Demo_Genome_Chr2 Synthetic sequence for testing
CGTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTA
GCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTA
GCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTAGCATGCATGCTAGCTAGCTAGCTA`;
                        demoFilePath = 'demo_genome.fasta';
                    } else if (file.type === 'gff') {
                        // ÂàõÂª∫ÊºîÁ§∫ GFF ÂÜÖÂÆπ
                        demoContent = `##gff-version 3
##sequence-region Demo_Genome_Chr1 1 600
Demo_Genome_Chr1\tGenomeExplorer\tgene\t1\t180\t.\t+\t.\tID=gene001;Name=demoA;description=Demo gene A
Demo_Genome_Chr1\tGenomeExplorer\tCDS\t1\t180\t.\t+\t0\tID=cds001;Parent=gene001;Name=demoA
Demo_Genome_Chr1\tGenomeExplorer\tgene\t200\t360\t.\t-\t.\tID=gene002;Name=demoB;description=Demo gene B
Demo_Genome_Chr1\tGenomeExplorer\tCDS\t200\t360\t.\t-\t0\tID=cds002;Parent=gene002;Name=demoB
Demo_Genome_Chr1\tGenomeExplorer\tgene\t400\t600\t.\t+\t.\tID=gene003;Name=demoC;description=Demo gene C
Demo_Genome_Chr1\tGenomeExplorer\tCDS\t400\t600\t.\t+\t0\tID=cds003;Parent=gene003;Name=demoC`;
                        demoFilePath = 'demo_annotations.gff';
                    } else {
                        // ÂÖ∂‰ªñÊñá‰ª∂Á±ªÂûãÁöÑÈªòËÆ§ÂÜÖÂÆπ
                        demoContent = `# Demo file content for ${file.name}\n# File type: ${file.type}\n# This is a demonstration file.`;
                        demoFilePath = file.name;
                    }

                    // ÂàõÂª∫‰∏¥Êó∂Êñá‰ª∂
                    if (window.electronAPI && window.electronAPI.createTempFile) {
                        const result = await window.electronAPI.createTempFile(demoFilePath, demoContent);
                        if (result.success) {
                            // ‰ΩøÁî®‰∏¥Êó∂Êñá‰ª∂Ë∑ØÂæÑÊâìÂºÄÊñá‰ª∂
                            const openResult = await window.electronAPI.openFileInMainWindow(result.filePath);
                            if (openResult.success) {
                                this.showNotification(`‚úÖ Opened demo file "${file.name}" in GenomeExplorer`, 'success');
                            } else {
                                throw new Error(openResult.error);
                            }
                        } else {
                            throw new Error(result.error || 'Failed to create temp file');
                        }
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÂàõÂª∫‰∏¥Êó∂Êñá‰ª∂ÁöÑAPIÔºåËá≥Â∞ëÊòæÁ§∫ÂÜÖÂÆπÈ¢ÑËßà
                        this.showDemoContentPreview(file, demoContent);
                    }
                } catch (error) {
                    console.error('Error opening test file:', error);
                    this.showNotification(`Test file "${file.name}" contains demo data. Add real files to work with actual genomic data.`, 'info');
                }
            }

            // ÊòæÁ§∫ÊºîÁ§∫ÂÜÖÂÆπÈ¢ÑËßà
            showDemoContentPreview(file, content) {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Demo Content Preview: ${file.name}</h3>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p style="margin-bottom: 15px;">This is a test file with demonstration content. To work with real genomic data, please add actual files to your project.</p>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-family: 'Courier New', monospace; font-size: 12px;">${this.escapeHtml(content)}</pre>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            // HTMLËΩ¨‰πâ
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Â∑•ÂÖ∑ÊñπÊ≥ï
            getCurrentFolderFiles() {
                if (!this.currentProject) return [];
                return this.currentProject.files.filter(file => {
                    if (this.currentPath.length === 0) {
                        return !file.folder || file.folder.length === 0;
                    }
                    return file.folder && this.arraysEqual(file.folder, this.currentPath);
                });
            }

            filterFiles(files) {
                if (!this.searchTerm) return files;
                return files.filter(file => file.name.toLowerCase().includes(this.searchTerm));
            }

            updateFileCardSelection() {
                const fileCards = document.querySelectorAll('.file-card');
                fileCards.forEach(card => {
                    const fileId = card.dataset.fileId;
                    if (this.selectedFiles.has(fileId)) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                });
            }

            updateContentTitle() {
                const titleElement = document.getElementById('contentTitle');
                if (!titleElement || !this.currentProject) return;

                let title = this.currentProject.name;
                if (this.currentPath.length > 0) {
                    title += ' / ' + this.currentPath.join(' / ');
                }
                titleElement.textContent = title;
            }

            updateActiveTreeItem(projectId = null) {
                const treeItems = document.querySelectorAll('.tree-item');
                treeItems.forEach(item => item.classList.remove('active'));

                if (projectId) {
                    const activeItem = document.querySelector(`[data-project-id="${projectId}"]`);
                    if (activeItem) activeItem.classList.add('active');
                }
            }

            updateStatusBar(message = 'Ready') {
                const statusText = document.getElementById('statusText');
                if (statusText) statusText.textContent = message;
                this.updateFileCountDisplay();
            }

            updateFileCountDisplay(count = null) {
                const fileCountElement = document.getElementById('fileCount');
                if (!fileCountElement) return;

                if (count === null && this.currentProject) {
                    count = this.getCurrentFolderFiles().length;
                }
                
                let text = `${count || 0} items`;
                if (this.selectedFiles.size > 0) {
                    text += ` (${this.selectedFiles.size} selected)`;
                }
                
                fileCountElement.textContent = text;
            }

            async saveProjects() {
                try {
                    const projectsData = {
                        projects: Object.fromEntries(this.projects),
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('genomeExplorer_projects', JSON.stringify(projectsData));
                    console.log('Projects saved to localStorage');
                } catch (error) {
                    console.error('Error saving projects:', error);
                }
            }

            async loadProjects() {
                try {
                    const data = localStorage.getItem('genomeExplorer_projects');
                    if (data) {
                        const projectsData = JSON.parse(data);
                        if (projectsData.projects) {
                            this.projects = new Map(Object.entries(projectsData.projects));
                        }
                    }
                    console.log(`Loaded ${this.projects.size} projects`);
                } catch (error) {
                    console.error('Error loading projects:', error);
                    this.projects = new Map();
                }
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            detectFileType(fileName) {
                const ext = '.' + fileName.toLowerCase().split('.').pop();
                for (const [type, config] of Object.entries(this.fileTypes)) {
                    if (config.extensions.includes(ext)) {
                        return type;
                    }
                }
                return 'unknown';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return Math.round(bytes / Math.pow(1024, i) * 10) / 10 + ' ' + sizes[i];
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleDateString();
            }

            arraysEqual(a, b) {
                return a.length === b.length && a.every((val, i) => val === b[i]);
            }

            findFileById(fileId) {
                if (!this.currentProject) return null;
                return this.currentProject.files.find(f => f.id === fileId);
            }

            showNotification(message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${message}`);
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    background: ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'};
                    color: white;
                    border-radius: 6px;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    font-size: 14px;
                    max-width: 300px;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }

            // XMLÈ°πÁõÆÊñá‰ª∂ÁÆ°ÁêÜÊñπÊ≥ï
            async createProjectXMLFile(project) {
                try {
                    // ÂàùÂßãÂåñXMLÂ§ÑÁêÜÂô®
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }

                    // ÁîüÊàêXMLÊñá‰ª∂Âêç
                    const xmlFileName = `${project.name}.prj.GAI`;
                    
                    // ËΩ¨Êç¢È°πÁõÆ‰∏∫XML
                    const xmlContent = this.xmlHandler.projectToXML(project);
                    
                    // Âú®ElectronÁéØÂ¢É‰∏≠‰øùÂ≠òÊñá‰ª∂
                    if (window.electronAPI && window.electronAPI.saveProjectFile) {
                        try {
                            const result = await window.electronAPI.saveProjectFile(xmlFileName, xmlContent);
                            if (result.success) {
                                // Â∞ÜXMLÊñá‰ª∂Ë∑ØÂæÑ‰øùÂ≠òÂà∞È°πÁõÆ‰∏≠
                                project.xmlFilePath = result.filePath;
                                project.xmlFileName = xmlFileName;
                                
                                // Êõ¥Êñ∞È°πÁõÆ
                                this.projects.set(project.id, project);
                                await this.saveProjects();
                                
                                console.log(`‚úÖ Created XML project file: ${result.filePath}`);
                                return result.filePath;
                            } else {
                                throw new Error(result.error || 'Failed to save XML file');
                            }
                        } catch (error) {
                            console.error('Error saving XML file via Electron:', error);
                            throw error;
                        }
                    } else {
                        // ÊµèËßàÂô®ÁéØÂ¢É‰∏≠ÂàõÂª∫‰∏ãËΩΩ
                        this.downloadXMLFile(xmlContent, xmlFileName);
                        console.log(`‚úÖ Created XML project file for download: ${xmlFileName}`);
                        return xmlFileName;
                    }
                } catch (error) {
                    console.error('Error creating project XML file:', error);
                    throw error;
                }
            }

            async saveCurrentProjectAsXML() {
                if (!this.currentProject) {
                    this.showNotification('No project selected to save', 'warning');
                    return;
                }

                try {
                    // Êõ¥Êñ∞È°πÁõÆ‰øÆÊîπÊó∂Èó¥
                    this.currentProject.modified = new Date().toISOString();
                    
                    // ‰øùÂ≠ò‰∏∫XML
                    const result = await this.createProjectXMLFile(this.currentProject);
                    
                    this.showNotification(`Project saved as XML: ${this.currentProject.xmlFileName || this.currentProject.name + '.prj.GAI'}`, 'success');
                    return result;
                } catch (error) {
                    console.error('Error saving project as XML:', error);
                    this.showNotification('Failed to save project as XML', 'error');
                    throw error;
                }
            }

            async saveProjectAsXML(projectId = null) {
                const project = projectId ? this.projects.get(projectId) : this.currentProject;
                
                if (!project) {
                    this.showNotification('No project found to save', 'warning');
                    return;
                }

                try {
                    // Êõ¥Êñ∞È°πÁõÆ‰øÆÊîπÊó∂Èó¥
                    project.modified = new Date().toISOString();
                    
                    // ‰øùÂ≠ò‰∏∫XML
                    const result = await this.createProjectXMLFile(project);
                    
                    this.showNotification(`Project "${project.name}" saved as XML`, 'success');
                    return result;
                } catch (error) {
                    console.error('Error saving project as XML:', error);
                    this.showNotification('Failed to save project as XML', 'error');
                    throw error;
                }
            }

            downloadXMLFile(xmlContent, fileName) {
                const blob = new Blob([xmlContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // ‰ªéXMLÊñá‰ª∂Âä†ËΩΩÈ°πÁõÆ
            async loadProjectFromXML(xmlContent, fileName = null) {
                try {
                    if (!this.xmlHandler) {
                        this.xmlHandler = new ProjectXMLHandler();
                    }

                    const project = this.xmlHandler.xmlToProject(xmlContent);
                    
                    // Êõ¥Êñ∞Êñá‰ª∂‰ø°ÊÅØ
                    if (fileName) {
                        project.xmlFileName = fileName;
                    }
                    
                    // Ê∑ªÂä†Âà∞È°πÁõÆÂàóË°®
                    this.projects.set(project.id, project);
                    await this.saveProjects();
                    
                    // Âà∑Êñ∞ÁïåÈù¢
                    this.renderProjectTree();
                    this.selectProject(project.id);
                    
                    this.showNotification(`Project "${project.name}" loaded from XML`, 'success');
                    return project;
                } catch (error) {
                    console.error('Error loading project from XML:', error);
                    this.showNotification('Failed to load project from XML', 'error');
                    throw error;
                }
            }
        }

        // ÂÖ®Â±ÄÈ°πÁõÆÁÆ°ÁêÜÂô®ÂÆû‰æã
        let projectManager = null;
        let projectManagerWindow = null;
        
        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing Project Manager...');
            
            // ÂàõÂª∫ ProjectManagerWindow UI ÂÆû‰æã
            projectManagerWindow = new ProjectManagerWindow();
            
            // ÂàõÂª∫ ProjectManager Ê†∏ÂøÉÈÄªËæëÂÆû‰æãÂπ∂ÈõÜÊàê
            if (typeof ProjectManager !== 'undefined') {
                projectManager = new ProjectManager();
                // Â∞Ü ProjectManager ÈõÜÊàêÂà∞ ProjectManagerWindow
                projectManagerWindow.projectManager = projectManager;
                
                // ÂÖ±‰∫´Êï∞ÊçÆÂíåÁä∂ÊÄÅ
                projectManagerWindow.projects = projectManager.projects;
                projectManagerWindow.currentProject = projectManager.currentProject;
                projectManagerWindow.currentPath = projectManager.currentPath;
                
                console.log('‚úÖ ProjectManager core logic integrated');
                console.log('ProjectManager instance:', projectManager);
                console.log('ProjectManagerWindow instance:', projectManagerWindow);
            } else {
                console.warn('‚ö†Ô∏è ProjectManager not available, using fallback UI only');
            }

            // ËÆæÁΩÆIPC‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (window.electronAPI && window.electronAPI.onCreateNewProject) {
                window.electronAPI.onCreateNewProject(() => {
                    console.log('üìù Create new project requested from main menu');
                    if (projectManagerWindow) {
                        projectManagerWindow.createNewProject();
                    }
                });
            }

            // ÁõëÂê¨‰ªéËèúÂçïÂä†ËΩΩÈ°πÁõÆÁöÑ‰∫ã‰ª∂
            if (window.electronAPI && window.electronAPI.onLoadProjectFromMenu) {
                window.electronAPI.onLoadProjectFromMenu((filePath) => {
                    console.log('üìÅ Load project requested from main menu:', filePath);
                    if (projectManagerWindow) {
                        projectManagerWindow.loadProjectFromFile(filePath);
                    }
                });
            }
        });
    </script>
    
    <!-- ‰æùËµñËÑöÊú¨ -->
    <script src="renderer/modules/ProjectXMLHandler.js"></script>
    <script src="renderer/modules/ProjectManager.js"></script>
</body>
</html> 