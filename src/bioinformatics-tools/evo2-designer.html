<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Evo2 DNA Designer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            min-height: 80vh;
        }

        .sidebar {
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
        }

        .content-area {
            padding: 30px;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e9ecef;
        }

        .section h3 {
            margin: 0 0 20px 0;
            color: #2c5530;
            font-size: 1.4em;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a7c59;
            box-shadow: 0 0 0 3px rgba(74, 124, 89, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        .btn {
            background: linear-gradient(135deg, #4a7c59, #2c5530);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 124, 89, 0.3);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .mode-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .mode-tab.active {
            background: white;
            color: #4a7c59;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .config-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-configured {
            background: #28a745;
        }

        .status-unconfigured {
            background: #dc3545;
        }

        /* Configuration Modal Styles */
        .config-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .config-modal {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .config-modal-header {
            background: linear-gradient(135deg, #4a7c59, #2c5530);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 600;
        }

        .config-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .config-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .config-modal-body {
            padding: 30px;
        }

        .config-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #4a7c59;
        }

        .config-group h4 {
            margin: 0 0 15px 0;
            color: #2c5530;
            font-size: 1.2em;
            font-weight: 600;
        }

        .config-group .description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .api-key-container {
            position: relative;
        }

        .api-key-toggle {
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        .api-key-toggle:hover {
            color: #4a7c59;
        }

        .config-status-display {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .config-status-display.configured {
            border-color: #28a745;
            background: #f8fff9;
        }

        .config-status-display.unconfigured {
            border-color: #dc3545;
            background: #fff8f8;
        }

        .config-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .compact-config-panel {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border: 1px solid #c3e6c3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .compact-config-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .config-summary {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-btn {
            background: #4a7c59;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .config-btn:hover {
            background: #2c5530;
            transform: translateY(-1px);
        }

        /* MCP Connection Styles */
        .mcp-connection-panel {
            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
            border: 1px solid #90caf9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .mcp-status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .mcp-status-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mcp-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .mcp-status-connected {
            background: #4caf50;
        }

        .mcp-status-disconnected {
            background: #f44336;
        }

        .mcp-status-connecting {
            background: #ff9800;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .mcp-toggle-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 80px;
        }

        .mcp-toggle-btn:hover {
            background: #1976d2;
            transform: translateY(-1px);
        }

        .mcp-toggle-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
            transform: none;
        }

        .mcp-server-info {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c59;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4a7c59;
        }

        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-type {
            background: #4a7c59;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .sequence-display {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
        }

        .metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metadata-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .metadata-label {
            font-weight: 600;
            color: #495057;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .metadata-value {
            color: #2c5530;
            font-weight: 600;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
            margin: 20px 0;
        }

        .example-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .example-btn {
            background: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .example-btn:hover {
            background: #4a7c59;
            color: white;
        }

        .range-input {
            width: 100%;
            margin: 10px 0;
        }

        .range-value {
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-weight: 600;
            color: #4a7c59;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧬 Evo2 DNA Designer</h1>
            <p>Advanced AI-powered genomic sequence design and analysis using NVIDIA's Evo2 foundation model</p>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <!-- MCP Server Connection Panel -->
                <div class="mcp-connection-panel">
                    <div class="mcp-status-row">
                        <div class="mcp-status-info">
                            <div class="mcp-status-indicator mcp-status-disconnected" id="mcpStatusIndicator"></div>
                            <div>
                                <div style="font-weight: 600; font-size: 13px;" id="mcpStatusText">MCP Disconnected</div>
                                <div class="mcp-server-info" id="mcpServerInfo">Server: localhost:3000</div>
                            </div>
                        </div>
                        <button class="mcp-toggle-btn" onclick="toggleMCPConnection()" id="mcpToggleBtn">
                            🔌 Connect
                        </button>
                    </div>
                </div>

                <!-- Compact API Configuration Panel -->
                <div class="compact-config-panel">
                    <div class="compact-config-status">
                        <div class="config-summary">
                            <div class="status-indicator status-unconfigured" id="compactConfigStatus"></div>
                            <div>
                                <div style="font-weight: 600; font-size: 14px;" id="compactConfigText">API Not Configured</div>
                                <div style="font-size: 12px; color: #6c757d;" id="compactConfigDetail">Click to setup NVIDIA API</div>
                            </div>
                        </div>
                        <button class="config-btn" onclick="openConfigModal()">
                            ⚙️ Setup
                        </button>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <h3>🚀 Quick Actions</h3>
                    <button class="btn" onclick="loadExample('generate')">Generate Example</button>
                    <button class="btn" onclick="loadExample('predict')">Predict Function</button>
                    <button class="btn" onclick="loadExample('crispr')">Design CRISPR</button>
                    <button class="btn" onclick="loadExample('optimize')">Optimize Sequence</button>
                    <button class="btn btn-secondary" onclick="clearAll()">Clear All</button>
                </div>

                <!-- Analysis History -->
                <div class="section">
                    <h3>📊 Recent Analysis</h3>
                    <div id="historyList">
                        <p style="color: #6c757d; font-style: italic;">No recent analysis</p>
                    </div>
                </div>
            </div>

            <div class="content-area">
                <!-- Mode Selection -->
                <div class="mode-tabs">
                    <button class="mode-tab active" onclick="switchMode('generate')" id="tab-generate">
                        Sequence Generation
                    </button>
                    <button class="mode-tab" onclick="switchMode('predict')" id="tab-predict">
                        Function Prediction
                    </button>
                    <button class="mode-tab" onclick="switchMode('crispr')" id="tab-crispr">
                        CRISPR Design
                    </button>
                    <button class="mode-tab" onclick="switchMode('optimize')" id="tab-optimize">
                        Sequence Optimization
                    </button>
                    <button class="mode-tab" onclick="switchMode('essentiality')" id="tab-essentiality">
                        Essentiality Analysis
                    </button>
                </div>

                <!-- Sequence Generation Mode -->
                <div id="mode-generate" class="mode-content">
                    <div class="section">
                        <h3>🧬 DNA Sequence Generation</h3>
                        <p>Generate novel DNA sequences using Evo2's generative capabilities. Can create sequences up to 1M base pairs.</p>
                        
                        <div class="form-group">
                            <label for="generatePrompt">Starting Sequence/Prompt (optional)</label>
                            <textarea id="generatePrompt" class="form-control" 
                                    placeholder="Enter a DNA sequence as starting prompt, or leave empty for de novo generation..."></textarea>
                            <div class="example-buttons">
                                <span class="example-btn" onclick="setPrompt('ATGAAGTCG')">Gene Start</span>
                                <span class="example-btn" onclick="setPrompt('TATAAA')">Promoter</span>
                                <span class="example-btn" onclick="setPrompt('GAATTC')">Restriction Site</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="taxonomy">Organism Taxonomy (optional)</label>
                            <input type="text" id="taxonomy" class="form-control" 
                                   placeholder="|k__Bacteria;p__Proteobacteria;c__Gammaproteobacteria;o__Enterobacterales;g__Escherichia;s__Escherichia coli|">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="maxTokens">Max Length: <span class="range-value" id="maxTokensValue">1000</span></label>
                                <input type="range" id="maxTokens" class="range-input" min="100" max="10000" value="1000" 
                                       oninput="document.getElementById('maxTokensValue').textContent = this.value">
                            </div>
                            
                            <div class="form-group">
                                <label for="temperature">Temperature: <span class="range-value" id="temperatureValue">1.0</span></label>
                                <input type="range" id="temperature" class="range-input" min="0" max="2" step="0.1" value="1.0"
                                       oninput="document.getElementById('temperatureValue').textContent = this.value">
                            </div>
                        </div>

                        <button class="btn" onclick="generateSequenceMain()" id="generateBtn">
                            Generate DNA Sequence
                        </button>
                    </div>
                </div>

                <!-- Function Prediction Mode -->
                <div id="mode-predict" class="mode-content" style="display: none;">
                    <div class="section">
                        <h3>🔬 Function Prediction</h3>
                        <p>Predict biological function from DNA sequences using Evo2's zero-shot capabilities.</p>
                        
                        <div class="form-group">
                            <label for="predictSequence">DNA Sequence</label>
                            <textarea id="predictSequence" class="form-control" 
                                    placeholder="Enter DNA sequence for function prediction..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="analysisType">Analysis Type</label>
                            <select id="analysisType" class="form-control">
                                <option value="function">Function Prediction</option>
                                <option value="essentiality">Essentiality Analysis</option>
                                <option value="regulation">Regulatory Element Identification</option>
                            </select>
                        </div>

                        <button class="btn" onclick="predictFunctionMain()" id="predictBtn">
                            Predict Function
                        </button>
                    </div>
                </div>

                <!-- CRISPR Design Mode -->
                <div id="mode-crispr" class="mode-content" style="display: none;">
                    <div class="section">
                        <h3>✂️ CRISPR-Cas System Design</h3>
                        <p>Design CRISPR-Cas molecular complexes for targeted genome editing.</p>
                        
                        <div class="form-group">
                            <label for="crisprTarget">Target DNA Sequence</label>
                            <textarea id="crisprTarget" class="form-control" 
                                    placeholder="Enter target DNA sequence for CRISPR design..."></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="casType">Cas System Type</label>
                                <select id="casType" class="form-control">
                                    <option value="Auto">Auto-detect</option>
                                    <option value="Cas9">Cas9</option>
                                    <option value="Cas12">Cas12</option>
                                    <option value="Cas13">Cas13</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="guideLength">Guide RNA Length: <span class="range-value" id="guideLengthValue">20</span></label>
                                <input type="range" id="guideLength" class="range-input" min="15" max="25" value="20"
                                       oninput="document.getElementById('guideLengthValue').textContent = this.value">
                            </div>
                        </div>

                        <button class="btn" onclick="designCrisprMain()" id="crisprBtn">
                            Design CRISPR System
                        </button>
                    </div>
                </div>

                <!-- Sequence Optimization Mode -->
                <div id="mode-optimize" class="mode-content" style="display: none;">
                    <div class="section">
                        <h3>⚡ Sequence Optimization</h3>
                        <p>Optimize DNA sequences for specific properties while preserving function.</p>
                        
                        <div class="form-group">
                            <label for="optimizeSequence">DNA Sequence to Optimize</label>
                            <textarea id="optimizeSequence" class="form-control" 
                                    placeholder="Enter DNA sequence to optimize..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="optimizationGoal">Optimization Goal</label>
                            <select id="optimizationGoal" class="form-control">
                                <option value="expression">Higher Expression</option>
                                <option value="stability">Improved Stability</option>
                                <option value="codingDensity">Increased Coding Density</option>
                                <option value="gc_content">Optimal GC Content</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="targetOrganism">Target Organism (optional)</label>
                            <input type="text" id="targetOrganism" class="form-control" 
                                   placeholder="e.g., Escherichia coli, Homo sapiens">
                        </div>

                        <button class="btn" onclick="optimizeSequenceMain()" id="optimizeBtn">
                            Optimize Sequence
                        </button>
                    </div>
                </div>

                <!-- Essentiality Analysis Mode -->
                <div id="mode-essentiality" class="mode-content" style="display: none;">
                    <div class="section">
                        <h3>🎯 Gene Essentiality Analysis</h3>
                        <p>Analyze gene essentiality at nucleotide resolution to identify critical regions.</p>
                        
                        <div class="form-group">
                            <label for="essentialitySequence">DNA Sequence</label>
                            <textarea id="essentialitySequence" class="form-control" 
                                    placeholder="Enter DNA sequence for essentiality analysis..."></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="form-group">
                                <label for="resolution">Analysis Resolution</label>
                                <select id="resolution" class="form-control">
                                    <option value="nucleotide">Nucleotide Level</option>
                                    <option value="codon">Codon Level</option>
                                    <option value="domain">Domain Level</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="organism">Organism Context</label>
                                <input type="text" id="organism" class="form-control" 
                                       placeholder="e.g., Escherichia coli">
                            </div>
                        </div>

                        <button class="btn" onclick="analyzeEssentialityMain()" id="essentialityBtn">
                            Analyze Essentiality
                        </button>
                    </div>
                </div>

                <!-- Results Area -->
                <div id="resultsArea" class="results-container" style="display: none;">
                    <h3>📋 Analysis Results</h3>
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentMode = 'generate';
        let analysisHistory = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            await loadApiConfig();
            await loadAnalysisHistory();
            setupMenuEventListeners();
            initializeMCPConnection();
        });

        // Setup menu event listeners
        function setupMenuEventListeners() {
            // Listen for menu actions from main process
            if (typeof require !== 'undefined') {
                const { ipcRenderer } = require('electron');
                
                ipcRenderer.on('evo2-menu-action', (event, action, data) => {
                    handleMenuAction(action, data);
                });
            }
        }

        // Handle menu actions
        function handleMenuAction(action, data) {
            console.log('Menu action received:', action, data);
            
            switch (action) {
                // File menu actions
                case 'new-project':
                    newProject();
                    break;
                case 'open-sequence-file':
                    openSequenceFile(data);
                    break;
                case 'import-clipboard':
                    importFromClipboard();
                    break;
                case 'save-design':
                    saveDesign();
                    break;
                case 'save-as':
                    saveAsDesign();
                    break;
                case 'export-fasta':
                    exportResults('fasta');
                    break;
                case 'export-genbank':
                    exportResults('genbank');
                    break;
                case 'export-json':
                    exportResults('json');
                    break;
                case 'export-report':
                    exportResults('report');
                    break;

                // Edit menu actions
                case 'undo':
                    performUndo();
                    break;
                case 'redo':
                    performRedo();
                    break;
                case 'copy':
                    copySelectedText();
                    break;
                case 'paste':
                    pasteToFocusedElement();
                    break;
                case 'cut':
                    cutSelectedText();
                    break;
                case 'select-all':
                    selectAllInFocusedElement();
                    break;
                case 'copy-sequence':
                    copyCurrentSequence();
                    break;
                case 'paste-sequence':
                    pasteSequenceToCurrentMode();
                    break;
                case 'clear-input':
                    clearCurrentInput();
                    break;

                // Generation menu actions
                case 'generate-sequence':
                    switchMode('generate');
                    generateSequenceAction();
                    break;
                case 'predict-function':
                    switchMode('predict');
                    predictFunctionAction();
                    break;
                case 'design-crispr':
                    switchMode('crispr');
                    designCrisprAction();
                    break;
                case 'optimize-sequence':
                    switchMode('optimize');
                    optimizeSequenceAction();
                    break;
                case 'analyze-essentiality':
                    switchMode('essentiality');
                    analyzeEssentialityAction();
                    break;
                case 'stop-generation':
                    stopCurrentGeneration();
                    break;

                // Tools menu actions
                case 'configure-api':
                    focusApiConfiguration();
                    break;
                case 'test-api-connection':
                    testApiConnection();
                    break;
                case 'show-history':
                    showHistoryPanel();
                    break;
                case 'clear-history':
                    clearAnalysisHistory();
                    break;

                // View menu actions
                case 'switch-mode':
                    switchMode(data);
                    break;
                case 'toggle-sidebar':
                    toggleSidebar();
                    break;
                case 'toggle-results-panel':
                    toggleResultsPanel();
                    break;
                case 'toggle-history-panel':
                    toggleHistoryPanel();
                    break;

                // Help menu actions
                case 'show-user-guide':
                    showUserGuide();
                    break;
                case 'show-shortcuts':
                    showKeyboardShortcuts();
                    break;
                case 'about':
                    showAbout();
                    break;

                default:
                    console.log('Unhandled menu action:', action);
            }
        }

        // Mode switching
        function switchMode(mode) {
            // Hide all mode contents
            document.querySelectorAll('.mode-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected mode and activate tab
            document.getElementById(`mode-${mode}`).style.display = 'block';
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            currentMode = mode;
        }

        // Enhanced API Configuration System
        async function loadApiConfig() {
            const config = await getStoredConfig();
            await updateCompactConfigDisplay();
            
            // Load into modal if it exists
            if (document.getElementById('modalApiKey')) {
                document.getElementById('modalApiKey').value = config.apiKey || '';
                document.getElementById('modalApiUrl').value = config.apiUrl || 'https://integrate.api.nvidia.com';
                document.getElementById('defaultTimeout').value = config.timeout || 60;
                document.getElementById('maxRetries').value = config.maxRetries || 3;
                document.getElementById('enableDebugMode').checked = config.debugMode || false;
                
                await updateModalConfigStatus();
                setupConfigValidation();
            }
        }

        async function getStoredConfig() {
            try {
                if (typeof require !== 'undefined') {
                    const { ipcRenderer } = require('electron');
                    const config = await ipcRenderer.invoke('evo2-get-config');
                    console.log('Evo2 config loaded from ConfigManager:', config);
                    return {
                        apiKey: config.apiKey || '',
                        apiUrl: config.apiUrl || 'https://integrate.api.nvidia.com',
                        timeout: config.timeout || 60,
                        maxRetries: config.maxRetries || 3,
                        debugMode: config.debugMode || false,
                        lastSaved: config.lastSaved || null
                    };
                } else {
                    // Fallback to localStorage if not in Electron environment
                    console.log('Evo2 config loaded from localStorage (fallback)');
                    return {
                        apiKey: localStorage.getItem('evo2_api_key') || '',
                        apiUrl: localStorage.getItem('evo2_api_url') || 'https://integrate.api.nvidia.com',
                        timeout: parseInt(localStorage.getItem('evo2_timeout')) || 60,
                        maxRetries: parseInt(localStorage.getItem('evo2_max_retries')) || 3,
                        debugMode: localStorage.getItem('evo2_debug_mode') === 'true',
                        lastSaved: localStorage.getItem('evo2_config_timestamp')
                    };
                }
            } catch (error) {
                console.error('Error loading Evo2 config:', error);
                // Return default config on error
                return {
                    apiKey: '',
                    apiUrl: 'https://integrate.api.nvidia.com',
                    timeout: 60,
                    maxRetries: 3,
                    debugMode: false,
                    lastSaved: null
                };
            }
        }

        async function getApiConfig() {
            const config = await getStoredConfig();
            if (config.apiKey) {
                return { 
                    key: config.apiKey, 
                    url: config.apiUrl,
                    timeout: config.timeout,
                    maxRetries: config.maxRetries,
                    debugMode: config.debugMode
                };
            }
            return null;
        }

        async function updateCompactConfigDisplay() {
            const config = await getStoredConfig();
            const statusElement = document.getElementById('compactConfigStatus');
            const statusText = document.getElementById('compactConfigText');
            const statusDetail = document.getElementById('compactConfigDetail');
            
            if (config.apiKey) {
                statusElement.className = 'status-indicator status-configured';
                statusText.textContent = 'API Configured';
                statusDetail.textContent = `Connected to ${config.apiUrl.replace('https://', '')}`;
            } else {
                statusElement.className = 'status-indicator status-unconfigured';
                statusText.textContent = 'API Not Configured';
                statusDetail.textContent = 'Click to setup NVIDIA API';
            }
        }

        // Modal Configuration Functions
        async function openConfigModal() {
            document.getElementById('configModal').style.display = 'flex';
            await loadApiConfig(); // Refresh modal data
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }

        async function saveModalConfig() {
            const apiKey = document.getElementById('modalApiKey').value.trim();
            const apiUrl = document.getElementById('modalApiUrl').value.trim();
            const timeout = document.getElementById('defaultTimeout').value;
            const maxRetries = document.getElementById('maxRetries').value;
            const debugMode = document.getElementById('enableDebugMode').checked;
            
            // Validate API key format
            if (apiKey && !apiKey.startsWith('nvapi-')) {
                showNotification('API key should start with "nvapi-"', 'warning');
                return;
            }
            
            // Validate URL format
            if (apiUrl && !apiUrl.startsWith('https://')) {
                showNotification('API URL must use HTTPS', 'warning');
                return;
            }
            
            try {
                if (typeof require !== 'undefined') {
                    const { ipcRenderer } = require('electron');
                    const config = {
                        apiKey: apiKey,
                        apiUrl: apiUrl,
                        timeout: parseInt(timeout),
                        maxRetries: parseInt(maxRetries),
                        debugMode: debugMode,
                        lastSaved: new Date().toISOString()
                    };
                    
                    const result = await ipcRenderer.invoke('evo2-set-config', config);
                    if (result.success) {
                        console.log('Evo2 config saved to ConfigManager');
                    } else {
                        throw new Error(result.error || 'Failed to save config');
                    }
                } else {
                    // Fallback to localStorage if not in Electron environment
                    localStorage.setItem('evo2_api_key', apiKey);
                    localStorage.setItem('evo2_api_url', apiUrl);
                    localStorage.setItem('evo2_timeout', timeout);
                    localStorage.setItem('evo2_max_retries', maxRetries);
                    localStorage.setItem('evo2_debug_mode', debugMode.toString());
                    localStorage.setItem('evo2_config_timestamp', new Date().toISOString());
                    console.log('Evo2 config saved to localStorage (fallback)');
                }
                
                // Update displays
                await updateCompactConfigDisplay();
                updateModalConfigStatus();
                
                showNotification('Configuration saved successfully!', 'success');
                
                // Auto-close modal after successful save
                setTimeout(() => {
                    closeConfigModal();
                }, 1500);
                
            } catch (error) {
                console.error('Error saving Evo2 config:', error);
                showNotification('Failed to save configuration: ' + error.message, 'error');
            }
        }

        async function updateModalConfigStatus() {
            const config = await getStoredConfig();
            const statusDisplay = document.getElementById('modalConfigStatus');
            const statusIndicator = document.getElementById('modalStatusIndicator');
            const statusText = document.getElementById('modalStatusText');
            const statusDetail = document.getElementById('modalStatusDetail');
            
            if (config.apiKey) {
                statusDisplay.className = 'config-status-display configured';
                statusIndicator.className = 'status-indicator status-configured';
                statusText.textContent = 'API Configured & Ready';
                
                const maskedKey = config.apiKey.substring(0, 12) + '...' + config.apiKey.substring(config.apiKey.length - 4);
                const lastSaved = config.lastSaved ? new Date(config.lastSaved).toLocaleString() : 'Unknown';
                statusDetail.textContent = `Key: ${maskedKey} • Saved: ${lastSaved}`;
            } else {
                statusDisplay.className = 'config-status-display unconfigured';
                statusIndicator.className = 'status-indicator status-unconfigured';
                statusText.textContent = 'API Not Configured';
                statusDetail.textContent = 'Enter your NVIDIA API key below to enable Evo2 functionality';
            }
        }

        function toggleApiKeyVisibility() {
            const keyInput = document.getElementById('modalApiKey');
            const toggleBtn = document.getElementById('apiKeyToggle');
            
            if (keyInput.type === 'password') {
                keyInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                keyInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        }

        async function pasteModalApiKey() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('modalApiKey').value = text.trim();
                validateApiKeyStrength();
                showNotification('API key pasted successfully!', 'success');
            } catch (error) {
                showNotification('Could not access clipboard', 'error');
                document.getElementById('modalApiKey').focus();
            }
        }

        function validateApiKeyStrength() {
            const apiKey = document.getElementById('modalApiKey').value;
            const strengthElement = document.getElementById('apiKeyStrength');
            
            if (!apiKey) {
                strengthElement.textContent = '';
                return;
            }
            
            if (!apiKey.startsWith('nvapi-')) {
                strengthElement.innerHTML = '⚠️ Key should start with "nvapi-"';
                strengthElement.style.color = '#f59e0b';
            } else if (apiKey.length < 20) {
                strengthElement.innerHTML = '⚠️ Key appears to be too short';
                strengthElement.style.color = '#f59e0b';
            } else {
                strengthElement.innerHTML = '✅ Key format looks valid';
                strengthElement.style.color = '#10b981';
            }
        }

        function testModalApiConnection() {
            const config = {
                key: document.getElementById('modalApiKey').value.trim(),
                url: document.getElementById('modalApiUrl').value.trim()
            };
            
            if (!config.key || !config.url) {
                showNotification('Please enter both API key and URL', 'warning');
                return;
            }
            
            const testBtn = document.getElementById('modalTestBtn');
            testBtn.textContent = '🔄 Testing...';
            testBtn.disabled = true;
            
            // Simulate API test
            setTimeout(() => {
                if (config.key.startsWith('nvapi-') && config.url.includes('nvidia')) {
                    showNotification('API connection test successful!', 'success');
                    testBtn.innerHTML = '✅ Connected';
                } else {
                    showNotification('API connection test failed', 'error');
                    testBtn.innerHTML = '❌ Failed';
                }
                
                setTimeout(() => {
                    testBtn.textContent = '🔗 Test Connection';
                    testBtn.disabled = false;
                }, 2000);
            }, 1500);
        }

        function resetConfigToDefaults() {
            if (confirm('Reset all configuration to defaults? This will clear your API key.')) {
                localStorage.removeItem('evo2_api_key');
                localStorage.removeItem('evo2_api_url');
                localStorage.removeItem('evo2_timeout');
                localStorage.removeItem('evo2_max_retries');
                localStorage.removeItem('evo2_debug_mode');
                localStorage.removeItem('evo2_config_timestamp');
                
                // Reset form
                document.getElementById('modalApiKey').value = '';
                document.getElementById('modalApiUrl').value = 'https://health.api.nvidia.com';
                document.getElementById('defaultTimeout').value = '60';
                document.getElementById('maxRetries').value = '3';
                document.getElementById('enableDebugMode').checked = false;
                
                updateCompactConfigDisplay();
                updateModalConfigStatus();
                
                showNotification('Configuration reset to defaults', 'success');
            }
        }

        // Add real-time validation
        function setupConfigValidation() {
            const apiKeyInput = document.getElementById('modalApiKey');
            if (apiKeyInput) {
                apiKeyInput.addEventListener('input', validateApiKeyStrength);
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existing = document.querySelector('.notification-toast');
            if (existing) {
                existing.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 20000;
                font-weight: 600;
                font-size: 14px;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;

            notification.innerHTML = `${icons[type] || icons.info} ${message}`;
            document.body.appendChild(notification);

            // Add CSS animation
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            // Auto-remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Enhanced keyboard support
        document.addEventListener('keydown', function(event) {
            // Close modal on Escape key
            if (event.key === 'Escape') {
                const modal = document.getElementById('configModal');
                if (modal && modal.style.display === 'flex') {
                    closeConfigModal();
                }
            }
            
            // Save config on Ctrl/Cmd+S in modal
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                const modal = document.getElementById('configModal');
                if (modal && modal.style.display === 'flex') {
                    event.preventDefault();
                    saveModalConfig();
                }
            }
        });

        // MCP Connection Management
        let mcpConnected = false;
        let mcpConnectionAttempts = 0;

        async function toggleMCPConnection() {
            const toggleBtn = document.getElementById('mcpToggleBtn');
            const statusIndicator = document.getElementById('mcpStatusIndicator');
            const statusText = document.getElementById('mcpStatusText');
            
            if (mcpConnected) {
                // Disconnect MCP
                mcpConnected = false;
                updateMCPStatus('disconnected', 'MCP Disconnected', '🔌 Connect');
                showNotification('Disconnected from MCP Server', 'info');
            } else {
                // Attempt to connect to MCP
                toggleBtn.textContent = '⏳ Connecting...';
                toggleBtn.disabled = true;
                statusIndicator.className = 'mcp-status-indicator mcp-status-connecting';
                statusText.textContent = 'Connecting...';
                
                try {
                    const connected = await attemptMCPConnection();
                    if (connected) {
                        mcpConnected = true;
                        updateMCPStatus('connected', 'MCP Connected', '🔌 Disconnect');
                        showNotification('Successfully connected to MCP Server', 'success');
                    } else {
                        updateMCPStatus('disconnected', 'Connection Failed', '🔌 Retry');
                        showNotification('Failed to connect to MCP Server', 'error');
                    }
                } catch (error) {
                    updateMCPStatus('disconnected', 'Connection Error', '🔌 Retry');
                    showNotification(`MCP Connection Error: ${error.message}`, 'error');
                }
                
                toggleBtn.disabled = false;
            }
        }

        async function attemptMCPConnection() {
            try {
                mcpConnectionAttempts++;
                
                // Try different endpoints to check if MCP server is running
                const endpoints = [
                    'http://localhost:3000/health',
                    'http://localhost:3000/',
                    'http://localhost:3000/execute-tool'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(endpoint, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (response.ok || response.status === 404) {
                            // Server is running (even if endpoint doesn't exist)
                            return true;
                        }
                    } catch (fetchError) {
                        // Continue to next endpoint
                        continue;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('MCP Connection attempt failed:', error);
                
                // If server is not running, show helpful message
                if (mcpConnectionAttempts === 1) {
                    showNotification('MCP Server not detected. Please start the server: node src/mcp-server.js', 'warning');
                }
                
                return false;
            }
        }

        function updateMCPStatus(status, text, buttonText) {
            const statusIndicator = document.getElementById('mcpStatusIndicator');
            const statusText = document.getElementById('mcpStatusText');
            const toggleBtn = document.getElementById('mcpToggleBtn');
            const serverInfo = document.getElementById('mcpServerInfo');
            
            // Update status indicator
            statusIndicator.className = `mcp-status-indicator mcp-status-${status}`;
            
            // Update status text
            statusText.textContent = text;
            
            // Update button
            toggleBtn.textContent = buttonText;
            
            // Update server info
            if (status === 'connected') {
                serverInfo.textContent = `Server: localhost:3000 • Attempt ${mcpConnectionAttempts}`;
            } else {
                serverInfo.textContent = 'Server: localhost:3000';
            }
        }

        function checkMCPConnection() {
            if (!mcpConnected) {
                showNotification('Please connect to MCP Server first', 'warning');
                
                // Flash the MCP panel to draw attention
                const mcpPanel = document.querySelector('.mcp-connection-panel');
                mcpPanel.style.animation = 'flash 0.5s ease-in-out 2';
                
                setTimeout(() => {
                    mcpPanel.style.animation = '';
                }, 1000);
                
                return false;
            }
            return true;
        }

        // Auto-check MCP connection on page load
        async function initializeMCPConnection() {
            try {
                const connected = await attemptMCPConnection();
                if (connected) {
                    mcpConnected = true;
                    updateMCPStatus('connected', 'MCP Connected', '🔌 Disconnect');
                } else {
                    updateMCPStatus('disconnected', 'MCP Disconnected', '🔌 Connect');
                }
            } catch (error) {
                updateMCPStatus('disconnected', 'MCP Disconnected', '🔌 Connect');
            }
        }

        // Add flash animation for MCP panel
        if (!document.querySelector('#mcp-flash-styles')) {
            const style = document.createElement('style');
            style.id = 'mcp-flash-styles';
            style.textContent = `
                @keyframes flash {
                    0%, 100% { background: linear-gradient(135deg, #e3f2fd, #f0f8ff); }
                    50% { background: linear-gradient(135deg, #ffecb3, #fff8e1); }
                }
            `;
            document.head.appendChild(style);
        }

        async function testApiConnection() {
            // Legacy function - redirect to modal test
            testModalApiConnection();
        }

        // Main analysis functions
        async function generateSequenceMain() {
            if (!checkMCPConnection()) return;
            
            const prompt = document.getElementById('generatePrompt').value;
            const taxonomy = document.getElementById('taxonomy').value;
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const temperature = parseFloat(document.getElementById('temperature').value);
            
            // Get API configuration
            const apiConfig = getApiConfig();
            
            const params = {
                prompt: prompt,
                maxTokens: maxTokens,
                temperature: temperature,
                taxonomy: taxonomy || null,
                apiConfig: apiConfig
            };
            
            await executeAnalysis('evo2_generate_sequence', params, 'Generating DNA sequence...');
        }

        async function predictFunctionMain() {
            if (!checkMCPConnection()) return;
            
            const sequence = document.getElementById('predictSequence').value;
            const analysisType = document.getElementById('analysisType').value;
            const taxonomy = document.getElementById('taxonomy').value;
            
            if (!sequence) {
                showNotification('Please enter a DNA sequence for analysis.', 'error');
                return;
            }
            
            // Get API configuration
            const apiConfig = getApiConfig();
            
            const params = {
                sequence: sequence,
                analysisType: analysisType,
                taxonomy: taxonomy || null,
                apiConfig: apiConfig
            };
            
            await executeAnalysis('evo2_predict_function', params, 'Predicting function...');
        }

        async function designCrisprMain() {
            if (!checkMCPConnection()) return;
            
            const targetSequence = document.getElementById('crisprTarget').value;
            const casType = document.getElementById('casType').value;
            const guideLength = parseInt(document.getElementById('guideLength').value);
            
            if (!targetSequence) {
                showNotification('Please enter a target DNA sequence.', 'error');
                return;
            }
            
            // Get API configuration
            const apiConfig = getApiConfig();
            
            const params = {
                targetSequence: targetSequence,
                casType: casType,
                guideLength: guideLength,
                apiConfig: apiConfig
            };
            
            await executeAnalysis('evo2_design_crispr', params, 'Designing CRISPR system...');
        }

        async function optimizeSequenceMain() {
            if (!checkMCPConnection()) return;
            
            const sequence = document.getElementById('optimizeSequence').value;
            const optimizationGoal = document.getElementById('optimizationGoal').value;
            const targetOrganism = document.getElementById('targetOrganism').value;
            
            if (!sequence) {
                showNotification('Please enter a DNA sequence to optimize.', 'error');
                return;
            }
            
            // Get API configuration
            const apiConfig = getApiConfig();
            
            const params = {
                sequence: sequence,
                optimizationGoal: optimizationGoal,
                targetOrganism: targetOrganism || null,
                apiConfig: apiConfig
            };
            
            await executeAnalysis('evo2_optimize_sequence', params, 'Optimizing sequence...');
        }

        async function analyzeEssentialityMain() {
            if (!checkMCPConnection()) return;
            
            const sequence = document.getElementById('essentialitySequence').value;
            const resolution = document.getElementById('resolution').value;
            const organism = document.getElementById('organism').value;
            
            if (!sequence) {
                showNotification('Please enter a DNA sequence for analysis.', 'error');
                return;
            }
            
            // Get API configuration
            const apiConfig = getApiConfig();
            
            const params = {
                sequence: sequence,
                resolution: resolution,
                organism: organism || null,
                apiConfig: apiConfig
            };
            
            await executeAnalysis('evo2_analyze_essentiality', params, 'Analyzing essentiality...');
        }

        // Core analysis execution
        async function executeAnalysis(toolName, params, loadingMessage) {
            showLoading(loadingMessage);
            
            try {
                const result = await callMCPTool(toolName, params);
                
                hideLoading();
                displayResults(result, toolName);
                await addToHistory(toolName, params, result);
                
            } catch (error) {
                hideLoading();
                console.error(`Analysis failed for ${toolName}:`, error);
                
                // Show appropriate error message
                let errorMessage = `Analysis failed: ${error.message}`;
                if (error.message.includes('not configured')) {
                    errorMessage += '\n\nPlease configure your NVIDIA API key first.';
                    setTimeout(() => {
                        openConfigModal();
                    }, 2000);
                }
                
                showNotification(errorMessage, 'error');
                showMessage(errorMessage, 'error');
            }
        }

        // MCP Tool calling
        async function callMCPTool(toolName, parameters) {
            // Debug logging
            console.log('=== EVO2 FRONTEND: CALLING MCP TOOL ===');
            console.log('Tool name:', toolName);
            console.log('Parameters:', parameters);
            console.log('API Config present:', !!parameters.apiConfig);
            if (parameters.apiConfig) {
                console.log('API Config details:', {
                    hasKey: !!parameters.apiConfig.key,
                    hasUrl: !!parameters.apiConfig.url,
                    url: parameters.apiConfig.url
                });
            }
            
            const response = await fetch('http://localhost:3000/execute-tool', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    toolName: toolName,
                    parameters: parameters,
                    clientId: 'evo2-designer'
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error);
            }
            
            console.log('=== EVO2 FRONTEND: MCP TOOL CALL COMPLETE ===');
            return data.result;
        }

        // Results display
        function displayResults(result, toolName) {
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsArea.style.display = 'block';
            resultsContent.innerHTML = formatResults(result, toolName);
            
            // Scroll to results
            resultsArea.scrollIntoView({ behavior: 'smooth' });
        }

        function formatResults(result, toolName) {
            let html = '<div class="result-item">';
            html += `<div class="result-header">`;
            html += `<h4>${getToolDisplayName(toolName)}</h4>`;
            html += `<span class="result-type">${toolName.replace('evo2_', '').toUpperCase()}</span>`;
            html += `</div>`;
            
            // Show simulation warning if applicable
            if (result.usingSimulation || result.metadata?.usingSimulation) {
                html += `<div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 12px; margin-bottom: 15px; color: #856404;">
                    <strong>⚠️ Simulation Mode:</strong> Using simulated response (API not configured or unavailable)
                </div>`;
            }
            
            // Main content based on tool type
            if (toolName === 'evo2_generate_sequence') {
                html += `<div class="sequence-display">${result.sequence}</div>`;
                html += '<div class="metadata">';
                html += `<div class="metadata-item"><div class="metadata-label">Length</div><div class="metadata-value">${result.sequence.length} bp</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Temperature</div><div class="metadata-value">${result.metadata.temperature}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Model</div><div class="metadata-value">${result.metadata.model}</div></div>`;
                html += '</div>';
            } else if (toolName === 'evo2_predict_function') {
                html += `<div class="sequence-display">${result.prediction}</div>`;
                html += '<div class="metadata">';
                html += `<div class="metadata-item"><div class="metadata-label">Analysis Type</div><div class="metadata-value">${result.analysisType}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Confidence</div><div class="metadata-value">${result.confidence}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Input Length</div><div class="metadata-value">${result.inputSequence.length} bp</div></div>`;
                html += '</div>';
            } else if (toolName === 'evo2_design_crispr') {
                html += `<div class="sequence-display">${result.design}</div>`;
                html += '<div class="metadata">';
                html += `<div class="metadata-item"><div class="metadata-label">Cas Type</div><div class="metadata-value">${result.casType}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Guide RNA</div><div class="metadata-value">${result.components.guideRNA}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">PAM Site</div><div class="metadata-value">${result.components.pamSite || 'N/A'}</div></div>`;
                html += `<div class="metadata-item"><div class="metadata-label">Efficiency</div><div class="metadata-value">${result.components.efficiency}</div></div>`;
                html += '</div>';
            }
            
            html += `<div style="margin-top: 15px; font-size: 12px; color: #6c757d;">`;
            html += `Generated on ${new Date(result.generatedAt || result.analyzedAt || Date.now()).toLocaleString()}`;
            html += `</div>`;
            html += '</div>';
            
            return html;
        }

        function getToolDisplayName(toolName) {
            const names = {
                'evo2_generate_sequence': 'DNA Sequence Generation',
                'evo2_predict_function': 'Function Prediction',
                'evo2_design_crispr': 'CRISPR Design',
                'evo2_optimize_sequence': 'Sequence Optimization',
                'evo2_analyze_essentiality': 'Essentiality Analysis'
            };
            return names[toolName] || toolName;
        }

        // History management
        async function addToHistory(toolName, params, result) {
            const historyItem = {
                toolName: toolName,
                timestamp: Date.now(),
                params: params,
                result: result
            };
            
            analysisHistory.unshift(historyItem);
            analysisHistory = analysisHistory.slice(0, 10); // Keep last 10
            
            try {
                if (typeof require !== 'undefined') {
                    const { ipcRenderer } = require('electron');
                    const result = await ipcRenderer.invoke('evo2-set-analysis-history', analysisHistory);
                    if (result.success) {
                        console.log('Evo2 analysis history saved to ConfigManager');
                    } else {
                        console.error('Failed to save analysis history:', result.error);
                        // Fallback to localStorage
                        localStorage.setItem('evo2_analysis_history', JSON.stringify(analysisHistory));
                    }
                } else {
                    // Fallback to localStorage if not in Electron environment
                    localStorage.setItem('evo2_analysis_history', JSON.stringify(analysisHistory));
                }
            } catch (error) {
                console.error('Error saving analysis history:', error);
                // Fallback to localStorage
                localStorage.setItem('evo2_analysis_history', JSON.stringify(analysisHistory));
            }
            
            updateHistoryDisplay();
        }

        async function loadAnalysisHistory() {
            try {
                if (typeof require !== 'undefined') {
                    const { ipcRenderer } = require('electron');
                    const history = await ipcRenderer.invoke('evo2-get-analysis-history');
                    analysisHistory = history || [];
                    console.log('Evo2 analysis history loaded from ConfigManager:', analysisHistory.length, 'items');
                } else {
                    // Fallback to localStorage if not in Electron environment
                    const stored = localStorage.getItem('evo2_analysis_history');
                    if (stored) {
                        analysisHistory = JSON.parse(stored);
                        console.log('Evo2 analysis history loaded from localStorage (fallback):', analysisHistory.length, 'items');
                    } else {
                        analysisHistory = [];
                    }
                }
                updateHistoryDisplay();
            } catch (error) {
                console.error('Error loading analysis history:', error);
                // Fallback to localStorage
                const stored = localStorage.getItem('evo2_analysis_history');
                if (stored) {
                    analysisHistory = JSON.parse(stored);
                } else {
                    analysisHistory = [];
                }
                updateHistoryDisplay();
            }
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            
            if (analysisHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #6c757d; font-style: italic;">No recent analysis</p>';
                return;
            }
            
            let html = '';
            analysisHistory.slice(0, 5).forEach(item => {
                html += `<div style="padding: 8px; border-bottom: 1px solid #e9ecef; cursor: pointer;" 
                              onclick="loadHistoryItem('${item.timestamp}')">`;
                html += `<div style="font-weight: 600; font-size: 12px;">${getToolDisplayName(item.toolName)}</div>`;
                html += `<div style="font-size: 11px; color: #6c757d;">${new Date(item.timestamp).toLocaleString()}</div>`;
                html += `</div>`;
            });
            
            historyList.innerHTML = html;
        }

        function loadHistoryItem(timestamp) {
            const item = analysisHistory.find(h => h.timestamp == timestamp);
            if (item) {
                displayResults(item.result, item.toolName);
            }
        }

        // Utility functions
        function showLoading(message) {
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsArea.style.display = 'block';
            resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        function hideLoading() {
            // Results will be replaced by actual content
        }

        function showMessage(message, type) {
            const className = type === 'success' ? 'success-message' : 'error-message';
            const resultsArea = document.getElementById('resultsArea');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsArea.style.display = 'block';
            resultsContent.innerHTML = `<div class="${className}">${message}</div>`;
        }

        // Enhanced notification system for menu actions
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                padding: 12px 20px; border-radius: 6px; color: white;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                font-size: 14px; font-weight: 500; max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            
            // Set background color based on type
            const colors = {
                success: '#10B981',
                error: '#EF4444', 
                warning: '#F59E0B',
                info: '#3B82F6'
            };
            notification.style.backgroundColor = colors[type] || colors.info;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            requestAnimationFrame(() => {
                notification.style.transform = 'translateX(0)';
            });
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function setPrompt(sequence) {
            document.getElementById('generatePrompt').value = sequence;
        }

        function loadExample(mode) {
            switchMode(mode);
            
            const examples = {
                generate: {
                    prompt: 'ATGAAATCGATC',
                    maxTokens: 500
                },
                predict: {
                    sequence: 'ATGAAATCGATCGCCTACGGCGTGAAAGACGATATCCCGCGTGAAGAGTAG'
                },
                crispr: {
                    targetSequence: 'ATGAAATCGATCGCCTACGGCGTGAAAGACGATATCCCGCGTGAAGAGTAG'
                },
                optimize: {
                    sequence: 'ATGAAATCGATCGCCTACGGCGTGAAAGACGATATCCCGCGTGAAGAGTAG',
                    goal: 'expression'
                }
            };
            
            const example = examples[mode];
            if (!example) return;
            
            if (mode === 'generate') {
                document.getElementById('generatePrompt').value = example.prompt;
                document.getElementById('maxTokens').value = example.maxTokens;
                document.getElementById('maxTokensValue').textContent = example.maxTokens;
            } else if (mode === 'predict') {
                document.getElementById('predictSequence').value = example.sequence;
            } else if (mode === 'crispr') {
                document.getElementById('crisprTarget').value = example.targetSequence;
            } else if (mode === 'optimize') {
                document.getElementById('optimizeSequence').value = example.sequence;
                document.getElementById('optimizationGoal').value = example.goal;
            }
        }

        function clearAll() {
            // Clear all form fields
            document.querySelectorAll('input, textarea, select').forEach(element => {
                if (element.id !== 'apiKey' && element.id !== 'apiUrl') {
                    if (element.type === 'range') {
                        element.value = element.defaultValue;
                        const valueDisplay = document.getElementById(element.id + 'Value');
                        if (valueDisplay) valueDisplay.textContent = element.defaultValue;
                    } else {
                        element.value = '';
                    }
                }
            });
            
            // Hide results
            document.getElementById('resultsArea').style.display = 'none';
        }

        // Legacy paste API key function - now redirects to modal
        async function pasteApiKey() {
            // Open config modal and focus on API key field
            openConfigModal();
            setTimeout(() => {
                pasteModalApiKey();
            }, 300);
        }

        // File Menu Functions
        function newProject() {
            if (confirm('Start a new project? This will clear all current data.')) {
                clearAll();
                switchMode('generate');
                showMessage('New project started', 'success');
            }
        }

        function openSequenceFile(filePath) {
            if (typeof require !== 'undefined') {
                const fs = require('fs');
                try {
                    const content = fs.readFileSync(filePath, 'utf8');
                    
                    // Try to parse as FASTA
                    if (content.startsWith('>')) {
                        const sequences = content.split('\n').filter(line => !line.startsWith('>')).join('');
                        pasteSequenceToCurrentInput(sequences);
                        showMessage(`Loaded FASTA file: ${filePath}`, 'success');
                    } else {
                        // Treat as plain text sequence
                        pasteSequenceToCurrentInput(content.trim());
                        showMessage(`Loaded sequence file: ${filePath}`, 'success');
                    }
                } catch (error) {
                    showMessage(`Error loading file: ${error.message}`, 'error');
                }
            }
        }

        async function importFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                pasteSequenceToCurrentInput(text);
                showMessage('Sequence imported from clipboard', 'success');
            } catch (error) {
                showMessage('Could not read from clipboard', 'error');
            }
        }

        function saveDesign() {
            const designData = {
                mode: window.currentMode || 'generate',
                timestamp: new Date().toISOString(),
                inputs: getCurrentInputs(),
                results: getCurrentResults(),
                config: getApiConfig()
            };
            
            const blob = new Blob([JSON.stringify(designData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `evo2-design-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showMessage('Design saved', 'success');
        }

        function saveAsDesign() {
            saveDesign(); // For now, same as save
        }

        function exportResults(format) {
            const results = getCurrentResults();
            if (!results || Object.keys(results).length === 0) {
                showMessage('No results to export', 'error');
                return;
            }

            let content = JSON.stringify(results, null, 2);
            let filename = `evo2-results-${Date.now()}.json`;

            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showMessage(`Results exported as ${format.toUpperCase()}`, 'success');
        }

        // Edit Menu Functions
        function performUndo() {
            showMessage('Undo not yet implemented', 'error');
        }

        function performRedo() {
            showMessage('Redo not yet implemented', 'error');
        }

        function copySelectedText() {
            const selection = window.getSelection().toString();
            if (selection) {
                navigator.clipboard.writeText(selection).then(() => {
                    showMessage('Text copied to clipboard', 'success');
                });
            } else {
                showMessage('No text selected', 'error');
            }
        }

        function pasteToFocusedElement() {
            navigator.clipboard.readText().then(text => {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                    activeElement.value = text;
                    activeElement.dispatchEvent(new Event('input'));
                    showMessage('Text pasted', 'success');
                }
            }).catch(() => {
                showMessage('Could not paste from clipboard', 'error');
            });
        }

        function cutSelectedText() {
            const selection = window.getSelection().toString();
            if (selection) {
                navigator.clipboard.writeText(selection).then(() => {
                    document.execCommand('delete');
                    showMessage('Text cut to clipboard', 'success');
                });
            } else {
                showMessage('No text selected', 'error');
            }
        }

        function selectAllInFocusedElement() {
            const activeElement = document.activeElement;
            if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                activeElement.select();
            } else {
                document.execCommand('selectAll');
            }
        }

        function copyCurrentSequence() {
            const sequence = getCurrentSequenceFromMode();
            if (sequence) {
                navigator.clipboard.writeText(sequence).then(() => {
                    showMessage('Sequence copied to clipboard', 'success');
                });
            } else {
                showMessage('No sequence to copy', 'error');
            }
        }

        function pasteSequenceToCurrentMode() {
            navigator.clipboard.readText().then(text => {
                pasteSequenceToCurrentInput(text);
                showMessage('Sequence pasted', 'success');
            }).catch(() => {
                showMessage('Could not paste sequence', 'error');
            });
        }

        function clearCurrentInput() {
            const currentInput = getCurrentModeInput();
            if (currentInput) {
                currentInput.value = '';
                currentInput.dispatchEvent(new Event('input'));
                showMessage('Input cleared', 'success');
            }
        }

        // Generation menu action functions - delegate to actual implementations
        function generateSequenceAction() {
            generateSequenceMain();
        }

        function predictFunctionAction() {
            predictFunctionMain();
        }

        function designCrisprAction() {
            designCrisprMain();
        }

        function optimizeSequenceAction() {
            optimizeSequenceMain();
        }

        function analyzeEssentialityAction() {
            analyzeEssentialityMain();
        }

        function stopCurrentGeneration() {
            showMessage('Generation stopped', 'info');
        }

        // Tools Menu Functions
        function focusApiConfiguration() {
            openConfigModal();
        }

        function testApiConnection() {
            const config = getApiConfig();
            if (!config.url || !config.key) {
                showMessage('Please configure API URL and key first', 'error');
                return;
            }

            showMessage('Testing API connection...', 'success');
        }

        function clearAnalysisHistory() {
            if (confirm('Are you sure you want to clear all analysis history?')) {
                analysisHistory = [];
                localStorage.removeItem('evo2_analysis_history');
                updateHistoryDisplay();
                showMessage('Analysis history cleared', 'success');
            }
        }

        // View Menu Functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar.style.display === 'none') {
                sidebar.style.display = 'block';
                mainContent.style.marginLeft = '320px';
            } else {
                sidebar.style.display = 'none';
                mainContent.style.marginLeft = '0';
            }
        }

        function toggleResultsPanel() {
            const resultsArea = document.getElementById('resultsArea');
            if (resultsArea) {
                resultsArea.style.display = resultsArea.style.display === 'none' ? 'block' : 'none';
            }
        }

        function showHistoryPanel() {
            const historySection = document.querySelector('.history-section');
            if (historySection) {
                historySection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Help Menu Functions
        function showUserGuide() {
            const guideContent = `
            <div style="padding: 20px; line-height: 1.6;">
                <h3>Evo2 Designer User Guide</h3>
                <p><strong>Getting Started:</strong></p>
                <ul>
                    <li>Configure your NVIDIA API credentials in the sidebar</li>
                    <li>Choose one of five analysis modes using the tabs</li>
                    <li>Input your sequence or parameters</li>
                    <li>Click the analyze button to start</li>
                </ul>
                <p><strong>Modes:</strong></p>
                <ul>
                    <li><strong>Generate:</strong> Create new DNA sequences</li>
                    <li><strong>Predict:</strong> Predict biological functions</li>
                    <li><strong>CRISPR:</strong> Design CRISPR-Cas systems</li>
                    <li><strong>Optimize:</strong> Optimize sequences for specific goals</li>
                    <li><strong>Essentiality:</strong> Analyze gene essentiality</li>
                </ul>
            </div>
            `;
            showDialog('User Guide', guideContent);
        }

        function showKeyboardShortcuts() {
            const shortcutsContent = `
            <div style="padding: 20px; line-height: 1.6;">
                <h3>Keyboard Shortcuts</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr style="border-bottom: 1px solid #ddd;"><th style="text-align: left; padding: 8px;">Action</th><th style="text-align: left; padding: 8px;">Shortcut</th></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">New Project</td><td style="padding: 6px;">Cmd/Ctrl+N</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Open File</td><td style="padding: 6px;">Cmd/Ctrl+O</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Save Design</td><td style="padding: 6px;">Cmd/Ctrl+S</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Copy</td><td style="padding: 6px;">Cmd/Ctrl+C</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Paste</td><td style="padding: 6px;">Cmd/Ctrl+V</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Generate Sequence</td><td style="padding: 6px;">Cmd/Ctrl+G</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Predict Function</td><td style="padding: 6px;">Cmd/Ctrl+P</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Design CRISPR</td><td style="padding: 6px;">Cmd/Ctrl+R</td></tr>
                    <tr style="border-bottom: 1px solid #eee;"><td style="padding: 6px;">Switch Modes</td><td style="padding: 6px;">1, 2, 3, 4, 5</td></tr>
                </table>
            </div>
            `;
            showDialog('Keyboard Shortcuts', shortcutsContent);
        }

        function showAbout() {
            const aboutContent = `
            <div style="padding: 20px; line-height: 1.6;">
                <h3>About Evo2 Designer</h3>
                                    <p><strong>Version:</strong> <span id="tool-version">1.0.0</span></p>
                <p><strong>Description:</strong> Advanced DNA sequence design tool powered by NVIDIA's Evo2 neural network.</p>
                <p><strong>Features:</strong></p>
                <ul>
                    <li>DNA sequence generation</li>
                    <li>Function prediction</li>
                    <li>CRISPR-Cas system design</li>
                    <li>Sequence optimization</li>
                    <li>Gene essentiality analysis</li>
                </ul>
                <p><strong>Technology:</strong> Built on NVIDIA's Evo2-40B model with StripedHyena architecture.</p>
                <p><strong>Developer:</strong> CodeXomics Team</p>
            </div>
            `;
            showDialog('About Evo2 Designer', aboutContent);
        }

        // Helper functions for menu actions
        function getCurrentInputs() {
            const mode = window.currentMode || 'generate';
            const inputs = {};
            
            if (mode === 'generate') {
                inputs.prompt = document.getElementById('generatePrompt')?.value || '';
                inputs.maxTokens = document.getElementById('maxTokens')?.value || '';
            } else if (mode === 'predict') {
                inputs.sequence = document.getElementById('predictSequence')?.value || '';
            } else if (mode === 'crispr') {
                inputs.targetSequence = document.getElementById('crisprTarget')?.value || '';
            }
            
            return inputs;
        }

        function getCurrentResults() {
            const resultsContent = document.getElementById('resultsContent');
            return resultsContent ? { html: resultsContent.innerHTML } : {};
        }

        function getCurrentSequenceFromMode() {
            const mode = window.currentMode || 'generate';
            
            if (mode === 'generate') {
                return document.getElementById('generatePrompt')?.value || '';
            } else if (mode === 'predict') {
                return document.getElementById('predictSequence')?.value || '';
            } else if (mode === 'crispr') {
                return document.getElementById('crisprTarget')?.value || '';
            }
            
            return '';
        }

        function pasteSequenceToCurrentInput(sequence) {
            const mode = window.currentMode || 'generate';
            
            if (mode === 'generate') {
                const input = document.getElementById('generatePrompt');
                if (input) {
                    input.value = sequence;
                    input.dispatchEvent(new Event('input'));
                }
            } else if (mode === 'predict') {
                const input = document.getElementById('predictSequence');
                if (input) {
                    input.value = sequence;
                    input.dispatchEvent(new Event('input'));
                }
            } else if (mode === 'crispr') {
                const input = document.getElementById('crisprTarget');
                if (input) {
                    input.value = sequence;
                    input.dispatchEvent(new Event('input'));
                }
            }
        }

        function getCurrentModeInput() {
            const mode = window.currentMode || 'generate';
            
            if (mode === 'generate') {
                return document.getElementById('generatePrompt');
            } else if (mode === 'predict') {
                return document.getElementById('predictSequence');
            } else if (mode === 'crispr') {
                return document.getElementById('crisprTarget');
            }
            
            return null;
        }

        function showDialog(title, content) {
            // Create a simple modal dialog
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: white; border-radius: 8px; max-width: 600px; 
                max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                           padding: 20px 20px 10px; border-bottom: 1px solid #eee;">
                    <h3 style="margin: 0;">${title}</h3>
                    <button onclick="this.closest('.overlay').remove()" 
                           style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div>${content}</div>
            `;
            
            overlay.className = 'overlay';
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Close on outside click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }
    </script>

    <!-- Configuration Modal -->
    <div id="configModal" class="config-overlay" style="display: none;">
        <div class="config-modal">
            <div class="config-modal-header">
                <h2>🔧 NVIDIA Evo2 API Configuration</h2>
                <button class="config-modal-close" onclick="closeConfigModal()">✕</button>
            </div>
            <div class="config-modal-body">
                <!-- Current Status -->
                <div class="config-status-display" id="modalConfigStatus">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <div class="status-indicator status-unconfigured" id="modalStatusIndicator"></div>
                            <strong id="modalStatusText">API Not Configured</strong>
                        </div>
                        <div style="font-size: 0.9em; color: #6c757d;" id="modalStatusDetail">
                            Configure your NVIDIA API credentials to enable Evo2 functionality
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="testModalApiConnection()" id="modalTestBtn">
                        🔗 Test Connection
                    </button>
                </div>

                <!-- API Key Configuration -->
                <div class="config-group">
                    <h4>🔑 NVIDIA API Key</h4>
                    <div class="description">
                        Get your API key from <a href="https://build.nvidia.com/arc/evo2-40b" target="_blank">NVIDIA AI Playground</a>. 
                        Your key will be stored securely in your browser's local storage.
                    </div>
                    <div class="api-key-container">
                        <input type="password" id="modalApiKey" class="form-control" 
                               placeholder="nvapi-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                        <button class="api-key-toggle" onclick="toggleApiKeyVisibility()" id="apiKeyToggle">
                            👁️
                        </button>
                        <button class="btn btn-secondary" onclick="pasteModalApiKey()" 
                                style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 8px 12px; font-size: 12px;">
                            📋 Paste
                        </button>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.85em; color: #6c757d;">
                        <span id="apiKeyStrength"></span>
                    </div>
                </div>

                <!-- API URL Configuration -->
                <div class="config-group">
                    <h4>🌐 API Endpoint</h4>
                    <div class="description">
                        The NVIDIA API base URL. You typically don't need to change this unless using a custom endpoint.
                    </div>
                    <input type="text" id="modalApiUrl" class="form-control" 
                           value="https://integrate.api.nvidia.com"
                           placeholder="https://integrate.api.nvidia.com">
                </div>

                <!-- Advanced Settings -->
                <div class="config-group">
                    <h4>⚡ Advanced Settings</h4>
                    <div class="description">
                        Configure additional parameters for API requests and model behavior.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div class="form-group">
                            <label for="defaultTimeout">Request Timeout (seconds)</label>
                            <input type="number" id="defaultTimeout" class="form-control" 
                                   value="60" min="10" max="300">
                        </div>
                        <div class="form-group">
                            <label for="maxRetries">Max Retries</label>
                            <input type="number" id="maxRetries" class="form-control" 
                                   value="3" min="0" max="10">
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" id="enableDebugMode" style="margin-right: 8px;">
                            Enable debug mode (detailed logging)
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="config-actions">
                    <button class="btn btn-secondary" onclick="resetConfigToDefaults()">
                        🔄 Reset to Defaults
                    </button>
                    <button class="btn btn-secondary" onclick="closeConfigModal()">
                        Cancel
                    </button>
                    <button class="btn" onclick="saveModalConfig()">
                        💾 Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 