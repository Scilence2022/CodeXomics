<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InterPro Domain Analysis - Genome AI Studio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #7bb3f0;
            --success-color: #4caf50;
            --bg-primary: #f8fafb;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --border-color: #e1e8ed;
            --radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.15);
            
            /* Enhanced color palette for different feature types */
            --color-domain: #667eea;
            --color-family: #f093fb;
            --color-repeat: #4facfe;
            --color-site: #43e97b;
            --color-signal: #fa709a;
            --color-transmembrane: #fee140;
            --color-coiled: #a8edea;
            --color-binding: #ffecd2;
            --color-kinase: #ff9a8b;
            --color-zinc: #a1c4fd;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            color: var(--text-primary);
            padding: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .app-title i {
            font-size: 2.2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 8px;
        }

        .title-text h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .title-text p {
            font-size: 1rem;
            opacity: 0.7;
            color: var(--text-primary);
        }

        .mcp-connect-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .mcp-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
        }

        .mcp-connect-btn.connected {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .mcp-connect-btn.connecting {
            background: linear-gradient(135deg, #ff9800, #ffc107);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .mcp-connect-btn.disconnected {
            background: linear-gradient(135deg, #f44336, #e57373);
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .main-container {
            display: flex;
            min-height: calc(100vh - 120px);
            max-width: 1400px;
            margin: 0 auto;
            gap: 24px;
            padding: 24px;
        }

        .sidebar {
            width: 380px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            overflow-y: auto;
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        .content-area {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 28px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            font-size: 1.3rem;
            padding: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 14px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            width: 100%;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.4);
        }

        .btn-secondary {
            background: rgba(74, 144, 226, 0.1);
            color: var(--primary-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Enhanced Results Display */
        .results-header {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .results-header h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .source-info {
            padding: 16px 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .source-info.real {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border: 1px solid #17a2b8;
            color: #0c5460;
        }

        .source-info.simulated {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            color: #856404;
        }

        .source-info i {
            font-size: 1.2rem;
        }

        /* Enhanced Statistics Grid */
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-detail {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Enhanced Domain Cards */
        .domain-card {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .domain-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--domain-color, var(--primary-color));
            transition: width 0.3s ease;
        }

        .domain-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }

        .domain-card:hover::before {
            width: 8px;
        }

        .domain-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .domain-id {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.2rem;
            line-height: 1.3;
        }

        .domain-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .domain-position {
            background: linear-gradient(135deg, #e2e8f0, #cbd5e0);
            padding: 12px 16px;
            border-radius: var(--radius);
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-indicator {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            flex-shrink: 0;
        }

        .domain-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin: 16px 0;
            padding: 16px;
            background: rgba(74, 144, 226, 0.05);
            border-radius: var(--radius);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .domain-description {
            margin: 16px 0;
            padding: 16px;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-radius: var(--radius);
            font-size: 0.95rem;
            line-height: 1.6;
            color: #475569;
            border-left: 4px solid var(--primary-color);
        }

        .sequence-display {
            margin: 16px 0;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: #e2e8f0;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 0.85rem;
            line-height: 1.8;
            overflow-x: auto;
            border: 1px solid #475569;
        }

        .external-links {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .external-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .external-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .go-terms {
            margin-top: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border-radius: var(--radius);
            border: 1px solid #0ea5e9;
        }

        .go-terms-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .go-term {
            display: inline-block;
            padding: 4px 10px;
            margin: 4px 6px 4px 0;
            background: rgba(14, 165, 233, 0.1);
            border: 1px solid rgba(14, 165, 233, 0.3);
            border-radius: 16px;
            font-size: 0.8rem;
            color: #0369a1;
            font-weight: 500;
        }

        /* Enhanced Domain Visualization */
        .domain-visualization {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: var(--radius);
            padding: 24px;
            margin: 20px 0;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .visualization-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .visualization-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sequence-length {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .domain-track {
            height: 40px;
            background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
            border-radius: 20px;
            position: relative;
            margin: 16px 0;
            border: 2px solid #cbd5e0;
            overflow: hidden;
        }

        .domain-region {
            position: absolute;
            height: 100%;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .domain-region:hover {
            transform: scaleY(1.3);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .domain-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: white;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .legend-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Results Controls */
        .results-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 24px 0;
            padding: 16px 20px;
            background: rgba(74, 144, 226, 0.05);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .results-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .controls-group {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: white;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .view-toggle {
            display: flex;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .view-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Loading and Empty States */
        .loading-state {
            text-align: center;
            padding: 60px 40px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 144, 226, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        .loading-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .loading-message {
            font-size: 1rem;
            color: #64748b;
            max-width: 400px;
            margin: 0 auto;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            opacity: 0.3;
            color: var(--primary-color);
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .empty-message {
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 16px;
            }
            
            .sidebar {
                width: 100%;
                position: static;
            }
            
            .statistics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .domain-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-content">
            <div class="app-title">
                <i class="fas fa-puzzle-piece"></i>
                <div class="title-text">
                    <h1>InterPro Domain Analysis</h1>
                    <p>Protein Domain and Family Classification</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <button id="mcpConnectBtn" class="mcp-connect-btn">
                    <i class="fas fa-plug"></i>
                    <span>Connect MCP</span>
                </button>
                <div id="connectionStatus" style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px;">
                    <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ffa500;"></div>
                    <div style="color: white; font-size: 0.9rem;">
                        <div id="statusText">Connecting to MCP Server...</div>
                        <div id="statusDetails" style="font-size: 0.8rem; opacity: 0.8;">InterPro API Integration</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-upload"></i>
                    Input Sequence
                </div>
                
                <div style="position: relative;">
                    <textarea class="form-control" id="sequenceInput" placeholder="Enter protein sequence in FASTA format or raw sequence..." rows="8"></textarea>
                    <button class="btn btn-secondary" id="pasteBtn" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-paste"></i>
                        Paste
                    </button>
                </div>
                
                <div class="form-section">
                    <div class="section-title">
                        <i class="fas fa-cogs"></i>
                        Analysis Parameters
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label">E-value Threshold</label>
                            <select class="form-control" id="evalueThreshold">
                                <option value="0.01">0.01 (Stringent)</option>
                                <option value="0.1" selected>0.1 (Moderate)</option>
                                <option value="1.0">1.0 (Relaxed)</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Min Domain Length</label>
                            <select class="form-control" id="minDomainLength">
                                <option value="10">10 AA</option>
                                <option value="20" selected>20 AA</option>
                                <option value="50">50 AA</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="includeSignalPeptide" checked> Include Signal Peptide Prediction
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label class="form-label">
                            <input type="checkbox" id="includeTransmembrane" checked> Include Transmembrane Region Prediction
                        </label>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="analyzeBtn">
                    <i class="fas fa-search"></i>
                    Analyze Domains
                </button>
            </div>

            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-bolt"></i>
                    Quick Actions
                </div>

                <button class="btn btn-primary" id="exampleBtn" style="margin-bottom: 10px;">
                    <i class="fas fa-flask"></i>
                    Load Example
                </button>

                <button class="btn btn-primary" id="clearBtn">
                    <i class="fas fa-trash"></i>
                    Clear Results
                </button>
            </div>
        </div>

        <div class="content-area">
            <div id="loadingIndicator" style="display: none;" class="loading-state">
                <div class="loading-spinner"></div>
                <div class="loading-title">Analyzing Protein Domains...</div>
                <div class="loading-message" id="analysisProgress">Initializing domain analysis...</div>
            </div>
            
            <div id="resultsContainer">
                <div class="empty-state">
                    <i class="fas fa-puzzle-piece empty-icon"></i>
                    <div class="empty-title">No Domain Analysis Results</div>
                    <div class="empty-message">Enter a protein sequence and click "Analyze Domains" to identify protein domains and functional sites.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="tool-menu-handler.js"></script>
    <script>
        class InterProAnalyzer {
            constructor() {
                this.currentResults = [];
                this.mcpClient = null;
                this.isConnected = false;
                this.domainDatabase = this.initializeDomainDatabase();
                this.init();
                this.initMenuHandler();
                this.initializeMCPConnection();
            }

            initializeDomainDatabase() {
                return {
                    // Common protein domains with their sequence patterns and signatures
                    'DNA_BINDING': {
                        patterns: ['KRKR', 'RKRK', 'KRQR', 'RRRR', 'KKKK'],
                        features: ['high lysine/arginine content', 'basic region'],
                        description: 'DNA-binding domain with basic residues for nucleic acid interaction'
                    },
                    'ZINC_FINGER': {
                        patterns: ['C.*C.*H.*H', 'C.*H.*C.*H', 'CYS.*CYS.*HIS.*HIS'],
                        features: ['cysteine-histidine coordination', 'metal binding'],
                        description: 'Zinc finger domain for DNA/RNA binding'
                    },
                    'HELIX_TURN_HELIX': {
                        patterns: ['[RK].[RK]', 'TAQL', 'VTLQ'],
                        features: ['helix-turn-helix motif', 'transcription factor'],
                        description: 'Helix-turn-helix DNA-binding motif'
                    },
                    'SIGNAL_PEPTIDE': {
                        patterns: ['M[GAVLI]', '^M.*[GAVLI]{5,}'],
                        features: ['N-terminal location', 'hydrophobic core'],
                        description: 'Signal peptide for protein targeting'
                    },
                    'TRANSMEMBRANE': {
                        patterns: ['[GAVLIFYW]{15,25}'],
                        features: ['hydrophobic residues', 'membrane spanning'],
                        description: 'Transmembrane domain'
                    },
                    'IMMUNOGLOBULIN': {
                        patterns: ['SSGDK', 'GGPS', 'CDTLM'],
                        features: ['beta-strand structure', 'antibody domain'],
                        description: 'Immunoglobulin fold domain'
                    },
                    'KINASE': {
                        patterns: ['DFG', 'APE', 'VAIK', 'HRD'],
                        features: ['ATP binding', 'phosphorylation'],
                        description: 'Protein kinase domain'
                    },
                    'EGF_LIKE': {
                        patterns: ['C.*C.*C.*C.*C.*C', 'EGF'],
                        features: ['epidermal growth factor-like', 'extracellular'],
                        description: 'EGF-like domain'
                    },
                    'ANKYRIN': {
                        patterns: ['TPLH', 'GADVNA'],
                        features: ['ankyrin repeat', 'protein-protein interaction'],
                        description: 'Ankyrin repeat domain'
                    },
                    'LEUCINE_ZIPPER': {
                        patterns: ['L.*L.*L.*L', '[IL].*[IL].*[IL].*[IL]'],
                        features: ['leucine zipper', 'dimerization'],
                        description: 'Leucine zipper dimerization domain'
                    }
                };
            }

            init() {
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeDomains());
                document.getElementById('exampleBtn').addEventListener('click', () => this.loadExample());
                document.getElementById('clearBtn').addEventListener('click', () => this.clearResults());
                document.getElementById('pasteBtn').addEventListener('click', () => this.pasteFromClipboard());
                document.getElementById('mcpConnectBtn').addEventListener('click', () => this.toggleMCPConnection());
            }

            initMenuHandler() {
                // Initialize menu handler with tool-specific actions
                this.menuHandler = new ToolMenuHandler('InterPro Domain Analysis', this);
            }

            toggleMCPConnection() {
                const btn = document.getElementById('mcpConnectBtn');
                const icon = btn.querySelector('i');
                const text = btn.querySelector('span');

                if (this.isConnected) {
                    // Disconnect
                    this.disconnectMCP();
                    btn.className = 'mcp-connect-btn disconnected';
                    icon.className = 'fas fa-plug';
                    text.textContent = 'Connect MCP';
                } else {
                    // Connect
                    btn.className = 'mcp-connect-btn connecting';
                    icon.className = 'fas fa-spinner fa-spin';
                    text.textContent = 'Connecting...';
                    this.initializeMCPConnection();
                }
            }

            disconnectMCP() {
                this.isConnected = false;
                this.mcpClient = null;
                this.updateConnectionStatus('disconnected', 'Disconnected from MCP Server', 'Click Connect MCP to reconnect');
            }

            updateMCPButtonState(connected) {
                const btn = document.getElementById('mcpConnectBtn');
                const icon = btn.querySelector('i');
                const text = btn.querySelector('span');

                if (connected) {
                    btn.className = 'mcp-connect-btn connected';
                    icon.className = 'fas fa-check-circle';
                    text.textContent = 'MCP Connected';
                } else {
                    btn.className = 'mcp-connect-btn disconnected';
                    icon.className = 'fas fa-plug';
                    text.textContent = 'Connect MCP';
                }
            }

            async initializeMCPConnection() {
                try {
                    this.updateConnectionStatus('connecting', 'Connecting to MCP Server...', 'Attempting InterPro API connection');
                    
                    // Connect to MCP WebSocket server
                    this.mcpClient = new WebSocket('ws://localhost:3001');
                    
                    this.mcpClient.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus('connected', 'Connected to MCP Server', 'Real InterPro API access enabled');
                        this.showToast('Connected to MCP Server. Real InterPro API access enabled.', 'success');
                    };
                    
                    this.mcpClient.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('Received MCP message:', data.type);
                            // WebSocket connection is maintained for status only
                            // Analysis requests now use HTTP endpoint
                        } catch (error) {
                            console.error('Error parsing MCP message:', error);
                        }
                    };
                    
                    this.mcpClient.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus('disconnected', 'Offline Mode', 'Using local domain patterns');
                        this.showToast('Disconnected from MCP Server. Using offline mode.', 'warning');
                    };
                    
                    this.mcpClient.onerror = (error) => {
                        this.isConnected = false;
                        this.updateConnectionStatus('error', 'Connection Failed', 'Using offline mode');
                        this.showToast('MCP Server connection failed. Using offline mode.', 'warning');
                    };
                    
                } catch (error) {
                    this.isConnected = false;
                    this.updateConnectionStatus('error', 'Connection Failed', 'Using offline mode');
                    this.showToast('Failed to connect to MCP Server. Using offline mode.', 'warning');
                }
            }

            updateConnectionStatus(status, text, details) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const statusDetails = document.getElementById('statusDetails');
                
                const colors = {
                    connecting: '#ffa500',  // orange
                    connected: '#4caf50',   // green
                    disconnected: '#ff9800', // amber
                    error: '#f44336'        // red
                };
                
                if (indicator) indicator.style.background = colors[status] || '#666';
                if (statusText) statusText.textContent = text;
                if (statusDetails) statusDetails.textContent = details;
                
                // Update MCP button state based on connection status
                this.updateMCPButtonState(status === 'connected');
                
                // Update isConnected flag
                this.isConnected = (status === 'connected');
            }


            
            getColorForDomain(domain) {
                // Use domain color if provided, otherwise generate one based on type/database
                if (domain.color) return domain.color;
                
                // Enhanced color scheme with modern gradients
                const typeColors = {
                    'Domain': 'linear-gradient(135deg, #667eea, #764ba2)',
                    'Family': 'linear-gradient(135deg, #f093fb, #f5576c)',
                    'Repeat': 'linear-gradient(135deg, #4facfe, #00f2fe)',
                    'Site': 'linear-gradient(135deg, #43e97b, #38f9d7)',
                    'Coiled coil': 'linear-gradient(135deg, #a8edea, #fed6e3)',
                    'Signal': 'linear-gradient(135deg, #fa709a, #fee140)',
                    'Transmembrane': 'linear-gradient(135deg, #fee140, #fa709a)',
                    'Binding': 'linear-gradient(135deg, #ffecd2, #fcb69f)',
                    'Kinase': 'linear-gradient(135deg, #ff9a8b, #a8edea)',
                    'Zinc finger': 'linear-gradient(135deg, #a1c4fd, #c2e9fb)',
                    'DNA-binding': 'linear-gradient(135deg, #667eea, #764ba2)',
                    'Helix-turn-helix': 'linear-gradient(135deg, #9c88ff, #7c4dff)',
                    'Immunoglobulin': 'linear-gradient(135deg, #4facfe, #00f2fe)',
                    'EGF-like': 'linear-gradient(135deg, #43e97b, #38f9d7)',
                    'Ankyrin': 'linear-gradient(135deg, #a8edea, #fed6e3)',
                    'Leucine zipper': 'linear-gradient(135deg, #ffecd2, #fcb69f)'
                };
                
                const dbColors = {
                    'Pfam': 'linear-gradient(135deg, #667eea, #764ba2)',
                    'SMART': 'linear-gradient(135deg, #4facfe, #00f2fe)', 
                    'PROSITE': 'linear-gradient(135deg, #fee140, #fa709a)',
                    'PANTHER': 'linear-gradient(135deg, #9c88ff, #7c4dff)',
                    'PRINTS': 'linear-gradient(135deg, #ff9a8b, #a8edea)',
                    'InterPro': 'linear-gradient(135deg, #667eea, #764ba2)',
                    'SignalP': 'linear-gradient(135deg, #fa709a, #fee140)',
                    'TMHMM': 'linear-gradient(135deg, #fee140, #fa709a)'
                };
                
                // Return solid colors for visualization track, gradients for cards
                const solidColors = {
                    'Domain': '#667eea',
                    'Family': '#f093fb',
                    'Repeat': '#4facfe',
                    'Site': '#43e97b',
                    'Coiled coil': '#a8edea',
                    'Signal': '#fa709a',
                    'Transmembrane': '#fee140',
                    'Binding': '#ffecd2',
                    'Kinase': '#ff9a8b',
                    'Zinc finger': '#a1c4fd',
                    'DNA-binding': '#667eea',
                    'Helix-turn-helix': '#9c88ff',
                    'Immunoglobulin': '#4facfe',
                    'EGF-like': '#43e97b',
                    'Ankyrin': '#a8edea',
                    'Leucine zipper': '#ffecd2'
                };
                
                // For visualization tracks, use solid colors
                if (domain.forVisualization) {
                    return solidColors[domain.type] || solidColors[domain.name] || '#667eea';
                }
                
                // For cards and other elements, use gradients
                return typeColors[domain.type] || typeColors[domain.name] || dbColors[domain.database] || 'linear-gradient(135deg, #667eea, #764ba2)';
            }

            async pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text.trim()) {
                        document.getElementById('sequenceInput').value = text;
                        this.showToast('✅ Sequence pasted from clipboard', 'success');
                    } else {
                        this.showToast('⚠️ Clipboard is empty', 'warning');
                    }
                } catch (err) {
                    this.showToast('❌ Could not access clipboard. Please paste manually (Ctrl+V)', 'error');
                }
            }

            loadExample() {
                document.getElementById('sequenceInput').value = `>P04637|TP53_HUMAN Cellular tumor antigen p53
MEEPQSDPSVEPPLSQETFSDLWKLLPENNVLSPLPSQAMDDLMLSPDDIEQWFTEDPGPDEAPRMPEAAPPVAPAPAAPTPAAPAPAPSWPLSSSVPSQKTYQGSYGFRLGFLHSGTAKSVTCTYSPALNKMFCQLAKTCPVQLWVDSTPPPGTRVRAMAIYKQSQHMTEVVRRCPHHERCSDSDGLAPPQHLIRVEGNLRVEYLDDRNTFRHSVVVPYEPPEVGSDCTTIHYNYMCNSSCMGGMNRRPILTIITLEDSSGNLLGRNSFEVRVCACPGRDRRTEEENLRKKGEPHHELPPGSTKRALPNNTSSSPQPKKKPLDGEYFTLQIRGRERFEMFRELNEALELKDAQAGKEPGGSRAHSSHLKSKKGQSTSRHKKLMFKTEGPDSD`;
            }

            clearResults() {
                document.getElementById('resultsContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-puzzle-piece empty-icon"></i>
                        <div class="empty-title">No Domain Analysis Results</div>
                        <div class="empty-message">Enter a protein sequence and click "Analyze Domains" to identify protein domains and functional sites.</div>
                    </div>
                `;
            }

            async analyzeDomains() {
                const sequence = document.getElementById('sequenceInput').value.trim();
                if (!sequence) {
                    this.showToast('Please enter a protein sequence.', 'error');
                    return;
                }

                // Clean and validate sequence
                const cleanSeq = this.cleanSequence(sequence);
                if (!this.validateSequence(cleanSeq)) {
                    this.showToast('Invalid protein sequence. Please check for non-amino acid characters.', 'error');
                    return;
                }

                this.showLoading(true);
                this.updateProgress('Initializing domain analysis...');

                try {
                    if (this.isConnected && this.mcpClient) {
                        // Use real MCP Server API
                        await this.analyzeDomainsViaAPI(cleanSeq);
                    } else {
                        // Fallback to simulation
                        this.updateProgress('Using offline domain detection...');
                        await this.analyzeDomainsOffline(cleanSeq);
                    }
                } catch (error) {
                    console.error('Domain analysis error:', error);
                    this.showToast(`Analysis failed: ${error.message}`, 'error');
                    this.clearResults();
                    this.showLoading(false);
                }
            }

            async analyzeDomainsViaAPI(sequence) {
                // Get analysis parameters
                const includeSignalPeptide = document.getElementById('includeSignalPeptide').checked;
                const includeTransmembrane = document.getElementById('includeTransmembrane').checked;
                
                // Build applications list
                const applications = ['Pfam', 'SMART', 'PROSITE', 'PANTHER'];
                if (includeSignalPeptide) applications.push('SignalP');
                if (includeTransmembrane) applications.push('TMHMM');

                const analysisParams = {
                    sequence: sequence,
                    applications: applications,
                    goterms: true,
                    pathways: true,
                    includeMatchSequence: true
                };

                this.updateProgress('Submitting sequence to InterPro database...');

                try {
                    // Use HTTP request instead of WebSocket to bypass communication issues
                    const response = await fetch('http://localhost:3000/execute-tool', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            toolName: 'analyze_interpro_domains',
                            parameters: analysisParams
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.result) {
                        this.handleAPIResponse(data.result);
                    } else {
                        throw new Error(data.error || 'Unknown error occurred');
                    }
                } catch (error) {
                    console.error('HTTP API request failed:', error);
                    throw error;
                }
            }
            
            handleAPIResponse(result) {
                console.log('Handling API response:', result);
                
                const results = result.results || [];
                const summary = result.summary || {};
                const sequence = result.sequence || '';
                
                this.updateProgress('Processing results...');
                
                // Add visual properties to results
                const processedResults = results.map(domain => ({
                    ...domain,
                    color: this.getColorForDomain(domain)
                }));
                
                this.currentResults = processedResults;
                this.displayResults(processedResults, sequence, summary, result.simulated);
                
                const sourceNote = result.simulated ? ' (simulated analysis)' : ' from InterPro database';
                this.showToast(`Analysis complete! Found ${results.length} domain(s)${sourceNote}`, 'success');
                this.showLoading(false);
            }

            async analyzeDomainsOffline(cleanSeq) {
                const evalueThreshold = parseFloat(document.getElementById('evalueThreshold').value);
                const minDomainLength = parseInt(document.getElementById('minDomainLength').value);
                const includeSignalPeptide = document.getElementById('includeSignalPeptide').checked;
                const includeTransmembrane = document.getElementById('includeTransmembrane').checked;

                // Perform comprehensive domain analysis
                this.updateProgress('Analyzing sequence composition...');
                await this.delay(500);

                this.updateProgress('Searching for conserved domains...');
                const domains = await this.findConservedDomains(cleanSeq, evalueThreshold, minDomainLength);
                await this.delay(800);

                this.updateProgress('Predicting structural features...');
                const structuralFeatures = await this.predictStructuralFeatures(cleanSeq);
                await this.delay(600);

                let additionalFeatures = [];
                if (includeSignalPeptide) {
                    this.updateProgress('Analyzing signal peptides...');
                    const signalPeptides = await this.predictSignalPeptide(cleanSeq);
                    additionalFeatures = additionalFeatures.concat(signalPeptides);
                    await this.delay(400);
                }

                if (includeTransmembrane) {
                    this.updateProgress('Predicting transmembrane regions...');
                    const tmRegions = await this.predictTransmembrane(cleanSeq);
                    additionalFeatures = additionalFeatures.concat(tmRegions);
                    await this.delay(400);
                }

                this.updateProgress('Generating results...');
                await this.delay(300);

                const allFeatures = [...domains, ...structuralFeatures, ...additionalFeatures];
                this.displayResults(allFeatures, cleanSeq, {}, true);
                this.showToast(`Analysis complete (offline mode)! Found ${allFeatures.length} features.`, 'warning');
                this.showLoading(false);
            }

            cleanSequence(sequence) {
                // Remove FASTA header and whitespace
                return sequence.replace(/^>.*$/gm, '').replace(/\s/g, '').toUpperCase();
            }

            validateSequence(sequence) {
                // Check if sequence contains only valid amino acid characters
                const validAA = /^[ACDEFGHIKLMNPQRSTVWY]*$/;
                return validAA.test(sequence) && sequence.length > 10;
            }

            async findConservedDomains(sequence, evalueThreshold, minLength) {
                const domains = [];
                
                // Search for known domain patterns
                for (const [domainType, domainInfo] of Object.entries(this.domainDatabase)) {
                    for (const pattern of domainInfo.patterns) {
                        const regex = new RegExp(pattern, 'gi');
                        let match;
                        
                        while ((match = regex.exec(sequence)) !== null) {
                            const start = match.index + 1;
                            const end = match.index + match[0].length;
                            const length = end - start + 1;
                            
                            if (length >= minLength) {
                                // Calculate simulated e-value based on pattern complexity and length
                                const evalue = this.calculateEValue(match[0], pattern, sequence.length);
                                
                                if (evalue <= evalueThreshold) {
                                    domains.push({
                                        id: this.generateDomainId(domainType),
                                        name: domainType.replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase()),
                                        type: 'Domain',
                                        start: start,
                                        end: end,
                                        length: length,
                                        evalue: evalue.toExponential(2),
                                        score: Math.max(20, 100 - Math.log10(evalue) * 10),
                                        database: 'InterPro',
                                        description: domainInfo.description,
                                        features: domainInfo.features,
                                        sequence: match[0],
                                        color: this.getDomainColor(domainType)
                                    });
                                }
                            }
                        }
                    }
                }

                // Add some realistic domain predictions for common proteins
                if (sequence.includes('TP53') || sequence.includes('TUMOR') || sequence.length > 300) {
                    domains.push(this.generateTumorSuppressorDomains(sequence));
                }

                return domains.flat().sort((a, b) => a.start - b.start);
            }

            async predictStructuralFeatures(sequence) {
                const features = [];
                
                // Low complexity regions
                const lowComplexityRegions = this.findLowComplexityRegions(sequence);
                features.push(...lowComplexityRegions);
                
                // Coiled coils
                const coiledCoils = this.predictCoiledCoils(sequence);
                features.push(...coiledCoils);
                
                return features;
            }

            async predictSignalPeptide(sequence) {
                const features = [];
                
                // Simple signal peptide prediction based on N-terminal characteristics
                if (sequence.length > 20) {
                    const nTerminal = sequence.substring(0, 30);
                    const hydrophobicCount = (nTerminal.match(/[GAVLIFYWM]/g) || []).length;
                    const basicCount = (nTerminal.match(/[RK]/g) || []).length;
                    
                    if (hydrophobicCount >= 10 && basicCount >= 2 && sequence[0] === 'M') {
                        features.push({
                            id: 'SP001',
                            name: 'Signal Peptide',
                            type: 'Signal',
                            start: 1,
                            end: Math.min(25, sequence.length),
                            length: Math.min(25, sequence.length),
                            evalue: '0.001',
                            score: 85 + Math.random() * 10,
                            database: 'SignalP',
                            description: 'N-terminal signal peptide for protein targeting',
                            features: ['hydrophobic core', 'basic residues'],
                            color: '#ff9800'
                        });
                    }
                }
                
                return features;
            }

            async predictTransmembrane(sequence) {
                const features = [];
                const windowSize = 20;
                
                for (let i = 0; i <= sequence.length - windowSize; i++) {
                    const window = sequence.substring(i, i + windowSize);
                    const hydrophobicCount = (window.match(/[GAVLIFYW]/g) || []).length;
                    
                    if (hydrophobicCount >= 15) {
                        features.push({
                            id: `TM${features.length + 1}`,
                            name: 'Transmembrane Domain',
                            type: 'Transmembrane',
                            start: i + 1,
                            end: i + windowSize,
                            length: windowSize,
                            evalue: '0.01',
                            score: 70 + hydrophobicCount * 2,
                            database: 'TMHMM',
                            description: 'Transmembrane alpha-helix',
                            features: ['hydrophobic residues', 'membrane spanning'],
                            color: '#9c27b0'
                        });
                        i += windowSize - 1; // Skip overlapping windows
                    }
                }
                
                return features;
            }

            generateTumorSuppressorDomains(sequence) {
                const domains = [];
                
                // p53-like domains
                if (sequence.length > 200) {
                    domains.push({
                        id: 'IPR011615',
                        name: 'DNA-binding Domain, p53',
                        type: 'Domain',
                        start: Math.floor(sequence.length * 0.3),
                        end: Math.floor(sequence.length * 0.7),
                        length: Math.floor(sequence.length * 0.4),
                        evalue: '1.2e-45',
                        score: 95,
                        database: 'InterPro',
                        description: 'Core DNA-binding domain of p53 tumor suppressor',
                        features: ['DNA binding', 'zinc coordination'],
                        color: '#f44336'
                    });
                    
                    domains.push({
                        id: 'IPR010991',
                        name: 'p53 Tetramerisation Motif',
                        type: 'Domain',
                        start: Math.floor(sequence.length * 0.8),
                        end: Math.floor(sequence.length * 0.9),
                        length: Math.floor(sequence.length * 0.1),
                        evalue: '3.4e-12',
                        score: 78,
                        database: 'InterPro',
                        description: 'C-terminal tetramerisation domain',
                        features: ['protein oligomerization', 'beta-strand'],
                        color: '#2196f3'
                    });
                }
                
                return domains;
            }

            findLowComplexityRegions(sequence) {
                const regions = [];
                const windowSize = 25;
                
                for (let i = 0; i <= sequence.length - windowSize; i++) {
                    const window = sequence.substring(i, i + windowSize);
                    const uniqueAA = new Set(window).size;
                    
                    if (uniqueAA <= 5) { // Low complexity threshold
                        regions.push({
                            id: `LCR${regions.length + 1}`,
                            name: 'Low Complexity Region',
                            type: 'Low Complexity',
                            start: i + 1,
                            end: i + windowSize,
                            length: windowSize,
                            evalue: 'N/A',
                            score: 50,
                            database: 'SEG',
                            description: 'Region with biased amino acid composition',
                            features: ['low complexity', 'repetitive sequence'],
                            color: '#607d8b'
                        });
                        i += windowSize - 1;
                    }
                }
                
                return regions;
            }

            predictCoiledCoils(sequence) {
                const coils = [];
                // Simple coiled coil prediction based on heptad repeats
                const windowSize = 21; // 3 heptads
                
                for (let i = 0; i <= sequence.length - windowSize; i++) {
                    const window = sequence.substring(i, i + windowSize);
                    let heptadScore = 0;
                    
                    // Check for hydrophobic residues at positions a and d of heptad
                    for (let j = 0; j < window.length; j++) {
                        const pos = j % 7;
                        if ((pos === 0 || pos === 3) && /[GAVLIFYW]/.test(window[j])) {
                            heptadScore++;
                        }
                    }
                    
                    if (heptadScore >= 4) {
                        coils.push({
                            id: `CC${coils.length + 1}`,
                            name: 'Coiled Coil',
                            type: 'Coiled Coil',
                            start: i + 1,
                            end: i + windowSize,
                            length: windowSize,
                            evalue: '0.05',
                            score: 60 + heptadScore * 5,
                            database: 'COILS',
                            description: 'Alpha-helical coiled coil structure',
                            features: ['heptad repeat', 'protein-protein interaction'],
                            color: '#4caf50'
                        });
                        i += windowSize - 1;
                    }
                }
                
                return coils;
            }

            calculateEValue(match, pattern, seqLength) {
                // Simplified e-value calculation
                const patternComplexity = pattern.length + (pattern.match(/[.*+?^${}()|[\]\\]/g) || []).length;
                const matchLength = match.length;
                const dbSize = 1000000; // Simulated database size
                
                return (dbSize * Math.pow(0.25, matchLength)) / (patternComplexity + 1);
            }

            generateDomainId(domainType) {
                const prefixes = {
                    'DNA_BINDING': 'IPR',
                    'ZINC_FINGER': 'IPR',
                    'HELIX_TURN_HELIX': 'IPR',
                    'SIGNAL_PEPTIDE': 'SP',
                    'TRANSMEMBRANE': 'TM',
                    'IMMUNOGLOBULIN': 'IPR',
                    'KINASE': 'IPR',
                    'EGF_LIKE': 'IPR',
                    'ANKYRIN': 'IPR',
                    'LEUCINE_ZIPPER': 'IPR'
                };
                
                const prefix = prefixes[domainType] || 'IPR';
                const number = String(Math.floor(Math.random() * 99999)).padStart(5, '0');
                return `${prefix}${number}`;
            }

            getDomainColor(domainType) {
                const colors = {
                    'DNA_BINDING': '#667eea',
                    'ZINC_FINGER': '#a1c4fd',
                    'HELIX_TURN_HELIX': '#9c88ff',
                    'SIGNAL_PEPTIDE': '#fa709a',
                    'TRANSMEMBRANE': '#fee140',
                    'IMMUNOGLOBULIN': '#4facfe',
                    'KINASE': '#ff9a8b',
                    'EGF_LIKE': '#43e97b',
                    'ANKYRIN': '#a8edea',
                    'LEUCINE_ZIPPER': '#ffecd2',
                    'COILED_COIL': '#a8edea',
                    'BINDING': '#ffecd2',
                    'DOMAIN': '#667eea',
                    'FAMILY': '#f093fb',
                    'REPEAT': '#4facfe',
                    'SITE': '#43e97b'
                };
                
                return colors[domainType] || '#667eea';
            }

            displayResults(results, sequence, summary, simulated) {
                const container = document.getElementById('resultsContainer');
                
                if (!results.length) {
                    const noResultsSource = simulated ? '(offline mode)' : 'from InterPro database';
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search empty-icon"></i>
                            <div class="empty-title">No Domains Found</div>
                            <div class="empty-message">
                                No significant protein domains were detected ${noResultsSource}.<br>
                                Try adjusting your search parameters or check sequence quality.
                            </div>
                        </div>
                    `;
                    return;
                }

                // Generate domain visualization
                const visualization = this.generateDomainVisualization(results, sequence);
                
                // Generate statistics
                const stats = this.generateStatistics(results, sequence, summary, simulated);
                
                // Generate enhanced domain cards with new design
                const domainCards = results.map((domain, index) => {
                    const displayFeatures = domain.features ? 
                        (Array.isArray(domain.features) ? domain.features.join(', ') : domain.features) : 'N/A';
                    
                    // Get appropriate colors
                    const cardColor = this.getColorForDomain(domain);
                    const visualColor = this.getColorForDomain({...domain, forVisualization: true});
                    
                    return `
                        <div class="domain-card" style="--domain-color: ${visualColor};">
                            <div class="domain-header">
                                <div class="domain-id">${domain.id} - ${domain.name}</div>
                                <div class="domain-type-badge" style="background: ${cardColor}; color: white;">
                                    ${domain.type}
                                </div>
                            </div>
                            
                            <div class="domain-position">
                                <div class="color-indicator" style="background: ${visualColor};"></div>
                                <div>
                                    <strong>Position:</strong> ${domain.start}-${domain.end} 
                                    <span style="color: #64748b;">(${domain.length} AA)</span>
                                </div>
                            </div>
                            
                            <div class="domain-info">
                                <div class="info-item">
                                    <div class="info-label">E-value</div>
                                    <div class="info-value">${domain.evalue || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Score</div>
                                    <div class="info-value">${Math.round(domain.score || 0)}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Database</div>
                                    <div class="info-value">${domain.database}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Features</div>
                                    <div class="info-value">${displayFeatures}</div>
                                </div>
                            </div>
                            
                            ${domain.description ? `
                                <div class="domain-description">
                                    <i class="fas fa-info-circle" style="margin-right: 8px; color: var(--primary-color);"></i>
                                    ${domain.description}
                                </div>
                            ` : ''}
                            
                            ${domain.matchSequence || domain.sequence ? `
                                <div class="sequence-display">
                                    <div style="margin-bottom: 8px; font-weight: 600; color: #cbd5e0;">
                                        <i class="fas fa-dna" style="margin-right: 8px;"></i>Match Sequence:
                                    </div>
                                    ${domain.matchSequence || domain.sequence}
                                </div>
                            ` : ''}
                            
                            <div class="external-links">
                                ${domain.interproId ? `
                                    <a href="https://www.ebi.ac.uk/interpro/entry/InterPro/${domain.interproId}/" target="_blank" class="external-link">
                                        <i class="fas fa-external-link-alt"></i>
                                        InterPro ${domain.interproId}
                                    </a>
                                ` : ''}
                                ${domain.id && domain.database === 'Pfam' ? `
                                    <a href="https://pfam.xfam.org/family/${domain.id}" target="_blank" class="external-link">
                                        <i class="fas fa-external-link-alt"></i>
                                        Pfam
                                    </a>
                                ` : ''}
                            </div>
                            
                            ${domain.goTerms && domain.goTerms.length > 0 ? `
                                <div class="go-terms">
                                    <div class="go-terms-label">
                                        <i class="fas fa-tags"></i>
                                        Gene Ontology Terms
                                    </div>
                                    <div>
                                        ${domain.goTerms.slice(0, 5).map(go => `
                                            <span class="go-term">${go.name || go}</span>
                                        `).join('')}
                                        ${domain.goTerms.length > 5 ? `<span class="go-term">+${domain.goTerms.length - 5} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');

                const sourceInfo = simulated ? 
                    '<div class="source-info simulated"><i class="fas fa-exclamation-triangle"></i><span><strong>Note:</strong> Results generated using offline pattern matching. Connect to MCP Server for real InterPro analysis.</span></div>' : 
                    '<div class="source-info real"><i class="fas fa-check-circle"></i><span><strong>Source:</strong> Real-time analysis from InterPro database via EBI API.</span></div>';

                container.innerHTML = `
                    <div class="results-header">
                        <h3><i class="fas fa-chart-line" style="margin-right: 12px; color: var(--primary-color);"></i>InterPro Domain Analysis Results</h3>
                        ${sourceInfo}
                        ${stats}
                    </div>
                    
                    ${visualization}
                    
                    <div class="results-controls">
                        <div class="results-title">
                            <i class="fas fa-puzzle-piece" style="margin-right: 8px;"></i>
                            Detected Domains and Features (${results.length})
                        </div>
                        <div class="controls-group">
                            <select class="filter-select" id="domainFilter">
                                <option value="all">All Types</option>
                                <option value="Domain">Domains</option>
                                <option value="Family">Families</option>
                                <option value="Site">Sites</option>
                                <option value="Repeat">Repeats</option>
                            </select>
                            <div class="view-toggle">
                                <button class="view-btn active" data-view="cards">
                                    <i class="fas fa-th-large"></i>
                                </button>
                                <button class="view-btn" data-view="table">
                                    <i class="fas fa-table"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="domainResults">
                        ${domainCards}
                    </div>
                `;
            }

            generateDomainVisualization(results, sequence) {
                const seqLength = sequence.length;
                const trackHeight = 30;
                
                // Sort results by start position
                const sortedResults = [...results].sort((a, b) => a.start - b.start);
                
                // Create domain regions with appropriate colors
                const domainRegions = sortedResults.map(domain => {
                    const startPercent = ((domain.start - 1) / seqLength) * 100;
                    const widthPercent = (domain.length / seqLength) * 100;
                    const visualColor = this.getColorForDomain({...domain, forVisualization: true});
                    
                    return `
                        <div class="domain-region" 
                             style="left: ${startPercent}%; width: ${widthPercent}%; background: ${visualColor};"
                             title="${domain.name} (${domain.start}-${domain.end}): ${domain.description || 'No description available'}">
                            ${domain.name.length > 15 ? domain.name.substring(0, 12) + '...' : domain.name}
                        </div>
                    `;
                }).join('');
                
                // Create enhanced legend with solid colors for visualization
                const uniqueDomains = [...new Map(sortedResults.map(d => [d.type, d])).values()];
                const legend = uniqueDomains.map(domain => {
                    const visualColor = this.getColorForDomain({...domain, forVisualization: true});
                    return `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${visualColor};"></div>
                            <span class="legend-label">${domain.type}</span>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="domain-visualization">
                        <div class="visualization-header">
                            <div class="visualization-title">
                                <i class="fas fa-project-diagram" style="margin-right: 8px;"></i>
                                Domain Architecture
                            </div>
                            <div class="sequence-length">${seqLength} AA</div>
                        </div>
                        <div style="position: relative; margin: 20px 0;">
                            <div style="font-size: 12px; margin-bottom: 8px; color: #64748b; font-weight: 600;">
                                <span style="float: left;">1</span>
                                <span style="float: right;">${seqLength}</span>
                                <div style="clear: both;"></div>
                            </div>
                            <div class="domain-track">
                                ${domainRegions}
                            </div>
                        </div>
                        <div class="domain-legend">
                            ${legend}
                        </div>
                    </div>
                `;
            }

            generateStatistics(results, sequence, summary, simulated) {
                const totalDomains = results.length;
                const coverage = results.reduce((sum, domain) => sum + domain.length, 0);
                const coveragePercent = summary && summary.coverage ? 
                    summary.coverage : 
                    ((coverage / sequence.length) * 100).toFixed(1);
                
                const domainTypes = [...new Set(results.map(d => d.type))];
                const avgScore = summary && summary.averageScore ? 
                    summary.averageScore.toFixed(1) : 
                    totalDomains > 0 ? (results.reduce((sum, d) => sum + (d.score || 0), 0) / totalDomains).toFixed(1) : '0';

                const databasesUsed = summary && summary.databases ? 
                    summary.databases : 
                    [...new Set(results.map(d => d.database))];
                
                return `
                    <div class="statistics-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalDomains}</div>
                            <div class="stat-label">Total Features</div>
                            <div class="stat-detail">Domains, sites, and motifs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${coveragePercent}%</div>
                            <div class="stat-label">Coverage</div>
                            <div class="stat-detail">Sequence annotation</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${domainTypes.length}</div>
                            <div class="stat-label">Feature Types</div>
                            <div class="stat-detail">Unique classifications</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgScore}</div>
                            <div class="stat-label">Avg Score</div>
                            <div class="stat-detail">Confidence metric</div>
                        </div>
                        ${databasesUsed.length > 0 ? `
                        <div class="stat-card">
                            <div class="stat-value">${databasesUsed.length}</div>
                            <div class="stat-label">Databases</div>
                            <div class="stat-detail">${databasesUsed.slice(0, 2).join(', ')}${databasesUsed.length > 2 ? '...' : ''}</div>
                        </div>
                        ` : ''}
                        <div class="stat-card">
                            <div class="stat-value">${sequence.length}</div>
                            <div class="stat-label">Length</div>
                            <div class="stat-detail">Amino acids</div>
                        </div>
                    </div>
                `;
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
                document.getElementById('resultsContainer').style.display = show ? 'none' : 'block';
            }

            updateProgress(message) {
                const progressElement = document.getElementById('analysisProgress');
                if (progressElement) {
                    progressElement.textContent = message;
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            showToast(message, type = 'info') {
                // Create toast notification
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed; top: 20px; right: 20px; 
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                    color: white; padding: 12px 20px; border-radius: 4px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10000;
                    font-size: 14px; max-width: 300px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new InterProAnalyzer();
        });
    </script>
</body>
</html> 