<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlphaFold Complete Pipeline Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            padding: 12px 24px;
            margin: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß¨ AlphaFold Complete Pipeline Test</h1>
        
        <div class="input-group">
            <label>Gene Name:</label>
            <input type="text" id="testGeneInput" placeholder="Enter gene name (e.g., TP53)" value="TP53">
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button id="testStep1" class="btn btn-primary">1Ô∏è‚É£ Test UniProt Search</button>
            <button id="testStep2" class="btn btn-primary">2Ô∏è‚É£ Test AlphaFold Check</button>
            <button id="testComplete" class="btn btn-success">üîç Test Complete Pipeline</button>
            <button id="clearLogs" class="btn">üóëÔ∏è Clear Logs</button>
        </div>
        
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        let logArea = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            logArea = document.getElementById('logArea');
            
            // Test buttons
            document.getElementById('testStep1').addEventListener('click', testUniProtSearch);
            document.getElementById('testStep2').addEventListener('click', testAlphaFoldCheck);
            document.getElementById('testComplete').addEventListener('click', testCompletePipeline);
            document.getElementById('clearLogs').addEventListener('click', clearLogs);
            
            log('üöÄ AlphaFold Complete Pipeline Test initialized');
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#333',
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colorMap[type] || '#333';
            logEntry.style.marginBottom = '5px';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(message);
        }
        
        function clearLogs() {
            logArea.innerHTML = '';
            log('üßπ Logs cleared');
        }
        
        // Step 1: Test UniProt Search
        async function testUniProtSearch() {
            const geneName = document.getElementById('testGeneInput').value.trim();
            log(`1Ô∏è‚É£ Testing UniProt search for gene: ${geneName}`, 'info');
            
            try {
                const query = `(gene:${geneName}) AND (organism_id:9606)`;
                const encodedQuery = encodeURIComponent(query);
                const url = `https://rest.uniprot.org/uniprotkb/search?query=${encodedQuery}&format=json&size=10`;
                
                log(`UniProt Query: ${query}`);
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'GenomeAIStudio/0.2 (contact: support@genomeaistudio.com)'
                    }
                });
                
                log(`UniProt Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`UniProt Results count: ${data.results ? data.results.length : 'No results field'}`);
                
                if (data.results && data.results.length > 0) {
                    log('‚úÖ UniProt search successful!', 'success');
                    
                    window.testUniProtResults = data.results.map(entry => ({
                        uniprotId: entry.primaryAccession,
                        proteinName: entry.proteinDescription?.recommendedName?.fullName?.value || 'Unknown protein',
                        organism: entry.organism?.scientificName || 'Homo sapiens',
                        length: entry.sequence?.length,
                        geneNames: entry.genes?.map(gene => gene.geneName?.value).filter(Boolean) || []
                    }));
                    
                    window.testUniProtResults.forEach((result, index) => {
                        log(`  ${index + 1}. ${result.uniprotId} - ${result.proteinName}`);
                    });
                    
                    log('‚ú® UniProt results stored in window.testUniProtResults', 'success');
                } else {
                    log('‚ö†Ô∏è UniProt search returned no results', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå UniProt search failed: ${error.message}`, 'error');
            }
        }
        
        // Step 2: Test AlphaFold Structure Check
        async function testAlphaFoldCheck() {
            if (!window.testUniProtResults || window.testUniProtResults.length === 0) {
                log('‚ö†Ô∏è No UniProt results available. Run Step 1 first.', 'warning');
                return;
            }
            
            log(`2Ô∏è‚É£ Testing AlphaFold structure check...`, 'info');
            
            for (const result of window.testUniProtResults) {
                try {
                    log(`Checking AlphaFold structure for ${result.uniprotId}...`);
                    
                    const url = `https://alphafold.ebi.ac.uk/api/prediction/${result.uniprotId}`;
                    const response = await fetch(url, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    log(`AlphaFold response for ${result.uniprotId}: ${response.status}`);
                    
                    if (response.ok) {
                        const alphaFoldData = await response.json();
                        log(`‚úÖ ${result.uniprotId} HAS AlphaFold structure!`, 'success');
                        log(`  Confidence score: ${alphaFoldData[0]?.pLDDT || 'Unknown'}`);
                        log(`  Model version: ${alphaFoldData[0]?.modelVersion || 'Unknown'}`);
                        
                        if (!window.testAlphaFoldResults) {
                            window.testAlphaFoldResults = [];
                        }
                        
                        window.testAlphaFoldResults.push({
                            uniprotId: result.uniprotId,
                            geneName: result.geneNames[0] || 'Unknown',
                            proteinName: result.proteinName,
                            organism: result.organism,
                            length: result.length,
                            hasAlphaFoldStructure: true,
                            alphaFoldUrl: `https://alphafold.ebi.ac.uk/entry/${result.uniprotId}`,
                            confidence: alphaFoldData[0]?.pLDDT
                        });
                    } else {
                        log(`‚ùå ${result.uniprotId} does NOT have AlphaFold structure (${response.status})`, 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå Error checking ${result.uniprotId}: ${error.message}`, 'error');
                }
            }
            
            if (window.testAlphaFoldResults && window.testAlphaFoldResults.length > 0) {
                log(`‚ú® Found ${window.testAlphaFoldResults.length} AlphaFold structures!`, 'success');
                log('‚ú® AlphaFold results stored in window.testAlphaFoldResults', 'success');
            } else {
                log('‚ö†Ô∏è No AlphaFold structures found for any UniProt entries', 'warning');
            }
        }
        
        // Complete Pipeline Test
        async function testCompletePipeline() {
            const geneName = document.getElementById('testGeneInput').value.trim();
            log(`üîç Testing COMPLETE AlphaFold pipeline for gene: ${geneName}`, 'info');
            
            // Clear previous results
            window.testUniProtResults = null;
            window.testAlphaFoldResults = null;
            
            // Step 1: UniProt Search
            await testUniProtSearch();
            
            if (!window.testUniProtResults || window.testUniProtResults.length === 0) {
                log('‚ùå Pipeline failed at UniProt search step', 'error');
                return;
            }
            
            // Step 2: AlphaFold Check
            await testAlphaFoldCheck();
            
            // Final Results
            log('=== PIPELINE COMPLETE ===', 'info');
            
            if (window.testAlphaFoldResults && window.testAlphaFoldResults.length > 0) {
                log(`üéâ SUCCESS! Found ${window.testAlphaFoldResults.length} AlphaFold structure(s):`, 'success');
                
                window.testAlphaFoldResults.forEach((result, index) => {
                    log(`  ${index + 1}. ${result.geneName} (${result.uniprotId}) - ${result.proteinName}`);
                    log(`     Confidence: ${result.confidence || 'Unknown'}`);
                    log(`     URL: ${result.alphaFoldUrl}`);
                });
            } else {
                log('‚ùå PIPELINE RESULT: No AlphaFold structures found', 'error');
                log('This indicates either:');
                log('  1. The gene has no UniProt entry');
                log('  2. The UniProt entry has no AlphaFold structure');
                log('  3. There is an API issue');
            }
        }
    </script>
</body>
</html> 