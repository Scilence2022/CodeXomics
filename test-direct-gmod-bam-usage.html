<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct @gmod/bam Usage Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .old-approach, .new-approach {
            padding: 15px;
            border-radius: 6px;
            border: 2px solid;
        }
        .old-approach {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .new-approach {
            border-color: #28a745;
            background: #d4edda;
        }
        .code-example {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button.success {
            background: #28a745;
        }
        button.success:hover {
            background: #218838;
        }
        .api-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .api-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .api-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 10px;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .feature-list li:before {
            content: "‚úÖ ";
            color: #28a745;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ Direct @gmod/bam Usage Test</h1>
            <p>Testing direct usage of @gmod/bam library without IPC overhead</p>
            <p><strong>Goal:</strong> Verify proper import and direct API usage for optimal performance</p>
        </div>

        <div class="test-section">
            <h3>üìä Implementation Comparison</h3>
            <div class="comparison-grid">
                <div class="old-approach">
                    <h4>‚ùå Old Approach (IPC-based)</h4>
                    <div class="code-example">
// Renderer process
const result = await ipcRenderer.invoke('bam-get-reads', {
    filePath, chromosome, start, end
});

// Main process
ipcMain.handle('bam-get-reads', async (event, params) => {
    const bamFile = new BamFile(config);
    const records = await bamFile.getRecordsForRange(...);
    return { success: true, reads: records };
});
                    </div>
                    <ul class="feature-list">
                        <li style="color: #dc3545;">‚ùå IPC serialization overhead</li>
                        <li style="color: #dc3545;">‚ùå Cross-process communication delay</li>
                        <li style="color: #dc3545;">‚ùå Complex error handling</li>
                        <li style="color: #dc3545;">‚ùå Limited streaming capabilities</li>
                    </ul>
                </div>
                <div class="new-approach">
                    <h4>‚úÖ New Approach (Direct API)</h4>
                    <div class="code-example">
// Direct usage in renderer
import { BamFile } from '@gmod/bam';

const bamFile = new BamFile({
    bamPath: filePath,
    baiPath: indexPath
});

const reads = await bamFile.getRecordsForRange('chr1', 1000000, 1010000);
                    </div>
                    <ul class="feature-list">
                        <li>No IPC overhead</li>
                        <li>Direct streaming support</li>
                        <li>Native error handling</li>
                        <li>Full @gmod/bam API access</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üîß @gmod/bam API Showcase</h3>
            <div class="api-showcase">
                <div class="api-card">
                    <div class="api-title">Basic File Operations</div>
                    <div class="code-example">
const bamFile = new BamFile({
    bamPath: 'file.bam',
    baiPath: 'file.bam.bai'
});

const header = await bamFile.getHeader();
const references = header.references;
                    </div>
                </div>
                <div class="api-card">
                    <div class="api-title">Region Queries</div>
                    <div class="code-example">
// Query specific region
const reads = await bamFile.getRecordsForRange(
    'chr1', 1000000, 1010000
);

// Process each read
reads.forEach(read => {
    console.log(`${read.name}: ${read.start}-${read.end}`);
});
                    </div>
                </div>
                <div class="api-card">
                    <div class="api-title">Index Detection</div>
                    <div class="code-example">
// Automatic index detection
const config = {
    bamPath: 'file.bam'
};

// Auto-detects file.bam.bai or file.bai
if (fs.existsSync('file.bam.bai')) {
    config.baiPath = 'file.bam.bai';
}
                    </div>
                </div>
                <div class="api-card">
                    <div class="api-title">Performance Optimization</div>
                    <div class="code-example">
const bamFile = new BamFile({
    bamPath: 'file.bam',
    baiPath: 'file.bam.bai',
    cacheSize: 200,        // Larger cache
    yieldThreadTime: 100   // Better responsiveness
});
                    </div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üß™ Live API Testing</h3>
            <p>Test the direct @gmod/bam API implementation:</p>
            <button id="testImportBtn">Test Import Statement</button>
            <button id="testBamFileCreationBtn">Test BamFile Creation</button>
            <button id="testIndexDetectionBtn">Test Index Detection</button>
            <button id="testDirectQueryBtn" class="success">Test Direct Query</button>
            <button id="testStreamingBtn">Test Streaming</button>
            <button id="testPerformanceBtn">Performance Comparison</button>
        </div>

        <div class="test-section">
            <h3>üìù Test Results</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üîç Console Output</h3>
            <div class="log-output" id="logOutput"></div>
        </div>
    </div>

    <script type="module">
        // Mock @gmod/bam for testing
        class MockBamFile {
            constructor(config) {
                this.config = config;
                this.log(`üîß Creating BamFile with config:`, JSON.stringify(config, null, 2));
            }

            async getHeader() {
                this.log('üìã Getting BAM header...');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const header = {
                    references: [
                        { name: 'chr1', length: 248956422 },
                        { name: 'chr2', length: 242193529 },
                        { name: 'chr3', length: 198295559 },
                        { name: 'chrX', length: 156040895 },
                        { name: 'chrY', length: 57227415 }
                    ]
                };
                
                this.log(`‚úÖ Header retrieved: ${header.references.length} references`);
                return header;
            }

            async getRecordsForRange(chromosome, start, end) {
                this.log(`üîç Querying ${chromosome}:${start.toLocaleString()}-${end.toLocaleString()}`);
                
                // Simulate query time based on index availability
                const queryTime = this.config.baiPath ? 
                    Math.random() * 50 + 10 :  // 10-60ms with index
                    Math.random() * 500 + 100; // 100-600ms without index
                
                await new Promise(resolve => setTimeout(resolve, queryTime));
                
                // Generate mock reads
                const numReads = Math.floor(Math.random() * 1000) + 100;
                const reads = [];
                
                for (let i = 0; i < numReads; i++) {
                    reads.push({
                        name: `read_${i}`,
                        refName: chromosome,
                        start: start + Math.floor(Math.random() * (end - start)),
                        end: start + Math.floor(Math.random() * (end - start)) + 100,
                        strand: Math.random() > 0.5 ? 1 : -1,
                        mapq: Math.floor(Math.random() * 60),
                        cigar: '100M',
                        seq: 'A'.repeat(100),
                        qual: '~'.repeat(100)
                    });
                }
                
                this.log(`‚úÖ Retrieved ${reads.length} reads in ${queryTime.toFixed(1)}ms`);
                return reads;
            }

            log(message, data) {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = data ? `${message}\n${data}` : message;
                logOutput.textContent += `[${timestamp}] ${logMessage}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log(message, data || '');
            }
        }

        // Test framework
        class DirectBamTester {
            constructor() {
                this.setupEventListeners();
                this.clearLog();
                this.log('üöÄ Direct @gmod/bam API Test Suite initialized');
                this.log('üìã Testing direct library usage without IPC overhead');
            }

            setupEventListeners() {
                document.getElementById('testImportBtn').addEventListener('click', () => this.testImport());
                document.getElementById('testBamFileCreationBtn').addEventListener('click', () => this.testBamFileCreation());
                document.getElementById('testIndexDetectionBtn').addEventListener('click', () => this.testIndexDetection());
                document.getElementById('testDirectQueryBtn').addEventListener('click', () => this.testDirectQuery());
                document.getElementById('testStreamingBtn').addEventListener('click', () => this.testStreaming());
                document.getElementById('testPerformanceBtn').addEventListener('click', () => this.testPerformance());
            }

            async testImport() {
                this.addResult('info', 'üì¶ Testing @gmod/bam import statement...');
                
                try {
                    // Simulate import test
                    this.log('import { BamFile } from "@gmod/bam";');
                    this.log('‚úÖ Import statement syntax valid');
                    
                    // Test if we can access the constructor
                    if (typeof MockBamFile === 'function') {
                        this.addResult('success', '‚úÖ @gmod/bam import successful (mocked for demo)');
                        this.log('üîß BamFile constructor available');
                    } else {
                        throw new Error('BamFile constructor not available');
                    }
                } catch (error) {
                    this.addResult('error', `‚ùå Import failed: ${error.message}`);
                }
            }

            async testBamFileCreation() {
                this.addResult('info', 'üîß Testing BamFile instance creation...');
                
                try {
                    const config = {
                        bamPath: '/path/to/test.bam',
                        baiPath: '/path/to/test.bam.bai',
                        cacheSize: 200,
                        yieldThreadTime: 100
                    };
                    
                    this.log('Creating BamFile instance...');
                    const bamFile = new MockBamFile(config);
                    
                    this.addResult('success', '‚úÖ BamFile instance created successfully');
                    this.log('üéØ Configuration applied correctly');
                    
                    return bamFile;
                } catch (error) {
                    this.addResult('error', `‚ùå BamFile creation failed: ${error.message}`);
                    return null;
                }
            }

            async testIndexDetection() {
                this.addResult('info', 'üîç Testing automatic index detection...');
                
                try {
                    // Test with index
                    this.log('Testing with BAI index...');
                    const configWithIndex = {
                        bamPath: '/path/to/test.bam',
                        baiPath: '/path/to/test.bam.bai'
                    };
                    
                    const bamFileWithIndex = new MockBamFile(configWithIndex);
                    this.log('‚úÖ BAI index configuration successful');
                    
                    // Test without index
                    this.log('Testing without index...');
                    const configWithoutIndex = {
                        bamPath: '/path/to/test.bam'
                    };
                    
                    const bamFileWithoutIndex = new MockBamFile(configWithoutIndex);
                    this.log('‚ö†Ô∏è No index - sequential access mode');
                    
                    this.addResult('success', '‚úÖ Index detection logic working correctly');
                } catch (error) {
                    this.addResult('error', `‚ùå Index detection failed: ${error.message}`);
                }
            }

            async testDirectQuery() {
                this.addResult('info', 'üß¨ Testing direct BAM query (bamFile.getRecordsForRange)...');
                
                try {
                    const bamFile = new MockBamFile({
                        bamPath: '/path/to/test.bam',
                        baiPath: '/path/to/test.bam.bai'
                    });
                    
                    // Get header first
                    this.log('Getting BAM header...');
                    const header = await bamFile.getHeader();
                    
                    // Test direct query - this is the key API call
                    this.log('üéØ Executing direct query: bamFile.getRecordsForRange("chr1", 1000000, 1010000)');
                    const startTime = performance.now();
                    
                    const reads = await bamFile.getRecordsForRange('chr1', 1000000, 1010000);
                    
                    const queryTime = performance.now() - startTime;
                    
                    this.addResult('success', `‚úÖ Direct query successful: ${reads.length} reads in ${queryTime.toFixed(1)}ms`);
                    this.log(`üìä Query performance: ${queryTime.toFixed(1)}ms (direct API call)`);
                    this.log(`üìà Retrieved reads: ${reads.length}`);
                    
                    // Show sample read
                    if (reads.length > 0) {
                        const sampleRead = reads[0];
                        this.log(`üìù Sample read: ${sampleRead.name} at ${sampleRead.refName}:${sampleRead.start}-${sampleRead.end}`);
                    }
                    
                } catch (error) {
                    this.addResult('error', `‚ùå Direct query failed: ${error.message}`);
                }
            }

            async testStreaming() {
                this.addResult('info', 'üåä Testing streaming capabilities...');
                
                try {
                    const bamFile = new MockBamFile({
                        bamPath: '/path/to/large.bam',
                        baiPath: '/path/to/large.bam.bai'
                    });
                    
                    this.log('üåä Testing streaming for large region...');
                    
                    // Simulate streaming by querying multiple smaller regions
                    const regions = [
                        { chr: 'chr1', start: 1000000, end: 1010000 },
                        { chr: 'chr1', start: 1010000, end: 1020000 },
                        { chr: 'chr1', start: 1020000, end: 1030000 }
                    ];
                    
                    let totalReads = 0;
                    for (const region of regions) {
                        const reads = await bamFile.getRecordsForRange(region.chr, region.start, region.end);
                        totalReads += reads.length;
                        this.log(`üì¶ Chunk: ${region.chr}:${region.start}-${region.end} ‚Üí ${reads.length} reads`);
                    }
                    
                    this.addResult('success', `‚úÖ Streaming test completed: ${totalReads} total reads across ${regions.length} chunks`);
                    
                } catch (error) {
                    this.addResult('error', `‚ùå Streaming test failed: ${error.message}`);
                }
            }

            async testPerformance() {
                this.addResult('info', '‚ö° Running performance comparison...');
                
                try {
                    // Test with index
                    this.log('üöÄ Testing performance with index...');
                    const bamFileWithIndex = new MockBamFile({
                        bamPath: '/path/to/test.bam',
                        baiPath: '/path/to/test.bam.bai'
                    });
                    
                    const startTimeIndexed = performance.now();
                    const readsIndexed = await bamFileWithIndex.getRecordsForRange('chr1', 1000000, 1010000);
                    const timeIndexed = performance.now() - startTimeIndexed;
                    
                    // Test without index
                    this.log('üêå Testing performance without index...');
                    const bamFileWithoutIndex = new MockBamFile({
                        bamPath: '/path/to/test.bam'
                    });
                    
                    const startTimeUnindexed = performance.now();
                    const readsUnindexed = await bamFileWithoutIndex.getRecordsForRange('chr1', 1000000, 1010000);
                    const timeUnindexed = performance.now() - startTimeUnindexed;
                    
                    const speedup = (timeUnindexed / timeIndexed).toFixed(1);
                    
                    this.addResult('success', `‚ö° Performance comparison completed:`);
                    this.addResult('info', `   üìà With index: ${timeIndexed.toFixed(1)}ms (${readsIndexed.length} reads)`);
                    this.addResult('info', `   üìâ Without index: ${timeUnindexed.toFixed(1)}ms (${readsUnindexed.length} reads)`);
                    this.addResult('success', `   üöÄ Speedup: ${speedup}x faster with index`);
                    
                } catch (error) {
                    this.addResult('error', `‚ùå Performance test failed: ${error.message}`);
                }
            }

            addResult(type, message) {
                const resultsDiv = document.getElementById('testResults');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                resultsDiv.appendChild(resultDiv);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }

            log(message, data) {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = data ? `${message}\n${JSON.stringify(data, null, 2)}` : message;
                logOutput.textContent += `[${timestamp}] ${logMessage}\n`;
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log(message, data || '');
            }

            clearLog() {
                document.getElementById('logOutput').textContent = '';
            }
        }

        // Initialize the tester
        const tester = new DirectBamTester();
        
        // Show initial information
        tester.addResult('info', 'üéØ Key Benefits of Direct @gmod/bam Usage:');
        tester.addResult('success', '   ‚úÖ No IPC serialization overhead');
        tester.addResult('success', '   ‚úÖ Direct access to all @gmod/bam features');
        tester.addResult('success', '   ‚úÖ Native streaming support');
        tester.addResult('success', '   ‚úÖ Simplified error handling');
        tester.addResult('info', 'üß™ Click buttons above to test the implementation!');
    </script>
</body>
</html> 